(function(){"use strict";var ai;(function(n){n[n.Page=0]="Page",n[n.Horizontal=1]="Horizontal"})(ai||(ai={}));var Bt;(function(n){n[n.Default=0]="Default",n[n.ScoreTab=1]="ScoreTab",n[n.Score=2]="Score",n[n.Tab=3]="Tab",n[n.TabMixed=4]="TabMixed"})(Bt||(Bt={}));class ni{static getValue(e){return ni._values||(ni._values=new Map),e=e.toLowerCase().replaceAll(" ",""),ni._values.has(e)?ni._values.get(e):0}static isPiano(e){return e<=7||e>=16&&e<=23}static isGuitar(e){return e>=24&&e<=39||e===105||e===43}}ni._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);class Gi{init(e,t){this.data=e,this.settings=t}}var at;(function(n){n[n.General=0]="General",n[n.Format=1]="Format",n[n.AlphaTex=2]="AlphaTex"})(at||(at={}));class nt extends Error{constructor(e,t="",i){super(t??"",{cause:i}),this.type=e,this.inner=i??null,Object.setPrototypeOf(this,nt.prototype)}}class xe extends nt{constructor(e=null,t=null){super(at.Format,e??"Unsupported format"),this.inner=t,Object.setPrototypeOf(this,xe.prototype)}}var He;(function(n){n[n.None=0]="None",n[n.Normal=1]="Normal",n[n.Heavy=2]="Heavy"})(He||(He={}));var Ge;(function(n){n[n.Tempo=0]="Tempo",n[n.Volume=1]="Volume",n[n.Instrument=2]="Instrument",n[n.Balance=3]="Balance"})(Ge||(Ge={}));class st{constructor(){this.isLinear=!1,this.type=Ge.Tempo,this.value=0,this.ratioPosition=0,this.text=""}static buildTempoAutomation(e,t,i,s){(s<1||s>5)&&(s=2);let r=new Float32Array([1,.5,1,1.5,2,3]),a=new st;return a.type=Ge.Tempo,a.isLinear=e,a.ratioPosition=t,a.value=i*r[s],a}static buildInstrumentAutomation(e,t,i){let s=new st;return s.type=Ge.Instrument,s.isLinear=e,s.ratioPosition=t,s.value=i,s}}var U;(function(n){n[n.Neutral=0]="Neutral",n[n.C3=1]="C3",n[n.C4=2]="C4",n[n.F4=3]="F4",n[n.G2=4]="G2"})(U||(U={}));var le;(function(n){n[n._15ma=0]="_15ma",n[n._8va=1]="_8va",n[n.Regular=2]="Regular",n[n._8vb=3]="_8vb",n[n._15mb=4]="_15mb"})(le||(le={}));var Pt;(function(n){n[n.None=0]="None",n[n.Simple=1]="Simple",n[n.FirstOfDouble=2]="FirstOfDouble",n[n.SecondOfDouble=3]="SecondOfDouble"})(Pt||(Pt={}));class oi{constructor(){this.id=oi._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=U.G2,this.clefOttava=le.Regular,this.voices=[],this.simileMark=Pt.None,this.isMultiVoice=!1,this.displayScale=1,this.displayWidth=-1}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){for(let e=0,t=this.voices.length;e<t;e++)if(!this.voices[e].isEmpty)return!1;return!0}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e,t=null){this.isMultiVoice=!1;for(let i=0,s=this.voices.length;i<s;i++){let r=this.voices[i];r.finish(e,t),i>0&&!r.isEmpty&&(this.isMultiVoice=!0)}}calculateDuration(){let e=0;for(let t of this.voices){let i=t.calculateDuration();i>e&&(e=i)}return e}}oi._globalBarId=0;class q{static ticksToMillis(e,t){return e*(6e4/(t*q.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*q.QuarterTime))|0}static toTicks(e){return q.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=1/-t),q.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+(e/4|0)*3:e+(e/2|0)}static applyTuplet(e,t,i){return e*i/t|0}static removeTuplet(e,t,i){return e*t/i|0}static dynamicToVelocity(e){return q.MinVelocity+e*q.VelocityIncrement}}q.QuarterTime=960,q.MinVelocity=15,q.VelocityIncrement=16;class L{constructor(e=0,t=0){this.offset=e,this.value=t}}L.MaxPosition=60,L.MaxValue=12;var me;(function(n){n[n.Default=0]="Default",n[n.Gradual=1]="Gradual",n[n.Fast=2]="Fast"})(me||(me={}));var M;(function(n){n[n.None=0]="None",n[n.Custom=1]="Custom",n[n.Bend=2]="Bend",n[n.Release=3]="Release",n[n.BendRelease=4]="BendRelease",n[n.Hold=5]="Hold",n[n.Prebend=6]="Prebend",n[n.PrebendBend=7]="PrebendBend",n[n.PrebendRelease=8]="PrebendRelease"})(M||(M={}));var Se;(function(n){n[n.None=0]="None",n[n.BrushUp=1]="BrushUp",n[n.BrushDown=2]="BrushDown",n[n.ArpeggioUp=3]="ArpeggioUp",n[n.ArpeggioDown=4]="ArpeggioDown"})(Se||(Se={}));var mt;(function(n){n[n.None=0]="None",n[n.Crescendo=1]="Crescendo",n[n.Decrescendo=2]="Decrescendo"})(mt||(mt={}));var m;(function(n){n[n.QuadrupleWhole=-4]="QuadrupleWhole",n[n.DoubleWhole=-2]="DoubleWhole",n[n.Whole=1]="Whole",n[n.Half=2]="Half",n[n.Quarter=4]="Quarter",n[n.Eighth=8]="Eighth",n[n.Sixteenth=16]="Sixteenth",n[n.ThirtySecond=32]="ThirtySecond",n[n.SixtyFourth=64]="SixtyFourth",n[n.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",n[n.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"})(m||(m={}));var j;(function(n){n[n.PPP=0]="PPP",n[n.PP=1]="PP",n[n.P=2]="P",n[n.MP=3]="MP",n[n.MF=4]="MF",n[n.F=5]="F",n[n.FF=6]="FF",n[n.FFF=7]="FFF"})(j||(j={}));var W;(function(n){n[n.None=0]="None",n[n.OnBeat=1]="OnBeat",n[n.BeforeBeat=2]="BeforeBeat",n[n.BendGrace=3]="BendGrace"})(W||(W={}));var Y;(function(n){n[n.Unknown=-2]="Unknown",n[n.NoOrDead=-1]="NoOrDead",n[n.Thumb=0]="Thumb",n[n.IndexFinger=1]="IndexFinger",n[n.MiddleFinger=2]="MiddleFinger",n[n.AnnularFinger=3]="AnnularFinger",n[n.LittleFinger=4]="LittleFinger"})(Y||(Y={}));var O;(function(n){n[n.None=0]="None",n[n.Natural=1]="Natural",n[n.Artificial=2]="Artificial",n[n.Pinch=3]="Pinch",n[n.Tap=4]="Tap",n[n.Semi=5]="Semi",n[n.Feedback=6]="Feedback"})(O||(O={}));var Me;(function(n){n[n.Default=0]="Default",n[n.ForceNone=1]="ForceNone",n[n.ForceNatural=2]="ForceNatural",n[n.ForceSharp=3]="ForceSharp",n[n.ForceDoubleSharp=4]="ForceDoubleSharp",n[n.ForceFlat=5]="ForceFlat",n[n.ForceDoubleFlat=6]="ForceDoubleFlat"})(Me||(Me={}));var $e;(function(n){n[n.None=0]="None",n[n.IntoFromBelow=1]="IntoFromBelow",n[n.IntoFromAbove=2]="IntoFromAbove"})($e||($e={}));var Q;(function(n){n[n.None=0]="None",n[n.Shift=1]="Shift",n[n.Legato=2]="Legato",n[n.OutUp=3]="OutUp",n[n.OutDown=4]="OutDown",n[n.PickSlideDown=5]="PickSlideDown",n[n.PickSlideUp=6]="PickSlideUp"})(Q||(Q={}));var oe;(function(n){n[n.None=0]="None",n[n.Slight=1]="Slight",n[n.Wide=2]="Wide"})(oe||(oe={}));var hi;(function(n){n[n.Hidden=0]="Hidden",n[n.ShowWithBeams=1]="ShowWithBeams",n[n.ShowWithBars=2]="ShowWithBars"})(hi||(hi={}));var Ot;(function(n){n[n.ScoreDefault=0]="ScoreDefault",n[n.ScoreForcePiano=1]="ScoreForcePiano",n[n.SingleNoteEffectBand=2]="SingleNoteEffectBand",n[n.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano"})(Ot||(Ot={}));var Ye;(function(n){n[n.GuitarPro=0]="GuitarPro",n[n.SongBook=1]="SongBook"})(Ye||(Ye={}));var G;(function(n){n[n.ScoreTitle=0]="ScoreTitle",n[n.ScoreSubTitle=1]="ScoreSubTitle",n[n.ScoreArtist=2]="ScoreArtist",n[n.ScoreAlbum=3]="ScoreAlbum",n[n.ScoreWords=4]="ScoreWords",n[n.ScoreMusic=5]="ScoreMusic",n[n.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",n[n.ScoreCopyright=7]="ScoreCopyright",n[n.GuitarTuning=8]="GuitarTuning",n[n.TrackNames=9]="TrackNames",n[n.ChordDiagrams=10]="ChordDiagrams",n[n.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",n[n.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",n[n.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",n[n.EffectAlternateEndings=14]="EffectAlternateEndings",n[n.EffectCapo=15]="EffectCapo",n[n.EffectChordNames=16]="EffectChordNames",n[n.EffectCrescendo=17]="EffectCrescendo",n[n.EffectDynamics=18]="EffectDynamics",n[n.EffectFadeIn=19]="EffectFadeIn",n[n.EffectFermata=20]="EffectFermata",n[n.EffectFingering=21]="EffectFingering",n[n.EffectHarmonics=22]="EffectHarmonics",n[n.EffectLetRing=23]="EffectLetRing",n[n.EffectLyrics=24]="EffectLyrics",n[n.EffectMarker=25]="EffectMarker",n[n.EffectOttavia=26]="EffectOttavia",n[n.EffectPalmMute=27]="EffectPalmMute",n[n.EffectPickSlide=28]="EffectPickSlide",n[n.EffectPickStroke=29]="EffectPickStroke",n[n.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",n[n.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",n[n.EffectTap=32]="EffectTap",n[n.EffectTempo=33]="EffectTempo",n[n.EffectText=34]="EffectText",n[n.EffectTrill=35]="EffectTrill",n[n.EffectTripletFeel=36]="EffectTripletFeel",n[n.EffectWhammyBar=37]="EffectWhammyBar",n[n.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",n[n.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",n[n.EffectLeftHandTap=40]="EffectLeftHandTap"})(G||(G={}));class ts{constructor(){this.notationMode=Ye.GuitarPro,this.fingeringMode=Ot.ScoreDefault,this.elements=new Map,this.rhythmMode=hi.Hidden,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(e){return this.elements.has(e)?this.elements.get(e):ts.defaultElements.has(e)?ts.defaultElements.get(e):!0}}ts.defaultElements=new Map([[G.ZerosOnDiveWhammys,!1]]);class aa{constructor(e){this._value=void 0,this._factory=e}get value(){return this._value===void 0&&(this._value=this._factory()),this._value}}var Vt;(function(n){n[n.None=0]="None",n[n.Debug=1]="Debug",n[n.Info=2]="Info",n[n.Warning=3]="Warning",n[n.Error=4]="Error"})(Vt||(Vt={}));class Ci{static format(e,t){return`[AlphaTab][${e}] ${t}`}debug(e,t,...i){console.debug(Ci.format(e,t),...i)}warning(e,t,...i){console.warn(Ci.format(e,t),...i)}info(e,t,...i){console.info(Ci.format(e,t),...i)}error(e,t,...i){console.error(Ci.format(e,t),...i)}}Ci.logLevel=Vt.Info;class _{static shouldLog(e){return _.logLevel!==Vt.None&&e>=_.logLevel}static debug(e,t,...i){_.shouldLog(Vt.Debug)&&_.log.debug(e,t,...i)}static warning(e,t,...i){_.shouldLog(Vt.Warning)&&_.log.warning(e,t,...i)}static info(e,t,...i){_.shouldLog(Vt.Info)&&_.log.info(e,t,...i)}static error(e,t,...i){_.shouldLog(Vt.Error)&&_.log.error(e,t,...i)}}_.logLevel=Vt.Info,_.log=new Ci;class An{constructor(){this.note=null,this.noteValue=0,this.octave=0}get realValue(){return this.octave*12+this.noteValue}}class Be{static getIndex(e){let t=0;return e<0?t:Math.log2(e)|0}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return e===0}static keySignatureIsSharp(e){return e>0}static applyPitchOffsets(e,t){for(let i=0;i<t.tracks.length;i++){if(i<e.notation.displayTranspositionPitches.length)for(let s of t.tracks[i].staves)s.displayTranspositionPitch=-e.notation.displayTranspositionPitches[i];if(i<e.notation.transpositionPitches.length)for(let s of t.tracks[i].staves)s.transpositionPitch=-e.notation.transpositionPitches[i]}}static fingerToString(e,t,i,s){if(e.notation.fingeringMode===Ot.ScoreForcePiano||e.notation.fingeringMode===Ot.SingleNoteEffectBandForcePiano||ni.isPiano(t.voice.bar.staff.track.playbackInfo.program))switch(i){case Y.Unknown:case Y.NoOrDead:return null;case Y.Thumb:return"1";case Y.IndexFinger:return"2";case Y.MiddleFinger:return"3";case Y.AnnularFinger:return"4";case Y.LittleFinger:return"5";default:return null}if(s)switch(i){case Y.Unknown:case Y.NoOrDead:return"0";case Y.Thumb:return"T";case Y.IndexFinger:return"1";case Y.MiddleFinger:return"2";case Y.AnnularFinger:return"3";case Y.LittleFinger:return"4";default:return null}switch(i){case Y.Unknown:case Y.NoOrDead:return null;case Y.Thumb:return"p";case Y.IndexFinger:return"i";case Y.MiddleFinger:return"m";case Y.AnnularFinger:return"a";case Y.LittleFinger:return"c";default:return null}}static isTuning(e){return!!Be.parseTuning(e)}static parseTuning(e){let t="",i="";for(let r=0;r<e.length;r++){let a=e.charCodeAt(r);if(a>=48&&a<=57){if(!t)return null;i+=String.fromCharCode(a)}else if(a>=65&&a<=90||a>=97&&a<=122||a===35)t+=String.fromCharCode(a);else return null}if(!i||!t)return null;let s=new An;return s.octave=parseInt(i)+1,s.note=t.toLowerCase(),s.noteValue=Be.getToneForText(s.note),s}static getTuningForText(e){let t=Be.parseTuning(e);return t?t.realValue:-1}static getToneForText(e){switch(e.toLowerCase()){case"c":return 0;case"c#":case"db":return 1;case"d":return 2;case"d#":case"eb":return 3;case"e":return 4;case"f":return 5;case"f#":case"gb":return 6;case"g":return 7;case"g#":case"ab":return 8;case"a":return 9;case"a#":case"bb":return 10;case"b":return 11;default:return 0}}static newGuid(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)+Math.floor((1+Math.random())*65536).toString(16).substring(1)+"-"+Math.floor((1+Math.random())*65536).toString(16).substring(1)+"-"+Math.floor((1+Math.random())*65536).toString(16).substring(1)+"-"+Math.floor((1+Math.random())*65536).toString(16).substring(1)+"-"+Math.floor((1+Math.random())*65536).toString(16).substring(1)+Math.floor((1+Math.random())*65536).toString(16).substring(1)+Math.floor((1+Math.random())*65536).toString(16).substring(1)}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let i="",s="0123456789ABCDEF";do i=String.fromCharCode(s.charCodeAt(e&15))+i,e=e>>4;while(e>0);for(;i.length<t;)i="0"+i;return i}}var je;(function(n){n[n.None=0]="None",n[n.Up=1]="Up",n[n.Down=2]="Down"})(je||(je={}));var u;(function(n){n[n.None=-1]="None",n[n.GClef=57424]="GClef",n[n.CClef=57436]="CClef",n[n.FClef=57442]="FClef",n[n.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",n[n.SixStringTabClef=57453]="SixStringTabClef",n[n.FourStringTabClef=57454]="FourStringTabClef",n[n.TimeSig0=57472]="TimeSig0",n[n.TimeSig1=57473]="TimeSig1",n[n.TimeSig2=57474]="TimeSig2",n[n.TimeSig3=57475]="TimeSig3",n[n.TimeSig4=57476]="TimeSig4",n[n.TimeSig5=57477]="TimeSig5",n[n.TimeSig6=57478]="TimeSig6",n[n.TimeSig7=57479]="TimeSig7",n[n.TimeSig8=57480]="TimeSig8",n[n.TimeSig9=57481]="TimeSig9",n[n.TimeSigCommon=57482]="TimeSigCommon",n[n.TimeSigCutCommon=57483]="TimeSigCutCommon",n[n.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",n[n.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",n[n.NoteheadWhole=57506]="NoteheadWhole",n[n.NoteheadHalf=57507]="NoteheadHalf",n[n.NoteheadBlack=57508]="NoteheadBlack",n[n.NoteheadNull=57509]="NoteheadNull",n[n.NoteheadXOrnate=57514]="NoteheadXOrnate",n[n.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",n[n.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",n[n.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",n[n.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",n[n.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",n[n.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",n[n.NoteheadCircleX=57523]="NoteheadCircleX",n[n.NoteheadXWhole=57511]="NoteheadXWhole",n[n.NoteheadXHalf=57512]="NoteheadXHalf",n[n.NoteheadXBlack=57513]="NoteheadXBlack",n[n.NoteheadParenthesis=57550]="NoteheadParenthesis",n[n.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",n[n.NoteheadCircleSlash=57591]="NoteheadCircleSlash",n[n.NoteheadHeavyX=57592]="NoteheadHeavyX",n[n.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",n[n.NoteheadSlashVerticalEnds=57600]="NoteheadSlashVerticalEnds",n[n.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",n[n.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",n[n.NoteQuarterUp=57813]="NoteQuarterUp",n[n.NoteEighthUp=57815]="NoteEighthUp",n[n.Tremolo3=57890]="Tremolo3",n[n.Tremolo2=57889]="Tremolo2",n[n.Tremolo1=57888]="Tremolo1",n[n.FlagEighthUp=57920]="FlagEighthUp",n[n.FlagEighthDown=57921]="FlagEighthDown",n[n.FlagSixteenthUp=57922]="FlagSixteenthUp",n[n.FlagSixteenthDown=57923]="FlagSixteenthDown",n[n.FlagThirtySecondUp=57924]="FlagThirtySecondUp",n[n.FlagThirtySecondDown=57925]="FlagThirtySecondDown",n[n.FlagSixtyFourthUp=57926]="FlagSixtyFourthUp",n[n.FlagSixtyFourthDown=57927]="FlagSixtyFourthDown",n[n.FlagOneHundredTwentyEighthUp=57928]="FlagOneHundredTwentyEighthUp",n[n.FlagOneHundredTwentyEighthDown=57929]="FlagOneHundredTwentyEighthDown",n[n.FlagTwoHundredFiftySixthUp=57930]="FlagTwoHundredFiftySixthUp",n[n.FlagTwoHundredFiftySixthDown=57931]="FlagTwoHundredFiftySixthDown",n[n.AccidentalFlat=57952]="AccidentalFlat",n[n.AccidentalNatural=57953]="AccidentalNatural",n[n.AccidentalSharp=57954]="AccidentalSharp",n[n.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",n[n.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",n[n.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",n[n.AccidentalQuarterToneSharpArrowUp=57972]="AccidentalQuarterToneSharpArrowUp",n[n.AccidentalQuarterToneNaturalArrowUp=57970]="AccidentalQuarterToneNaturalArrowUp",n[n.ArticAccentAbove=58528]="ArticAccentAbove",n[n.ArticStaccatoAbove=58530]="ArticStaccatoAbove",n[n.ArticMarcatoAbove=58540]="ArticMarcatoAbove",n[n.FermataAbove=58560]="FermataAbove",n[n.FermataShortAbove=58564]="FermataShortAbove",n[n.FermataLongAbove=58566]="FermataLongAbove",n[n.RestLonga=58593]="RestLonga",n[n.RestDoubleWhole=58594]="RestDoubleWhole",n[n.RestWhole=58595]="RestWhole",n[n.RestHalf=58596]="RestHalf",n[n.RestQuarter=58597]="RestQuarter",n[n.RestEighth=58598]="RestEighth",n[n.RestSixteenth=58599]="RestSixteenth",n[n.RestThirtySecond=58600]="RestThirtySecond",n[n.RestSixtyFourth=58601]="RestSixtyFourth",n[n.RestOneHundredTwentyEighth=58602]="RestOneHundredTwentyEighth",n[n.RestTwoHundredFiftySixth=58603]="RestTwoHundredFiftySixth",n[n.Repeat1Bar=58624]="Repeat1Bar",n[n.Repeat2Bars=58625]="Repeat2Bars",n[n.Ottava=58640]="Ottava",n[n.OttavaAlta=58641]="OttavaAlta",n[n.OttavaBassaVb=58652]="OttavaBassaVb",n[n.Quindicesima=58644]="Quindicesima",n[n.QuindicesimaAlta=58645]="QuindicesimaAlta",n[n.DynamicPPP=58666]="DynamicPPP",n[n.DynamicPP=58667]="DynamicPP",n[n.DynamicPiano=58656]="DynamicPiano",n[n.DynamicMP=58668]="DynamicMP",n[n.DynamicMF=58669]="DynamicMF",n[n.DynamicForte=58658]="DynamicForte",n[n.DynamicFF=58671]="DynamicFF",n[n.DynamicFFF=58672]="DynamicFFF",n[n.OrnamentTrill=58726]="OrnamentTrill",n[n.StringsDownBow=58896]="StringsDownBow",n[n.StringsUpBow=58898]="StringsUpBow",n[n.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",n[n.GuitarString0=59443]="GuitarString0",n[n.GuitarString1=59444]="GuitarString1",n[n.GuitarString2=59445]="GuitarString2",n[n.GuitarString3=59446]="GuitarString3",n[n.GuitarString4=59447]="GuitarString4",n[n.GuitarString5=59448]="GuitarString5",n[n.GuitarString6=59449]="GuitarString6",n[n.GuitarString7=59450]="GuitarString7",n[n.GuitarString8=59451]="GuitarString8",n[n.GuitarString9=59452]="GuitarString9",n[n.GuitarGolpe=59458]="GuitarGolpe",n[n.FretboardX=59481]="FretboardX",n[n.FretboardO=59482]="FretboardO",n[n.WiggleTrill=60068]="WiggleTrill",n[n.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",n[n.OctaveBaselineM=60565]="OctaveBaselineM",n[n.OctaveBaselineB=60563]="OctaveBaselineB"})(u||(u={}));var V;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(V||(V={}));var J;(function(n){n[n.Top=0]="Top",n[n.Middle=1]="Middle",n[n.Bottom=2]="Bottom"})(J||(J={}));class Ts{constructor(e,t){this.width=e,this.height=t}}class E{constructor(e="",t=0,i=0,s=u.None,r=u.None,a=u.None,o=u.None,h=J.Middle){this.elementType=e,this.outputMidiNumber=i,this.staffLine=t,this.noteHeadDefault=s,this.noteHeadHalf=r!==u.None?r:s,this.noteHeadWhole=a!==u.None?a:s,this.techniqueSymbol=o,this.techniqueSymbolPlacement=h}getSymbol(e){switch(e){case m.Whole:return this.noteHeadWhole;case m.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class Ae{static articulationFromElementVariation(e,t){return e<Ae.gp6ElementAndVariationToArticulation.length?(t>=Ae.gp6ElementAndVariationToArticulation.length&&(t=0),Ae.gp6ElementAndVariationToArticulation[e][t]):38}static getArticulation(e){const t=e.percussionArticulation,i=e.beat.voice.bar.staff.track.percussionArticulations;return t<i.length?i[t]:Ae.getArticulationByValue(t)}static getElementAndVariation(e){const t=Ae.getArticulation(e);if(!t)return[-1,-1];for(let i=0;i<Ae.gp6ElementAndVariationToArticulation.length;i++){const s=Ae.gp6ElementAndVariationToArticulation[i];for(let r=0;r<s.length;r++){const a=Ae.getArticulationByValue(s[r]);if((a==null?void 0:a.outputMidiNumber)===t.outputMidiNumber)return[i,r]}}return[-1,-1]}static getArticulationByValue(e){return Ae.instrumentArticulations.has(e)?Ae.instrumentArticulations.get(e):null}}Ae.gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],Ae.instrumentArticulations=new Map([[38,new E("snare",3,38,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[37,new E("snare",3,37,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[91,new E("snare",3,38,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite)],[42,new E("hiHat",-1,42,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[92,new E("hiHat",-1,46,u.NoteheadCircleSlash,u.NoteheadCircleSlash,u.NoteheadCircleSlash)],[46,new E("hiHat",-1,46,u.NoteheadCircleX,u.NoteheadCircleX,u.NoteheadCircleX)],[44,new E("hiHat",9,44,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[35,new E("kickDrum",8,35,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[36,new E("kickDrum",7,36,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[50,new E("tom",1,50,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[48,new E("tom",2,48,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[47,new E("tom",4,47,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[45,new E("tom",5,45,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[43,new E("tom",6,43,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[93,new E("ride",0,51,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.PictEdgeOfCymbal,J.Bottom)],[51,new E("ride",0,51,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[53,new E("ride",0,53,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite)],[94,new E("ride",0,51,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.ArticStaccatoAbove,J.Top)],[55,new E("splash",-2,55,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[95,new E("splash",-2,55,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.ArticStaccatoAbove,J.Bottom)],[52,new E("china",-3,52,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat)],[96,new E("china",-3,52,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat)],[49,new E("crash",-2,49,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX)],[97,new E("crash",-2,49,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX,u.ArticStaccatoAbove,J.Bottom)],[57,new E("crash",-1,57,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX)],[98,new E("crash",-1,57,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX,u.ArticStaccatoAbove,J.Bottom)],[99,new E("cowbell",1,56,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpWhole)],[100,new E("cowbell",1,56,u.NoteheadXBlack,u.NoteheadXHalf,u.NoteheadXWhole)],[56,new E("cowbell",0,56,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpWhole)],[101,new E("cowbell",0,56,u.NoteheadXBlack,u.NoteheadXHalf,u.NoteheadXWhole)],[102,new E("cowbell",-1,56,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpWhole)],[103,new E("cowbell",-1,56,u.NoteheadXBlack,u.NoteheadXHalf,u.NoteheadXWhole)],[77,new E("woodblock",-9,77,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack)],[76,new E("woodblock",-10,76,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack)],[60,new E("bongo",-4,60,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[104,new E("bongo",-5,60,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,J.Middle)],[105,new E("bongo",-6,60,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[61,new E("bongo",-7,61,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[106,new E("bongo",-8,61,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,J.Middle)],[107,new E("bongo",-16,61,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[66,new E("timbale",10,66,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[65,new E("timbale",9,65,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[68,new E("agogo",12,68,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[67,new E("agogo",11,67,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[64,new E("conga",17,64,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[108,new E("conga",16,64,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[109,new E("conga",15,64,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,J.Middle)],[63,new E("conga",14,63,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[110,new E("conga",13,63,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[62,new E("conga",19,62,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,J.Middle)],[72,new E("whistle",-11,72,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[71,new E("whistle",-17,71,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[73,new E("guiro",38,73,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[74,new E("guiro",37,74,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[86,new E("surdo",36,86,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[87,new E("surdo",35,87,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadParenthesis,J.Middle)],[54,new E("tambourine",3,54,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack)],[111,new E("tambourine",2,54,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.StringsUpBow,J.Bottom)],[112,new E("tambourine",1,54,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.StringsDownBow,J.Bottom)],[113,new E("tambourine",-7,54,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[79,new E("cuica",30,79,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[78,new E("cuica",29,78,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[58,new E("vibraslap",28,58,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[81,new E("triangle",27,81,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[80,new E("triangle",26,80,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadParenthesis,J.Middle)],[114,new E("grancassa",25,43,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[115,new E("piatti",18,49,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[116,new E("piatti",24,49,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[69,new E("cabasa",23,69,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[117,new E("cabasa",22,69,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,J.Bottom)],[85,new E("castanets",21,85,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[75,new E("claves",20,75,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[70,new E("maraca",-12,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[118,new E("maraca",-13,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,J.Bottom)],[119,new E("maraca",-14,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[120,new E("maraca",-15,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,J.Bottom)],[82,new E("shaker",-23,54,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[122,new E("shaker",-24,54,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,J.Bottom)],[84,new E("bellTree",-18,53,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[123,new E("bellTree",-19,53,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,J.Bottom)],[83,new E("jingleBell",-20,53,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[124,new E("unpitched",-21,62,u.NoteheadNull,u.NoteheadNull,u.NoteheadNull,u.GuitarGolpe,J.Top)],[125,new E("unpitched",-22,62,u.NoteheadNull,u.NoteheadNull,u.NoteheadNull,u.GuitarGolpe,J.Bottom)],[39,new E("handClap",3,39,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[40,new E("snare",3,40,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[31,new E("snare",3,40,u.NoteheadSlashedBlack2,u.NoteheadSlashedBlack2,u.NoteheadSlashedBlack2)],[41,new E("tom",5,41,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[59,new E("ride",2,59,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.PictEdgeOfCymbal,J.Bottom)],[126,new E("ride",2,59,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[127,new E("ride",2,59,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite)],[29,new E("ride",2,59,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.ArticStaccatoAbove,J.Top)],[30,new E("crash",-3,49,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[33,new E("snare",3,37,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[34,new E("snare",3,38,u.NoteheadBlack,u.NoteheadBlack,u.NoteheadBlack)]]),Ae.instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]);class zi{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1}}class Ee{constructor(){this.id=Ee.GlobalNoteId++,this.index=0,this.accentuated=He.None,this.bendType=M.None,this.bendStyle=me.Default,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=null,this.maxBendPoint=null,this.fret=-1,this.string=-1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=O.None,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isStaccato=!1,this.slideInType=$e.None,this.slideOutType=Q.None,this.slideTarget=null,this.slideOrigin=null,this.vibrato=oe.None,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=Y.Unknown,this.rightHandFinger=Y.Unknown,this.isFingering=!1,this.trillValue=-1,this.trillSpeed=m.ThirtySecond,this.durationPercent=1,this.accidentalMode=Me.Default,this.dynamics=j.F,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this._noteIdBag=null}get hasBend(){return this.bendPoints!==null&&this.bendType!==M.None}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?Ae.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?Ae.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==O.None}get isTieOrigin(){return this.tieDestination!==null}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+Ee.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return e.tuning.length>0?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(e,t){const i=e?this.beat.voice.bar.staff.transpositionPitch:0;if(t){let s=this.calculateRealValue(e,!1);return this.isStringed&&(this.harmonicType===O.Natural?s=this.harmonicPitch+this.stringTuning-i:s+=this.harmonicPitch),s}else return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-i:this.isPiano?this.octave*12+this.tone-i:0}get harmonicPitch(){if(this.harmonicType===O.None||!this.isStringed)return 0;let e=this.harmonicValue;return Be.isAlmostEqualTo(e,2.4)?36:Be.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==O.Natural&&this.harmonicType!==O.None&&(e-=this.harmonicPitch),this.beat.ottava){case le._15ma:e-=24;break;case le._8va:e-=12;break;case le.Regular:break;case le._8vb:e+=12;break;case le._15mb:e+=24;break}switch(this.beat.voice.bar.clefOttava){case le._15ma:e-=24;break;case le._8va:e-=12;break;case le.Regular:break;case le._8vb:e+=12;break;case le._15mb:e+=24;break}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!==0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!==0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!==0:this.beat.isContinuedWhammy?this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!==0:!1}addBendPoint(e){let t=this.bendPoints;t===null&&(t=[],this.bendPoints=t),t.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===M.None&&(this.bendType=M.Custom)}finish(e,t=null){let i=new aa(()=>Ee.nextNoteOnSameLine(this)),s=e&&e.notation.notationMode===Ye.SongBook;if(this.isTieDestination&&(this.chain(t),s&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(!i.value||!i.value.isLetRing?this.letRingDestination=this:this.letRingDestination=i.value,s&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(!i.value||!i.value.isPalmMute?this.palmMuteDestination=this:this.palmMuteDestination=i.value),this.isHammerPullOrigin){let o=Ee.findHammerPullDestination(this);o?(this.hammerPullDestination=o,o.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case Q.Shift:case Q.Legato:this.slideTarget=i.value,this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=Q.None;break}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:this.slideOutType===Q.Legato&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===je.None?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));const a=this.bendPoints;if(a!=null&&a.length>0&&this.bendType===M.Custom){let o=this.isTieDestination&&this.tieOrigin.hasBend;if(this.isContinuedBend=o,a.length===4){let h=a[0],l=a[1],d=a[2],c=a[3];l.value===d.value?c.value>h.value?l.value>c.value?this.bendType=M.BendRelease:!o&&h.value>0?(this.bendType=M.PrebendBend,a.splice(2,1),a.splice(1,1)):(this.bendType=M.Bend,a.splice(2,1),a.splice(1,1)):c.value<h.value?o?(this.bendType=M.Release,a.splice(2,1),a.splice(1,1)):(this.bendType=M.PrebendRelease,a.splice(2,1),a.splice(1,1)):l.value>h.value?this.bendType=M.BendRelease:h.value>0&&!o?(this.bendType=M.Prebend,a.splice(2,1),a.splice(1,1)):(this.bendType=M.Hold,a.splice(2,1),a.splice(1,1)):_.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(a.length===2){let h=a[0],l=a[1];l.value>h.value?!o&&h.value>0?this.bendType=M.PrebendBend:this.bendType=M.Bend:l.value<h.value?o?this.bendType=M.Release:this.bendType=M.PrebendRelease:h.value>0&&!o?this.bendType=M.Prebend:this.bendType=M.Hold}}else(a===null||a.length===0)&&(this.bendType=M.None);this.initialBendValue>0&&(this.accidentalMode=Me.Default)}static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+Ee.MaxOffsetForSameLineSearch;){let i=t.getNoteOnString(e.string);if(i)return i;t=t.nextBeat}return null}static findHammerPullDestination(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+Ee.MaxOffsetForSameLineSearch;){let i=t.getNoteOnString(e.string);if(i)return i;for(let s=e.string;s>0;s--)if(i=t.getNoteOnString(s),i){if(i.isLeftHandTapped)return i;break}for(let s=e.string;s<=e.beat.voice.bar.staff.tuning.length;s++)if(i=t.getNoteOnString(s),i){if(i.isLeftHandTapped)return i;break}t=t.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-Ee.MaxOffsetForSameLineSearch;){if(e.isStringed){let i=t.getNoteOnString(e.string);if(i)return i}else if(e.octave===-1&&e.tone===-1){if(e.index<t.notes.length)return t.notes[e.index]}else{let i=t.getNoteWithRealValue(e.realValue);if(i)return i}t=t.previousBeat}return null}chain(e=null){if(e!==null)if(this._noteIdBag!==null){let t;e.has(Ee.NoteIdLookupKey)?t=e.get(Ee.NoteIdLookupKey):(t=new Map,e.set(Ee.NoteIdLookupKey,t)),(this._noteIdBag.hammerPullDestinationNoteId!==-1||this._noteIdBag.tieDestinationNoteId!==-1||this._noteIdBag.slurDestinationNoteId!==-1)&&t.set(this.id,this),this._noteIdBag.hammerPullOriginNoteId!==-1&&(this.hammerPullOrigin=t.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),this._noteIdBag.tieOriginNoteId!==-1&&(this.tieOrigin=t.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),this._noteIdBag.slurOriginNoteId!==-1&&(this.slurOrigin=t.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),this._noteIdBag=null}else{if(!this.isTieDestination&&this.tieOrigin===null)return;let t=this.tieOrigin??Ee.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(e){this.tieDestination!==null&&e.set("tiedestinationnoteid",this.tieDestination.id),this.tieOrigin!==null&&e.set("tieoriginnoteid",this.tieOrigin.id),this.slurDestination!==null&&e.set("slurdestinationnoteid",this.slurDestination.id),this.slurOrigin!==null&&e.set("sluroriginnoteid",this.slurOrigin.id),this.hammerPullOrigin!==null&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),this.hammerPullDestination!==null&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new zi),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new zi),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new zi),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new zi),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new zi),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new zi),this._noteIdBag.hammerPullDestinationNoteId=t,!0}return!1}}Ee.GlobalNoteId=0,Ee.MaxOffsetForSameLineSearch=3,Ee.NoteIdLookupKey="NoteIdLookup";class et{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(e){if(this.beats.length===0)return this.beats.push(e),this.totalDuration+=e.playbackDuration,!0;if(e.graceType!==W.None)return!0;if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{let t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(let i of et.AllTicks)if(this.totalDuration===i*t){this.isFull=!0;break}}return!0}}et.HalfTicks=1920,et.QuarterTicks=960,et.EighthTicks=480,et.SixteenthTicks=240,et.ThirtySecondTicks=120,et.SixtyFourthTicks=60,et.OneHundredTwentyEighthTicks=30,et.TwoHundredFiftySixthTicks=15,et.AllTicks=[et.HalfTicks,et.QuarterTicks,et.EighthTicks,et.SixteenthTicks,et.ThirtySecondTicks,et.SixtyFourthTicks,et.OneHundredTwentyEighthTicks,et.TwoHundredFiftySixthTicks];var de;(function(n){n[n.None=0]="None",n[n.Custom=1]="Custom",n[n.Dive=2]="Dive",n[n.Dip=3]="Dip",n[n.Hold=4]="Hold",n[n.Predive=5]="Predive",n[n.PrediveDive=6]="PrediveDive"})(de||(de={}));class na{static clone(e){const t=new L;return t.offset=e.offset,t.value=e.value,t}}class oa{static clone(e){const t=new Ee;if(t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,e.bendPoints){t.bendPoints=[];for(const i of e.bendPoints)t.addBendPoint(na.clone(i))}return t.fret=e.fret,t.string=e.string,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.isFingering=e.isFingering,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t}}class On{static clone(e){const t=new st;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.ratioPosition=e.ratioPosition,t.text=e.text,t}}class ir{static clone(e){const t=new rt;t.index=e.index,t.notes=[];for(const i of e.notes)t.addNote(oa.clone(i));t.isEmpty=e.isEmpty,t.whammyStyle=e.whammyStyle,t.ottava=e.ottava,t.isLegatoOrigin=e.isLegatoOrigin,t.duration=e.duration,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.automations=[];for(const i of e.automations)t.automations.push(On.clone(i));if(t.dots=e.dots,t.fadeIn=e.fadeIn,t.lyrics=e.lyrics?e.lyrics.slice():null,t.hasRasgueado=e.hasRasgueado,t.pop=e.pop,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.isContinuedWhammy=e.isContinuedWhammy,t.whammyBarType=e.whammyBarType,e.whammyBarPoints){t.whammyBarPoints=[];for(const i of e.whammyBarPoints)t.addWhammyBarPoint(na.clone(i))}return t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.playbackStart=e.playbackStart,t.displayDuration=e.displayDuration,t.playbackDuration=e.playbackDuration,t.dynamics=e.dynamics,t.invertBeamDirection=e.invertBeamDirection,t.preferredBeamDirection=e.preferredBeamDirection,t.isEffectSlurOrigin=e.isEffectSlurOrigin,t.beamingMode=e.beamingMode,t}}class sr{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(e){e.graceIndex=this.beats.length,e.graceGroup=this,this.beats.push(e)}finish(){this.beats.length>0&&(this.id=this.beats[0].absoluteDisplayStart+"_"+this.beats[0].voice.index)}}var Wt;(function(n){n[n.Auto=0]="Auto",n[n.ForceSplitToNext=1]="ForceSplitToNext",n[n.ForceMergeWithNext=2]="ForceMergeWithNext"})(Wt||(Wt={}));class rt{constructor(){this.id=rt._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=me.Default,this.ottava=le.Regular,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=m.Quarter,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fadeIn=!1,this.lyrics=null,this.hasRasgueado=!1,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.brushType=Se.None,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=de.None,this.whammyBarPoints=null,this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=oe.None,this.chordId=null,this.graceType=W.None,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=je.None,this.tremoloSpeed=null,this.crescendo=mt.None,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.dynamics=j.F,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=Wt.Auto}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||this.notes.length===0}get isFullBarRest(){return this.isRest&&this.voice.beats.length===1&&this.duration===m.Whole}get hasTuplet(){return!(this.tupletDenominator===-1&&this.tupletNumerator===-1)&&!(this.tupletDenominator===1&&this.tupletNumerator===1)}get hasWhammyBar(){return this.whammyBarPoints!==null&&this.whammyBarType!==de.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}addWhammyBarPoint(e){let t=this.whammyBarPoints;t===null&&(t=[],this.whammyBarPoints=t),t.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===de.None&&(this.whammyBarType=de.Custom)}removeWhammyBarPoint(e){const t=this.whammyBarPoints;if(t===null||e<0||e>=t.length)return;t.splice(e,1);let i=t[e];if(i===this.maxWhammyPoint){this.maxWhammyPoint=null;for(let s of t)(!this.maxWhammyPoint||s.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=s)}if(i===this.minWhammyPoint){this.minWhammyPoint=null;for(let s of t)(!this.minWhammyPoint||s.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=s)}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){let t=this.notes.indexOf(e);t>=0&&(this.notes.splice(t,1),e.isStringed&&this.noteStringLookup.delete(e.string))}getAutomation(e){for(let t=0,i=this.automations.length;t<i;t++){let s=this.automations[t];if(s.type===e)return s}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}calculateDuration(){if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=q.toTicks(this.duration);return this.dots===2?e=q.applyDot(e,!0):this.dots===1&&(e=q.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=q.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){let e=this.calculateDuration();switch(this.playbackDuration=e,this.graceType){case W.BeforeBeat:case W.OnBeat:switch(this.duration){case m.Sixteenth:this.playbackDuration=q.toTicks(m.SixtyFourth);break;case m.ThirtySecond:this.playbackDuration=q.toTicks(m.OneHundredTwentyEighth);break;default:this.playbackDuration=q.toTicks(m.ThirtySecond);break}this.displayDuration=0;break;case W.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;let t=this.previousBeat;t&&t.graceType===W.BendGrace&&(this.playbackDuration=t.playbackDuration);break}}finishTuplet(){let e=this.previousBeat,t=e?e.tupletGroup:null;if((this.hasTuplet||this.graceType!==W.None&&t)&&((!e||!t||!t.check(this))&&(t=new et(this.voice),t.check(this)),this.tupletGroup=t),this.index>0){const i=this.voice.bar.masterBar.calculateDuration(),s=[];for(const r of this.automations)r.ratioPosition===0&&(r.ratioPosition=this.playbackStart/i),r.type!==Ge.Volume&&s.push(r);this.automations=s}}finish(e,t=null){switch(this.getAutomation(Ge.Instrument)===null&&this.index===0&&this.voice.index===0&&this.voice.bar.index===0&&this.voice.bar.staff.index===0&&this.automations.push(st.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case W.OnBeat:case W.BeforeBeat:let l=this.graceGroup.beats.length;l===1?this.duration=m.Eighth:l===2?this.duration=m.Sixteenth:this.duration=m.ThirtySecond;break}let i=e?e.notation.notationMode:Ye.GuitarPro,s=this.text==="grad"||this.text==="grad.";s&&i===Ye.SongBook&&(this.text="");let r=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let a=0,o=!1;for(let l=0,d=this.notes.length;l<d;l++){let c=this.notes[l];if(c.dynamics=this.dynamics,c.finish(e,t),c.isLetRing&&(this.isLetRing=!0),c.isPalmMute&&(this.isPalmMute=!0),i===Ye.SongBook&&c.hasBend&&this.graceType!==W.BendGrace){if(!c.isTieOrigin)switch(c.bendType){case M.Bend:case M.PrebendRelease:case M.PrebendBend:r=!0;break}s||c.bendStyle===me.Gradual?(s=!0,c.bendStyle=me.Gradual,r=!1):c.bendStyle=me.Fast}c.isVisible&&(a++,(!this.minNote||c.realValue<this.minNote.realValue)&&(this.minNote=c),(!this.maxNote||c.realValue>this.maxNote.realValue)&&(this.maxNote=c),(!this.minStringNote||c.string<this.minStringNote.string)&&(this.minStringNote=c),(!this.maxStringNote||c.string>this.maxStringNote.string)&&(this.maxStringNote=c),c.hasEffectSlur&&(o=!0))}if(o&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&a===0&&(this.isEmpty=!0),!this.isRest&&(!this.isLetRing||!this.isPalmMute)){let l=this.previousBeat;for(;l&&l.isRest;)this.isLetRing||(l.isLetRing=!1),this.isPalmMute||(l.isPalmMute=!1),l=l.previousBeat}else this.isRest&&this.previousBeat&&e&&e.notation.notationMode===Ye.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));const h=this.whammyBarPoints;if(h!==null&&h.length>0&&this.whammyBarType===de.Custom){i===Ye.SongBook&&(this.whammyStyle=s?me.Gradual:me.Fast);let l=!!this.previousBeat&&this.previousBeat.hasWhammyBar;if(this.isContinuedWhammy=l,h.length===4){let d=h[0],c=h[1],f=h[2],p=h[3];c.value===f.value&&(d.value<c.value&&c.value<p.value||d.value>c.value&&c.value>p.value?(d.value!==0&&!l?this.whammyBarType=de.PrediveDive:this.whammyBarType=de.Dive,h.splice(2,1),h.splice(1,1)):d.value>c.value&&c.value<p.value||d.value<c.value&&c.value>p.value?(this.whammyBarType=de.Dip,(c.offset===f.offset||i===Ye.SongBook)&&h.splice(2,1)):d.value===c.value&&c.value===p.value&&(d.value!==0&&!l?this.whammyBarType=de.Predive:this.whammyBarType=de.Hold,h.splice(2,1),h.splice(1,1)))}}if(this.updateDurations(),r){let l=ir.clone(this);l.id=rt._globalBeatId++,l.pickStroke=je.None;for(let d=0,c=l.notes.length;d<c;d++){let f=l.notes[d],p=this.notes[d];if(f.bendType=M.None,f.maxBendPoint=null,f.bendPoints=null,f.bendStyle=me.Default,f.id=Ee.GlobalNoteId++,p.isTieOrigin&&(f.tieDestination=p.tieDestination,p.tieDestination.tieOrigin=f),p.isTieDestination&&(f.tieOrigin=p.tieOrigin?p.tieOrigin:null,p.tieOrigin.tieDestination=f),p.hasBend&&p.isTieOrigin){let g=Ee.findTieOrigin(p);if(g&&g.hasBend){f.bendType=M.Hold;let b=p.bendPoints[p.bendPoints.length-1];f.addBendPoint(new L(0,b.value)),f.addBendPoint(new L(L.MaxPosition,b.value))}}f.isTieDestination=!0}this.graceType=W.BendGrace,this.graceGroup=new sr,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,l),l.graceGroup=new sr,l.graceGroup.addBeat(this),l.graceGroup.isComplete=!0,l.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(const t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}}rt._globalBeatId=0;class bi{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}var Xe;(function(n){n[n.Cb=-7]="Cb",n[n.Gb=-6]="Gb",n[n.Db=-5]="Db",n[n.Ab=-4]="Ab",n[n.Eb=-3]="Eb",n[n.Bb=-2]="Bb",n[n.F=-1]="F",n[n.C=0]="C",n[n.G=1]="G",n[n.D=2]="D",n[n.A=3]="A",n[n.E=4]="E",n[n.B=5]="B",n[n.FSharp=6]="FSharp",n[n.CSharp=7]="CSharp"})(Xe||(Xe={}));var ot;(function(n){n[n.IgnoreSpaces=0]="IgnoreSpaces",n[n.Begin=1]="Begin",n[n.Text=2]="Text",n[n.Comment=3]="Comment",n[n.Dash=4]="Dash"})(ot||(ot={}));class ze{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this.parse(this.text,0,this.chunks,e)}parse(e,t,i,s){if(!e)return;let r=ot.Begin,a=ot.Begin,o=!1,h=0;for(;t<e.length;){let l=e.charCodeAt(t);switch(r){case ot.IgnoreSpaces:switch(l){case ze.CharCodeLF:case ze.CharCodeCR:case ze.CharCodeTab:break;case ze.CharCodeSpace:if(!o){r=a;continue}break;default:o=!1,r=a;continue}break;case ot.Begin:switch(l){case ze.CharCodeBrackedOpen:r=ot.Comment;break;default:h=t,r=ot.Text;continue}break;case ot.Comment:switch(l){case ze.CharCodeBrackedClose:r=ot.Begin;break}break;case ot.Text:switch(l){case ze.CharCodeDash:r=ot.Dash;break;case ze.CharCodeCR:case ze.CharCodeLF:case ze.CharCodeSpace:let d=e.substr(h,t-h);this.addChunk(d,s),r=ot.IgnoreSpaces,a=ot.Begin;break}break;case ot.Dash:switch(l){case ze.CharCodeDash:break;default:let d=e.substr(h,t-h);this.addChunk(d,s),o=!0,r=ot.IgnoreSpaces,a=ot.Begin;continue}break}t+=1}r===ot.Text&&t!==h&&this.addChunk(e.substr(h,t-h),s)}addChunk(e,t){e=this.prepareChunk(e),(!t||e.length>0&&e!=="-")&&this.chunks.push(e)}prepareChunk(e){let t=e.split("+").join(" "),i=t.length;for(;i>0&&t.charAt(i-1)==="_";)i--;return i!==t.length?t.substr(0,i):t}}ze.CharCodeLF=10,ze.CharCodeTab=9,ze.CharCodeCR=13,ze.CharCodeSpace=32,ze.CharCodeBrackedClose=93,ze.CharCodeBrackedOpen=91,ze.CharCodeDash=45;var wi;(function(n){n[n.Major=0]="Major",n[n.Minor=1]="Minor"})(wi||(wi={}));var ee;(function(n){n[n.NoTripletFeel=0]="NoTripletFeel",n[n.Triplet16th=1]="Triplet16th",n[n.Triplet8th=2]="Triplet8th",n[n.Dotted16th=3]="Dotted16th",n[n.Dotted8th=4]="Dotted8th",n[n.Scottish16th=5]="Scottish16th",n[n.Scottish8th=6]="Scottish8th"})(ee||(ee={}));class li{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.keySignature=Xe.C,this.keySignatureType=wi.Major,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.tripletFeel=ee.NoTripletFeel,this.section=null,this.tempoAutomations=[],this.fermata=null,this.start=0,this.isAnacrusis=!1,this.displayScale=1,this.displayWidth=-1}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}calculateDuration(e=!0){if(this.isAnacrusis&&e){let t=0;for(let i of this.score.tracks)for(let s of i.staves){let r=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;r>t&&(t=r)}return t}return this.timeSignatureNumerator*q.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){let i=this.fermata;i===null&&(i=new Map,this.fermata=i),i.set(e,t)}getFermata(e){const t=this.fermata;return t===null?null:t.has(e.playbackStart)?t.get(e.playbackStart):null}}li.MaxAlternateEndings=8;class Vn{constructor(){this.hideDynamics=!1}}class ha{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){const e=this.opening;return e?[e]:[]}get isOpened(){var e;return((e=this.opening)==null?void 0:e.isRepeatStart)===!0}addMasterBar(e){this.opening===null&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}}class Li{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.tempo=120,this.tempoLabel="",this.masterBars=[],this.tracks=[],this.defaultSystemsLayout=3,this.systemsLayout=[],this.stylesheet=new Vn}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(const e of this.masterBars)this.addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,this.masterBars.length!==0&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],e.previousMasterBar.nextMasterBar=e,e.start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this.addMasterBarToRepeatGroups(e),this.masterBars.push(e)}addMasterBarToRepeatGroups(e){var t;e.isRepeatStart?((t=this._currentRepeatGroup)!=null&&t.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new ha,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new ha,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(e){const t=new Map;for(let i=0,s=this.tracks.length;i<s;i++)this.tracks[i].finish(e,t)}}class xs{constructor(){this.marker="",this.text=""}}class Ue extends nt{constructor(e){super(at.Format,e),Object.setPrototypeOf(this,Ue.prototype)}}class fe{constructor(e,t,i,s=255){this.raw=0,this.raw=(s&255)<<24|(e&255)<<16|(t&255)<<8|i&255,this.updateRgba()}updateRgba(){this.a===255?this.rgba="#"+Be.toHexString(this.r,2)+Be.toHexString(this.g,2)+Be.toHexString(this.b,2):this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return this.raw&255}static random(e=100){return new fe(Math.random()*255|0,Math.random()*255|0,Math.random()*255|0,e)}static fromJson(e){if(e instanceof fe)return e;switch(typeof e){case"number":{const t=new fe(0,0,0,0);return t.raw=e,t.updateRgba(),t}case"string":{const t=e;if(t.startsWith("#")){if(t.length===4)return new fe(parseInt(t[1],16)*17,parseInt(t[2],16)*17,parseInt(t[3],16)*17);if(t.length===5)return new fe(parseInt(t[1],16)*17,parseInt(t[2],16)*17,parseInt(t[3],16)*17,parseInt(t[4],16)*17);if(t.length===7)return new fe(parseInt(t.substring(1,3),16),parseInt(t.substring(3,5),16),parseInt(t.substring(5,7),16));if(t.length===9)return new fe(parseInt(t.substring(1,3),16),parseInt(t.substring(3,5),16),parseInt(t.substring(5,7),16),parseInt(t.substring(7,9),16))}else if(t.startsWith("rgba")||t.startsWith("rgb")){const i=t.indexOf("("),s=t.lastIndexOf(")");if(i===-1||s===-1)throw new Ue("No values specified for rgb/rgba function");const r=t.substring(i+1,s).split(",");if(r.length===3)return new fe(parseInt(r[0]),parseInt(r[1]),parseInt(r[2]));if(r.length===4)return new fe(parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),parseFloat(r[3])*255)}return null}}throw new Ue("Unsupported format for color")}static toJson(e){return e.raw}}fe.BlackRgb="#000000";class la{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}}class x{static getTextForTuning(e,t){let i=x.getTextPartsForTuning(e);return t?i.join(""):i[0]}static getTextPartsForTuning(e,t=-1){let i=e/12|0,s=e%12;return[["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"][s],(i+t).toString()]}static getDefaultTuningFor(e){return x._defaultTunings.has(e)?x._defaultTunings.get(e):null}static getPresetsFor(e){switch(e){case 7:return x._sevenStrings;case 6:return x._sixStrings;case 5:return x._fiveStrings;case 4:return x._fourStrings}return[]}static initialize(){x._defaultTunings.set(7,new x("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),x._sevenStrings.push(x._defaultTunings.get(7)),x._defaultTunings.set(6,new x("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),x._sixStrings.push(x._defaultTunings.get(6)),x._sixStrings.push(new x("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),x._sixStrings.push(new x("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),x._sixStrings.push(new x("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),x._sixStrings.push(new x("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),x._sixStrings.push(new x("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),x._sixStrings.push(new x("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),x._sixStrings.push(new x("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),x._sixStrings.push(new x("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),x._sixStrings.push(new x("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),x._sixStrings.push(new x("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),x._sixStrings.push(new x("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),x._sixStrings.push(new x("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),x._sixStrings.push(new x("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),x._sixStrings.push(new x("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),x._sixStrings.push(new x("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),x._sixStrings.push(new x("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),x._sixStrings.push(new x("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),x._sixStrings.push(new x("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),x._sixStrings.push(new x("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),x._sixStrings.push(new x("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),x._sixStrings.push(new x("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),x._sixStrings.push(new x("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),x._sixStrings.push(new x("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),x._sixStrings.push(new x("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),x._sixStrings.push(new x("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),x._sixStrings.push(new x("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),x._sixStrings.push(new x("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),x._sixStrings.push(new x("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),x._sixStrings.push(new x("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),x._sixStrings.push(new x("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),x._defaultTunings.set(5,new x("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),x._fiveStrings.push(x._defaultTunings.get(5)),x._fiveStrings.push(new x("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),x._fiveStrings.push(new x("Banjo Open D Tuning",[62,57,54,50,69],!1)),x._fiveStrings.push(new x("Banjo Open G Tuning",[62,59,55,50,67],!1)),x._fiveStrings.push(new x("Banjo G Minor Tuning",[62,58,55,50,67],!1)),x._fiveStrings.push(new x("Banjo G Modal Tuning",[62,57,55,50,67],!1)),x._defaultTunings.set(4,new x("Bass Standard Tuning",[43,38,33,28],!0)),x._fourStrings.push(x._defaultTunings.get(4)),x._fourStrings.push(new x("Bass Tune down ½ step",[42,37,32,27],!1)),x._fourStrings.push(new x("Bass Tune down 1 step",[41,36,31,26],!1)),x._fourStrings.push(new x("Bass Tune down 2 step",[39,34,29,24],!1)),x._fourStrings.push(new x("Bass Dropped D Tuning",[43,38,33,26],!1)),x._fourStrings.push(new x("Ukulele C Tuning",[45,40,36,43],!1)),x._fourStrings.push(new x("Ukulele G Tuning",[52,47,43,38],!1)),x._fourStrings.push(new x("Mandolin Standard Tuning",[64,57,50,43],!1)),x._fourStrings.push(new x("Mandolin or Violin Tuning",[76,69,62,55],!1)),x._fourStrings.push(new x("Viola Tuning",[69,62,55,48],!1)),x._fourStrings.push(new x("Cello Tuning",[57,50,43,36],!1))}static findTuning(e){let t=x.getPresetsFor(e.length);for(let i=0,s=t.length;i<s;i++){let r=t[i],a=!0;for(let o=0,h=e.length;o<h;o++)if(e[o]!==r.tunings[o]){a=!1;break}if(a)return r}return null}constructor(e="",t=null,i=!1){this.isStandard=i,this.name=e,this.tunings=t??[]}finish(){const e=x.findTuning(this.tunings);e&&(this.name=e.name,this.isStandard=e.isStandard),this.name=this.name.trim()}}x._sevenStrings=[],x._sixStrings=[],x._fiveStrings=[],x._fourStrings=[],x._defaultTunings=new Map,x.defaultAccidentals=["","#","","#","","","#","","#","","#",""],x.defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"],x.initialize();class da{constructor(){this.index=0,this.bars=[],this.chords=null,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new x("",[],!1),this.showSlash=!1,this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=5}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}finish(e,t=null){this.stringTuning.finish();for(let i=0,s=this.bars.length;i<s;i++)this.bars[i].finish(e,t)}addChord(e,t){t.staff=this;let i=this.chords;i===null&&(i=new Map,this.chords=i),i.set(e,t)}hasChord(e){var t;return((t=this.chords)==null?void 0:t.has(e))??!1}getChord(e){var t;return((t=this.chords)==null?void 0:t.get(e))??null}addBar(e){let t=this.bars;e.staff=this,e.index=t.length,t.length>0&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}class Jt{constructor(){this.index=0,this.staves=[],this.playbackInfo=new la,this.color=new fe(200,0,0,255),this.name="",this.isVisibleOnMultiTrack=!0,this.shortName="",this.defaultSystemsLayout=3,this.systemsLayout=[],this.percussionArticulations=[]}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new da)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}finish(e,t=null){this.shortName||(this.shortName=this.name,this.shortName.length>Jt.ShortNameMaxLength&&(this.shortName=this.shortName.substr(0,Jt.ShortNameMaxLength)));for(let i=0,s=this.staves.length;i<s;i++)this.staves[i].finish(e,t)}applyLyrics(e){for(let i of e)i.finish();let t=this.staves[0];for(let i=0;i<e.length;i++){let s=e[i];if(s.startBar>=0&&s.startBar<t.bars.length){let r=t.bars[s.startBar].voices[0].beats[0];for(let a=0;a<s.chunks.length&&r;a++){for(;r&&(r.isEmpty||r.isRest);)r=r.nextBeat;r&&(r.lyrics||(r.lyrics=new Array(e.length),r.lyrics.fill("")),r.lyrics[i]=s.chunks[a],r=r.nextBeat)}}}}}Jt.ShortNameMaxLength=10;let Qt=class Mn{constructor(){this.id=Mn._globalBarId++,this.index=0,this.beats=[],this.isEmpty=!0}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this.isEmpty=!1)}chain(e,t=null){if(this.bar){if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){let i=this.bar.nextBar.voices[this.index];i.beats.length>0&&(e.nextBeat=i.beats[0]),e.nextBeat.previousBeat=e}e.chain(t)}}addGraceBeat(e){if(this.beats.length===0){this.addBeat(e);return}let t=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this.isEmpty=!1}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e,t=null){this._beatLookup=new Map;let i=null;for(let a=0;a<this.beats.length;a++){let o=this.beats[a];o.index=a,this.chain(o,t),o.graceType===W.None?(o.graceGroup=i,i&&(i.isComplete=!0),i=null):(i||(i=new sr),i.addBeat(o))}let s=0,r=0;for(let a=0;a<this.beats.length;a++){let o=this.beats[a];if(o.index=a,o.finish(e,t),o.graceType===W.None){if(o.graceGroup){const h=o.graceGroup.beats[0],l=o.graceGroup.beats[o.graceGroup.beats.length-1];if(h.graceType!==W.BendGrace){let d=l.playbackStart+l.playbackDuration-h.playbackStart;switch(h.graceType){case W.BeforeBeat:h.previousBeat?(h.previousBeat.playbackDuration-=d,h.previousBeat.voice==this?r=h.previousBeat.playbackStart+h.previousBeat.playbackDuration:r=-d):r=-d;for(const c of o.graceGroup.beats)this._beatLookup.delete(c.playbackStart),c.playbackStart=r,this._beatLookup.set(c.playbackStart,o),r+=c.playbackDuration;break;case W.OnBeat:o.playbackDuration-=d,l.voice===this?r=l.playbackStart+l.playbackDuration:r=-d;break}}}o.displayStart=s,o.playbackStart=r,o.fermata?this.bar.masterBar.addFermata(o.playbackStart,o.fermata):o.fermata=this.bar.masterBar.getFermata(o),this._beatLookup.set(o.playbackStart,o)}else o.displayStart=s,o.playbackStart=r;o.finishTuplet(),o.graceGroup&&o.graceGroup.finish(),s+=o.displayDuration,r+=o.playbackDuration}}calculateDuration(){if(this.isEmpty||this.beats.length===0)return 0;let e=this.beats[this.beats.length-1],t=this.beats[0];return e.playbackStart+e.playbackDuration-t.playbackStart}};Qt._globalBarId=0;class Z{static float64ToBytes(e){return Z._dataView.setFloat64(0,e,!0),this._conversionByteArray}static bytesToFloat64(e){throw Z._conversionByteArray.set(e,0),Z._dataView.getFloat64(0,!0)}static uint16ToInt16(e){return Z._dataView.setUint16(0,e,!0),Z._dataView.getInt16(0,!0)}static int16ToUint32(e){return Z._dataView.setInt16(0,e,!0),Z._dataView.getUint32(0,!0)}static int32ToUint16(e){return Z._dataView.setInt32(0,e,!0),Z._dataView.getUint16(0,!0)}static int32ToInt16(e){return Z._dataView.setInt32(0,e,!0),Z._dataView.getInt16(0,!0)}static int32ToUint32(e){return Z._dataView.setInt32(0,e,!0),Z._dataView.getUint32(0,!0)}static uint8ToInt8(e){return Z._dataView.setUint8(0,e),Z._dataView.getInt8(0)}}Z._conversionBuffer=new ArrayBuffer(8),Z._conversionByteArray=new Uint8Array(Z._conversionBuffer),Z._dataView=new DataView(Z._conversionBuffer);class S{static readInt32BE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte(),r=e.readByte();return t<<24|i<<16|s<<8|r}static readInt32LE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte();return e.readByte()<<24|s<<16|i<<8|t}static readUInt32LE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte();return e.readByte()<<24|s<<16|i<<8|t}static decodeUInt32LE(e,t){let i=e[t],s=e[t+1],r=e[t+2];return e[t+3]<<24|r<<16|s<<8|i}static readUInt16LE(e){let t=e.readByte(),i=e.readByte();return Z.int32ToUint16(i<<8|t)}static readInt16LE(e){let t=e.readByte(),i=e.readByte();return Z.int32ToInt16(i<<8|t)}static readUInt32BE(e){let t=e.readByte(),i=e.readByte(),s=e.readByte(),r=e.readByte();return Z.int32ToUint32(t<<24|i<<16|s<<8|r)}static readUInt16BE(e){let t=e.readByte(),i=e.readByte();return Z.int32ToInt16(t<<8|i)}static readInt16BE(e){let t=e.readByte(),i=e.readByte();return Z.int32ToInt16(t<<8|i)}static readByteArray(e,t){let i=new Uint8Array(t);return e.read(i,0,t),i}static read8BitChars(e,t){let i=new Uint8Array(t);return e.read(i,0,i.length),S.toString(i,"utf-8")}static read8BitString(e){let t="",i=e.readByte();for(;i!==0;)t+=String.fromCharCode(i),i=e.readByte();return t}static read8BitStringLength(e,t){let i="",s=-1;for(let a=0;a<t;a++){let o=e.readByte();o===0&&s===-1&&(s=a),i+=String.fromCharCode(o)}let r=i;return s>=0?r.substr(0,s):r}static readSInt8(e){let t=e.readByte();return((t&255)>>7)*-256+(t&255)}static readInt24(e,t){let i=e[t]|e[t+1]<<8|e[t+2]<<16;return(i&8388608)===8388608&&(i=i|255<<24),i}static readInt16(e,t){return Z.int32ToInt16(e[t]|e[t+1]<<8)}static toString(e,t){let i=S.detectEncoding(e);return i&&(t=i),t||(t="utf-8"),new TextDecoder(t).decode(e.buffer)}static detectEncoding(e){return e.length>2&&e[0]===254&&e[1]===255?"utf-16be":e.length>2&&e[0]===255&&e[1]===254?"utf-16le":e.length>4&&e[0]===0&&e[1]===0&&e[2]===254&&e[3]===255?"utf-32be":e.length>4&&e[0]===255&&e[1]===254&&e[2]===0&&e[3]===0?"utf-32le":null}static stringToBytes(e){return new TextEncoder().encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(t>>0&255)}static writeInt32LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16BE(e,t){e.writeByte(t>>8&255),e.writeByte(t>>0&255)}}class Ke{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return Ke.withCapacity(0)}static withCapacity(e){let t=new Ke;return t._buffer=new Uint8Array(e),t}static fromBuffer(e){let t=new Ke;return t._buffer=e,t.length=e.length,t}static fromString(e){let t=S.stringToBytes(e);return Ke.fromBuffer(t)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,i){let s=this.length-this.position;return s>i&&(s=i),s<=0?0:(e.set(this._buffer.subarray(this.position,this.position+s),t),this.position+=s,s)}writeByte(e){let t=this.position+1;this.ensureCapacity(t),this._buffer[this.position]=e&255,t>this.length&&(this.length=t),this.position=t}write(e,t,i){let s=this.position+i;this.ensureCapacity(s);let r=Math.min(i,e.length-t);this._buffer.set(e.subarray(t,t+r),this.position),s>this.length&&(this.length=s),this.position=s}ensureCapacity(e){if(e>this._buffer.length){let t=e;t<256&&(t=256),t<this._buffer.length*2&&(t=this._buffer.length*2);let i=new Uint8Array(t);this.length>0&&i.set(this._buffer.subarray(0,0+this.length),0),this._buffer=i}}readAll(){return this.toArray()}toArray(){let e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}copyTo(e){e.write(this._buffer,0,this.length)}}var y;(function(n){n[n.No=0]="No",n[n.Eof=1]="Eof",n[n.Number=2]="Number",n[n.DoubleDot=3]="DoubleDot",n[n.Dot=4]="Dot",n[n.String=5]="String",n[n.Tuning=6]="Tuning",n[n.LParensis=7]="LParensis",n[n.RParensis=8]="RParensis",n[n.LBrace=9]="LBrace",n[n.RBrace=10]="RBrace",n[n.Pipe=11]="Pipe",n[n.MetaCommand=12]="MetaCommand",n[n.Multiply=13]="Multiply",n[n.LowerThan=14]="LowerThan"})(y||(y={}));class vi extends nt{constructor(e,t,i,s,r,a,o,h=null){super(at.AlphaTex,e),this.position=t,this.line=i,this.col=s,this.nonTerm=r??"",this.expected=a??y.No,this.symbol=o??y.No,this.symbolData=h,Object.setPrototypeOf(this,vi.prototype)}static symbolError(e,t,i,s,r,a,o=null){let h=`MalFormed AlphaTex: @${e} (line ${t}, col ${i}): Error on block ${s}`;return r!==a?(h+=`, expected a ${y[r]} found a ${y[a]}`,o!==null&&(h+=`: '${o}'`)):h+=`, invalid value: '${o}'`,new vi(h,e,t,i,s,r,a,o)}static errorMessage(e,t,i,s){return e=`MalFormed AlphaTex: @${t} (line ${i}, col ${s}): ${e}`,new vi(e,t,i,s,null,null,null,null)}}class ht extends Gi{constructor(){super(),this._trackChannel=0,this._input="",this._ch=ht.Eof,this._curChPos=0,this._line=1,this._col=0,this._lastValidSpot=[0,1,0],this._sy=y.No,this._syData="",this._allowNegatives=!1,this._allowFloat=!1,this._allowTuning=!1,this._currentDuration=m.QuadrupleWhole,this._currentDynamics=j.PPP,this._currentTuplet=0,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._percussionArticulationNames=new Map,this.logErrors=!1}get name(){return"AlphaTex"}initFromString(e,t){this.data=Ke.empty(),this._input=e,this.settings=t}readScore(){try{if(this.data.length>0&&(this._input=S.toString(this.data.readAll(),this.settings.importer.encoding)),this._allowTuning=!0,this._lyrics=new Map,this.createDefaultScore(),this._curChPos=0,this._line=1,this._col=0,this.saveValidSpot(),this._currentDuration=m.Quarter,this._currentDynamics=j.F,this._currentTuplet=1,this._ch=this.nextChar(),this._sy=this.newSy(),this._sy===y.LowerThan)throw new xe("Unknown start sign '<' (meant to import as XML?)");if(this._sy===y.Eof)throw new xe("Unexpected end of file");const e=this.metaData(),t=this.bars();if(!e&&!t)throw new xe("No alphaTex data found");this.consolidate(),this._score.finish(this.settings),this._score.rebuildRepeatGroups();for(const[i,s]of this._lyrics)this._score.tracks[i].applyLyrics(s);return this._score}catch(e){throw e instanceof vi?new xe(e.message,e):e}}consolidate(){for(let e of this._score.tracks)for(let t of e.staves)for(;t.bars.length<this._score.masterBars.length;){let i=this.newBar(t),s=new rt;s.isEmpty=!0,i.voices[0].addBeat(s)}}error(e,t,i=!0){let s,r=!1;i?(s=this._sy,(s===y.String||s===y.Number||s===y.MetaCommand)&&(r=!0)):s=t;let a=vi.symbolError(this._lastValidSpot[0],this._lastValidSpot[1],this._lastValidSpot[2],e,t,s,r?this._syData:null);throw this.logErrors&&_.error(this.name,a.message),a}errorMessage(e){let t=vi.errorMessage(e,this._lastValidSpot[0],this._lastValidSpot[1],this._lastValidSpot[2]);throw this.logErrors&&_.error(this.name,t.message),t}createDefaultScore(){this._score=new Li,this._score.tempo=120,this._score.tempoLabel="",this.newTrack()}newTrack(){this._currentTrack=new Jt,this._currentTrack.ensureStaveCount(1),this._currentTrack.playbackInfo.program=25,this._currentTrack.playbackInfo.primaryChannel=this._trackChannel++,this._currentTrack.playbackInfo.secondaryChannel=this._trackChannel++,this._currentStaff=this._currentTrack.staves[0],this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=x.getDefaultTuningFor(6).tunings,this._score.addTrack(this._currentTrack),this._lyrics.set(this._currentTrack.index,[]),this._currentDynamics=j.F}parseClefFromString(e){switch(e.toLowerCase()){case"g2":case"treble":return U.G2;case"f4":case"bass":return U.F4;case"c3":case"tenor":return U.C3;case"c4":case"alto":return U.C4;case"n":case"neutral":return U.Neutral;default:return U.G2}}parseClefFromInt(e){switch(e){case 43:return U.G2;case 65:return U.F4;case 48:return U.C3;case 60:return U.C4;default:return U.G2}}parseTripletFeelFromString(e){switch(e.toLowerCase()){case"no":case"none":return ee.NoTripletFeel;case"t16":case"triplet-16th":return ee.Triplet16th;case"t8":case"triplet-8th":return ee.Triplet8th;case"d16":case"dotted-16th":return ee.Dotted16th;case"d8":case"dotted-8th":return ee.Dotted8th;case"s16":case"scottish-16th":return ee.Scottish16th;case"s8":case"scottish-8th":return ee.Scottish8th;default:return ee.NoTripletFeel}}parseTripletFeelFromInt(e){switch(e){case 0:return ee.NoTripletFeel;case 1:return ee.Triplet16th;case 2:return ee.Triplet8th;case 3:return ee.Dotted16th;case 4:return ee.Dotted8th;case 5:return ee.Scottish16th;case 6:return ee.Scottish8th;default:return ee.NoTripletFeel}}parseKeySignature(e){switch(e.toLowerCase()){case"cb":case"cbmajor":return Xe.Cb;case"gb":case"gbmajor":case"d#minor":return Xe.Gb;case"db":case"dbmajor":case"bbminor":return Xe.Db;case"ab":case"abmajor":case"fminor":return Xe.Ab;case"eb":case"ebmajor":case"cminor":return Xe.Eb;case"bb":case"bbmajor":case"gminor":return Xe.Bb;case"f":case"fmajor":case"dminor":return Xe.F;case"c":case"cmajor":case"aminor":return Xe.C;case"g":case"gmajor":case"eminor":return Xe.G;case"d":case"dmajor":case"bminor":return Xe.D;case"a":case"amajor":case"f#minor":return Xe.A;case"e":case"emajor":case"c#minor":return Xe.E;case"b":case"bmajor":case"g#minor":return Xe.B;case"f#":case"f#major":case"ebminor":return Xe.FSharp;case"c#":case"c#major":return Xe.CSharp;default:return Xe.C}}nextChar(){return this._curChPos<this._input.length?(this._ch=this._input.charCodeAt(this._curChPos++),this._ch===10?(this._line++,this._col=0):this._col++):this._ch=ht.Eof,this._ch}saveValidSpot(){this._lastValidSpot=[this._curChPos,this._line,this._col]}newSy(){for(this.saveValidSpot(),this._sy=y.No;this._sy===y.No;)if(this._ch===ht.Eof)this._sy=y.Eof;else if(ht.isWhiteSpace(this._ch))this._ch=this.nextChar(),this.saveValidSpot();else if(this._ch===47){if(this._ch=this.nextChar(),this._ch===47)for(;this._ch!==13&&this._ch!==10&&this._ch!==ht.Eof;)this._ch=this.nextChar();else if(this._ch===42)for(;this._ch!==ht.Eof;)if(this._ch===42){if(this._ch=this.nextChar(),this._ch===47){this._ch=this.nextChar();break}}else this._ch=this.nextChar();else this.error("comment",y.String,!1);this.saveValidSpot()}else if(this._ch===34||this._ch===39){let e=this._ch;this._ch=this.nextChar();let t="";for(this._sy=y.String;this._ch!==e&&this._ch!==ht.Eof;)t+=String.fromCharCode(this._ch),this._ch=this.nextChar();this._ch===ht.Eof&&this.errorMessage("String opened but never closed"),this._syData=t,this._ch=this.nextChar()}else if(this._ch===45)this._allowNegatives?(this._sy=y.Number,this._syData=this.readNumber()):(this._sy=y.String,this._syData=this.readName());else if(this._ch===46)this._sy=y.Dot,this._ch=this.nextChar();else if(this._ch===58)this._sy=y.DoubleDot,this._ch=this.nextChar();else if(this._ch===40)this._sy=y.LParensis,this._ch=this.nextChar();else if(this._ch===92)this._ch=this.nextChar(),this._sy=y.MetaCommand,this._syData=this.readName();else if(this._ch===41)this._sy=y.RParensis,this._ch=this.nextChar();else if(this._ch===123)this._sy=y.LBrace,this._ch=this.nextChar();else if(this._ch===125)this._sy=y.RBrace,this._ch=this.nextChar();else if(this._ch===124)this._sy=y.Pipe,this._ch=this.nextChar();else if(this._ch===42)this._sy=y.Multiply,this._ch=this.nextChar();else if(this._ch===60)this._sy=y.LowerThan,this._ch=this.nextChar();else if(this.isDigit(this._ch))this._sy=y.Number,this._syData=this.readNumber();else if(ht.isNameLetter(this._ch)){let e=this.readName(),t=this._allowTuning?Be.parseTuning(e):null;t?(this._sy=y.Tuning,this._syData=t):(this._sy=y.String,this._syData=e)}else this.error("symbol",y.String,!1);return this._sy}static isNameLetter(e){return!ht.isTerminal(e)&&(33<=e&&e<=47||58<=e&&e<=126||128<=e)}static isTerminal(e){return e===46||e===123||e===125||e===91||e===93||e===40||e===41||e===124||e===39||e===34||e===92}static isWhiteSpace(e){return e===9||e===10||e===11||e===13||e===32}isDigit(e){return e>=48&&e<=57||this._allowNegatives&&e===45||this._allowFloat&&e===46}readName(){let e="";do e+=String.fromCharCode(this._ch),this._ch=this.nextChar();while(ht.isNameLetter(this._ch)||this.isDigit(this._ch));return e}readNumber(){let e="";do e+=String.fromCharCode(this._ch),this._ch=this.nextChar();while(this.isDigit(this._ch));return this._allowFloat?parseFloat(e):parseInt(e)}metaData(){let e=!1,t=!0;for(;this._sy===y.MetaCommand&&t;){let i=this._syData.toLowerCase();switch(i){case"title":case"subtitle":case"artist":case"album":case"words":case"music":case"copyright":this._sy=this.newSy(),this._sy!==y.String&&this.error(i,y.String,!0);let s=this._syData;switch(i){case"title":this._score.title=s;break;case"subtitle":this._score.subTitle=s;break;case"artist":this._score.artist=s;break;case"album":this._score.album=s;break;case"words":this._score.words=s;break;case"music":this._score.music=s;break;case"copyright":this._score.copyright=s;break}this._sy=this.newSy(),e=!0;break;case"tempo":this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy===y.Number?this._score.tempo=this._syData:this.error("tempo",y.Number,!0),this._sy=this.newSy(),e=!0;break;default:this.handleStaffMeta()?e=!0:e?this.error("metaDataTags",y.String,!1):t=!1;break}}return e?(this._sy!==y.Dot&&this.error("song",y.Dot,!0),this._sy=this.newSy()):this._sy===y.Dot&&(this._sy=this.newSy()),e}handleStaffMeta(){var e;switch(this._syData.toLowerCase()){case"capo":return this._sy=this.newSy(),this._sy===y.Number?this._currentStaff.capo=this._syData:this.error("capo",y.Number,!0),this._sy=this.newSy(),!0;case"tuning":this._sy=this.newSy();let t=this._currentStaff.tuning.length;switch(this._staffHasExplicitTuning=!0,this._staffTuningApplied=!1,this._sy){case y.String:let o=this._syData.toLowerCase();o==="piano"||o==="none"||o==="voice"?(this._currentStaff.stringTuning.tunings=[],this._currentStaff.displayTranspositionPitch=0):this.error("tuning",y.Tuning,!0),this._sy=this.newSy();break;case y.Tuning:let h=[];do{let l=this._syData;h.push(l.realValue),this._sy=this.newSy()}while(this._sy===y.Tuning);this._currentStaff.stringTuning.tunings=h;break;default:this.error("tuning",y.Tuning,!0);break}return t!==this._currentStaff.tuning.length&&(((e=this._currentStaff.chords)==null?void 0:e.size)??0)>0&&this.errorMessage("Tuning must be defined before any chord"),!0;case"instrument":if(this._sy=this.newSy(),this._staffTuningApplied=!1,this._sy===y.Number){let o=this._syData;o>=0&&o<=127?this._currentTrack.playbackInfo.program=this._syData:this.error("instrument",y.Number,!1)}else if(this._sy===y.String){let o=this._syData.toLowerCase();if(o==="percussion"){for(const h of this._currentTrack.staves)this.applyPercussionStaff(h);this._currentTrack.playbackInfo.primaryChannel=9,this._currentTrack.playbackInfo.secondaryChannel=9}else this._currentTrack.playbackInfo.program=ni.getValue(o)}else this.error("instrument",y.Number,!0);return this._sy=this.newSy(),!0;case"lyrics":this._sy=this.newSy();let i=new ze;return i.startBar=0,i.text="",this._sy===y.Number&&(i.startBar=this._syData,this._sy=this.newSy()),this._sy===y.String?(i.text=this._syData,this._sy=this.newSy()):this.error("lyrics",y.String,!0),this._lyrics.get(this._currentTrack.index).push(i),!0;case"chord":this._sy=this.newSy();let s=new bi;this.chordProperties(s),this._sy===y.String?(s.name=this._syData,this._sy=this.newSy()):this.error("chord-name",y.String,!0);for(let o=0;o<this._currentStaff.tuning.length;o++)this._sy===y.Number?s.strings.push(this._syData):this._sy===y.String&&this._syData.toLowerCase()==="x"&&s.strings.push(-1),this._sy=this.newSy();return this._currentStaff.addChord(this.getChordId(this._currentStaff,s.name),s),!0;case"articulation":this._sy=this.newSy();let r="";if(this._sy===y.String?(r=this._syData,this._sy=this.newSy()):this.error("articulation-name",y.String,!0),r==="defaults"){for(const[o,h]of Ae.instrumentArticulationNames)this._percussionArticulationNames.set(o.toLowerCase(),h),this._percussionArticulationNames.set(ht.toArticulationId(o),h);return!0}let a=0;return this._sy===y.Number?(a=this._syData,this._sy=this.newSy()):this.error("articulation-number",y.Number,!0),Ae.instrumentArticulations.has(a)||this.errorMessage(`Unknown articulation ${a}. Refer to https://www.alphatab.net/docs/alphatex/percussion for available ids`),this._percussionArticulationNames.set(r.toLowerCase(),a),!0;default:return!1}}static toArticulationId(e){return e.replace(new RegExp("[^a-zA-Z0-9]","g"),"").toLowerCase()}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1}chordProperties(e){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;)switch(this._syData.toLowerCase()){case"firstfret":switch(this._sy=this.newSy(),this._sy){case y.Number:e.firstFret=this._syData;break;default:this.error("chord-firstfret",y.Number,!0);break}this._sy=this.newSy();break;case"showdiagram":switch(this._sy=this.newSy(),this._sy){case y.String:e.showDiagram=this._syData.toLowerCase()!=="false";break;case y.Number:e.showDiagram=this._syData!==0;break;default:this.error("chord-showdiagram",y.String,!0);break}this._sy=this.newSy();break;case"showfingering":switch(this._sy=this.newSy(),this._sy){case y.String:e.showDiagram=this._syData.toLowerCase()!=="false";break;case y.Number:e.showFingering=this._syData!==0;break;default:this.error("chord-showfingering",y.String,!0);break}this._sy=this.newSy();break;case"showname":switch(this._sy=this.newSy(),this._sy){case y.String:e.showName=this._syData.toLowerCase()!=="false";break;case y.Number:e.showName=this._syData!==0;break;default:this.error("chord-showname",y.String,!0);break}this._sy=this.newSy();break;case"barre":for(this._sy=this.newSy();this._sy===y.Number;)e.barreFrets.push(this._syData),this._sy=this.newSy();break;default:this.error("chord-properties",y.String,!1);break}this._sy!==y.RBrace&&this.error("chord-properties",y.RBrace,!0),this._sy=this.newSy()}}bars(){let e=this.bar();for(;this._sy!==y.Eof;)if(this._sy===y.Pipe)this._sy=this.newSy(),this.bar();else if(this._sy===y.MetaCommand)this.bar();else break;return e}trackStaffMeta(){if(this._sy!==y.MetaCommand)return!1;if(this._syData.toLowerCase()==="track"&&(this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),this._score.masterBars.length>0&&this.newTrack(),this._sy===y.String&&(this._currentTrack.name=this._syData,this._sy=this.newSy()),this._sy===y.String&&(this._currentTrack.shortName=this._syData,this._sy=this.newSy())),this._sy===y.MetaCommand&&this._syData.toLowerCase()==="staff"){if(this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),this._currentTrack.staves[0].bars.length>0){this._currentTrack.ensureStaveCount(this._currentTrack.staves.length+1);const e=this._currentStaff.isPercussion;this._currentStaff=this._currentTrack.staves[this._currentTrack.staves.length-1],e&&this.applyPercussionStaff(this._currentStaff),this._currentDynamics=j.F}this.staffProperties()}return!0}staffProperties(){if(this._sy!==y.LBrace)return;this._sy=this.newSy();let e=!1,t=!1,i=!1;for(;this._sy===y.String;)switch(this._syData.toLowerCase()){case"score":e=!0,this._sy=this.newSy();break;case"tabs":t=!0,this._sy=this.newSy();break;case"slash":i=!0,this._sy=this.newSy();break;default:this.error("staff-properties",y.String,!1);break}(e||t||i)&&(this._currentStaff.showStandardNotation=e,this._currentStaff.showTablature=t,this._currentStaff.showSlash=i),this._sy!==y.RBrace&&this.error("staff-properties",y.RBrace,!0),this._sy=this.newSy()}bar(){const e=this.trackStaffMeta();let t=this.newBar(this._currentStaff);if(this._currentStaff.bars.length>this._score.masterBars.length){let a=new li;this._score.addMasterBar(a),a.index>0&&(a.keySignature=a.previousMasterBar.keySignature,a.keySignatureType=a.previousMasterBar.keySignatureType,a.timeSignatureDenominator=a.previousMasterBar.timeSignatureDenominator,a.timeSignatureNumerator=a.previousMasterBar.timeSignatureNumerator,a.tripletFeel=a.previousMasterBar.tripletFeel)}const i=this.barMeta(t);if(!this._staffTuningApplied&&!this._staffHasExplicitTuning){const a=this._currentTrack.playbackInfo.program;this._currentStaff.displayTranspositionPitch=0,this._currentStaff.stringTuning.tunings=[],a==15||a>=24&&a<=31?(this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=x.getDefaultTuningFor(6).tunings):a>=32&&a<=39?(this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=[43,38,33,28]):a==40||a==44||a==45||a==48||a==49||a==50||a==51?this._currentStaff.stringTuning.tunings=[52,57,50,43]:a==41?this._currentStaff.stringTuning.tunings=[57,50,43,36]:a==42?this._currentStaff.stringTuning.tunings=[45,38,31,24]:a==43?(this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=[43,38,33,28]):a==105?this._currentStaff.stringTuning.tunings=[50,47,43,38,55]:a==106?this._currentStaff.stringTuning.tunings=[57,52,45]:a==107?this._currentStaff.stringTuning.tunings=[52,45,38,31]:a==110&&(this._currentStaff.stringTuning.tunings=[64,57,50,43]),this._staffTuningApplied=!0}let s=!1,r=t.voices[0];for(;this._sy!==y.Pipe&&this._sy!==y.Eof&&this.beat(r);)s=!0;if(r.beats.length===0){let a=new rt;a.isEmpty=!0,r.addBeat(a)}return e||i||s}newBar(e){let t=new oi;e.addBar(t),t.index>0&&(t.clef=t.previousBar.clef);let i=new Qt;return t.addVoice(i),t}beat(e){this.beatDuration();let t=new rt;if(e.addBeat(t),this._allowTuning=!this._currentStaff.isPercussion,this._sy===y.LParensis){for(this._sy=this.newSy(),this.note(t);this._sy!==y.RParensis&&this._sy!==y.Eof&&(this._allowTuning=!this._currentStaff.isPercussion,!!this.note(t)););this._sy!==y.RParensis&&this.error("note-list",y.RParensis,!0),this._sy=this.newSy()}else if(this._sy===y.String&&this._syData.toLowerCase()==="r")this._sy=this.newSy();else if(!this.note(t))return e.beats.splice(e.beats.length-1,1),!1;this._sy===y.Dot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==y.Number&&this.error("duration",y.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._sy=this.newSy()),t.duration=this._currentDuration,t.dynamics=this._currentDynamics,this._currentTuplet!==1&&!t.hasTuplet&&ht.applyTuplet(t,this._currentTuplet);let i=1;this._sy===y.Multiply&&(this._sy=this.newSy(),this._sy!==y.Number?this.error("multiplier",y.Number,!0):i=this._syData,this._sy=this.newSy()),this.beatEffects(t);for(let s=0;s<i-1;s++)e.addBeat(ir.clone(t));return!0}beatDuration(){if(this._sy===y.DoubleDot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==y.Number&&this.error("duration",y.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._currentTuplet=1,this._sy=this.newSy(),this._sy===y.LBrace)){for(this._sy=this.newSy();this._sy===y.String;)switch(this._syData.toLowerCase()){case"tu":this._sy=this.newSy(),this._sy!==y.Number&&this.error("duration-tuplet",y.Number,!0),this._currentTuplet=this._syData,this._sy=this.newSy();break;default:this.error("beat-duration",y.String,!1);break}this._sy!==y.RBrace&&this.error("beat-duration",y.RBrace,!0),this._sy=this.newSy()}}beatEffects(e){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;)this.applyBeatEffect(e)||this.error("beat-effects",y.String,!1);this._sy!==y.RBrace&&this.error("beat-effects",y.RBrace,!0),this._sy=this.newSy()}}applyBeatEffect(e){let t=this._syData.toLowerCase();if(t==="f")e.fadeIn=!0;else if(t==="v")e.vibrato=oe.Slight;else if(t==="s")e.slap=!0;else if(t==="p")e.pop=!0;else if(t==="tt")e.tap=!0;else if(t==="dd")e.dots=2;else if(t==="d")e.dots=1;else if(t==="su")e.pickStroke=je.Up;else if(t==="sd")e.pickStroke=je.Down;else if(t==="tu"){if(this._sy=this.newSy(),this._sy!==y.Number)return this.error("tuplet",y.Number,!0),!1;ht.applyTuplet(e,this._syData)}else if(t==="tb"||t==="tbe"){let i=t==="tbe";for(this._sy=this.newSy(),this._sy!==y.LParensis&&this.error("tremolobar-effect",y.LParensis,!0),this._allowNegatives=!0,this._sy=this.newSy();this._sy!==y.RParensis&&this._sy!==y.Eof;){let s=0,r=0;i?(this._sy!==y.Number&&this.error("tremolobar-effect",y.Number,!0),s=this._syData,this._sy=this.newSy(),this._sy!==y.Number&&this.error("tremolobar-effect",y.Number,!0),r=this._syData):(this._sy!==y.Number&&this.error("tremolobar-effect",y.Number,!0),s=0,r=this._syData),e.addWhammyBarPoint(new L(s,r)),this._sy=this.newSy()}if(e.whammyBarPoints!=null){for(;e.whammyBarPoints.length>60;)e.removeWhammyBarPoint(e.whammyBarPoints.length-1);if(i)e.whammyBarPoints.sort((s,r)=>s.offset-r.offset);else{let s=e.whammyBarPoints.length,r=60/s|0,a=0;for(;a<s;)e.whammyBarPoints[a].offset=Math.min(60,a*r),a++}}this._allowNegatives=!1,this._sy!==y.RParensis&&this.error("tremolobar-effect",y.RParensis,!0)}else if(t==="bu"||t==="bd"||t==="au"||t==="ad"){switch(t){case"bu":e.brushType=Se.BrushUp;break;case"bd":e.brushType=Se.BrushDown;break;case"au":e.brushType=Se.ArpeggioUp;break;case"ad":e.brushType=Se.ArpeggioDown;break}return this._sy=this.newSy(),this._sy===y.Number?(e.brushDuration=this._syData,this._sy=this.newSy(),!0):(e.updateDurations(),t==="bu"||t==="bd"?e.brushDuration=e.playbackDuration/4/e.notes.length:(t==="au"||t==="ad")&&(e.brushDuration=e.playbackDuration/e.notes.length),!0)}else if(t==="ch"){this._sy=this.newSy();let i=this._syData,s=this.getChordId(this._currentStaff,i);if(!this._currentStaff.hasChord(s)){let r=new bi;r.showDiagram=!1,r.name=i,this._currentStaff.addChord(s,r)}e.chordId=s}else{if(t==="gr")return this._sy=this.newSy(),this._syData.toLowerCase()==="ob"?(e.graceType=W.OnBeat,this._sy=this.newSy()):this._syData.toLowerCase()==="b"?(e.graceType=W.BendGrace,this._sy=this.newSy()):e.graceType=W.BeforeBeat,!0;if(t==="dy"){switch(this._sy=this.newSy(),this._syData.toLowerCase()){case"ppp":e.dynamics=j.PPP;break;case"pp":e.dynamics=j.PP;break;case"p":e.dynamics=j.P;break;case"mp":e.dynamics=j.MP;break;case"mf":e.dynamics=j.MF;break;case"f":e.dynamics=j.F;break;case"ff":e.dynamics=j.FF;break;case"fff":e.dynamics=j.FFF;break}this._currentDynamics=e.dynamics}else if(t==="cre")e.crescendo=mt.Crescendo;else if(t==="dec")e.crescendo=mt.Decrescendo;else if(t==="tempo"){const i=this.readTempoAutomation();return e.automations.push(i),e.voice.bar.masterBar.tempoAutomations.push(i),!0}else if(t==="tp"){if(this._sy=this.newSy(),e.tremoloSpeed=m.Eighth,this._sy===y.Number){switch(this._syData){case 8:e.tremoloSpeed=m.Eighth;break;case 16:e.tremoloSpeed=m.Sixteenth;break;case 32:e.tremoloSpeed=m.ThirtySecond;break;default:e.tremoloSpeed=m.Eighth;break}this._sy=this.newSy()}return!0}else return!1}return this._sy=this.newSy(),!0}getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}static applyTuplet(e,t){switch(t){case 3:e.tupletNumerator=3,e.tupletDenominator=2;break;case 5:e.tupletNumerator=5,e.tupletDenominator=4;break;case 6:e.tupletNumerator=6,e.tupletDenominator=4;break;case 7:e.tupletNumerator=7,e.tupletDenominator=4;break;case 9:e.tupletNumerator=9,e.tupletDenominator=8;break;case 10:e.tupletNumerator=10,e.tupletDenominator=8;break;case 11:e.tupletNumerator=11,e.tupletDenominator=8;break;case 12:e.tupletNumerator=12,e.tupletDenominator=8;break;default:e.tupletNumerator=1,e.tupletDenominator=1;break}}isNoteText(e){return e==="x"||e==="-"||e==="r"}note(e){let t=!1,i=!1,s=-1,r=-1,a=-1;switch(this._sy){case y.Number:s=this._syData,this._currentStaff.isPercussion&&!Ae.instrumentArticulations.has(s)&&this.errorMessage(`Unknown percussion articulation ${s}`);break;case y.String:if(this._currentStaff.isPercussion){const c=this._syData.toLowerCase();this._percussionArticulationNames.has(c)?s=this._percussionArticulationNames.get(c):this.errorMessage(`Unknown percussion articulation '${this._syData}'`)}else t=this._syData==="x",i=this._syData==="-",i||t?s=0:this.error("note-fret",y.Number,!0);break;case y.Tuning:let d=this._syData;r=d.octave,a=d.noteValue;break;default:return!1}this._sy=this.newSy();let o=r===-1&&this._currentStaff.tuning.length>0&&!this._currentStaff.isPercussion,h=-1;o&&(this._sy!==y.Dot&&this.error("note",y.Dot,!0),this._sy=this.newSy(),this._sy!==y.Number&&this.error("note-string",y.Number,!0),h=this._syData,(h<1||h>this._currentStaff.tuning.length)&&this.error("note-string",y.Number,!1),this._sy=this.newSy());let l=new Ee;return o?(l.string=this._currentStaff.tuning.length-(h-1),l.isDead=t,l.isTieDestination=i,i||(l.fret=s)):this._currentStaff.isPercussion?l.percussionArticulation=s:(l.octave=r,l.tone=a,l.isTieDestination=i),e.addNote(l),this.noteEffects(l),!0}noteEffects(e){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;){let t=this._syData.toLowerCase();if(t==="b"||t==="be"){let i=t==="be";for(this._sy=this.newSy(),this._sy!==y.LParensis&&this.error("bend-effect",y.LParensis,!0),this._sy=this.newSy();this._sy!==y.RParensis&&this._sy!==y.Eof;){let r=0,a=0;i?(this._sy!==y.Number&&this.error("bend-effect-value",y.Number,!0),r=this._syData,this._sy=this.newSy(),this._sy!==y.Number&&this.error("bend-effect-value",y.Number,!0),a=this._syData):(this._sy!==y.Number&&this.error("bend-effect-value",y.Number,!0),a=this._syData),e.addBendPoint(new L(r,a)),this._sy=this.newSy()}const s=e.bendPoints;if(s!=null){for(;s.length>60;)s.splice(s.length-1,1);if(i)s.sort((r,a)=>r.offset-a.offset);else{let r=s.length,a=60/(r-1)|0,o=0;for(;o<r;)s[o].offset=Math.min(60,o*a),o++}}this._sy!==y.RParensis&&this.error("bend-effect",y.RParensis,!0),this._sy=this.newSy()}else if(t==="nh")e.harmonicType=O.Natural,this._sy=this.newSy();else if(t==="ah")e.harmonicType=O.Artificial,this._sy=this.newSy();else if(t==="th")e.harmonicType=O.Tap,this._sy=this.newSy();else if(t==="ph")e.harmonicType=O.Pinch,this._sy=this.newSy();else if(t==="sh")e.harmonicType=O.Semi,this._sy=this.newSy();else if(t==="tr"){this._sy=this.newSy(),this._sy!==y.Number&&this.error("trill-effect",y.Number,!0);let i=this._syData;this._sy=this.newSy();let s=m.Sixteenth;if(this._sy===y.Number){switch(this._syData){case 16:s=m.Sixteenth;break;case 32:s=m.ThirtySecond;break;case 64:s=m.SixtyFourth;break;default:s=m.Sixteenth;break}this._sy=this.newSy()}e.trillValue=i+e.stringTuning,e.trillSpeed=s}else if(t==="v")this._sy=this.newSy(),e.vibrato=oe.Slight;else if(t==="sl")this._sy=this.newSy(),e.slideOutType=Q.Legato;else if(t==="ss")this._sy=this.newSy(),e.slideOutType=Q.Shift;else if(t==="sib")this._sy=this.newSy(),e.slideInType=$e.IntoFromBelow;else if(t==="sia")this._sy=this.newSy(),e.slideInType=$e.IntoFromAbove;else if(t==="sou")this._sy=this.newSy(),e.slideOutType=Q.OutUp;else if(t==="sod")this._sy=this.newSy(),e.slideOutType=Q.OutDown;else if(t==="psd")this._sy=this.newSy(),e.slideOutType=Q.PickSlideDown;else if(t==="psu")this._sy=this.newSy(),e.slideOutType=Q.PickSlideUp;else if(t==="h")this._sy=this.newSy(),e.isHammerPullOrigin=!0;else if(t==="lht")this._sy=this.newSy(),e.isLeftHandTapped=!0;else if(t==="g")this._sy=this.newSy(),e.isGhost=!0;else if(t==="ac")this._sy=this.newSy(),e.accentuated=He.Normal;else if(t==="hac")this._sy=this.newSy(),e.accentuated=He.Heavy;else if(t==="pm")this._sy=this.newSy(),e.isPalmMute=!0;else if(t==="st")this._sy=this.newSy(),e.isStaccato=!0;else if(t==="lr")this._sy=this.newSy(),e.isLetRing=!0;else if(t==="x")this._sy=this.newSy(),e.fret=0,e.isDead=!0;else if(t==="-"||t==="t")this._sy=this.newSy(),e.isTieDestination=!0;else if(t==="lf"){this._sy=this.newSy();let i=Y.Thumb;this._sy===y.Number&&(i=this.toFinger(this._syData),this._sy=this.newSy()),e.leftHandFinger=i}else if(t==="rf"){this._sy=this.newSy();let i=Y.Thumb;this._sy===y.Number&&(i=this.toFinger(this._syData),this._sy=this.newSy()),e.rightHandFinger=i}else this.applyBeatEffect(e.beat)||this.error(t,y.String,!1)}this._sy!==y.RBrace&&this.error("note-effect",y.RBrace,!1),this._sy=this.newSy()}}toFinger(e){switch(e){case 1:return Y.Thumb;case 2:return Y.IndexFinger;case 3:return Y.MiddleFinger;case 4:return Y.AnnularFinger;case 5:return Y.LittleFinger}return Y.Thumb}parseDuration(e){switch(e){case-4:return m.QuadrupleWhole;case-2:return m.DoubleWhole;case 1:return m.Whole;case 2:return m.Half;case 4:return m.Quarter;case 8:return m.Eighth;case 16:return m.Sixteenth;case 32:return m.ThirtySecond;case 64:return m.SixtyFourth;case 128:return m.OneHundredTwentyEighth;case 256:return m.TwoHundredFiftySixth;default:return m.Quarter}}barMeta(e){let t=!1,i=e.masterBar;for(;this._sy===y.MetaCommand;){t=!0;let s=this._syData.toLowerCase();if(s==="ts")this._sy=this.newSy(),this._sy!==y.Number&&this.error("timesignature-numerator",y.Number,!0),i.timeSignatureNumerator=this._syData,this._sy=this.newSy(),this._sy!==y.Number&&this.error("timesignature-denominator",y.Number,!0),i.timeSignatureDenominator=this._syData,this._sy=this.newSy();else if(s==="ro")i.isRepeatStart=!0,this._sy=this.newSy();else if(s==="rc")this._sy=this.newSy(),this._sy!==y.Number&&this.error("repeatclose",y.Number,!0),this._syData>2048&&this.error("repeatclose",y.Number,!1),i.repeatCount=this._syData,this._sy=this.newSy();else if(s==="ae")if(this._sy=this.newSy(),this._sy===y.LParensis){for(this._sy=this.newSy(),this._sy!==y.Number&&this.error("alternateending",y.Number,!0),this.applyAlternateEnding(i);this._sy===y.Number;)this.applyAlternateEnding(i);this._sy!==y.RParensis&&this.error("alternateending-list",y.RParensis,!0),this._sy=this.newSy()}else this._sy!==y.Number&&this.error("alternateending",y.Number,!0),this.applyAlternateEnding(i);else if(s==="ks")this._sy=this.newSy(),this._sy!==y.String&&this.error("keysignature",y.String,!0),i.keySignature=this.parseKeySignature(this._syData),this._sy=this.newSy();else if(s==="clef"){switch(this._sy=this.newSy(),this._sy){case y.String:e.clef=this.parseClefFromString(this._syData);break;case y.Number:e.clef=this.parseClefFromInt(this._syData);break;case y.Tuning:let r=this._syData;e.clef=this.parseClefFromInt(r.realValue);break;default:this.error("clef",y.String,!0);break}this._sy=this.newSy()}else if(s==="tempo"){const r=this.readTempoAutomation();i.tempoAutomations.push(r)}else if(s==="section"){this._sy=this.newSy(),this._sy!==y.String&&this.error("section",y.String,!0);let r=this._syData;this._sy=this.newSy();let a="";this._sy===y.String&&!this.isNoteText(this._syData.toLowerCase())&&(a=r,r=this._syData,this._sy=this.newSy());let o=new xs;o.marker=a,o.text=r,i.section=o}else if(s==="tf"){switch(this._allowTuning=!1,this._sy=this.newSy(),this._allowTuning=!0,this._sy){case y.String:i.tripletFeel=this.parseTripletFeelFromString(this._syData);break;case y.Number:i.tripletFeel=this.parseTripletFeelFromInt(this._syData);break;default:this.error("triplet-feel",y.String,!0);break}this._sy=this.newSy()}else s==="ac"?(i.isAnacrusis=!0,this._sy=this.newSy()):e.index===0?this.handleStaffMeta()||this.error("measure-effects",y.String,!1):this.error("measure-effects",y.String,!1)}if(i.index===0&&i.tempoAutomations.length===0){let s=new st;s.isLinear=!1,s.type=Ge.Tempo,s.value=this._score.tempo,i.tempoAutomations.push(s)}return t}readTempoAutomation(){this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy!==y.Number&&this.error("tempo",y.Number,!0);const e=new st;return e.isLinear=!1,e.type=Ge.Tempo,e.value=this._syData,this._sy=this.newSy(),e}applyAlternateEnding(e){let t=this._syData;t<1&&this.error("alternateending",y.Number,!0),e.alternateEndings|=1<<t-1,this._sy=this.newSy()}}ht.Eof=0;class $t extends Gi{get name(){return"Guitar Pro 3-5"}constructor(){super(),this._versionNumber=0,this._globalTripletFeel=ee.NoTripletFeel,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._beatTextChunksByTrack=new Map}readScore(){if(this.readVersion(),this._score=new Li,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=he.gpReadBool(this.data)?ee.Triplet8th:ee.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._versionNumber>=500&&(this.readPageSetup(),this._score.tempoLabel=he.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._score.tempo=S.readInt32LE(this.data),this._versionNumber>=510&&he.gpReadBool(this.data),S.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this.data.skip(38),this.data.skip(4)),this._barCount=S.readInt32LE(this.data),this._trackCount=S.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){const e=st.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}readVersion(){let e=he.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith($t.VersionString))throw new xe("Unsupported format");e=e.substr($t.VersionString.length+1);let t=e.indexOf(".");this._versionNumber=100*parseInt(e.substr(0,t))+parseInt(e.substr(t+1)),_.debug(this.name,"Guitar Pro version "+e+" detected")}readScoreInformation(){var i;this._score.title=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?he.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding);let e=S.readInt32LE(this.data),t="";for(let s=0;s<e;s++)s>0&&(t+=`\r
`),t+=(i=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding))==null?void 0:i.toString();this._score.notices=t}readLyrics(){this._lyrics=[],this._lyricsTrack=S.readInt32LE(this.data)-1;for(let e=0;e<5;e++){let t=new ze;t.startBar=S.readInt32LE(this.data)-1,t.text=he.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(t)}}readPageSetup(){this.data.skip(30);for(let e=0;e<10;e++)he.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];for(let e=0;e<64;e++){let t=new la;t.primaryChannel=e,t.secondaryChannel=e,t.program=S.readInt32LE(this.data),t.volume=this.data.readByte(),t.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(t)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);let t=new li,i=this.data.readByte();if(i&1?t.timeSignatureNumerator=this.data.readByte():e&&(t.timeSignatureNumerator=e.timeSignatureNumerator),i&2?t.timeSignatureDenominator=this.data.readByte():e&&(t.timeSignatureDenominator=e.timeSignatureDenominator),t.isRepeatStart=(i&4)!==0,i&8&&(t.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),i&16&&this._versionNumber<500){let s=e,r=0;for(;s&&!(s.isRepeatEnd&&s!==e||s.isRepeatStart);)r=r|s.alternateEndings,s=s.previousMasterBar;let a=0,o=this.data.readByte();for(let h=0;h<8;h++){let l=1<<h;o>h&&!(r&l)&&(a=a|l)}t.alternateEndings=a}if(i&32){let s=new xs;s.text=he.gpReadStringIntByte(this.data,this.settings.importer.encoding),s.marker="",he.gpReadColor(this.data,!1),t.section=s}if(i&64?(t.keySignature=S.readSInt8(this.data),t.keySignatureType=this.data.readByte()):e&&(t.keySignature=e.keySignature,t.keySignatureType=e.keySignatureType),this._versionNumber>=500&&i&3&&this.data.skip(4),this._versionNumber>=500&&(t.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:t.tripletFeel=ee.Triplet8th;break;case 2:t.tripletFeel=ee.Triplet16th;break}this.data.readByte()}else t.tripletFeel=this._globalTripletFeel;t.isDoubleBar=(i&128)!==0,this._score.addMasterBar(t)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){let e=new Jt;e.ensureStaveCount(1),this._score.addTrack(e);let t=e.staves[0],i=this.data.readByte();e.name=he.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),i&1&&(t.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=(i&8)!==0);let s=S.readInt32LE(this.data),r=[];for(let l=0;l<7;l++){let d=S.readInt32LE(this.data);s>l&&r.push(d)}t.stringTuning.tunings=r;let a=S.readInt32LE(this.data),o=S.readInt32LE(this.data)-1,h=S.readInt32LE(this.data)-1;if(this.data.skip(4),o>=0&&o<this._playbackInfos.length){let l=this._playbackInfos[o];l.port=a,l.isSolo=(i&16)!==0,l.isMute=(i&32)!==0,l.secondaryChannel=h,ni.isGuitar(l.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=l}t.capo=S.readInt32LE(this.data),e.color=he.gpReadColor(this.data,!1),this._versionNumber>=500&&(this.data.readByte(),this.data.readByte(),this.data.skip(43)),this._versionNumber>=510&&(this.data.skip(4),he.gpReadStringIntByte(this.data,this.settings.importer.encoding),he.gpReadStringIntByte(this.data,this.settings.importer.encoding))}readBars(){for(let e=0;e<this._barCount;e++)for(let t=0;t<this._trackCount;t++)this.readBar(this._score.tracks[t])}readBar(e){let t=new oi,i=e.staves[0];i.isPercussion&&(t.clef=U.Neutral),i.addBar(t);let s=1;this._versionNumber>=500&&(this.data.readByte(),s=2);for(let r=0;r<s;r++)this.readVoice(e,t)}readVoice(e,t){let i=S.readInt32LE(this.data);if(i===0)return;let s=new Qt;t.addVoice(s);for(let r=0;r<i;r++)this.readBeat(e,t,s)}readBeat(e,t,i){let s=new rt,r=this.data.readByte();if(r&1&&(s.dots=1),r&64){let d=this.data.readByte();s.isEmpty=(d&2)===0}switch(i.addBeat(s),S.readSInt8(this.data)){case-2:s.duration=m.Whole;break;case-1:s.duration=m.Half;break;case 0:s.duration=m.Quarter;break;case 1:s.duration=m.Eighth;break;case 2:s.duration=m.Sixteenth;break;case 3:s.duration=m.ThirtySecond;break;case 4:s.duration=m.SixtyFourth;break;default:s.duration=m.Quarter;break}if(r&32)switch(s.tupletNumerator=S.readInt32LE(this.data),s.tupletNumerator){case 1:s.tupletDenominator=1;break;case 3:s.tupletDenominator=2;break;case 5:case 6:case 7:s.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:s.tupletDenominator=8;break;case 2:case 4:case 8:break;default:s.tupletNumerator=1,s.tupletDenominator=1;break}r&2&&this.readChord(s);let o=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if(r&4){const d=he.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(o){const c=new ze;c.text=d.trim(),c.finish(!0);const f=[];for(let p=c.chunks.length-1;p>=0;p--)f.push(c.chunks[p]);this._beatTextChunksByTrack.set(e.index,f)}else s.text=d}let h=O.None;r&8&&(h=this.readBeatEffects(s)),r&16&&this.readMixTableChange(s);let l=this.data.readByte();for(let d=6;d>=0;d--)if(l&1<<d&&6-d<t.staff.tuning.length){const c=this.readNote(e,t,i,s,6-d);h!==O.None&&(c.harmonicType=h,c.harmonicType===O.Natural&&(c.harmonicValue=this.deltaFretToHarmonicValue(c.fret)))}this._versionNumber>=500&&(this.data.readByte(),this.data.readByte()&8&&this.data.readByte()),o&&!s.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(s.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){let t=new bi,i=Be.newGuid();if(this._versionNumber>=500){this.data.skip(17),t.name=he.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=S.readInt32LE(this.data);for(let a=0;a<7;a++){let o=S.readInt32LE(this.data);a<e.voice.bar.staff.tuning.length&&t.strings.push(o)}let s=this.data.readByte(),r=new Uint8Array(5);this.data.read(r,0,r.length);for(let a=0;a<s;a++)t.barreFrets.push(r[a]);this.data.skip(26)}else if(this.data.readByte()!==0)if(this._versionNumber>=400){this.data.skip(16),t.name=he.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=S.readInt32LE(this.data);for(let a=0;a<7;a++){let o=S.readInt32LE(this.data);a<e.voice.bar.staff.tuning.length&&t.strings.push(o)}let s=this.data.readByte(),r=new Uint8Array(5);this.data.read(r,0,r.length);for(let a=0;a<s;a++)t.barreFrets.push(r[a]);this.data.skip(26)}else{this.data.skip(25),t.name=he.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),t.firstFret=S.readInt32LE(this.data);for(let s=0;s<6;s++){let r=S.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(r)}this.data.skip(36)}else{let s=this._versionNumber>=406?7:6;if(t.name=he.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.firstFret=S.readInt32LE(this.data),t.firstFret>0)for(let r=0;r<s;r++){let a=S.readInt32LE(this.data);r<e.voice.bar.staff.tuning.length&&t.strings.push(a)}}t.name&&(e.chordId=i,e.voice.bar.staff.addChord(e.chordId,t))}readBeatEffects(e){let t=this.data.readByte(),i=0;if(this._versionNumber>=400&&(i=this.data.readByte()),e.fadeIn=(t&16)!==0,(this._versionNumber<400&&t&1||t&2)&&(e.vibrato=oe.Slight),e.hasRasgueado=(i&1)!==0,t&32&&this._versionNumber>=400)switch(S.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0;break}else if(t&32){switch(S.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0;break}this.data.skip(4)}if(i&4&&this.readTremoloBarEffect(e),t&64){let s=0,r=0;this._versionNumber<500?(r=this.data.readByte(),s=this.data.readByte()):(s=this.data.readByte(),r=this.data.readByte()),s>0?(e.brushType=Se.BrushUp,e.brushDuration=$t.toStrokeValue(s)):r>0&&(e.brushType=Se.BrushDown,e.brushDuration=$t.toStrokeValue(r))}if(i&2)switch(S.readSInt8(this.data)){case 0:e.pickStroke=je.None;break;case 1:e.pickStroke=je.Up;break;case 2:e.pickStroke=je.Down;break}if(this._versionNumber<400){if(t&4)return O.Natural;if(t&8)return O.Artificial}return O.None}readTremoloBarEffect(e){this.data.readByte(),S.readInt32LE(this.data);let t=S.readInt32LE(this.data);if(t>0)for(let i=0;i<t;i++){let s=new L(0,0);s.offset=S.readInt32LE(this.data),s.value=S.readInt32LE(this.data)/$t.BendStep|0,he.gpReadBool(this.data),e.addWhammyBarPoint(s)}}static toStrokeValue(e){switch(e){case 1:return 30;case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}readMixTableChange(e){let t=new Wn;t.instrument=S.readSInt8(this.data),this._versionNumber>=500&&this.data.skip(16),t.volume=S.readSInt8(this.data),t.balance=S.readSInt8(this.data);let i=S.readSInt8(this.data),s=S.readSInt8(this.data),r=S.readSInt8(this.data),a=S.readSInt8(this.data);if(this._versionNumber>=500&&(t.tempoName=he.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=S.readInt32LE(this.data),t.volume>=0&&this.data.readByte(),t.balance>=0&&this.data.readByte(),i>=0&&this.data.readByte(),s>=0&&this.data.readByte(),r>=0&&this.data.readByte(),a>=0&&this.data.readByte(),t.tempo>=0&&(t.duration=S.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500&&this.data.readByte(),this._versionNumber>=510&&(he.gpReadStringIntByte(this.data,this.settings.importer.encoding),he.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.volume>=0){let o=new st;o.isLinear=!0,o.type=Ge.Volume,o.value=t.volume,e.automations.push(o)}if(t.balance>=0){let o=new st;o.isLinear=!0,o.type=Ge.Balance,o.value=t.balance,e.automations.push(o)}if(t.instrument>=0){let o=new st;o.isLinear=!0,o.type=Ge.Instrument,o.value=t.instrument,e.automations.push(o)}if(t.tempo>=0){let o=new st;o.isLinear=!0,o.type=Ge.Tempo,o.value=t.tempo,e.automations.push(o),e.voice.bar.masterBar.tempoAutomations.push(o)}}readNote(e,t,i,s,r){let a=new Ee;a.string=t.staff.tuning.length-r;let o=this.data.readByte();if(o&2?a.accentuated=He.Heavy:o&64&&(a.accentuated=He.Normal),a.isGhost=(o&4)!==0,o&32){let l=this.data.readByte();l===3?a.isDead=!0:l===2&&(a.isTieDestination=!0)}if(o&1&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),o&16){let l=S.readSInt8(this.data);a.dynamics=this.toDynamicValue(l),s.dynamics=a.dynamics}o&32&&(a.fret=S.readSInt8(this.data)),o&128&&(a.leftHandFinger=S.readSInt8(this.data),a.rightHandFinger=S.readSInt8(this.data),a.isFingering=!0);let h=!1;if(this._versionNumber>=500&&(o&1&&(a.durationPercent=he.gpReadDouble(this.data)),h=(this.data.readByte()&2)!==0),s.addNote(a),o&8&&this.readNoteEffects(e,i,s,a),t.staff.isPercussion&&(a.percussionArticulation=a.fret,a.string=-1,a.fret=-1),h){const l=x.defaultAccidentals[a.realValueWithoutHarmonic%12];l==="#"?a.accidentalMode=Me.ForceFlat:l==="b"&&(a.accidentalMode=Me.ForceSharp)}return a}toDynamicValue(e){switch(e){case 1:return j.PPP;case 2:return j.PP;case 3:return j.P;case 4:return j.MP;case 5:return j.MF;case 6:return j.F;case 7:return j.FF;case 8:return j.FFF;default:return j.F}}readNoteEffects(e,t,i,s){let r=this.data.readByte(),a=0;this._versionNumber>=400&&(a=this.data.readByte()),r&1&&this.readBend(s),r&16&&this.readGrace(t,s),a&4&&this.readTremoloPicking(i),a&8?this.readSlide(s):this._versionNumber<400&&r&4&&(s.slideOutType=Q.Shift),a&16&&this.readArtificialHarmonic(s),a&32&&this.readTrill(s),s.isLetRing=(r&8)!==0,s.isHammerPullOrigin=(r&2)!==0,a&64&&(s.vibrato=oe.Slight),s.isPalmMute=(a&2)!==0,s.isStaccato=(a&1)!==0}readBend(e){this.data.readByte(),S.readInt32LE(this.data);let t=S.readInt32LE(this.data);if(t>0)for(let i=0;i<t;i++){let s=new L(0,0);s.offset=S.readInt32LE(this.data),s.value=S.readInt32LE(this.data)/$t.BendStep|0,he.gpReadBool(this.data),e.addBendPoint(s)}}readGrace(e,t){let i=new rt,s=new Ee;switch(s.string=t.string,s.fret=S.readSInt8(this.data),i.duration=m.ThirtySecond,i.dynamics=this.toDynamicValue(S.readSInt8(this.data)),S.readSInt8(this.data)){case 0:break;case 1:s.slideOutType=Q.Legato,s.slideTarget=t;break;case 2:break;case 3:s.isHammerPullOrigin=!0;break}if(s.dynamics=i.dynamics,this.data.skip(1),this._versionNumber<500)i.graceType=W.BeforeBeat;else{let a=this.data.readByte();s.isDead=(a&1)!==0,i.graceType=a&2?W.OnBeat:W.BeforeBeat}e.addGraceBeat(i),i.addNote(s)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=m.Eighth;break;case 2:e.tremoloSpeed=m.Sixteenth;break;case 3:e.tremoloSpeed=m.ThirtySecond;break}}readSlide(e){if(this._versionNumber>=500){let t=S.readSInt8(this.data);t&1?e.slideOutType=Q.Shift:t&2?e.slideOutType=Q.Legato:t&4?e.slideOutType=Q.OutDown:t&8&&(e.slideOutType=Q.OutUp),t&16?e.slideInType=$e.IntoFromBelow:t&32&&(e.slideInType=$e.IntoFromAbove)}else switch(S.readSInt8(this.data)){case 1:e.slideOutType=Q.Shift;break;case 2:e.slideOutType=Q.Legato;break;case 3:e.slideOutType=Q.OutDown;break;case 4:e.slideOutType=Q.OutUp;break;case-1:e.slideInType=$e.IntoFromBelow;break;case-2:e.slideInType=$e.IntoFromAbove;break}}readArtificialHarmonic(e){let t=this.data.readByte();if(this._versionNumber>=500)switch(t){case 1:e.harmonicType=O.Natural,e.harmonicValue=this.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=O.Artificial;break;case 3:e.harmonicType=O.Tap,e.harmonicValue=this.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=O.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=O.Semi,e.harmonicValue=12;break}else if(this._versionNumber>=400)switch(t){case 1:e.harmonicType=O.Natural;break;case 3:e.harmonicType=O.Tap;break;case 4:e.harmonicType=O.Pinch;break;case 5:e.harmonicType=O.Semi;break;case 15:e.harmonicType=O.Artificial;break;case 17:e.harmonicType=O.Artificial;break;case 22:e.harmonicType=O.Artificial;break}}deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=m.Sixteenth;break;case 2:e.trillSpeed=m.ThirtySecond;break;case 3:e.trillSpeed=m.SixtyFourth;break}}}$t.VersionString="FICHIER GUITAR PRO ",$t.BendStep=25;class he{static gpReadDouble(e){let t=new Uint8Array(8);return e.read(t,0,t.length),new Float64Array(t.buffer)[0]}static gpReadFloat(e){let t=new Uint8Array(4);return t[3]=e.readByte(),t[2]=e.readByte(),t[2]=e.readByte(),t[1]=e.readByte(),new Float32Array(t.buffer)[0]}static gpReadColor(e,t=!1){let i=e.readByte(),s=e.readByte(),r=e.readByte(),a=255;return t?a=e.readByte():e.skip(1),new fe(i,s,r,a)}static gpReadBool(e){return e.readByte()!==0}static gpReadStringIntUnused(e,t){return e.skip(4),he.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return he.gpReadString(e,S.readInt32LE(e),t)}static gpReadStringIntByte(e,t){let i=S.readInt32LE(e)-1;return e.readByte(),he.gpReadString(e,i,t)}static gpReadString(e,t,i){let s=new Uint8Array(t);return e.read(s,0,s.length),S.toString(s,i)}static gpWriteString(e,t){const i=S.stringToBytes(t);e.writeByte(t.length),e.write(i,0,i.length)}static gpReadStringByteLength(e,t,i){let s=e.readByte(),r=he.gpReadString(e,s,i);return s<t&&e.skip(t-s),r}}class Wn{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}}class gt{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}}var Ht;(function(n){n[n.Boolean=0]="Boolean",n[n.Integer=1]="Integer",n[n.Float=2]="Float",n[n.String=3]="String",n[n.Point=4]="Point",n[n.Size=5]="Size",n[n.Rectangle=6]="Rectangle",n[n.Color=7]="Color"})(Ht||(Ht={}));class Ns{constructor(e){this.raw=new Map;let t=Ke.fromBuffer(e),i=S.readInt32BE(t);for(let s=0;s<i;s++){let r=he.gpReadString(t,t.readByte(),"utf-8");switch(t.readByte()){case Ht.Boolean:let o=t.readByte()===1;this.addValue(r,o);break;case Ht.Integer:let h=S.readInt32BE(t);this.addValue(r,h);break;case Ht.Float:let l=he.gpReadFloat(t);this.addValue(r,l);break;case Ht.String:let d=he.gpReadString(t,S.readInt16BE(t),"utf-8");this.addValue(r,d);break;case Ht.Point:let c=S.readInt32BE(t),f=S.readInt32BE(t);this.addValue(r,new L(c,f));break;case Ht.Size:let p=S.readInt32BE(t),g=S.readInt32BE(t);this.addValue(r,new L(p,g));break;case Ht.Rectangle:let b=new gt;b.x=S.readInt32BE(t),b.y=S.readInt32BE(t),b.w=S.readInt32BE(t),b.h=S.readInt32BE(t),this.addValue(r,b);break;case Ht.Color:let w=he.gpReadColor(t,!0);this.addValue(r,w);break}}}apply(e){for(const[t,i]of this.raw)switch(t){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=i;break}}addValue(e,t){this.raw.set(e,t)}static writeForScore(e){const t=Ke.withCapacity(128);return S.writeInt32BE(t,1),Ns.writeBooleanEntry(t,"StandardNotation/hideDynamics",e.stylesheet.hideDynamics),t.toArray()}static writeBooleanEntry(e,t,i){he.gpWriteString(e,t),e.writeByte(Ht.Boolean),e.writeByte(i?1:0)}}var Gt;(function(n){n[n.Short=0]="Short",n[n.Medium=1]="Medium",n[n.Long=2]="Long"})(Gt||(Gt={}));class rr{constructor(){this.type=Gt.Short,this.length=0}}var k;(function(n){n[n.None=0]="None",n[n.Element=1]="Element",n[n.Text=2]="Text",n[n.CDATA=3]="CDATA",n[n.Document=4]="Document",n[n.DocumentType=5]="DocumentType"})(k||(k={}));class zt{constructor(){this.nodeType=k.None,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}addChild(e){this.childNodes.push(e),this.firstChild=e,(e.nodeType===k.Element||e.nodeType===k.CDATA)&&(this.firstElement=e)}getAttribute(e){return this.attributes.has(e)?this.attributes.get(e):""}getElementsByTagName(e,t=!1){let i=[];return this.searchElementsByTagName(this.childNodes,i,e,t),i}searchElementsByTagName(e,t,i,s=!1){for(let r of e)r&&r.nodeType===k.Element&&r.localName===i&&t.push(r),s&&this.searchElementsByTagName(r.childNodes,t,i,!0)}findChildElement(e){for(let t of this.childNodes)if(t&&t.nodeType===k.Element&&t.localName===e)return t;return null}addElement(e){const t=new zt;return t.nodeType=k.Element,t.localName=e,this.addChild(t),t}get innerText(){var e;if(this.nodeType===k.Element||this.nodeType===k.Document){if(this.firstElement&&this.firstElement.nodeType===k.CDATA)return this.firstElement.innerText;let t="";for(let s of this.childNodes)t+=(e=s.innerText)==null?void 0:e.toString();return t.trim()}return this.value??""}set innerText(e){const t=new zt;t.nodeType=k.Text,t.value=e,this.childNodes=[t]}setCData(e){const t=new zt;t.nodeType=k.CDATA,t.value=e,this.childNodes=[t]}}class yt extends nt{constructor(e,t,i){super(at.Format,e),this.pos=0,this.xml=t,this.pos=i,Object.setPrototypeOf(this,yt.prototype)}}var z;(function(n){n[n.IgnoreSpaces=0]="IgnoreSpaces",n[n.Begin=1]="Begin",n[n.BeginNode=2]="BeginNode",n[n.TagName=3]="TagName",n[n.Body=4]="Body",n[n.AttribName=5]="AttribName",n[n.Equals=6]="Equals",n[n.AttvalBegin=7]="AttvalBegin",n[n.AttribVal=8]="AttribVal",n[n.Childs=9]="Childs",n[n.Close=10]="Close",n[n.WaitEnd=11]="WaitEnd",n[n.WaitEndRet=12]="WaitEndRet",n[n.Pcdata=13]="Pcdata",n[n.Header=14]="Header",n[n.Comment=15]="Comment",n[n.Doctype=16]="Doctype",n[n.Cdata=17]="Cdata",n[n.Escape=18]="Escape"})(z||(z={}));class I{static parse(e,t,i){let s=e.charCodeAt(t),r=z.Begin,a=z.Begin,o=0,h="",l=z.Begin,d=null,c=null,f=0,p=0;for(;t<e.length;){switch(s=e.charCodeAt(t),r){case z.IgnoreSpaces:switch(s){case I.CharCodeLF:case I.CharCodeCR:case I.CharCodeTab:case I.CharCodeSpace:break;default:r=a;continue}break;case z.Begin:switch(s){case I.CharCodeLowerThan:r=z.IgnoreSpaces,a=z.BeginNode;break;default:o=t,r=z.Pcdata;continue}break;case z.Pcdata:if(s===I.CharCodeLowerThan){h+=e.substr(o,t-o);let g=new zt;g.nodeType=k.Text,g.value=h,h="",i.addChild(g),r=z.IgnoreSpaces,a=z.BeginNode}else s===I.CharCodeAmp&&(h+=e.substr(o,t-o),r=z.Escape,l=z.Pcdata,o=t+1);break;case z.Cdata:if(s===I.CharCodeBrackedClose&&e.charCodeAt(t+1)===I.CharCodeBrackedClose&&e.charCodeAt(t+2)===I.CharCodeGreaterThan){let g=new zt;g.nodeType=k.CDATA,g.value=e.substr(o,t-o),i.addChild(g),t+=2,r=z.Begin}break;case z.BeginNode:switch(s){case I.CharCodeExclamation:if(e.charCodeAt(t+1)===I.CharCodeBrackedOpen){if(t+=2,e.substr(t,6).toUpperCase()!=="CDATA[")throw new yt("Expected <![CDATA[",e,t);t+=5,r=z.Cdata,o=t+1}else if(e.charCodeAt(t+1)===I.CharCodeUpperD||e.charCodeAt(t+1)===I.CharCodeLowerD){if(e.substr(t+2,6).toUpperCase()!=="OCTYPE")throw new yt("Expected <!DOCTYPE",e,t);t+=8,r=z.Doctype,o=t+1}else{if(e.charCodeAt(t+1)!==I.CharCodeMinus||e.charCodeAt(t+2)!==I.CharCodeMinus)throw new yt("Expected <!--",e,t);t+=2,r=z.Comment,o=t+1}break;case I.CharCodeQuestion:r=z.Header,o=t;break;case I.CharCodeSlash:if(!i)throw new yt("Expected node name",e,t);o=t+1,r=z.IgnoreSpaces,a=z.Close;break;default:r=z.TagName,o=t;continue}break;case z.TagName:if(!I.isValidChar(s)){if(t===o)throw new yt("Expected node name",e,t);d=new zt,d.nodeType=k.Element,d.localName=e.substr(o,t-o),i.addChild(d),r=z.IgnoreSpaces,a=z.Body;continue}break;case z.Body:switch(s){case I.CharCodeSlash:r=z.WaitEnd;break;case I.CharCodeGreaterThan:r=z.Childs;break;default:r=z.AttribName,o=t;continue}break;case z.AttribName:if(!I.isValidChar(s)){if(o===t)throw new yt("Expected attribute name",e,t);if(c=e.substr(o,t-o),d.attributes.has(c))throw new yt(`Duplicate attribute [${c}]`,e,t);r=z.IgnoreSpaces,a=z.Equals;continue}break;case z.Equals:switch(s){case I.CharCodeEquals:r=z.IgnoreSpaces,a=z.AttvalBegin;break;default:throw new yt("Expected =",e,t)}break;case z.AttvalBegin:switch(s){case I.CharCodeDoubleQuote:case I.CharCodeSingleQuote:h="",r=z.AttribVal,o=t+1,p=s;break}break;case z.AttribVal:switch(s){case I.CharCodeAmp:h+=e.substr(o,t-o),r=z.Escape,l=z.AttribVal,o=t+1;break;default:if(s===p){h+=e.substr(o,t-o);let g=h;h="",d.attributes.set(c,g),r=z.IgnoreSpaces,a=z.Body}break}break;case z.Childs:t=I.parse(e,t,d),o=t,r=z.Begin;break;case z.WaitEnd:switch(s){case I.CharCodeGreaterThan:r=z.Begin;break;default:throw new yt("Expected >",e,t)}break;case z.WaitEndRet:switch(s){case I.CharCodeGreaterThan:return t;default:throw new yt("Expected >",e,t)}case z.Close:if(!I.isValidChar(s)){if(o===t)throw new yt("Expected node name",e,t);if(e.substr(o,t-o)!==i.localName)throw new yt("Expected </"+i.localName+">",e,t);r=z.IgnoreSpaces,a=z.WaitEndRet;continue}break;case z.Comment:s===I.CharCodeMinus&&e.charCodeAt(t+1)===I.CharCodeMinus&&e.charCodeAt(t+2)===I.CharCodeGreaterThan&&(t+=2,r=z.Begin);break;case z.Doctype:if(s===I.CharCodeBrackedOpen)f++;else if(s===I.CharCodeBrackedClose)f--;else if(s===I.CharCodeGreaterThan&&f===0){let g=new zt;g.nodeType=k.DocumentType,g.value=e.substr(o,t-o),i.addChild(g),r=z.Begin}break;case z.Header:s===I.CharCodeQuestion&&e.charCodeAt(t+1)===I.CharCodeGreaterThan&&(t++,r=z.Begin);break;case z.Escape:if(s===I.CharCodeSemi){let g=e.substr(o,t-o);if(g.charCodeAt(0)===I.CharCodeSharp){let b=g.charCodeAt(1)===I.CharCodeLowerX?parseInt("0"+g.substr(1,g.length-1)):parseInt(g.substr(1,g.length-1));h+=String.fromCharCode(b)}else I.Escapes.has(g)?h+=I.Escapes.get(g):h+=("&"+g+";").toString();o=t+1,r=l}else!I.isValidChar(s)&&s!==I.CharCodeSharp&&(h+="&",h+=e.substr(o,t-o),t--,o=t+1,r=l);break}t++}if(r===z.Begin&&(o=t,r=z.Pcdata),r===z.Pcdata){if(t!==o){h+=e.substr(o,t-o);let g=new zt;g.nodeType=k.Text,g.value=h,i.addChild(g)}return t}if(r===z.Escape&&l===z.Pcdata){h+="&",h+=e.substr(o,t-o);let g=new zt;return g.nodeType=k.Text,g.value=h,i.addChild(g),t}throw new yt("Unexpected end",e,t)}static isValidChar(e){return e>=I.CharCodeLowerA&&e<=I.CharCodeLowerZ||e>=I.CharCodeUpperA&&e<=I.CharCodeUpperZ||e>=I.CharCode0&&e<=I.CharCode9||e===I.CharCodeColon||e===I.CharCodeDot||e===I.CharCodeUnderscore||e===I.CharCodeMinus}}I.CharCodeLF=10,I.CharCodeTab=9,I.CharCodeCR=13,I.CharCodeSpace=32,I.CharCodeLowerThan=60,I.CharCodeAmp=38,I.CharCodeBrackedClose=93,I.CharCodeBrackedOpen=91,I.CharCodeGreaterThan=62,I.CharCodeExclamation=33,I.CharCodeUpperD=68,I.CharCodeLowerD=100,I.CharCodeMinus=45,I.CharCodeQuestion=63,I.CharCodeSlash=47,I.CharCodeEquals=61,I.CharCodeDoubleQuote=34,I.CharCodeSingleQuote=39,I.CharCodeSharp=35,I.CharCodeLowerX=120,I.CharCodeLowerA=97,I.CharCodeLowerZ=122,I.CharCodeUpperA=65,I.CharCodeUpperZ=90,I.CharCode0=48,I.CharCode9=57,I.CharCodeColon=58,I.CharCodeDot=46,I.CharCodeUnderscore=95,I.CharCodeSemi=59,I.Escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);class ar{static write(e,t,i){const s=new ar(t,i);return s.writeNode(e),s.toString()}constructor(e,t){this._result=[],this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}writeNode(e){switch(e.nodeType){case k.None:break;case k.Element:this._result.length>0&&this.writeLine(),this.write(`<${e.localName}`);for(const[t,i]of e.attributes)this.write(` ${t}="`),this.writeAttributeValue(i),this.write('"');if(e.childNodes.length===0)this.write("/>");else{if(this.write(">"),e.childNodes.length===1&&!e.firstElement)this.writeNode(e.childNodes[0]);else{this.indent();for(const t of e.childNodes)t.nodeType===k.Element&&this.writeNode(t);this.unindend(),this.writeLine()}this.write(`</${e.localName}>`)}break;case k.Text:e.value&&this.write(e.value);break;case k.CDATA:e.value!==null&&this.write(`<![CDATA[${e.value}]]>`);break;case k.Document:this._xmlHeader&&this.write('<?xml version="1.0" encoding="utf-8"?>');for(const t of e.childNodes)this.writeNode(t);break;case k.DocumentType:this.write(`<!DOCTYPE ${e.value}>`);break}}unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}indent(){this._currentIndention+=this._indention}writeAttributeValue(e){for(let t=0;t<e.length;t++){const i=e.charAt(t);switch(i){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(i);break}}}write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}writeLine(e=null){e&&this.write(e),this._indention.length>0&&!this._isStartOfLine&&(this._result.push(`
`),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class Ps extends zt{constructor(){super(),this.nodeType=k.Document}parse(e){I.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return ar.write(this,e,t)}}var P;(function(n){n[n.Up=0]="Up",n[n.Down=1]="Down"})(P||(P={}));class Hn{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=m.Quarter}}class Gn{constructor(){this.name="",this.path="",this.role="",this.program=0}get uniqueId(){return this.path+";"+this.name+";"+this.role}}class Dt{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1}parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;let i=new Ps;try{i.parse(e)}catch(s){throw new xe("Could not parse XML",s)}if(this.parseDom(i),this.buildModel(),this.score.finish(t),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(const[s,r]of this._lyricsByTrack)this._tracksById.get(s).applyLyrics(r)}parseDom(e){let t=e.firstElement;if(t)if(t.localName==="GPIF"){this.score=new Li;for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Score":this.parseScoreNode(i);break;case"MasterTrack":this.parseMasterTrackNode(i);break;case"Tracks":this.parseTracksNode(i);break;case"MasterBars":this.parseMasterBarsNode(i);break;case"Bars":this.parseBars(i);break;case"Voices":this.parseVoices(i);break;case"Beats":this.parseBeats(i);break;case"Notes":this.parseNotes(i);break;case"Rhythms":this.parseRhythms(i);break}}else throw new xe("Root node of XML was not GPIF")}parseScoreNode(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Title":this.score.title=t.firstChild.innerText;break;case"SubTitle":this.score.subTitle=t.firstChild.innerText;break;case"Artist":this.score.artist=t.firstChild.innerText;break;case"Album":this.score.album=t.firstChild.innerText;break;case"Words":this.score.words=t.firstChild.innerText;break;case"Music":this.score.music=t.firstChild.innerText;break;case"WordsAndMusic":if(t.firstChild&&t.firstChild.innerText!==""){let i=t.firstChild.innerText;i&&!this.score.words&&(this.score.words=i),i&&!this.score.music&&(this.score.music=i)}break;case"Copyright":this.score.copyright=t.firstChild.innerText;break;case"Tabber":this.score.tab=t.firstChild.innerText;break;case"Instructions":this.score.instructions=t.firstChild.innerText;break;case"Notices":this.score.notices=t.firstChild.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=parseInt(t.innerText);break;case"ScoreSystemsLayout":this.score.systemsLayout=t.innerText.split(" ").map(i=>parseInt(i));break}}parseMasterTrackNode(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Automations":this.parseAutomations(t,this._masterTrackAutomations,null);break;case"Tracks":this._tracksMapping=t.innerText.split(" ");break;case"Anacrusis":this._hasAnacrusis=!0;break}}parseAutomations(e,t,i){for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Automation":this.parseAutomation(s,t,i);break}}parseAutomation(e,t,i){let s=null,r=!1,a=-1,o=0,h=0,l=null,d=0,c=null;for(let p of e.childNodes)if(p.nodeType===k.Element)switch(p.localName){case"Type":s=p.innerText;break;case"Linear":r=p.innerText.toLowerCase()==="true";break;case"Bar":a=parseInt(p.innerText);break;case"Position":o=parseFloat(p.innerText);break;case"Value":if(p.firstElement&&p.firstElement.nodeType===k.CDATA)l=p.innerText;else{let g=p.innerText.split(" ");g.length===1?(h=parseFloat(g[0]),d=1):(h=parseFloat(g[0]),d=parseInt(g[1]))}break;case"Text":c=p.innerText;break}if(!s)return;let f=null;switch(s){case"Tempo":f=st.buildTempoAutomation(r,o,h,d);break;case"Sound":l&&i&&i.has(l)&&(f=st.buildInstrumentAutomation(r,o,i.get(l).program));break}f&&(c&&(f.text=c),a>=0&&(t.has(a)||t.set(a,[]),t.get(a).push(f)))}parseTracksNode(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Track":this.parseTrack(t);break}}parseTrack(e){this._articulationByName=new Map;let t=new Jt;t.ensureStaveCount(1);let i=t.staves[0];i.showStandardNotation=!0;let s=e.getAttribute("id");for(let r of e.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"Name":t.name=r.innerText;break;case"Color":let a=r.innerText.split(" ");if(a.length>=3){let l=parseInt(a[0]),d=parseInt(a[1]),c=parseInt(a[2]);t.color=new fe(l,d,c,255)}break;case"Instrument":let o=r.getAttribute("ref");(o.endsWith("-gs")||o.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.parseInstrumentSet(t,r);break;case"NotationPatch":this.parseNotationPatch(t,r);break;case"ShortName":t.shortName=r.innerText;break;case"SystemsDefautLayout":t.defaultSystemsLayout=parseInt(r.innerText);break;case"SystemsLayout":t.systemsLayout=r.innerText.split(" ").map(l=>parseInt(l));break;case"Lyrics":this.parseLyrics(s,r);break;case"Properties":this.parseTrackProperties(t,r);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.parseGeneralMidi(t,r);break;case"Sounds":this.parseSounds(s,t,r);break;case"PlaybackState":let h=r.innerText;t.playbackInfo.isSolo=h==="Solo",t.playbackInfo.isMute=h==="Mute";break;case"PartSounding":this.parsePartSounding(t,r);break;case"Staves":this.parseStaves(t,r);break;case"Transpose":this.parseTranspose(t,r);break;case"RSE":this.parseRSE(t,r);break;case"Automations":this.parseTrackAutomations(s,r);break}this._tracksById.set(s,t)}parseTrackAutomations(e,t){const i=new Map;this._automationsPerTrackIdAndBarIndex.set(e,i),this.parseAutomations(t,i,this._soundsByTrack.get(e))}parseNotationPatch(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"LineCount":const s=parseInt(i.innerText);for(let r of e.staves)r.standardNotationLineCount=s;break;case"Elements":this.parseElements(e,i);break}}parseInstrumentSet(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Type":switch(i.innerText){case"drumKit":for(let r of e.staves)r.isPercussion=!0;break}if(i.innerText==="drumKit")for(let r of e.staves)r.isPercussion=!0;break;case"Elements":this.parseElements(e,i);break;case"LineCount":const s=parseInt(i.innerText);for(let r of e.staves)r.standardNotationLineCount=s;break}}parseElements(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Element":this.parseElement(e,i);break}}parseElement(e,t){const i=t.findChildElement("Type"),s=i?i.innerText:"";for(let r of t.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"Name":case"Articulations":this.parseArticulations(e,r,s);break}}parseArticulations(e,t,i){for(let s of t.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Articulation":this.parseArticulation(e,s,i);break}}parseArticulation(e,t,i){const s=new E;s.outputMidiNumber=-1,s.elementType=i;let r="";for(let a of t.childNodes)if(a.nodeType===k.Element){const o=a.innerText;switch(a.localName){case"Name":r=a.innerText;break;case"OutputMidiNumber":o.length>0&&(s.outputMidiNumber=parseInt(o));break;case"TechniqueSymbol":s.techniqueSymbol=this.parseTechniqueSymbol(o);break;case"TechniquePlacement":switch(o){case"outside":s.techniqueSymbolPlacement=J.Bottom;break;case"inside":s.techniqueSymbolPlacement=J.Middle;break;case"above":s.techniqueSymbolPlacement=J.Bottom;break;case"below":s.techniqueSymbolPlacement=J.Top;break}break;case"Noteheads":const h=o.split(" ");h.length>=1&&(s.noteHeadDefault=this.parseNoteHead(h[0])),h.length>=2&&(s.noteHeadHalf=this.parseNoteHead(h[1])),h.length>=3&&(s.noteHeadWhole=this.parseNoteHead(h[2])),s.noteHeadHalf==u.None&&(s.noteHeadHalf=s.noteHeadDefault),s.noteHeadWhole==u.None&&(s.noteHeadWhole=s.noteHeadDefault);break;case"StaffLine":o.length>0&&(s.staffLine=parseInt(o));break}}s.outputMidiNumber!==-1?(e.percussionArticulations.push(s),r.length>0&&this._articulationByName.set(r,s)):r.length>0&&this._articulationByName.has(r)&&(this._articulationByName.get(r).staffLine=s.staffLine)}parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return u.PictEdgeOfCymbal;case"articStaccatoAbove":return u.ArticStaccatoAbove;case"noteheadParenthesis":return u.NoteheadParenthesis;case"stringsUpBow":return u.StringsUpBow;case"stringsDownBow":return u.StringsDownBow;case"guitarGolpe":return u.GuitarGolpe;default:return u.None}}parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return u.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return u.NoteheadDoubleWhole;case"noteheadWhole":return u.NoteheadWhole;case"noteheadHalf":return u.NoteheadHalf;case"noteheadBlack":return u.NoteheadBlack;case"noteheadNull":return u.NoteheadNull;case"noteheadXOrnate":return u.NoteheadXOrnate;case"noteheadTriangleUpWhole":return u.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return u.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return u.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return u.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return u.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return u.NoteheadDiamondWhiteWide;case"noteheadCircleX":return u.NoteheadCircleX;case"noteheadXWhole":return u.NoteheadXWhole;case"noteheadXHalf":return u.NoteheadXHalf;case"noteheadXBlack":return u.NoteheadXBlack;case"noteheadParenthesis":return u.NoteheadParenthesis;case"noteheadSlashedBlack2":return u.NoteheadSlashedBlack2;case"noteheadCircleSlash":return u.NoteheadCircleSlash;case"noteheadHeavyX":return u.NoteheadHeavyX;case"noteheadHeavyXHat":return u.NoteheadHeavyXHat;default:return _.warning("GPIF","Unknown notehead symbol",e),u.None}}parseStaves(e,t){let i=0;for(let s of t.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Staff":e.ensureStaveCount(i+1);let r=e.staves[i];this.parseStaff(r,s),i++;break}}parseStaff(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Properties":this.parseStaffProperties(e,i);break}}parseStaffProperties(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Property":this.parseStaffProperty(e,i);break}}parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":for(let r of t.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"Pitches":let a=t.findChildElement("Pitches").innerText.split(" "),o=new Array(a.length);for(let h=0;h<o.length;h++)o[o.length-1-h]=parseInt(a[h]);e.stringTuning.tunings=o;break;case"Label":e.stringTuning.name=r.innerText;break}e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForStaff(e,t);break;case"CapoFret":let s=parseInt(t.findChildElement("Fret").innerText);e.capo=s;break}}parseLyrics(e,t){let i=[];for(let s of t.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Line":i.push(this.parseLyricsLine(s));break}this._lyricsByTrack.set(e,i)}parseLyricsLine(e){let t=new ze;for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Offset":t.startBar=parseInt(i.innerText);break;case"Text":t.text=i.innerText;break}return t}parseDiagramCollectionForTrack(e,t){let i=t.findChildElement("Items");for(let s of i.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Item":this.parseDiagramItemForTrack(e,s);break}}parseDiagramCollectionForStaff(e,t){let i=t.findChildElement("Items");for(let s of i.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Item":this.parseDiagramItemForStaff(e,s);break}}parseDiagramItemForTrack(e,t){let i=new bi,s=t.getAttribute("id");for(let r of e.staves)r.addChord(s,i);this.parseDiagramItemForChord(i,t)}parseDiagramItemForStaff(e,t){let i=new bi,s=t.getAttribute("id");e.addChord(s,i),this.parseDiagramItemForChord(i,t)}parseDiagramItemForChord(e,t){e.name=t.getAttribute("name");let i=t.findChildElement("Diagram");if(!i){e.showDiagram=!1,e.showFingering=!1;return}let s=parseInt(i.getAttribute("stringCount")),r=parseInt(i.getAttribute("baseFret"));e.firstFret=r+1;for(let a=0;a<s;a++)e.strings.push(-1);for(let a of i.childNodes)if(a.nodeType===k.Element)switch(a.localName){case"Fret":let o=parseInt(a.getAttribute("string"));e.strings[s-o-1]=r+parseInt(a.getAttribute("fret"));break;case"Fingering":let h=new Map;for(let l of a.childNodes)if(l.nodeType===k.Element)switch(l.localName){case"Position":let d=Y.Unknown,c=r+parseInt(l.getAttribute("fret"));switch(l.getAttribute("finger")){case"Index":d=Y.IndexFinger;break;case"Middle":d=Y.MiddleFinger;break;case"Rank":d=Y.AnnularFinger;break;case"Pinky":d=Y.LittleFinger;break;case"Thumb":d=Y.Thumb;break}d!==Y.Unknown&&(h.has(d)?e.barreFrets.push(c):h.set(d,!0));break}break;case"Property":switch(a.getAttribute("name")){case"ShowName":e.showName=a.getAttribute("value")==="true";break;case"ShowDiagram":e.showDiagram=a.getAttribute("value")==="true";break;case"ShowFingering":e.showFingering=a.getAttribute("value")==="true";break}break}}parseTrackProperties(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Property":this.parseTrackProperty(e,i);break}}parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":let s=t.findChildElement("Pitches").innerText.split(" "),r=new Array(s.length);for(let o=0;o<r.length;o++)r[r.length-1-o]=parseInt(s[o]);for(let o of e.staves)o.stringTuning.tunings=r,o.showStandardNotation=!0,o.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForTrack(e,t);break;case"CapoFret":let a=parseInt(t.findChildElement("Fret").innerText);for(let o of e.staves)o.capo=a;break}}parseGeneralMidi(e,t){for(let s of t.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Program":e.playbackInfo.program=parseInt(s.innerText);break;case"Port":e.playbackInfo.port=parseInt(s.innerText);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=parseInt(s.innerText);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=parseInt(s.innerText);break}if(t.getAttribute("table")==="Percussion")for(let s of e.staves)s.isPercussion=!0}parseSounds(e,t,i){for(let s of i.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Sound":this.parseSound(e,t,s);break}}parseSound(e,t,i){const s=new Gn;for(let r of i.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"Name":s.name=r.innerText;break;case"Path":s.path=r.innerText;break;case"Role":s.role=r.innerText;break;case"MIDI":this.parseSoundMidi(s,r);break}(s.role==="Factory"||t.playbackInfo.program===0)&&(t.playbackInfo.program=s.program),this._soundsByTrack.has(e)||this._soundsByTrack.set(e,new Map),this._soundsByTrack.get(e).set(s.uniqueId,s)}parseSoundMidi(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Program":e.program=parseInt(i.innerText);break}}parsePartSounding(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"TranspositionPitch":for(let s of e.staves)s.displayTranspositionPitch=parseInt(i.innerText);break}}parseTranspose(e,t){let i=0,s=0;for(let r of t.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"Chromatic":s=parseInt(r.innerText);break;case"Octave":i=parseInt(r.innerText);break}for(let r of e.staves)r.displayTranspositionPitch=i*12+s}parseRSE(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"ChannelStrip":this.parseChannelStrip(e,i);break}}parseChannelStrip(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Parameters":this.parseChannelStripParameters(e,i);break}}parseChannelStripParameters(e,t){if(t.firstChild&&t.firstChild.value){let i=t.firstChild.value.split(" ");i.length>=12&&(e.playbackInfo.balance=Math.floor(parseFloat(i[11])*16),e.playbackInfo.volume=Math.floor(parseFloat(i[12])*16))}}parseMasterBarsNode(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"MasterBar":this.parseMasterBar(t);break}}parseMasterBar(e){let t=new li;this._masterBars.length===0&&this._hasAnacrusis&&(t.isAnacrusis=!0);for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Time":let s=i.innerText.split("/");t.timeSignatureNumerator=parseInt(s[0]),t.timeSignatureDenominator=parseInt(s[1]);break;case"DoubleBar":t.isDoubleBar=!0;break;case"Section":t.section=new xs,t.section.marker=i.findChildElement("Letter").innerText,t.section.text=i.findChildElement("Text").innerText;break;case"Repeat":i.getAttribute("start").toLowerCase()==="true"&&(t.isRepeatStart=!0),i.getAttribute("end").toLowerCase()==="true"&&i.getAttribute("count")&&(t.repeatCount=parseInt(i.getAttribute("count")));break;case"AlternateEndings":let r=i.innerText.split(" "),a=0;for(let h=0;h<r.length;h++)a=a|1<<-1+parseInt(r[h]);t.alternateEndings=a;break;case"Bars":this._barsOfMasterBar.push(i.innerText.split(" "));break;case"TripletFeel":switch(i.innerText){case"NoTripletFeel":t.tripletFeel=ee.NoTripletFeel;break;case"Triplet8th":t.tripletFeel=ee.Triplet8th;break;case"Triplet16th":t.tripletFeel=ee.Triplet16th;break;case"Dotted8th":t.tripletFeel=ee.Dotted8th;break;case"Dotted16th":t.tripletFeel=ee.Dotted16th;break;case"Scottish8th":t.tripletFeel=ee.Scottish8th;break;case"Scottish16th":t.tripletFeel=ee.Scottish16th;break}break;case"Key":t.keySignature=parseInt(i.findChildElement("AccidentalCount").innerText);let o=i.findChildElement("Mode");if(o)switch(o.innerText.toLowerCase()){case"major":t.keySignatureType=wi.Major;break;case"minor":t.keySignatureType=wi.Minor;break}break;case"Fermatas":this.parseFermatas(t,i);break;case"XProperties":this.parseMasterBarXProperties(i,t);break}this._masterBars.push(t)}parseFermatas(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Fermata":this.parseFermata(e,i);break}}parseFermata(e,t){let i=0,s=new rr;for(let r of t.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"Type":switch(r.innerText){case"Short":s.type=Gt.Short;break;case"Medium":s.type=Gt.Medium;break;case"Long":s.type=Gt.Long;break}break;case"Length":s.length=parseFloat(r.innerText);break;case"Offset":let a=r.innerText.split("/");if(a.length===2){let o=parseInt(a[0]),h=parseInt(a[1]);i=o/h*q.QuarterTime|0}break}e.addFermata(i,s)}parseBars(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Bar":this.parseBar(t);break}}parseBar(e){let t=new oi,i=e.getAttribute("id");for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Voices":this._voicesOfBar.set(i,s.innerText.split(" "));break;case"Clef":switch(s.innerText){case"Neutral":t.clef=U.Neutral;break;case"G2":t.clef=U.G2;break;case"F4":t.clef=U.F4;break;case"C4":t.clef=U.C4;break;case"C3":t.clef=U.C3;break}break;case"Ottavia":switch(s.innerText){case"8va":t.clefOttava=le._8va;break;case"15ma":t.clefOttava=le._15ma;break;case"8vb":t.clefOttava=le._8vb;break;case"15mb":t.clefOttava=le._15mb;break}break;case"SimileMark":switch(s.innerText){case"Simple":t.simileMark=Pt.Simple;break;case"FirstOfDouble":t.simileMark=Pt.FirstOfDouble;break;case"SecondOfDouble":t.simileMark=Pt.SecondOfDouble;break}break;case"XProperties":this.parseBarXProperties(s,t);break}this._barsById.set(i,t)}parseVoices(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Voice":this.parseVoice(t);break}}parseVoice(e){let t=new Qt,i=e.getAttribute("id");for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Beats":this._beatsOfVoice.set(i,s.innerText.split(" "));break}this._voiceById.set(i,t)}parseBeats(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Beat":this.parseBeat(t);break}}parseBeat(e){let t=new rt,i=e.getAttribute("id");for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Notes":this._notesOfBeat.set(i,s.innerText.split(" "));break;case"Rhythm":this._rhythmOfBeat.set(i,s.getAttribute("ref"));break;case"Fadding":s.innerText==="FadeIn"&&(t.fadeIn=!0);break;case"Tremolo":switch(s.innerText){case"1/2":t.tremoloSpeed=m.Eighth;break;case"1/4":t.tremoloSpeed=m.Sixteenth;break;case"1/8":t.tremoloSpeed=m.ThirtySecond;break}break;case"Chord":t.chordId=s.innerText;break;case"Hairpin":switch(s.innerText){case"Crescendo":t.crescendo=mt.Crescendo;break;case"Decrescendo":t.crescendo=mt.Decrescendo;break}break;case"Arpeggio":s.innerText==="Up"?t.brushType=Se.ArpeggioUp:t.brushType=Se.ArpeggioDown;break;case"Properties":this.parseBeatProperties(s,t);break;case"XProperties":this.parseBeatXProperties(s,t);break;case"FreeText":t.text=s.innerText;break;case"TransposedPitchStemOrientation":switch(s.innerText){case"Upward":t.preferredBeamDirection=P.Up;break;case"Downward":t.preferredBeamDirection=P.Down;break}break;case"Dynamic":switch(s.innerText){case"PPP":t.dynamics=j.PPP;break;case"PP":t.dynamics=j.PP;break;case"P":t.dynamics=j.P;break;case"MP":t.dynamics=j.MP;break;case"MF":t.dynamics=j.MF;break;case"F":t.dynamics=j.F;break;case"FF":t.dynamics=j.FF;break;case"FFF":t.dynamics=j.FFF;break}break;case"GraceNotes":switch(s.innerText){case"OnBeat":t.graceType=W.OnBeat;break;case"BeforeBeat":t.graceType=W.BeforeBeat;break}break;case"Legato":s.getAttribute("origin")==="true"&&(t.isLegatoOrigin=!0);break;case"Whammy":let r=new L(0,0);r.value=this.toBendValue(parseFloat(s.getAttribute("originValue"))),r.offset=this.toBendOffset(parseFloat(s.getAttribute("originOffset"))),t.addWhammyBarPoint(r);let a=new L(0,0);a.value=this.toBendValue(parseFloat(s.getAttribute("middleValue"))),a.offset=this.toBendOffset(parseFloat(s.getAttribute("middleOffset1"))),t.addWhammyBarPoint(a);let o=new L(0,0);o.value=this.toBendValue(parseFloat(s.getAttribute("middleValue"))),o.offset=this.toBendOffset(parseFloat(s.getAttribute("middleOffset2"))),t.addWhammyBarPoint(o);let h=new L(0,0);h.value=this.toBendValue(parseFloat(s.getAttribute("destinationValue"))),h.offset=this.toBendOffset(parseFloat(s.getAttribute("destinationOffset"))),t.addWhammyBarPoint(h);break;case"Ottavia":switch(s.innerText){case"8va":t.ottava=le._8va;break;case"8vb":t.ottava=le._8vb;break;case"15ma":t.ottava=le._15ma;break;case"15mb":t.ottava=le._15mb;break}break;case"Lyrics":t.lyrics=this.parseBeatLyrics(s),this._skipApplyLyrics=!0;break}this._beatById.set(i,t)}parseBeatLyrics(e){const t=[];for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"Line":t.push(i.innerText);break}return t}parseBeatXProperties(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"XProperty":let s=i.getAttribute("id"),r=0;switch(s){case"1124204545":r=parseInt(i.findChildElement("Int").innerText),t.invertBeamDirection=r===1;break;case"687935489":r=parseInt(i.findChildElement("Int").innerText),t.brushDuration=r;break}break}}parseBarXProperties(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"XProperty":switch(i.getAttribute("id")){case"1124139520":const r=i.findChildElement("Double")??i.findChildElement("Float");t.displayScale=parseFloat(r.innerText);break}break}}parseMasterBarXProperties(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"XProperty":switch(i.getAttribute("id")){case"1124073984":t.displayScale=parseFloat(i.findChildElement("Double").innerText);break}break}}parseBeatProperties(e,t){let i=!1,s=null,r=null,a=null,o=null,h=null;for(let l of e.childNodes)if(l.nodeType===k.Element)switch(l.localName){case"Property":switch(l.getAttribute("name")){case"Brush":l.findChildElement("Direction").innerText==="Up"?t.brushType=Se.BrushUp:t.brushType=Se.BrushDown;break;case"PickStroke":l.findChildElement("Direction").innerText==="Up"?t.pickStroke=je.Up:t.pickStroke=je.Down;break;case"Slapped":l.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":l.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(l.findChildElement("Strength").innerText){case"Wide":t.vibrato=oe.Wide;break;case"Slight":t.vibrato=oe.Slight;break}break;case"WhammyBar":i=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":s||(s=new L(0,0)),s.value=this.toBendValue(parseFloat(l.findChildElement("Float").innerText));break;case"WhammyBarOriginOffset":s||(s=new L(0,0)),s.offset=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"WhammyBarMiddleValue":r=this.toBendValue(parseFloat(l.findChildElement("Float").innerText));break;case"WhammyBarMiddleOffset1":a=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"WhammyBarMiddleOffset2":o=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"WhammyBarDestinationValue":h||(h=new L(L.MaxPosition,0)),h.value=this.toBendValue(parseFloat(l.findChildElement("Float").innerText));break;case"WhammyBarDestinationOffset":h||(h=new L(0,0)),h.offset=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break}break}i&&(s||(s=new L(0,0)),h||(h=new L(L.MaxPosition,0)),t.addWhammyBarPoint(s),a&&r&&t.addWhammyBarPoint(new L(a,r)),o&&r&&t.addWhammyBarPoint(new L(o,r)),!a&&!o&&r&&t.addWhammyBarPoint(new L(L.MaxPosition/2|0,r)),t.addWhammyBarPoint(h))}parseNotes(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Note":this.parseNote(t);break}}parseNote(e){let t=new Ee,i=e.getAttribute("id");for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Properties":this.parseNoteProperties(s,t,i);break;case"AntiAccent":s.innerText.toLowerCase()==="normal"&&(t.isGhost=!0);break;case"LetRing":t.isLetRing=!0;break;case"Trill":t.trillValue=parseInt(s.innerText),t.trillSpeed=m.Sixteenth;break;case"Accent":let r=parseInt(s.innerText);r&1&&(t.isStaccato=!0),r&4&&(t.accentuated=He.Heavy),r&8&&(t.accentuated=He.Normal);break;case"Tie":s.getAttribute("destination").toLowerCase()==="true"&&(t.isTieDestination=!0);break;case"Vibrato":switch(s.innerText){case"Slight":t.vibrato=oe.Slight;break;case"Wide":t.vibrato=oe.Wide;break}break;case"LeftFingering":switch(t.isFingering=!0,s.innerText){case"P":t.leftHandFinger=Y.Thumb;break;case"I":t.leftHandFinger=Y.IndexFinger;break;case"M":t.leftHandFinger=Y.MiddleFinger;break;case"A":t.leftHandFinger=Y.AnnularFinger;break;case"C":t.leftHandFinger=Y.LittleFinger;break}break;case"RightFingering":switch(t.isFingering=!0,s.innerText){case"P":t.rightHandFinger=Y.Thumb;break;case"I":t.rightHandFinger=Y.IndexFinger;break;case"M":t.rightHandFinger=Y.MiddleFinger;break;case"A":t.rightHandFinger=Y.AnnularFinger;break;case"C":t.rightHandFinger=Y.LittleFinger;break}break;case"InstrumentArticulation":t.percussionArticulation=parseInt(s.innerText);break}this._noteById.set(i,t)}parseNoteProperties(e,t,i){let s=!1,r=null,a=null,o=null,h=null,l=null,d=-1,c=-1;for(let f of e.childNodes)if(f.nodeType===k.Element)switch(f.localName){case"Property":switch(f.getAttribute("name")){case"String":t.string=parseInt(f.findChildElement("String").innerText)+1;break;case"Fret":t.fret=parseInt(f.findChildElement("Fret").innerText);break;case"Element":d=parseInt(f.findChildElement("Element").innerText);break;case"Variation":c=parseInt(f.findChildElement("Variation").innerText);break;case"Tapped":this._tappedNotes.set(i,!0);break;case"HarmonicType":let g=f.findChildElement("HType");if(g)switch(g.innerText){case"NoHarmonic":t.harmonicType=O.None;break;case"Natural":t.harmonicType=O.Natural;break;case"Artificial":t.harmonicType=O.Artificial;break;case"Pinch":t.harmonicType=O.Pinch;break;case"Tap":t.harmonicType=O.Tap;break;case"Semi":t.harmonicType=O.Semi;break;case"Feedback":t.harmonicType=O.Feedback;break}break;case"HarmonicFret":let b=f.findChildElement("HFret");b&&(t.harmonicValue=parseFloat(b.innerText));break;case"Muted":f.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":f.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=parseInt(f.findChildElement("Number").innerText),t.tone===-1&&(t.tone=0);break;case"Tone":t.tone=parseInt(f.findChildElement("Step").innerText);break;case"ConcertPitch":this.parseConcertPitch(f,t);break;case"Bended":s=!0;break;case"BendOriginValue":r||(r=new L(0,0)),r.value=this.toBendValue(parseFloat(f.findChildElement("Float").innerText));break;case"BendOriginOffset":r||(r=new L(0,0)),r.offset=this.toBendOffset(parseFloat(f.findChildElement("Float").innerText));break;case"BendMiddleValue":a=this.toBendValue(parseFloat(f.findChildElement("Float").innerText));break;case"BendMiddleOffset1":o=this.toBendOffset(parseFloat(f.findChildElement("Float").innerText));break;case"BendMiddleOffset2":h=this.toBendOffset(parseFloat(f.findChildElement("Float").innerText));break;case"BendDestinationValue":l||(l=new L(L.MaxPosition,0)),l.value=this.toBendValue(parseFloat(f.findChildElement("Float").innerText));break;case"BendDestinationOffset":l||(l=new L(0,0)),l.offset=this.toBendOffset(parseFloat(f.findChildElement("Float").innerText));break;case"HopoOrigin":f.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":t.isLeftHandTapped=!0;break;case"Slide":let w=parseInt(f.findChildElement("Flags").innerText);w&1?t.slideOutType=Q.Shift:w&2?t.slideOutType=Q.Legato:w&4?t.slideOutType=Q.OutDown:w&8&&(t.slideOutType=Q.OutUp),w&16?t.slideInType=$e.IntoFromBelow:w&32&&(t.slideInType=$e.IntoFromAbove),w&64?t.slideOutType=Q.PickSlideDown:w&128&&(t.slideOutType=Q.PickSlideUp);break}break}s&&(r||(r=new L(0,0)),l||(l=new L(L.MaxPosition,0)),t.addBendPoint(r),o&&a&&t.addBendPoint(new L(o,a)),h&&a&&t.addBendPoint(new L(h,a)),!o&&!h&&a&&t.addBendPoint(new L(L.MaxPosition/2|0,a)),t.addBendPoint(l)),d!==-1&&c!==-1&&(t.percussionArticulation=Ae.articulationFromElementVariation(d,c))}parseConcertPitch(e,t){const i=e.findChildElement("Pitch");if(i){for(let s of i.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"Accidental":switch(s.innerText){case"x":t.accidentalMode=Me.ForceDoubleSharp;break;case"#":t.accidentalMode=Me.ForceSharp;break;case"b":t.accidentalMode=Me.ForceFlat;break;case"bb":t.accidentalMode=Me.ForceDoubleFlat;break}break}}}toBendValue(e){return e*Dt.BendPointValueFactor|0}toBendOffset(e){return e*Dt.BendPointPositionFactor}parseRhythms(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"Rhythm":this.parseRhythm(t);break}}parseRhythm(e){let t=new Hn,i=e.getAttribute("id");t.id=i;for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":t.value=m.QuadrupleWhole;break;case"DoubleWhole":t.value=m.DoubleWhole;break;case"Whole":t.value=m.Whole;break;case"Half":t.value=m.Half;break;case"Quarter":t.value=m.Quarter;break;case"Eighth":t.value=m.Eighth;break;case"16th":t.value=m.Sixteenth;break;case"32nd":t.value=m.ThirtySecond;break;case"64th":t.value=m.SixtyFourth;break;case"128th":t.value=m.OneHundredTwentyEighth;break;case"256th":t.value=m.TwoHundredFiftySixth;break}break;case"PrimaryTuplet":t.tupletNumerator=parseInt(s.getAttribute("num")),t.tupletDenominator=parseInt(s.getAttribute("den"));break;case"AugmentationDot":t.dots=parseInt(s.getAttribute("count"));break}this._rhythmById.set(i,t)}buildModel(){for(let e=0,t=this._masterBars.length;e<t;e++){let i=this._masterBars[e];this.score.addMasterBar(i)}for(let e of this._tracksMapping){if(!e)continue;let t=this._tracksById.get(e);this.score.addTrack(t)}for(let e of this._barsOfMasterBar){let t=0;for(let i=0,s=0;i<e.length&&s<this.score.tracks.length;i++){let r=e[i];if(r!==Dt.InvalidId){let a=this._barsById.get(r),o=this.score.tracks[s],h=o.staves[t];if(h.addBar(a),this._voicesOfBar.has(r))for(let l of this._voicesOfBar.get(r))if(l!==Dt.InvalidId){let d=this._voiceById.get(l);if(a.addVoice(d),this._beatsOfVoice.has(l)){for(let c of this._beatsOfVoice.get(l))if(c!==Dt.InvalidId){let f=ir.clone(this._beatById.get(c));d.addBeat(f);let p=this._rhythmOfBeat.get(c),g=this._rhythmById.get(p);if(f.duration=g.value,f.dots=g.dots,f.tupletNumerator=g.tupletNumerator,f.tupletDenominator=g.tupletDenominator,this._notesOfBeat.has(c)){for(let b of this._notesOfBeat.get(c))if(b!==Dt.InvalidId){const w=oa.clone(this._noteById.get(b));h.isPercussion?(w.fret=-1,w.string=-1):w.percussionArticulation=-1,f.addNote(w),this._tappedNotes.has(b)&&(f.tap=!0)}}}}}else{let d=new Qt;a.addVoice(d);let c=new rt;c.isEmpty=!0,c.duration=m.Quarter,d.addBeat(c)}t===o.staves.length-1?(s++,t=0):t++}else s++}}for(let e of this._tracksMapping){if(!e)continue;let t=this._tracksById.get(e),i=!1;for(const s of t.staves)if(s.isPercussion){i=!0;break}if(i||(t.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(e)){const s=this._automationsPerTrackIdAndBarIndex.get(e);for(const[r,a]of s)if(t.staves.length>0&&r<t.staves[0].bars.length){const o=t.staves[0].bars[r];if(o.voices.length>0&&o.voices[0].beats.length>0){const h=o.voices[0].beats[0];for(const l of a)h.automations.push(l)}}}}for(const[e,t]of this._masterTrackAutomations){let i=this.score.masterBars[e];for(let s=0,r=t.length;s<r;s++){let a=t[s];a.type===Ge.Tempo&&(e===0&&(this.score.tempo=a.value|0,a.text&&(this.score.tempoLabel=a.text)),i.tempoAutomations.push(a))}}}}Dt.InvalidId="-1",Dt.BendPointPositionFactor=L.MaxPosition/100,Dt.BendPointValueFactor=1/25;class nr{constructor(){this.isMultiRest=!1,this.trackViewGroups=[]}}class ca{constructor(){this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}}class ua{apply(e){if(this.scoreViews.length>0){let t=0;for(let i of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){const s=e.tracks[t];for(const r of s.staves)r.showTablature=i.showTablature,r.showStandardNotation=i.showStandardNotation,r.showSlash=i.showSlash}t++}}}constructor(e){this.scoreViews=[];let t=Ke.fromBuffer(e);const i=S.readInt32BE(t);for(let s=0;s<i;s++){const r=new nr;this.scoreViews.push(r),r.isMultiRest=he.gpReadBool(t);const a=S.readInt32BE(t);for(let o=0;o<a;o++){let h=t.readByte();h===0&&(h=1);let l=new ca;l.showStandardNotation=(h&1)!==0,l.showTablature=(h&2)!==0,l.showSlash=(h&4)!==0,r.trackViewGroups.push(l)}}}static writeForScore(e){const t=Ke.withCapacity(128),i=[new nr];for(const s of e.tracks){const r=new ca;r.showStandardNotation=s.staves[0].showStandardNotation,r.showTablature=s.staves[0].showTablature,r.showSlash=s.staves[0].showSlash,i[0].trackViewGroups.push(r);const a=new nr;a.trackViewGroups.push(r),i.push(a)}S.writeInt32BE(t,i.length);for(const s of i){t.writeByte(s.isMultiRest?1:0),S.writeInt32BE(t,s.trackViewGroups.length);for(const r of s.trackViewGroups){let a=0;r.showStandardNotation&&(a=a|1),r.showTablature&&(a=a|2),r.showSlash&&(a=a|4),t.writeByte(a)}}return S.writeInt32BE(t,1),t.toArray()}}class or{}class Cs extends or{constructor(e){super(),this.n=e}}class Fi extends or{constructor(e,t){super(),this.left=e,this.right=t}}class hr extends or{constructor(e,t){super(),this.n=e,this.table=t}}class tt{static make(e,t,i,s){let r=[],a=[];if(s>32)throw new Ue("Invalid huffman");for(let l=0;l<s;l++)r.push(0),a.push(0);for(let l=0;l<i;l++){let d=e[l+t];if(d>=s)throw new Ue("Invalid huffman");r[d]++}let o=0;for(let l=1;l<s-1;l++)o=o+r[l]<<1,a[l]=o;let h=new Map;for(let l=0;l<i;l++){let d=e[l+t];if(d!==0){let c=a[d-1];a[d-1]=c+1,h.set(c<<5|d,l)}}return tt.treeCompress(new Fi(tt.treeMake(h,s,0,1),tt.treeMake(h,s,1,1)))}static treeMake(e,t,i,s){if(s>t)throw new Ue("Invalid huffman");let r=i<<5|s;return e.has(r)?new Cs(e.get(r)):(i=i<<1,s+=1,new Fi(tt.treeMake(e,t,i,s),tt.treeMake(e,t,i|1,s)))}static treeCompress(e){let t=tt.treeDepth(e);if(t===0)return e;if(t===1){if(e instanceof Fi)return new Fi(tt.treeCompress(e.left),tt.treeCompress(e.right));throw new Ue("assert")}let i=1<<t,s=[];for(let r=0;r<i;r++)s.push(new Cs(-1));return tt.treeWalk(s,0,0,t,e),new hr(t,s)}static treeWalk(e,t,i,s,r){r instanceof Fi&&s>0?(tt.treeWalk(e,t,i+1,s-1,r.left),tt.treeWalk(e,t|1<<i,i+1,s-1,r.right)):e[t]=tt.treeCompress(r)}static treeDepth(e){if(e instanceof Cs)return 0;if(e instanceof hr)throw new Ue("assert");if(e instanceof Fi){let t=tt.treeDepth(e.left),i=tt.treeDepth(e.right);return 1+(t<i?t:i)}return 0}}var Oe;(function(n){n[n.Head=0]="Head",n[n.Block=1]="Block",n[n.CData=2]="CData",n[n.Flat=3]="Flat",n[n.Crc=4]="Crc",n[n.Dist=5]="Dist",n[n.DistOne=6]="DistOne",n[n.Done=7]="Done"})(Oe||(Oe={}));class Ut{constructor(){this.buffer=new Uint8Array(Ut.BufferSize),this.pos=0}slide(){let e=new Uint8Array(Ut.BufferSize);this.pos-=Ut.Size,e.set(this.buffer.subarray(Ut.Size,Ut.Size+this.pos),0),this.buffer=e}addBytes(e,t,i){this.pos+i>Ut.BufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+i),this.pos),this.pos+=i}addByte(e){this.pos===Ut.BufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}Ut.Size=32768,Ut.BufferSize=65536;class ft{static buildFixedHuffman(){let e=[];for(let t=0;t<288;t++)e.push(t<=143?8:t<=255?9:t<=279?7:8);return tt.make(e,0,288,10)}constructor(e){this._nbits=0,this._bits=0,this._state=Oe.Block,this._isFinal=!1,this._huffman=ft._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new Ut,this._input=e;for(let t=0;t<19;t++)this._lengths.push(-1)}readBytes(e,t,i){if(this._needed=i,this._outpos=t,this._output=e,i>0)for(;this.inflateLoop(););return i-this._needed}inflateLoop(){switch(this._state){case Oe.Head:let e=this._input.readByte();if((e&15)!==8)throw new Ue("Invalid data");let i=this._input.readByte(),s=(i&32)!==0;if(((e<<8)+i)%31!==0)throw new Ue("Invalid data");if(s)throw new Ue("Unsupported dictionary");return this._state=Oe.Block,!0;case Oe.Crc:return this._state=Oe.Done,!0;case Oe.Done:return!1;case Oe.Block:switch(this._isFinal=this.getBit(),this.getBits(2)){case 0:if(this._len=S.readUInt16LE(this._input),S.readUInt16LE(this._input)!==65535-this._len)throw new Ue("Invalid data");this._state=Oe.Flat;let o=this.inflateLoop();return this.resetBits(),o;case 1:return this._huffman=ft._fixedHuffman,this._huffdist=null,this._state=Oe.CData,!0;case 2:let h=this.getBits(5)+257,l=this.getBits(5)+1,d=this.getBits(4)+4;for(let f=0;f<d;f++)this._lengths[ft.CodeLengthsPos[f]]=this.getBits(3);for(let f=d;f<19;f++)this._lengths[ft.CodeLengthsPos[f]]=0;this._huffman=tt.make(this._lengths,0,19,8);let c=[];for(let f=0;f<h+l;f++)c.push(0);return this.inflateLengths(c,h+l),this._huffdist=tt.make(c,h,l,16),this._huffman=tt.make(c,0,h,16),this._state=Oe.CData,!0;default:throw new Ue("Invalid data")}case Oe.Flat:{let a=this._len<this._needed?this._len:this._needed,o=S.readByteArray(this._input,a);return this._len-=a,this.addBytes(o,0,a),this._len===0&&(this._state=this._isFinal?Oe.Crc:Oe.Block),this._needed>0}case Oe.DistOne:{let a=this._len<this._needed?this._len:this._needed;return this.addDistOne(a),this._len-=a,this._len===0&&(this._state=Oe.CData),this._needed>0}case Oe.Dist:for(;this._len>0&&this._needed>0;){let a=this._len<this._dist?this._len:this._dist,o=this._needed<a?this._needed:a;this.addDist(this._dist,o),this._len-=o}return this._len===0&&(this._state=Oe.CData),this._needed>0;case Oe.CData:let r=this.applyHuffman(this._huffman);if(r<256)return this.addByte(r),this._needed>0;if(r===256)return this._state=this._isFinal?Oe.Crc:Oe.Block,!0;{r=r-257&255;let a=ft.LenExtraBitsTbl[r];if(a===-1)throw new Ue("Invalid data");this._len=ft.LenBaseValTbl[r]+this.getBits(a);let o=this._huffdist,h=o?this.applyHuffman(o):this.getRevBits(5);if(a=ft.DistExtraBitsTbl[h],a===-1)throw new Ue("Invalid data");if(this._dist=ft.DistBaseValTbl[h]+this.getBits(a),this._dist>this._window.available())throw new Ue("Invalid data");return this._state=this._dist===1?Oe.DistOne:Oe.Dist,!0}}return!1}addDistOne(e){let t=this._window.getLastChar();for(let i=0;i<e;i++)this.addByte(t)}addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}addDist(e,t){this.addBytes(this._window.buffer,this._window.pos-e,t)}getBit(){this._nbits===0&&(this._nbits=8,this._bits=this._input.readByte());let e=(this._bits&1)===1;return this._nbits--,this._bits=this._bits>>1,e}getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;let t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}getRevBits(e){return e===0?0:this.getBit()?1<<e-1|this.getRevBits(e-1):this.getRevBits(e-1)}resetBits(){this._bits=0,this._nbits=0}addBytes(e,t,i){this._window.addBytes(e,t,i),this._output.set(e.subarray(t,t+i),this._outpos),this._needed-=i,this._outpos+=i}inflateLengths(e,t){let i=0,s=0;for(;i<t;){let r=this.applyHuffman(this._huffman);switch(r){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:s=r,e[i]=r,i++;break;case 16:let a=i+3+this.getBits(2);if(a>t)throw new Ue("Invalid data");for(;i<a;)e[i]=s,i++;break;case 17:if(i+=3+this.getBits(3),i>t)throw new Ue("Invalid data");break;case 18:if(i+=11+this.getBits(7),i>t)throw new Ue("Invalid data");break;default:throw new Ue("Invalid data")}}}applyHuffman(e){if(e instanceof Cs)return e.n;if(e instanceof Fi)return this.applyHuffman(this.getBit()?e.right:e.left);if(e instanceof hr)return this.applyHuffman(e.table[this.getBits(e.n)]);throw new Ue("Invalid data")}}ft.LenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],ft.LenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],ft.DistExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],ft.DistBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],ft.CodeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ft._fixedHuffman=ft.buildFixedHuffman();class di{constructor(e,t){this.fullName=e;let i=e.lastIndexOf("/");this.fileName=i===-1||i===e.length-1?this.fullName:e.substr(i+1),this.data=t}}di.OptionalDataDescriptorSignature=134695760,di.CompressionMethodDeflate=8,di.LocalFileHeaderSignature=67324752,di.CentralFileHeaderSignature=33639248,di.EndOfCentralDirSignature=101010256;class lr{constructor(e){this._readable=e}read(){let e=[];for(;;){let t=this.readEntry();if(!t)break;e.push(t)}return e}readEntry(){let e=this._readable;if(S.readInt32LE(e)!==di.LocalFileHeaderSignature)return null;S.readUInt16LE(e);let i=S.readUInt16LE(e),s=S.readUInt16LE(e),r=s!==0;if(r&&s!==di.CompressionMethodDeflate)return null;S.readInt16LE(this._readable),S.readInt16LE(this._readable),S.readInt32LE(e),S.readInt32LE(e);let a=S.readInt32LE(e),o=S.readInt16LE(e),h=S.readInt16LE(e),l=S.toString(S.readByteArray(e,o),"utf-8");e.skip(h);let d;if(r){let c=Ke.empty(),f=new ft(this._readable),p=new Uint8Array(65536);for(;;){let g=f.readBytes(p,0,p.length);if(c.write(p,0,g),g<p.length)break}d=c.toArray()}else d=S.readByteArray(this._readable,a);return i&8&&(S.readInt32LE(this._readable)===di.OptionalDataDescriptorSignature&&S.readInt32LE(this._readable),S.readInt32LE(this._readable),S.readInt32LE(this._readable)),new di(l,d)}}class zn{constructor(){this.trackViewGroups=[]}}class Un{constructor(){this.isVisible=!1}}var dr;(function(n){n[n.PageVertical=0]="PageVertical",n[n.PageGrid=1]="PageGrid",n[n.PageParchment=2]="PageParchment",n[n.ScreenVertical=3]="ScreenVertical",n[n.ScreenHorizontal=4]="ScreenHorizontal",n[n.PageHorizontal=5]="PageHorizontal"})(dr||(dr={}));class fa{constructor(e,t){this.zoomLevel=4,this.view=dr.PageVertical,this.muiltiVoiceCursor=!1,this.scoreViews=[];const i=Ke.fromBuffer(t);this.zoomLevel=S.readInt32BE(i),this.view=i.readByte(),this.muiltiVoiceCursor=i.readByte()!=0;const s=e.scoreViews.length;for(let r=0;r<s;r++){const a=new zn;this.scoreViews.push(a);const o=e.scoreViews[r];for(let h=0;h<o.trackViewGroups.length;h++){const l=new Un;l.isVisible=i.readByte()!=0,a.trackViewGroups.push(l)}}}apply(e){if(this.scoreViews.length>0){let t=0;for(let i of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){const s=e.tracks[t];s.isVisibleOnMultiTrack=i.isVisible}t++}}}static writeForScore(e){const t=Ke.withCapacity(128);S.writeInt32BE(t,4),t.writeByte(0);const i=e.tracks.length>0&&e.tracks[0].staves[0].bars[0].isMultiVoice;t.writeByte(i?255:0);for(const s of e.tracks)t.writeByte(s.isVisibleOnMultiTrack?255:0);for(const s of e.tracks)t.writeByte(255);return t.toArray()}}class Yn extends Gi{get name(){return"Guitar Pro 7-8"}constructor(){super()}readScore(){_.debug(this.name,"Loading ZIP entries");let e=new lr(this.data),t;try{t=e.read()}catch(d){throw new xe("No Zip archive",d)}_.debug(this.name,"Zip entries loaded");let i=null,s=null,r=null,a=null;for(let d of t)switch(d.fileName){case"score.gpif":i=S.toString(d.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=d.data;break;case"PartConfiguration":r=d.data;break;case"LayoutConfiguration":a=d.data;break}if(!i)throw new xe("No score.gpif found in zip archive");_.debug(this.name,"Start Parsing score.gpif");let o=new Dt;o.parseXml(i,this.settings),_.debug(this.name,"score.gpif parsed");let h=o.score;s&&(_.debug(this.name,"Start Parsing BinaryStylesheet"),new Ns(s).apply(h),_.debug(this.name,"BinaryStylesheet parsed"));let l=null;return r&&(_.debug(this.name,"Start Parsing Part Configuration"),l=new ua(r),l.apply(h),_.debug(this.name,"Part Configuration parsed")),a&&l!=null&&(_.debug(this.name,"Start Parsing Layout Configuration"),new fa(l,a).apply(h),_.debug(this.name,"Layout Configuration parsed")),h}}class is extends nt{constructor(){super(at.Format,"Unexpected end of data within reader"),Object.setPrototypeOf(this,is.prototype)}}class ss{constructor(e){this._currentByte=0,this._position=ss.ByteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(e){const t=new Uint8Array(e);for(let i=0;i<e;i++)t[i]=this.readByte()&255;return t}readBits(e){let t=0,i=e-1;for(;i>=0;)t=t|this.readBit()<<i,i--;return t}readBitsReversed(e){let t=0;for(let i=0;i<e;i++)t=t|this.readBit()<<i;return t}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),this._currentByte===-1)throw new is;this._position=0}const e=this._currentByte>>ss.ByteSize-this._position-1&1;return this._position++,e}readAll(){let e=Ke.empty();try{for(;;)e.writeByte(this.readByte()&255)}catch(t){if(!(t instanceof is))throw t}return e.toArray()}}ss.ByteSize=8;class Xn{constructor(){this.fileName="",this.fileSize=0,this.data=null}}class cr{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){let t=new ss(e);this.readBlock(t)}readHeader(e){return this.getString(e.readBytes(4),0,4)}decompress(e,t=!1){let i=Ke.empty(),s,r=this.getInteger(e.readBytes(4),0);try{for(;i.length<r;)if(e.readBits(1)===1){let c=e.readBits(4),f=e.readBitsReversed(c),p=e.readBitsReversed(c),g=i.length-f,b=Math.min(f,p);s=i.getBuffer(),i.write(s,g,b)}else{let c=e.readBitsReversed(2);for(let f=0;f<c;f++)i.writeByte(e.readByte())}}catch(d){if(!(d instanceof is))throw d}s=i.getBuffer();let a=t?4:0,o=i.length-a,h=new Uint8Array(o),l=o;return h.set(s.subarray(a,a+l),0),h}readBlock(e){let t=this.readHeader(e);if(t==="BCFZ")this.readUncompressedBlock(this.decompress(e,!0));else if(t==="BCFS")this.readUncompressedBlock(e.readAll());else throw new xe("Unsupported format")}readUncompressedBlock(e){let t=4096,i=t;for(;i+3<e.length;){if(this.getInteger(e,i)===2){let r=new Xn;r.fileName=this.getString(e,i+4,127),r.fileSize=this.getInteger(e,i+140);let a=!this.fileFilter||this.fileFilter(r.fileName);a&&this.files.push(r);let o=i+148,h=0,l=0,d=a?Ke.withCapacity(r.fileSize):null;for(;h=this.getInteger(e,o+4*l++),h!==0;)i=h*t,a&&d.write(e,i,t);if(a){r.data=new Uint8Array(Math.min(r.fileSize,d.length));let c=d.toArray();r.data.set(c.subarray(0,0+r.data.length),0)}}i+=t}}getString(e,t,i){let s="";for(let r=0;r<i;r++){let a=e[t+r]&255;if(a===0)break;s+=String.fromCharCode(a)}return s}getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}}cr.HeaderBcFs="BCFS",cr.HeaderBcFz="BCFZ";class qn extends Gi{get name(){return"Guitar Pro 6"}constructor(){super()}readScore(){_.debug(this.name,"Loading GPX filesystem");let e=new cr;e.fileFilter=l=>l.endsWith("score.gpif")||l.endsWith("BinaryStylesheet")||l.endsWith("PartConfiguration")||l.endsWith("LayoutConfiguration"),e.load(this.data),_.debug(this.name,"GPX filesystem loaded");let t=null,i=null,s=null,r=null;for(let l of e.files)switch(l.fileName){case"score.gpif":t=S.toString(l.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=l.data;break;case"PartConfiguration":s=l.data;break;case"LayoutConfiguration":r=l.data;break}if(!t)throw new xe("No score.gpif found in GPX");_.debug(this.name,"Start Parsing score.gpif");let a=new Dt;a.parseXml(t,this.settings),_.debug(this.name,"score.gpif parsed");let o=a.score;i&&(_.debug(this.name,"Start Parsing BinaryStylesheet"),new Ns(i).apply(o),_.debug(this.name,"BinaryStylesheet parsed"));let h=null;return s&&(_.debug(this.name,"Start Parsing Part Configuration"),h=new ua(s),h.apply(o),_.debug(this.name,"Part Configuration parsed")),r&&h!=null&&(_.debug(this.name,"Start Parsing Layout Configuration"),new fa(h,r).apply(o),_.debug(this.name,"Layout Configuration parsed")),o}}class Jn extends Gi{get name(){return"MusicXML"}constructor(){super(),this._currentPartGroup=null,this._trackFirstMeasureNumber=0,this._maxVoices=0,this._currentDirection=null,this._currentChord=null,this._divisionsPerQuarterNote=0,this._voiceOfStaff=new Map,this._isBeamContinue=!1,this._previousBeatWasPulled=!1,this._previousBeat=null}readScore(){this._trackById=new Map,this._partGroups=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._slurStarts=new Map;let e=this.extractMusicXml(),t=new Ps;try{t.parse(e)}catch{throw new xe("Unsupported format")}return this._score=new Li,this._score.tempo=120,this.parseDom(t),this.settings.importer.mergePartGroupsInMusicXml&&this.mergePartGroups(),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}extractMusicXml(){const e=new lr(this.data);let t;try{t=e.read()}catch{t=[]}if(t.length===0)return this.data.reset(),S.toString(this.data.readAll(),this.settings.importer.encoding);const i=t.find(l=>l.fullName==="META-INF/container.xml");if(!i)throw new xe("No compressed MusicXML");const s=new Ps;try{s.parse(S.toString(i.data,this.settings.importer.encoding))}catch(l){throw new xe("Malformed container.xml, could not parse as XML",l)}let r=s.firstElement;if(!r||r.localName!=="container")throw new xe("Malformed container.xml, root element not 'container'");const a=r.findChildElement("rootfiles");if(!a)throw new xe("Malformed container.xml, 'container/rootfiles' not found");let o="";for(const l of a.childNodes)if(l.nodeType==k.Element&&l.localName==="rootfile"){o=l.getAttribute("full-path");break}if(!o)throw new xe("Unsupported compressed MusicXML, missing rootfile");const h=t.find(l=>l.fullName===o);if(!h)throw new xe(`Malformed container.xml, '${o}' not contained in zip`);return S.toString(h.data,this.settings.importer.encoding)}mergePartGroups(){let e=!1;for(const t of this._partGroups.values())t.length>1&&(this.mergeGroup(t),e=!0);if(e)for(let t=0;t<this._score.tracks.length;t++)this._score.tracks[t].index=t}mergeGroup(e){let t=e[0];for(let i=1;i<e.length;i++){let s=e[i];for(let a of s.staves)t.addStaff(a);let r=this._score.tracks.indexOf(s);this._score.tracks.splice(r,1)}}parseDom(e){let t=e.firstElement;if(!t)throw new xe("Unsupported format");switch(t.localName){case"score-partwise":this.parsePartwise(t);break;case"score-timewise":break;default:throw new xe("Unsupported format")}}parsePartwise(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"work":this.parseWork(t);break;case"movement-title":this._score.title=t.innerText;break;case"identification":this.parseIdentification(t);break;case"part-list":this.parsePartList(t);break;case"part":this.parsePart(t);break}}parseWork(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"work-title":this._score.title=t.innerText;break}}parsePart(e){let t=e.getAttribute("id");if(!this._trackById.has(t))if(this._trackById.size===1){for(const[r,a]of this._trackById)(a.staves.length===0||a.staves[0].bars.length===0)&&(t=r);if(!this._trackById.has(t))return}else return;let i=this._trackById.get(t),s=!0;this._maxVoices=0;for(let r of e.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"measure":this.parseMeasure(r,i,s)&&(s=!1);break}for(let r of i.staves)for(let a of r.bars)this.ensureVoices(a)}parseMeasure(e,t,i){if(e.getAttribute("implicit")==="yes"&&e.getElementsByTagName("note",!1).length===0)return!1;let s=0;if(i)this._divisionsPerQuarterNote=0,this._trackFirstMeasureNumber=parseInt(e.getAttribute("number")),this._trackFirstMeasureNumber||(this._trackFirstMeasureNumber=0),s=0;else{if(s=parseInt(e.getAttribute("number")),!s)return!1;s-=this._trackFirstMeasureNumber}if(i){let h=e.getElementsByTagName("attributes",!1);if(h.length>0){let l=h[0].getElementsByTagName("staves",!1);if(l.length>0){let d=parseInt(l[0].innerText);t.ensureStaveCount(d)}}}let r=new Array(t.staves.length),a=null;for(let h=t.staves[0].bars.length;h<=s;h++)for(let l=0;l<t.staves.length;l++){let d=new oi;if(r[l]=d,t.staves[l].bars.length>0){let c=t.staves[l].bars[t.staves[l].bars.length-1];d.clef=c.clef}a=this.getOrCreateMasterBar(s),t.staves[l].addBar(d),this.ensureVoices(d)}let o=new Map;if(a){let h=!1;for(let l of e.childNodes)if(l.nodeType===k.Element)switch(l.localName){case"note":this.parseNoteBeat(l,r);break;case"forward":this.parseForward(l,r);break;case"direction":this.parseDirection(l,a);break;case"attributes":h||(this.parseAttributes(l,r,a,t),h=!0);break;case"harmony":this.parseHarmony(l,t,o);break;case"sound":break;case"barline":this.parseBarline(l,a);break}}return!0}ensureVoices(e){for(;e.voices.length<this._maxVoices;){let t=new Qt;e.addVoice(t);let i=new rt;i.isEmpty=!0,i.chordId=this._currentChord,t.addBeat(i)}}getOrCreateBeat(e,t,i){let s=0,r=e.getElementsByTagName("voice",!1);r.length>0&&(s=parseInt(r[0].innerText)-1);let a=this._previousBeatWasPulled;this._previousBeatWasPulled=!1;let o=e.getElementsByTagName("staff",!1),h=1;if(o.length>0){h=parseInt(o[0].innerText),(this._isBeamContinue||a)&&this._previousBeat.voice.bar.staff.index!==h-1&&(h=this._previousBeat.voice.bar.staff.index+1,this._previousBeatWasPulled=!0);let f=t[0].staff.track.index+"-"+h;this._voiceOfStaff.has(f)||this._voiceOfStaff.set(f,s)}h--;let l;h<0?l=t[0]:h>=t.length?l=t[t.length-1]:l=t[h];let d,c=this.getOrCreateVoice(l,s);return i&&c.beats.length>0||c.beats.length===1&&c.isEmpty?d=c.beats[c.beats.length-1]:(d=new rt,d.isEmpty=!1,c.addBeat(d)),this._isBeamContinue=!1,this._previousBeat=d,d}parseForward(e,t){let i=this.getOrCreateBeat(e,t,!1),r=parseInt(e.findChildElement("duration").innerText)*m.Quarter/this._divisionsPerQuarterNote,a=[m.SixtyFourth,m.ThirtySecond,m.Sixteenth,m.Eighth,m.Quarter,m.Half,m.Whole];for(let o of a)if(r>=o){i.duration=o,r-=o;break}i.isEmpty=!1}parseStaffDetails(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"staff-lines":for(let s of t.staves)s.stringTuning.tunings=new Array(parseInt(i.innerText)).fill(0);break;case"staff-tuning":this.parseStaffTuning(i,t);break}for(let i of t.staves)this.isEmptyTuning(i.tuning)&&(i.stringTuning.tunings=[])}parseStaffTuning(e,t){let i=parseInt(e.getAttribute("line")),s="C",r="",a=0;for(let h of e.childNodes)if(h.nodeType===k.Element)switch(h.localName){case"tuning-step":s=h.innerText;break;case"tuning-alter":a=parseInt(h.innerText);break;case"tuning-octave":r=h.innerText;break}let o=Be.getTuningForText(s+r)+a;for(let h of t.staves)h.tuning[h.tuning.length-i]=o}parseHarmony(e,t,i){let s=new bi;for(let a of e.childNodes)if(a.nodeType===k.Element)switch(a.localName){case"root":s.name=this.parseHarmonyRoot(a);break;case"kind":s.name=s.name+this.parseHarmonyKind(a);break;case"frame":this.parseHarmonyFrame(a,s);break}this._currentChord=Be.newGuid();const r=s.uniqueId;i.has(r)&&(s.showDiagram=!1);for(let a of t.staves)a.addChord(this._currentChord,s);i.set(r,s)}parseHarmonyRoot(e){let t="",i="";for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"root-step":t=s.innerText;break;case"root-alter":switch(parseInt(e.innerText)){case-2:i="bb";break;case-1:i="b";break;case 0:i="";break;case 1:i="#";break;case 2:i="##";break}break}return t+i}parseHarmonyKind(e){const t=e.getAttribute("text");let i="";if(t)i=t;else switch(e.innerText){case"major":i="";break;case"minor":i="m";break;case"augmented":i="+";break;case"diminished":i="○";break;case"dominant":i="7";break;case"major-seventh":i="7M";break;case"minor-seventh":i="m7";break;case"diminished-seventh":i="○7";break;case"augmented-seventh":i="+7";break;case"half-diminished":i="⍉";break;case"major-minor":i="mMaj";break;case"major-sixth":i="maj6";break;case"minor-sixth":i="m6";break;case"dominant-ninth":i="9";break;case"major-ninth":i="maj9";break;case"minor-ninth":i="m9";break;case"dominant-11th":i="11";break;case"major-11th":i="maj11";break;case"minor-11th":i="m11";break;case"dominant-13th":i="13";break;case"major-13th":i="maj13";break;case"minor-13th":i="m13";break;case"suspended-second":i="sus2";break;case"suspended-fourth":i="sus4";break}return i}parseHarmonyFrame(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"frame-strings":const s=parseInt(i.innerText);t.strings=new Array(s);for(let o=0;o<s;o++)t.strings[o]=-1;break;case"first-fret":t.firstFret=parseInt(i.innerText);break;case"frame-note":let r=null,a=null;for(let o of i.childNodes)switch(o.localName){case"string":r=parseInt(o.innerText);break;case"fret":a=parseInt(o.innerText),r&&a>=0&&(t.strings[r-1]=a);break;case"barre":r&&a&&o.getAttribute("type")==="start"&&t.barreFrets.push(a);break}break}}parseBarline(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"repeat":this.parseRepeat(i,t);break;case"ending":this.parseEnding(i,t);break}}parseEnding(e,t){let i=parseInt(e.getAttribute("number"));i>0&&(--i,t.alternateEndings=t.alternateEndings|1<<i&255)}parseRepeat(e,t){let i=e.getAttribute("direction"),s=parseInt(e.getAttribute("times"));(s<0||isNaN(s))&&(s=2),i==="backward"?t.repeatCount=s:i==="forward"&&(t.isRepeatStart=!0)}parseNoteBeat(e,t){let i=e.getElementsByTagName("chord",!1).length>0,s=this.getOrCreateBeat(e,t,i);!s.chordId&&this._currentChord&&(s.chordId=this._currentChord,this._currentChord=null),this._currentDirection&&(s.text=this._currentDirection,this._currentDirection=null);let r=new Ee;s.voice.isEmpty=!1,s.isEmpty=!1,s.addNote(r),s.dots=0;let a=!1;for(let o of e.childNodes)if(o.nodeType===k.Element)switch(o.localName){case"grace":s.graceType=W.BeforeBeat,s.duration=m.ThirtySecond;break;case"duration":if(s.isRest&&!a)switch(parseInt(o.innerText)){case 1:s.duration=m.Whole;break;case 2:s.duration=m.Half;break;case 4:s.duration=m.Quarter;break;case 8:s.duration=m.Eighth;break;case 16:s.duration=m.Sixteenth;break;case 32:s.duration=m.ThirtySecond;break;case 64:s.duration=m.SixtyFourth;break;default:s.duration=m.Quarter;break}break;case"tie":this.parseTied(o,r);break;case"cue":break;case"instrument":break;case"type":s.duration=this.getDuration(o.innerText),s.graceType!==W.None&&s.duration<m.Sixteenth&&(s.duration=m.Eighth);break;case"dot":s.dots++;break;case"accidental":this.parseAccidental(o,r);break;case"time-modification":this.parseTimeModification(o,s);break;case"stem":break;case"notehead":o.getAttribute("parentheses")==="yes"&&(r.isGhost=!0);break;case"beam":o.innerText==="continue"&&(this._isBeamContinue=!0);break;case"notations":this.parseNotations(o,s,r);break;case"lyric":this.parseLyric(o,s);break;case"pitch":this.parsePitch(o,r);break;case"unpitched":this.parseUnpitched(o,r);break;case"rest":a=o.getAttribute("measure")==="yes",s.isEmpty=!1,s.notes=[],s.duration=m.Whole;break}if(r.isStringed){for(let o=0;o<s.notes.length;o++)if(s.notes[o].string===r.string&&s.notes[o]!==r){s.removeNote(r);break}}}getDuration(e){switch(e){case"256th":case"128th":case"64th":return m.SixtyFourth;case"32nd":return m.ThirtySecond;case"16th":return m.Sixteenth;case"eighth":return m.Eighth;case"quarter":return m.Quarter;case"half":return m.Half;case"long":case"breve":case"whole":return m.Whole}return m.Quarter}parseLyric(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"text":t.text?t.text+=" "+i.innerText:t.text=i.innerText;break}}parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=Me.ForceSharp;break;case"natural":t.accidentalMode=Me.ForceNatural;break;case"flat":t.accidentalMode=Me.ForceFlat;break}}parseTied(e,t){if(e.getAttribute("type")==="start")this._tieStartIds.has(t.id)||(this._tieStartIds.set(t.id,!0),this._tieStarts.push(t));else if(e.getAttribute("type")==="stop"&&this._tieStarts.length>0&&!t.isTieDestination){const i=this._tieStarts[0];i.beat.voice.index===t.beat.voice.index&&i.beat.voice.bar.staff.index===t.beat.voice.bar.staff.index&&i.beat.voice.bar.staff.track.index===t.beat.voice.bar.staff.track.index&&(t.isTieDestination=!0,t.tieOrigin=this._tieStarts[0]),this._tieStarts.splice(0,1),this._tieStartIds.delete(t.id)}}parseNotations(e,t,i){for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"articulations":this.parseArticulations(s,i);break;case"tied":this.parseTied(s,i);break;case"slide":case"glissando":s.getAttribute("type")==="start"&&(i.slideOutType=Q.Shift);break;case"dynamics":this.parseDynamics(s,t);break;case"technical":this.parseTechnical(s,i);break;case"ornaments":this.parseOrnaments(s,i);break;case"slur":let r=s.getAttribute("number");switch(r||(r="1"),r=t.voice.bar.staff.index+"_"+r,s.getAttribute("type")){case"start":this._slurStarts.set(r,i);break;case"stop":if(this._slurStarts.has(r)){i.isSlurDestination=!0;let a=this._slurStarts.get(r);a.slurDestination=i,i.slurOrigin=a}break}break}}parseOrnaments(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"tremolo":switch(parseInt(i.innerText)){case 1:t.beat.tremoloSpeed=m.Eighth;break;case 2:t.beat.tremoloSpeed=m.Sixteenth;break;case 3:t.beat.tremoloSpeed=m.ThirtySecond;break}break}}parseTechnical(e,t){let i=[];for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"string":t.string=parseInt(s.innerText),t.string!==-2147483648&&(t.string=t.beat.voice.bar.staff.tuning.length-t.string+1);break;case"fret":t.fret=parseInt(s.innerText);break;case"down-bow":t.beat.pickStroke=je.Down;break;case"up-bow":t.beat.pickStroke=je.Up;break;case"bend":i.push(s);break}i.length>0&&this.parseBends(i,t),(t.string===-2147483648||t.fret===-2147483648)&&(t.string=-1,t.fret=-1)}parseBends(e,t){let i=L.MaxPosition/e.length,s=0,r=0,a=!0;for(let o of e){let h=o.findChildElement("bend-alter");if(h){let l=Math.round(Math.abs(parseFloat(h.innerText))*2);o.findChildElement("pre-bend")?a?(s+=l,t.addBendPoint(new L(r,s)),r+=i,t.addBendPoint(new L(r,s)),a=!1):r+=i:o.findChildElement("release")?(a&&(s+=l),t.addBendPoint(new L(r,s)),r+=i,s-=l,t.addBendPoint(new L(r,s)),a=!1):(t.addBendPoint(new L(r,s)),s+=l,r+=i,t.addBendPoint(new L(r,s)),a=!1)}}}parseArticulations(e,t){for(let i of e.childNodes)switch(i.localName){case"accent":t.accentuated=He.Normal;break;case"strong-accent":t.accentuated=He.Heavy;break;case"staccato":case"detached-legato":t.isStaccato=!0;break}}parseDynamics(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"p":t.dynamics=j.P;break;case"pp":t.dynamics=j.PP;break;case"ppp":t.dynamics=j.PPP;break;case"f":t.dynamics=j.F;break;case"ff":t.dynamics=j.FF;break;case"fff":t.dynamics=j.FFF;break;case"mp":t.dynamics=j.MP;break;case"mf":t.dynamics=j.MF;break}}parseTimeModification(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"actual-notes":t.tupletNumerator=parseInt(i.innerText);break;case"normal-notes":t.tupletDenominator=parseInt(i.innerText);break}}parseUnpitched(e,t){let i="",s=0,r=0;for(let o of e.childNodes)if(o.nodeType===k.Element)switch(o.localName){case"display-step":i=o.innerText;break;case"display-alter":s=parseInt(o.innerText);break;case"display-octave":r=parseInt(o.innerText);break}let a=r*12+Be.getToneForText(i)+s;t.octave=a/12|0,t.tone=a-t.octave*12}parsePitch(e,t){let i="",s=0,r=0;for(let o of e.childNodes)if(o.nodeType===k.Element)switch(o.localName){case"step":i=o.innerText;break;case"alter":s=parseFloat(o.innerText),isNaN(s)&&(s=0);break;case"octave":r=parseInt(o.innerText)+1;break}let a=r*12+Be.getToneForText(i)+(s|0);t.octave=a/12|0,t.tone=a-t.octave*12}getOrCreateVoice(e,t){if(t<e.voices.length)return e.voices[t];for(let i=e.voices.length;i<=t;i++)e.addVoice(new Qt);return this._maxVoices=Math.max(this._maxVoices,e.voices.length),e.voices[t]}parseDirection(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"sound":let s=i.getAttribute("tempo");if(s){let a=new st;a.isLinear=!0,a.type=Ge.Tempo,a.value=parseInt(s),t.tempoAutomations.push(a),t.index===0&&(t.score.tempo=a.value)}break;case"direction-type":let r=i.firstElement;switch(r.localName){case"words":this._currentDirection=r.innerText;break;case"metronome":this.parseMetronome(r,t);break}break}}parseMetronome(e,t){let i=m.Quarter,s=120;for(let a of e.childNodes)if(a.nodeType===k.Element)switch(a.localName){case"beat-unit":i=this.getDuration(a.innerText);break;case"per-minute":s=parseInt(a.innerText);break}let r=new st;r.type=Ge.Tempo,r.value=s*(i/4)|0,this.hasSameTempo(t,r)||(t.tempoAutomations.push(r),t.index===0&&(t.score.tempo=r.value))}hasSameTempo(e,t){for(const i of e.tempoAutomations)if(t.ratioPosition===i.ratioPosition&&t.value==i.value)return!0;return!1}parseAttributes(e,t,i,s){let r=0,a=!1;for(let o of e.childNodes)if(o.nodeType===k.Element)switch(o.localName){case"divisions":this._divisionsPerQuarterNote=parseInt(o.innerText);break;case"key":this.parseKey(o,i);break;case"time":this.parseTime(o,i),a=!0;break;case"clef":r=parseInt(o.getAttribute("number")),isNaN(r)&&(r=1),this.parseClef(o,t[r-1]);break;case"staff-details":this.parseStaffDetails(o,s);break;case"transpose":this.parseTranspose(o,s);break}a||(i.timeSignatureCommon=!0)}parseTranspose(e,t){let i=0;for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"chromatic":i+=parseInt(s.innerText);break;case"octave-change":i+=parseInt(s.innerText)*12;break}for(let s of t.staves)s.transpositionPitch=i}parseClef(e,t){let i="s",s=0;for(let r of e.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"sign":i=r.innerText.toLowerCase();break;case"line":s=parseInt(r.innerText);break;case"clef-octave-change":switch(parseInt(r.innerText)){case-2:t.clefOttava=le._15mb;break;case-1:t.clefOttava=le._8vb;break;case 1:t.clefOttava=le._8va;break;case 2:t.clefOttava=le._15mb;break}break}switch(i){case"g":t.clef=U.G2;break;case"f":t.clef=U.F4;break;case"c":s===3?t.clef=U.C3:t.clef=U.C4;break;case"percussion":t.clef=U.Neutral,t.staff.isPercussion=!0;break;case"tab":t.clef=U.G2,t.staff.showTablature=!0;break;default:t.clef=U.G2;break}}parseTime(e,t){e.getAttribute("symbol")==="common"&&(t.timeSignatureCommon=!0);let i=!1,s=!1;for(let r of e.childNodes)if(r.nodeType===k.Element){let a=r.innerText;switch(r.localName){case"beats":i||(a.indexOf("+")===-1?t.timeSignatureNumerator=parseInt(a):t.timeSignatureNumerator=4,i=!0);break;case"beat-type":s||(a.indexOf("+")===-1?t.timeSignatureDenominator=parseInt(a):t.timeSignatureDenominator=4,s=!0);break}}}parseKey(e,t){let i=-2147483648,s="";for(let r of e.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"fifths":i=parseInt(r.innerText);break;case"key-step":break;case"key-alter":break;case"mode":s=r.innerText;break}-7<=i&&i<=7?t.keySignature=i:t.keySignature=Xe.C,s==="minor"?t.keySignatureType=wi.Minor:t.keySignatureType=wi.Major}getOrCreateMasterBar(e){if(e<this._score.masterBars.length)return this._score.masterBars[e];for(let t=this._score.masterBars.length;t<=e;t++){let i=new li;if(this._score.masterBars.length>0){let s=this._score.masterBars[this._score.masterBars.length-1];i.timeSignatureDenominator=s.timeSignatureDenominator,i.timeSignatureNumerator=s.timeSignatureNumerator,i.keySignature=s.keySignature,i.keySignatureType=s.keySignatureType}this._score.addMasterBar(i)}return this._score.masterBars[e]}parseIdentification(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"creator":t.getAttribute("type")==="composer"&&(this._score.music=t.innerText);break;case"rights":this._score.copyright&&(this._score.copyright+=`
`),this._score.copyright+=t.innerText;break}}parsePartList(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"part-group":this.parsePartGroup(t);break;case"score-part":this.parseScorePart(t);break}}parsePartGroup(e){switch(e.getAttribute("type")){case"start":this._currentPartGroup=e.getAttribute("number"),this._partGroups.set(this._currentPartGroup,[]);break;case"stop":this._currentPartGroup=null;break}}parseScorePart(e){let t=e.getAttribute("id"),i=new Jt;i.ensureStaveCount(1);let s=i.staves[0];s.showStandardNotation=!0,this._trackById.set(t,i),this._score.addTrack(i),this._currentPartGroup&&this._partGroups.get(this._currentPartGroup).push(i);for(let r of e.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"part-name":i.name=r.innerText;break;case"part-abbreviation":i.shortName=r.innerText;break;case"midi-instrument":this.parseMidiInstrument(r,i);break}this.isEmptyTuning(i.staves[0].tuning)&&(i.staves[0].stringTuning.tunings=[])}isEmptyTuning(e){if(!e)return!0;for(let t=0;t<e.length;t++)if(e[t]!==0)return!1;return!0}parseMidiInstrument(e,t){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"midi-channel":t.playbackInfo.primaryChannel=parseInt(i.innerText);break;case"midi-program":t.playbackInfo.program=parseInt(i.innerText);break;case"volume":t.playbackInfo.volume=Math.floor(parseInt(i.innerText)/100*16);break;case"pan":t.playbackInfo.balance=Math.max(0,Math.min(16,Math.floor((parseInt(i.innerText)+90)/180*16)));break}}}var Ui;(function(n){n[n.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",n[n.MultiTrack=1]="MultiTrack"})(Ui||(Ui={}));class pa{constructor(){this.events=[]}addEvent(e){if(this.events.length===0||e.tick>=this.events[this.events.length-1].tick)this.events.push(e);else{let t=this.events.length;for(;t>0&&this.events[t-1].tick>e.tick;)t--;this.events.splice(t,0,e)}}writeTo(e){let t=Ke.empty(),i=0;for(let a of this.events){let o=a.tick-i;Si.writeVariableInt(t,o),a.writeTo(t),i=a.tick}const s=new Uint8Array([77,84,114,107]);e.write(s,0,s.length);let r=t.toArray();S.writeInt32BE(e,r.length),e.write(r,0,r.length)}}class Si{constructor(){this.format=Ui.SingleTrackMultiChannel,this.division=q.QuarterTime,this.tracks=[]}get events(){if(this.tracks.length==1)return this.tracks[0].events;{const e=[];for(const t of this.tracks)this.events.push(...t.events);return e.sort((t,i)=>t.tick-i.tick),e}}ensureTracks(e){for(;this.tracks.length<e;)this.tracks.push(new pa)}addEvent(e){this.format==Ui.SingleTrackMultiChannel?(this.ensureTracks(1),this.tracks[0].addEvent(e)):(this.ensureTracks(e.track+1),this.tracks[e.track].addEvent(e))}toBinary(){let e=Ke.empty();return this.writeTo(e),e.toArray()}writeTo(e){let t=new Uint8Array([77,84,104,100]);e.write(t,0,t.length),S.writeInt32BE(e,6),S.writeInt16BE(e,this.format),S.writeInt16BE(e,this.tracks.length),S.writeInt16BE(e,this.division);for(const i of this.tracks)i.writeTo(e)}static writeVariableInt(e,t){let i=new Uint8Array(4),s=0;do i[s++]=t&127,t>>=7;while(t>0);for(;s>0;)s--,s>0?e.writeByte(i[s]|128):e.writeByte(i[s])}}var ie;(function(n){n[n.TimeSignature=88]="TimeSignature",n[n.NoteOn=128]="NoteOn",n[n.NoteOff=144]="NoteOff",n[n.ControlChange=176]="ControlChange",n[n.ProgramChange=192]="ProgramChange",n[n.TempoChange=81]="TempoChange",n[n.PitchBend=224]="PitchBend",n[n.PerNotePitchBend=96]="PerNotePitchBend",n[n.EndOfTrack=47]="EndOfTrack",n[n.AlphaTabRest=241]="AlphaTabRest",n[n.AlphaTabMetronome=242]="AlphaTabMetronome",n[n.SystemExclusive=240]="SystemExclusive",n[n.SystemExclusive2=247]="SystemExclusive2",n[n.Meta=255]="Meta"})(ie||(ie={}));class ci{constructor(e,t,i){this.track=e,this.tick=t,this.type=i}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class ga extends ci{constructor(e,t,i,s,r,a){super(e,t,ie.TimeSignature),this.track=e,this.tick=t,this.numerator=i,this.denominatorIndex=s,this.midiClocksPerMetronomeClick=r,this.thirtySecondNodesInQuarter=a}writeTo(e){e.writeByte(255),e.writeByte(88),Si.writeVariableInt(e,4),e.writeByte(this.numerator&255),e.writeByte(this.denominatorIndex&255),e.writeByte(this.midiClocksPerMetronomeClick&255),e.writeByte(this.thirtySecondNodesInQuarter&255)}}class ui extends ci{constructor(e,t,i){super(e,t,i)}writeTo(e){e.writeByte(240);const t=Ke.withCapacity(16);t.writeByte(ui.AlphaTabManufacturerId),this.writeEventData(t),t.writeByte(247),Si.writeVariableInt(e,t.length),t.copyTo(e)}}ui.AlphaTabManufacturerId=125,ui.MetronomeEventId=0,ui.RestEventId=1;class ma extends ui{constructor(e,t,i,s,r){super(e,t,ie.AlphaTabMetronome),this.isMetronome=!0,this.metronomeNumerator=i,this.metronomeDurationInMilliseconds=r,this.metronomeDurationInTicks=s}writeEventData(e){e.writeByte(ui.MetronomeEventId),e.writeByte(this.metronomeNumerator),S.writeInt32LE(e,this.metronomeDurationInTicks),S.writeInt32LE(e,this.metronomeDurationInMilliseconds)}}class ya extends ui{constructor(e,t,i){super(e,t,ie.AlphaTabRest),this.channel=i}writeEventData(e){e.writeByte(ui.RestEventId),e.writeByte(this.channel)}}class ba extends ci{constructor(e,t,i,s,r,a){super(e,t,i),this.channel=s,this.noteKey=r,this.noteVelocity=a}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class wa extends ba{constructor(e,t,i,s,r){super(e,t,ie.NoteOn,i,s,r)}writeTo(e){e.writeByte(this.channel&15|144),e.writeByte(this.noteKey&255),e.writeByte(this.noteVelocity&255)}}class Sa extends ba{constructor(e,t,i,s,r){super(e,t,ie.NoteOff,i,s,r)}writeTo(e){e.writeByte(this.channel&15|128),e.writeByte(this.noteKey&255),e.writeByte(this.noteVelocity&255)}}class Ba extends ci{constructor(e,t,i,s,r){super(e,t,ie.ControlChange),this.channel=i,this.controller=s,this.value=r}writeTo(e){e.writeByte(this.channel&15|176),e.writeByte(this.controller&255),e.writeByte(this.value&255)}get data1(){return this.controller}get data2(){return this.value}}class ka extends ci{constructor(e,t,i,s){super(e,t,ie.ProgramChange),this.channel=i,this.program=s}writeTo(e){e.writeByte(this.channel&15|192),e.writeByte(this.program&255)}get data1(){return this.program}}class _a extends ci{constructor(e,t){super(0,e,ie.TempoChange),this.microSecondsPerQuarterNote=t}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(this.microSecondsPerQuarterNote&255)}}class Ta extends ci{constructor(e,t,i,s){super(e,t,ie.PitchBend),this.channel=i,this.value=s}writeTo(e){e.writeByte(this.channel&15|224),e.writeByte(this.value&127),e.writeByte(this.value>>7&127)}get data1(){return this.value&127}get data2(){return this.value>>7&127}}class xa extends ci{constructor(e,t,i,s,r){super(e,t,ie.PerNotePitchBend),this.channel=i,this.noteKey=s,this.value=r}writeTo(e){throw new nt(at.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class Na extends ci{constructor(e,t){super(e,t,ie.EndOfTrack)}writeTo(e){e.writeByte(255),e.writeByte(47),e.writeByte(0)}}class rs{constructor(e,t){this.time=0,this.eventIndex=e,this.event=t,this.isMetronome=this.event.type==ie.AlphaTabMetronome}static newMetronomeEvent(e,t,i,s,r){const a=new ma(0,t,i,s,r);return new rs(e,a)}}class K{}K.DefaultChannelCount=17,K.MetronomeChannel=K.DefaultChannelCount-1,K.AudioChannels=2,K.MinVolume=0,K.MinProgram=0,K.MaxProgram=127,K.MinPlaybackSpeed=.125,K.MaxPlaybackSpeed=8,K.MaxPitchWheel=16384,K.MaxPitchWheel20=4294967296,K.DefaultPitchWheel=K.MaxPitchWheel/2,K.MicroBufferCount=32,K.MicroBufferSize=64;class Pa{constructor(e,t,i){this.bpm=e,this.ticks=t,this.time=i}}class ur{constructor(){this.tempoChanges=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=q.QuarterTime,this.eventIndex=0,this.currentTime=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0}}class Qn{get isPlayingMain(){return this._currentState==this._mainState}get isPlayingOneTimeMidi(){return this._currentState==this._oneTimeState}get isPlayingCountIn(){return this._currentState==this._countInState}constructor(e){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this._synthesizer=e,this._mainState=new ur,this._currentState=this._mainState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){this._mainState.playbackRange=e,e&&(this._mainState.playbackRangeStartTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}mainSeek(e){if(e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime)this.mainSilentProcess(e-this._mainState.currentTime);else if(e<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this.isPlayingMain){let t=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(t)}this.mainSilentProcess(e)}}mainSilentProcess(e){if(e<=0)return;let t=Date.now(),i=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<i;)this.fillMidiEventQueueLimited(i-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(K.MicroBufferSize);this._mainState.currentTime=i;let s=Date.now()-t;_.debug("Sequencer","Silent seek finished in "+s+"ms (main)")}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}loadMidi(e){this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){const t=new ur;t.tempoChanges=[],t.division=e.division,t.eventIndex=0,t.currentTime=0,t.synthData=[];let i=120,s=0,r=0,a=0,o=0,h=0,l=0,d=0,c=0;for(let f of e.events){let p=new rs(t.synthData.length,f);t.synthData.push(p);let g=f.tick-c;if(s+=g,r+=g*(6e4/(i*e.division)),p.time=r,c=f.tick,o>0)for(;l<s;){let b=rs.newMetronomeEvent(t.synthData.length,l,Math.floor(l/o)%a,o,h);t.synthData.push(b),b.time=d,l+=o,d+=h}if(f.type===ie.TempoChange)i=6e7/f.microSecondsPerQuarterNote,t.tempoChanges.push(new Pa(i,s,r)),h=o*(6e4/(i*e.division));else if(f.type===ie.TimeSignature){let b=f,w=Math.pow(2,b.denominatorIndex);a=b.numerator,o=t.division*(4/w)|0,h=o*(6e4/(i*e.division)),t.firstTimeSignatureDenominator===0&&(t.firstTimeSignatureNumerator=b.numerator,t.firstTimeSignatureDenominator=w)}else if(f.type===ie.ProgramChange){let b=f.channel;t.firstProgramEventPerChannel.has(b)||t.firstProgramEventPerChannel.set(b,p)}}return t.synthData.sort((f,p)=>f.time>p.time?1:f.time<p.time?-1:f.eventIndex-p.eventIndex),t.endTime=r,t.endTick=s,t}fillMidiEventQueue(){return this.fillMidiEventQueueLimited(-1)}fillMidiEventQueueLimited(e){let t=K.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,i=this.internalEndTime;e>0&&(e<t&&(t=e),i=Math.min(this.internalEndTime,this._currentState.currentTime+e));let s=!1;for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<i;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,s=!0;return s}mainTickPositionToTimePosition(e){return this.tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainTimePositionToTickPosition(e){return this.timePositionToTickPositionWithSpeed(this._mainState,e,this.playbackSpeed)}currentTimePositionToTickPosition(e){return this.timePositionToTickPositionWithSpeed(this._currentState,e,this.playbackSpeed)}tickPositionToTimePositionWithSpeed(e,t,i){let s=0,r=120,a=0;for(const o of e.tempoChanges){if(t<o.ticks)break;s=o.time,r=o.bpm,a=o.ticks}return t-=a,s+=t*(6e4/(r*e.division)),s/i}timePositionToTickPositionWithSpeed(e,t,i){t*=i;let s=0,r=120,a=0;for(const o of e.tempoChanges){if(t<o.time)break;s=o.ticks,r=o.bpm,a=o.time}return t-=a,s+=t/(6e4/(r*e.division))|0,s+1}get internalEndTime(){return this.isPlayingMain?this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this.internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){const e=new ur;e.division=this._mainState.division;let t=120,i=4,s=4;this._mainState.eventIndex===0?(t=this._mainState.tempoChanges[0].bpm,i=this._mainState.firstTimeSignatureNumerator,s=this._mainState.firstTimeSignatureDenominator):(t=this._synthesizer.currentTempo,i=this._synthesizer.timeSignatureNumerator,s=this._synthesizer.timeSignatureDenominator),e.tempoChanges.push(new Pa(t,0,0));let r=e.division*(4/s)|0,a=r*(6e4/(t*this._mainState.division)),o=0,h=0;for(let l=0;l<i;l++){let d=rs.newMetronomeEvent(e.synthData.length,o,l,r,a);e.synthData.push(d),d.time=h,o+=r,h+=a}e.synthData.sort((l,d)=>l.time>d.time?1:l.time<d.time?-1:l.eventIndex-d.eventIndex),e.endTime=h,e.endTick=o,this._countInState=e}}var qe;(function(n){n[n.Paused=0]="Paused",n[n.Playing=1]="Playing"})(qe||(qe={}));class Ls{constructor(e,t){this.state=e,this.stopped=t}}class vs{constructor(e,t,i,s,r){this.currentTime=e,this.endTime=t,this.currentTick=i,this.endTick=s,this.isSeek=r}}class Ct{constructor(){this.id="",this.size=0}static load(e,t,i){if(e&&Ct.HeaderSize>e.size||i.position+Ct.HeaderSize>=i.length||(t.id=S.read8BitStringLength(i,4),t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122)||(t.size=S.readUInt32LE(i),e&&Ct.HeaderSize+t.size>e.size))return!1;e&&(e.size-=Ct.HeaderSize+t.size);let s=t.id==="RIFF",r=t.id==="LIST";return s&&e?!1:!s&&!r?!0:(t.id=S.read8BitStringLength(i,4),t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122?!1:(t.size-=4,!0))}}Ct.HeaderSize=8;class fr{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.fontSamples=new Float32Array(0)}load(e){const t=new Ct,i=new Ct;if(!Ct.load(null,t,e)||t.id!=="sfbk")throw new Ue("Soundfont is not a valid Soundfont2 file");for(;Ct.load(t,i,e);){let s=new Ct;if(i.id==="pdta")for(;Ct.load(i,s,e);)switch(s.id){case"phdr":for(let r=0,a=s.size/wr.SizeInFile|0;r<a;r++)this.phdrs.push(new wr(e));break;case"pbag":for(let r=0,a=s.size/br.SizeInFile|0;r<a;r++)this.pbags.push(new br(e));break;case"pmod":for(let r=0,a=s.size/Sr.SizeInFile|0;r<a;r++)this.pmods.push(new Sr(e));break;case"pgen":for(let r=0,a=s.size/kt.SizeInFile|0;r<a;r++)this.pgens.push(new kt(e));break;case"inst":for(let r=0,a=s.size/yr.SizeInFile|0;r<a;r++)this.insts.push(new yr(e));break;case"ibag":for(let r=0,a=s.size/pr.SizeInFile|0;r<a;r++)this.ibags.push(new pr(e));break;case"imod":for(let r=0,a=s.size/gr.SizeInFile|0;r<a;r++)this.imods.push(new gr(e));break;case"igen":for(let r=0,a=s.size/mr.SizeInFile|0;r<a;r++)this.igens.push(new mr(e));break;case"shdr":for(let r=0,a=s.size/Br.SizeInFile|0;r<a;r++)this.sHdrs.push(new Br(e));break;default:e.position+=s.size;break}else if(i.id==="sdta")for(;Ct.load(i,s,e);)switch(s.id){case"smpl":this.fontSamples=fr.loadSamples(s,e);break;default:e.position+=s.size;break}else e.position+=i.size}}static loadSamples(e,t){let i=e.size/2|0;const s=new Float32Array(i);let r=0;const a=new Uint8Array(16*1024);for(;i>0;){let o=Math.min(i,a.length/2|0);t.read(a,0,o*2);for(let h=0;h<o;h++){const l=Z.int32ToInt16(a[h*2+1]<<8|a[h*2]);s[r+h]=l/32767}i-=o,r+=o}return s}}class pr{constructor(e){this.instGenNdx=S.readUInt16LE(e),this.instModNdx=S.readUInt16LE(e)}}pr.SizeInFile=4;class gr{constructor(e){this.modSrcOper=S.readUInt16LE(e),this.modDestOper=S.readUInt16LE(e),this.modAmount=S.readInt16LE(e),this.modAmtSrcOper=S.readUInt16LE(e),this.modTransOper=S.readUInt16LE(e)}}gr.SizeInFile=10;class mr{constructor(e){this.genOper=S.readUInt16LE(e),this.genAmount=new Ca(e)}}mr.SizeInFile=4;class yr{constructor(e){this.instName=S.read8BitStringLength(e,20),this.instBagNdx=S.readUInt16LE(e)}}yr.SizeInFile=22;class br{constructor(e){this.genNdx=S.readUInt16LE(e),this.modNdx=S.readUInt16LE(e)}}br.SizeInFile=4;class kt{constructor(e){this.genOper=S.readUInt16LE(e),this.genAmount=new Ca(e)}}kt.SizeInFile=4,kt.GenInstrument=41,kt.GenKeyRange=43,kt.GenVelRange=44,kt.GenSampleId=53;class wr{constructor(e){this.presetName=S.read8BitStringLength(e,20),this.preset=S.readUInt16LE(e),this.bank=S.readUInt16LE(e),this.presetBagNdx=S.readUInt16LE(e),this.library=S.readUInt32LE(e),this.genre=S.readUInt32LE(e),this.morphology=S.readUInt32LE(e)}}wr.SizeInFile=38;class Sr{constructor(e){this.modSrcOper=S.readUInt16LE(e),this.modDestOper=S.readUInt16LE(e),this.modAmount=S.readUInt16LE(e),this.modAmtSrcOper=S.readUInt16LE(e),this.modTransOper=S.readUInt16LE(e)}}Sr.SizeInFile=10;class Br{constructor(e){this.sampleName=S.read8BitStringLength(e,20),this.start=S.readUInt32LE(e),this.end=S.readUInt32LE(e),this.startLoop=S.readUInt32LE(e),this.endLoop=S.readUInt32LE(e),this.sampleRate=S.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=S.readSInt8(e),this.sampleLink=S.readUInt16LE(e),this.sampleType=S.readUInt16LE(e)}}Br.SizeInFile=46;class Ca{get shortAmount(){return Z.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return this.wordAmount&255}get highByteAmount(){return(this.wordAmount&65280)>>8&255}constructor(e){this.wordAmount=S.readUInt16LE(e)}}class $n{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}}class Kn{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){const i=this.channelList[this.activeChannel],s=t.region.pan+i.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=i.mixVolume,t.noteGainDb+=i.gainDb,t.updatePitchRatio(i,e.outSampleRate),s<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):s>=.5?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-s),t.panFactorRight=Math.sqrt(.5+s))}}var fi;(function(n){n[n.None=0]="None",n[n.Continuous=1]="Continuous",n[n.Sustain=2]="Sustain"})(fi||(fi={}));var Ei;(function(n){n[n.StereoInterleaved=0]="StereoInterleaved",n[n.StereoUnweaved=1]="StereoUnweaved",n[n.Mono=2]="Mono"})(Ei||(Ei={}));class Zn{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null,this.fontSamples=null}}class Re{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return e>-100?Math.pow(10,e*.05):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}static clamp(e,t,i){return e<=t?t:e>=i?i:e}}class as{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Re.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Re.timecents2Secs(this.attack),this.release=this.release<-11950?0:Re.timecents2Secs(this.release),this.keynumToHold===0&&(this.hold=this.hold<-11950?0:Re.timecents2Secs(this.hold)),this.keynumToDecay===0&&(this.decay=this.decay<-11950?0:Re.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:e?this.sustain=Re.decibelsToGain(-this.sustain/10):this.sustain=1-this.sustain/1e3}}var se;(function(n){n[n.StartAddrsOffset=0]="StartAddrsOffset",n[n.EndAddrsOffset=1]="EndAddrsOffset",n[n.StartloopAddrsOffset=2]="StartloopAddrsOffset",n[n.EndloopAddrsOffset=3]="EndloopAddrsOffset",n[n.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",n[n.ModLfoToPitch=5]="ModLfoToPitch",n[n.VibLfoToPitch=6]="VibLfoToPitch",n[n.ModEnvToPitch=7]="ModEnvToPitch",n[n.InitialFilterFc=8]="InitialFilterFc",n[n.InitialFilterQ=9]="InitialFilterQ",n[n.ModLfoToFilterFc=10]="ModLfoToFilterFc",n[n.ModEnvToFilterFc=11]="ModEnvToFilterFc",n[n.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",n[n.ModLfoToVolume=13]="ModLfoToVolume",n[n.Unused1=14]="Unused1",n[n.ChorusEffectsSend=15]="ChorusEffectsSend",n[n.ReverbEffectsSend=16]="ReverbEffectsSend",n[n.Pan=17]="Pan",n[n.Unused2=18]="Unused2",n[n.Unused3=19]="Unused3",n[n.Unused4=20]="Unused4",n[n.DelayModLFO=21]="DelayModLFO",n[n.FreqModLFO=22]="FreqModLFO",n[n.DelayVibLFO=23]="DelayVibLFO",n[n.FreqVibLFO=24]="FreqVibLFO",n[n.DelayModEnv=25]="DelayModEnv",n[n.AttackModEnv=26]="AttackModEnv",n[n.HoldModEnv=27]="HoldModEnv",n[n.DecayModEnv=28]="DecayModEnv",n[n.SustainModEnv=29]="SustainModEnv",n[n.ReleaseModEnv=30]="ReleaseModEnv",n[n.KeynumToModEnvHold=31]="KeynumToModEnvHold",n[n.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",n[n.DelayVolEnv=33]="DelayVolEnv",n[n.AttackVolEnv=34]="AttackVolEnv",n[n.HoldVolEnv=35]="HoldVolEnv",n[n.DecayVolEnv=36]="DecayVolEnv",n[n.SustainVolEnv=37]="SustainVolEnv",n[n.ReleaseVolEnv=38]="ReleaseVolEnv",n[n.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",n[n.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",n[n.Instrument=41]="Instrument",n[n.Reserved1=42]="Reserved1",n[n.KeyRange=43]="KeyRange",n[n.VelRange=44]="VelRange",n[n.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",n[n.Keynum=46]="Keynum",n[n.Velocity=47]="Velocity",n[n.InitialAttenuation=48]="InitialAttenuation",n[n.Reserved2=49]="Reserved2",n[n.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",n[n.CoarseTune=51]="CoarseTune",n[n.FineTune=52]="FineTune",n[n.SampleID=53]="SampleID",n[n.SampleModes=54]="SampleModes",n[n.Reserved3=55]="Reserved3",n[n.ScaleTuning=56]="ScaleTuning",n[n.ExclusiveClass=57]="ExclusiveClass",n[n.OverridingRootKey=58]="OverridingRootKey",n[n.Unused5=59]="Unused5",n[n.EndOper=60]="EndOper"})(se||(se={}));class Yi{constructor(e){this.loopMode=fi.None,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new as,this.modEnv=new as,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,e&&(this.loopMode=e.loopMode,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new as(e.ampEnv),this.modEnv=new as(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=fi.None,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,!e&&(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case se.StartAddrsOffset:this.offset+=Z.int16ToUint32(t.shortAmount);break;case se.EndAddrsOffset:this.end+=Z.int16ToUint32(t.shortAmount);break;case se.StartloopAddrsOffset:this.loopStart+=Z.int16ToUint32(t.shortAmount);break;case se.EndloopAddrsOffset:this.loopEnd+=Z.int16ToUint32(t.shortAmount);break;case se.StartAddrsCoarseOffset:this.offset+=Z.int16ToUint32(t.shortAmount)*32768;break;case se.ModLfoToPitch:this.modLfoToPitch=t.shortAmount;break;case se.VibLfoToPitch:this.vibLfoToPitch=t.shortAmount;break;case se.ModEnvToPitch:this.modEnvToPitch=t.shortAmount;break;case se.InitialFilterFc:this.initialFilterFc=t.shortAmount;break;case se.InitialFilterQ:this.initialFilterQ=t.shortAmount;break;case se.ModLfoToFilterFc:this.modLfoToFilterFc=t.shortAmount;break;case se.ModEnvToFilterFc:this.modEnvToFilterFc=t.shortAmount;break;case se.EndAddrsCoarseOffset:this.end+=Z.int16ToUint32(t.shortAmount)*32768;break;case se.ModLfoToVolume:this.modLfoToVolume=t.shortAmount;break;case se.Pan:this.pan=t.shortAmount/1e3;break;case se.DelayModLFO:this.delayModLFO=t.shortAmount;break;case se.FreqModLFO:this.freqModLFO=t.shortAmount;break;case se.DelayVibLFO:this.delayVibLFO=t.shortAmount;break;case se.FreqVibLFO:this.freqVibLFO=t.shortAmount;break;case se.DelayModEnv:this.modEnv.delay=t.shortAmount;break;case se.AttackModEnv:this.modEnv.attack=t.shortAmount;break;case se.HoldModEnv:this.modEnv.hold=t.shortAmount;break;case se.DecayModEnv:this.modEnv.decay=t.shortAmount;break;case se.SustainModEnv:this.modEnv.sustain=t.shortAmount;break;case se.ReleaseModEnv:this.modEnv.release=t.shortAmount;break;case se.KeynumToModEnvHold:this.modEnv.keynumToHold=t.shortAmount;break;case se.KeynumToModEnvDecay:this.modEnv.keynumToDecay=t.shortAmount;break;case se.DelayVolEnv:this.ampEnv.delay=t.shortAmount;break;case se.AttackVolEnv:this.ampEnv.attack=t.shortAmount;break;case se.HoldVolEnv:this.ampEnv.hold=t.shortAmount;break;case se.DecayVolEnv:this.ampEnv.decay=t.shortAmount;break;case se.SustainVolEnv:this.ampEnv.sustain=t.shortAmount;break;case se.ReleaseVolEnv:this.ampEnv.release=t.shortAmount;break;case se.KeynumToVolEnvHold:this.ampEnv.keynumToHold=t.shortAmount;break;case se.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=t.shortAmount;break;case se.KeyRange:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case se.VelRange:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case se.StartloopAddrsCoarseOffset:this.loopStart+=Z.int16ToUint32(t.shortAmount)*32768;break;case se.InitialAttenuation:this.attenuation+=t.shortAmount*.1;break;case se.EndloopAddrsCoarseOffset:this.loopEnd+=Z.int16ToUint32(t.shortAmount)*32768;break;case se.CoarseTune:this.transpose+=t.shortAmount;break;case se.FineTune:this.tune+=t.shortAmount;break;case se.SampleModes:this.loopMode=(t.wordAmount&3)===3?fi.Sustain:(t.wordAmount&3)===1?fi.Continuous:fi.None;break;case se.ScaleTuning:this.pitchKeyTrack=t.shortAmount;break;case se.ExclusiveClass:this.group=t.wordAmount;break;case se.OverridingRootKey:this.pitchKeyCenter=t.shortAmount;break}}}var we;(function(n){n[n.None=0]="None",n[n.Delay=1]="Delay",n[n.Attack=2]="Attack",n[n.Hold=3]="Hold",n[n.Decay=4]="Decay",n[n.Sustain=5]="Sustain",n[n.Release=6]="Release",n[n.Done=7]="Done"})(we||(we={}));class ns{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=we.None,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,t){if(this.parameters)for(;;)switch(e){case we.None:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,this.samplesUntilNextSegment>0){this.segment=we.Delay,this.segmentIsExponential=!1,this.level=0,this.slope=0;return}e=we.Delay;break;case we.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,this.samplesUntilNextSegment>0){this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=we.Attack,this.segmentIsExponential=!1,this.level=0,this.slope=1/this.samplesUntilNextSegment;return}e=we.Attack;break;case we.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,this.samplesUntilNextSegment>0){this.segment=we.Hold,this.segmentIsExponential=!1,this.level=1,this.slope=0;return}e=we.Hold;break;case we.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,this.samplesUntilNextSegment>0){if(this.segment=we.Decay,this.level=1,this.isAmpEnv){let i=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(i),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/i|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1;return}e=we.Decay;break;case we.Decay:this.segment=we.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,this.segmentIsExponential=!1;return;case we.Sustain:if(this.segment=we.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?ns.FastReleaseTime:this.parameters.release)*t|0,this.isAmpEnv){let i=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(i),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:this.segment=we.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,this.samplesUntilNextSegment=134217727;return}}setup(e,t,i,s,r){this.parameters=new as(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Re.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Re.timecents2Secs(this.parameters.decay)),this.midiVelocity=i|0,this.isAmpEnv=s,this.nextSegment(we.None,r)}process(e,t){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}}ns.FastReleaseTime=.01;class La{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,i){this.samplesUntil=e*i|0,this.delta=4*Re.cents2Hertz(t)/i,this.level=0}process(e){if(this.samplesUntil>e){this.samplesUntil-=e;return}this.level+=this.delta*e,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level)}}class va{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){let t=Math.tan(Math.PI*e),i=t*t,s=1/(1+t*this.qInv+i);this.a0=i*s,this.a1=2*this.a0,this.b1=2*(i-1)*s,this.b2=(1-t*this.qInv+i)*s}process(e){let t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}}class os{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new ns,this.modEnv=new ns,this.lowPass=new va,this.modLfo=new La,this.vibLfo=new La,this.mixVolume=0,this.mute=!1}updatePitchRatio(e,t){let i=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(i+=e.perNotePitchWheel.get(this.playingKey)-8192);const s=i===8192?e.tuning:i/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(s,t)}calcPitchRatio(e,t){if(!this.region)return;const i=this.playingKey+this.region.transpose+this.region.tune/100;let s=this.region.pitchKeyCenter+(i-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);e!==0&&(s+=e),this.pitchInputTimecents=s*100,this.pitchOutputFactor=this.region.sampleRate/(Re.timecents2Secs(this.region.pitchKeyCenter*100)*t)}end(e){this.region&&(this.ampEnv.nextSegment(we.Sustain,e),this.modEnv.nextSegment(we.Sustain,e),this.region.loopMode===fi.Sustain&&(this.loopEnd=this.loopStart))}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(we.Sustain,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(we.Sustain,e)}render(e,t,i,s,r){if(!this.region)return;let a=this.region,h=e.presets[this.playingPreset].fontSamples,l=0,d=e.outputMode===Ei.StereoUnweaved?s:-1,c=a.modEnvToPitch!==0||a.modEnvToFilterFc!==0,f=this.modLfo.delta>0&&(a.modLfoToPitch!==0||a.modLfoToFilterFc!==0||a.modLfoToVolume!==0),p=this.vibLfo.delta>0&&a.vibLfoToPitch!==0,g=this.loopStart<this.loopEnd,b=this.loopStart,w=this.loopEnd,D=a.end,R=w+1,B=this.sourceSamplePosition,X=new va(this.lowPass),C=a.modLfoToFilterFc!==0||a.modEnvToFilterFc!==0,be=0,Fe=0,Pe=0,ge=0,ct=a.modLfoToPitch!==0||a.modEnvToPitch!==0||a.vibLfoToPitch!==0,Nt=0,si=0,xi=0,Zi=0,ks=a.modLfoToVolume!==0,Ni=0,Hi=0;for(C?(be=e.outSampleRate,Fe=a.initialFilterFc,Pe=a.modLfoToFilterFc,ge=a.modEnvToFilterFc):(be=0,Fe=0,Pe=0,ge=0),ct?(Nt=0,si=a.modLfoToPitch,xi=a.vibLfoToPitch,Zi=a.modEnvToPitch):(Nt=Re.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,si=0,xi=0,Zi=0),ks?Hi=a.modLfoToVolume*.1:(Ni=Re.decibelsToGain(this.noteGainDb),Hi=0);s>0;){let ri,ji,es=0,ut=s>os.RenderEffectSampleBlock?os.RenderEffectSampleBlock:s;if(s-=ut,C){let pt=Fe+this.modLfo.level*Pe+this.modEnv.level*ge;X.active=pt<=13500,X.active&&X.setup(Re.cents2Hertz(pt)/be)}switch(ct&&(Nt=Re.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*si+this.vibLfo.level*xi+this.modEnv.level*Zi))*this.pitchOutputFactor),ks&&(Ni=Re.decibelsToGain(this.noteGainDb+this.modLfo.level*Hi)),ri=Ni*this.ampEnv.level,r?ri=0:ri*=this.mixVolume,this.ampEnv.process(ut,e.outSampleRate),c&&this.modEnv.process(ut,e.outSampleRate),f&&this.modLfo.process(ut),p&&this.vibLfo.process(ut),e.outputMode){case Ei.StereoInterleaved:for(ji=ri*this.panFactorLeft,es=ri*this.panFactorRight;ut-- >0&&B<D;){let pt=B|0,_s=pt>=w&&g?b:pt+1,Pi=B-pt,Et=h[pt]*(1-Pi)+h[_s]*Pi;X.active&&(Et=X.process(Et)),t[i+l]+=Et*ji,l++,t[i+l]+=Et*es,l++,B+=Nt,B>=R&&g&&(B-=w-b+1)}break;case Ei.StereoUnweaved:for(ji=ri*this.panFactorLeft,es=ri*this.panFactorRight;ut-- >0&&B<D;){let pt=B|0,_s=pt>=w&&g?b:pt+1,Pi=B-pt,Et=h[pt]*(1-Pi)+h[_s]*Pi;X.active&&(Et=X.process(Et)),t[i+l]+=Et*ji,l++,t[i+d]+=Et*es,d++,B+=Nt,B>=R&&g&&(B-=w-b+1)}break;case Ei.Mono:for(;ut-- >0&&B<D;){let pt=B|0,_s=pt>=w&&g?b:pt+1,Pi=B-pt,Et=h[pt]*(1-Pi)+h[_s]*Pi;X.active&&(Et=X.process(Et)),t[i+l]=Et*ri,l++,B+=Nt,B>=R&&g&&(B-=w-b+1)}break}if(B>=D||this.ampEnv.segment===we.Done){this.kill();return}}this.sourceSamplePosition=B,(X.active||C)&&(this.lowPass=X)}kill(){this.playingPreset=-1}}os.RenderEffectSampleBlock=K.MicroBufferSize;class kr{constructor(){this._items=[],this._position=0,this.isEmpty=!0}clear(){this._items=[],this._position=0,this.isEmpty=!0}enqueue(e){this.isEmpty=!1,this._items.push(e)}peek(){return this._items[this._position]}dequeue(){const e=this._items[this._position];return this._position++,this._position>=this._items.length/2&&(this._items=this._items.slice(this._position),this._position=0),this.isEmpty=this._items.length==0,e}toArray(){const e=this._items.slice(this._position);return e.reverse(),e}}var ye;(function(n){n[n.BankSelectCoarse=0]="BankSelectCoarse",n[n.ModulationCoarse=1]="ModulationCoarse",n[n.DataEntryCoarse=6]="DataEntryCoarse",n[n.VolumeCoarse=7]="VolumeCoarse",n[n.PanCoarse=10]="PanCoarse",n[n.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",n[n.BankSelectFine=32]="BankSelectFine",n[n.ModulationFine=33]="ModulationFine",n[n.DataEntryFine=38]="DataEntryFine",n[n.VolumeFine=39]="VolumeFine",n[n.PanFine=42]="PanFine",n[n.ExpressionControllerFine=43]="ExpressionControllerFine",n[n.HoldPedal=64]="HoldPedal",n[n.LegatoPedal=68]="LegatoPedal",n[n.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",n[n.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",n[n.RegisteredParameterFine=100]="RegisteredParameterFine",n[n.RegisteredParameterCourse=101]="RegisteredParameterCourse",n[n.AllSoundOff=120]="AllSoundOff",n[n.ResetControllers=121]="ResetControllers",n[n.AllNotesOff=123]="AllNotesOff"})(ye||(ye={}));class jn{constructor(e){this._midiEventQueue=new kr,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._transpositionPitches=new Map,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=Ei.StereoInterleaved,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(e,t,i){return this.fillWorkingBuffer(e,t,i)}synthesizeSilent(e){this.fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){let i=this.channelInit(e);for(let s of this._voices)s.playingChannel===e&&s.playingPreset!==-1&&(s.mixVolume=t);i.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}applyTranspositionPitches(e){const t=this._transpositionPitches;for(const i of this._voices)if(i.playingChannel>=0&&i.playingChannel!==9){let s=0;t.has(i.playingChannel)&&(s-=t.get(i.playingChannel)),e.has(i.playingChannel)&&(s+=e.get(i.playingChannel)),i.playingKey+=s,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}this._transpositionPitches=e}dispatchEvent(e){this._midiEventQueue.enqueue(e)}fillWorkingBuffer(e,t,i){const s=this._isAnySolo,r=[];for(;!this._midiEventQueue.isEmpty;){let a=this._midiEventQueue.dequeue();a.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(K.MetronomeChannel,33),this.channelNoteOn(K.MetronomeChannel,33,95/127)):a.event&&this.processMidiMessage(a.event),r.push(a)}for(const a of this._voices)if(a.playingPreset!==-1){const o=a.playingChannel,h=this._mutedChannels.has(o)||s&&o!=K.MetronomeChannel&&!this._soloChannels.has(o);e?a.render(this,e,t,i,h):a.kill()}return r}processMidiMessage(e){switch(_.debug("MIdi","Processing Midi message "+ie[e.type]+"/"+e.tick),e.type){case ie.TimeSignature:const i=e;this.timeSignatureNumerator=i.numerator,this.timeSignatureDenominator=Math.pow(2,i.denominatorIndex);break;case ie.NoteOn:const s=e;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case ie.NoteOff:const r=e;this.channelNoteOff(r.channel,r.noteKey);break;case ie.ControlChange:const a=e;this.channelMidiControl(a.channel,a.controller,a.value);break;case ie.ProgramChange:const o=e;this.channelSetPresetNumber(o.channel,o.program,o.channel===9);break;case ie.TempoChange:const h=e;this.currentTempo=6e7/h.microSecondsPerQuarterNote;break;case ie.PitchBend:const l=e;this.channelSetPitchWheel(l.channel,l.value);break;case ie.PerNotePitchBend:const d=e;let c=d.value;c=c*K.MaxPitchWheel/K.MaxPitchWheel20,this.channelSetPerNotePitchWheel(d.channel,d.noteKey,c);break}}get metronomeVolume(){return this.channelGetMixVolume(K.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(K.MetronomeChannel,e),e>0&&(this.channelSetVolume(K.MetronomeChannel,1),this.channelSetPresetNumber(K.MetronomeChannel,0,!0))}get masterVolume(){return Re.decibelsToGain(this.globalGainDb)}set masterVolume(e){var t=Re.gainToDecibels(e);const i=t-this.globalGainDb;if(i!==0){for(const s of this._voices)s.playingPreset!==-1&&(s.noteGainDb+=i);this.globalGainDb=t}}resetSoft(){for(const e of this._voices)e.playingPreset!==-1&&(e.ampEnv.segment<we.Release||e.ampEnv.parameters.release!==0)&&e.endQuick(this.outSampleRate);if(this._channels)for(const e of this._channels.channelList)e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.perNotePitchWheel.clear(),e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0}get presetCount(){var e;return((e=this.presets)==null?void 0:e.length)??0}reset(){for(let e of this._voices)e.playingPreset!==-1&&(e.ampEnv.segment<we.Release||e.ampEnv.parameters.release!==0)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,i){this.outputMode=e,this.outSampleRate=t>=1?t:44100,this.globalGainDb=i}noteOn(e,t,i){if(!this.presets)return;const s=i*127|0;if(e<0||e>=this.presets.length)return;if(i<=0){this.noteOff(e,t);return}const r=this._voicePlayIndex++;for(const a of this.presets[e].regions){if(t<a.loKey||t>a.hiKey||s<a.loVel||s>a.hiVel)continue;let o=null;if(a.group!==0)for(const d of this._voices)d.playingPreset===e&&d.region.group===a.group?d.endQuick(this.outSampleRate):d.playingPreset===-1&&!o&&(o=d);else for(let d of this._voices)d.playingPreset===-1&&(o=d);if(!o){for(let d=0;d<4;d++){const c=new os;c.playingPreset=-1,this._voices.push(c)}o=this._voices[this._voices.length-4]}o.region=a,o.playingPreset=e,o.playingKey=t,o.playIndex=r,o.noteGainDb=this.globalGainDb-a.attenuation-Re.gainToDecibels(1/i),this._channels?this._channels.setupVoice(this,o):(o.calcPitchRatio(0,this.outSampleRate),o.panFactorLeft=Math.sqrt(.5-a.pan),o.panFactorRight=Math.sqrt(.5+a.pan)),o.sourceSamplePosition=a.offset;const h=a.loopMode!==fi.None&&a.loopStart<a.loopEnd;o.loopStart=h?a.loopStart:0,o.loopEnd=h?a.loopEnd:0,o.ampEnv.setup(a.ampEnv,t,s,!0,this.outSampleRate),o.modEnv.setup(a.modEnv,t,s,!1,this.outSampleRate);const l=a.initialFilterQ/10;o.lowPass.qInv=1/Math.pow(10,l/20),o.lowPass.z1=0,o.lowPass.z2=0,o.lowPass.active=a.initialFilterFc<=13500,o.lowPass.active&&o.lowPass.setup(Re.cents2Hertz(a.initialFilterFc)/this.outSampleRate),o.modLfo.setup(a.delayModLFO,a.freqModLFO,this.outSampleRate),o.vibLfo.setup(a.delayVibLFO,a.freqVibLFO,this.outSampleRate)}}bankNoteOn(e,t,i,s){let r=this.getPresetIndex(e,t);return r===-1?!1:(this.noteOn(r,i,s),!0)}noteOff(e,t){let i=null,s=null,r=[];for(let a of this._voices)a.playingPreset!==e||a.playingKey!==t||a.ampEnv.segment>=we.Release||(!i||a.playIndex<i.playIndex?(i=a,s=a,r.push(a)):a.playIndex===i.playIndex&&(s=a,r.push(a)));if(i)for(const a of r)a!==i&&a!==s&&(a.playIndex!==i.playIndex||a.playingPreset!==e||a.playingKey!==t||a.ampEnv.segment>=we.Release)||a.end(this.outSampleRate)}bankNoteOff(e,t,i){const s=this.getPresetIndex(e,t);return s===-1?!1:(this.noteOff(s,i),!0)}noteOffAll(e){for(const t of this._voices)t.playingPreset!==-1&&(e?t.endQuick(this.outSampleRate):t.ampEnv.segment<we.Release&&t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(const t of this._voices)t.playingPreset!==-1&&e++;return e}channelInit(e){if(this._channels&&e<this._channels.channelList.length)return this._channels.channelList[e];this._channels||(this._channels=new Kn);for(let t=this._channels.channelList.length;t<=e;t++){let i=new $n;i.presetIndex=0,i.bank=0,i.pitchWheel=8192,i.midiPan=8192,i.midiVolume=16383,i.midiExpression=16383,i.midiRpn=65535,i.midiData=0,i.panOffset=0,i.gainDb=0,i.pitchRange=2,i.tuning=0,i.mixVolume=1,this._channels.channelList.push(i)}return this._channels.channelList[e]}getPresetIndex(e,t){if(!this.presets)return-1;for(let i=this.presets.length-1;i>=0;i--){let s=this.presets[i];if(s.presetNumber===t&&s.bank===e)return i}return-1}getPresetName(e){return this.presets?e<0||e>=this.presets.length?null:this.presets[e].name:null}bankGetPresetName(e,t){return this.getPresetName(this.getPresetIndex(e,t))}channelNoteOn(e,t,i){!this._channels||e>this._channels.channelList.length||(this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,i))}channelNoteOff(e,t){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e));const i=[];let s=null,r=null;for(const o of this._voices)o.playingPreset===-1||o.playingChannel!==e||o.playingKey!==t||o.ampEnv.segment>=we.Release||(!s||o.playIndex<s.playIndex?(s=o,r=o,i.push(o)):o.playIndex===s.playIndex&&(r=o,i.push(o)));if(this.channelInit(e).perNotePitchWheel.delete(t),!!s)for(const o of i)o!==s&&o!==r&&(o.playIndex!==s.playIndex||o.playingPreset===-1||o.playingChannel!==e||o.playingKey!==t||o.ampEnv.segment>=we.Release)||o.end(this.outSampleRate)}channelNoteOffAll(e){this.channelInit(e).perNotePitchWheel.clear();for(const i of this._voices)i.playingPreset!==-1&&i.playingChannel===e&&i.ampEnv.segment<we.Release&&i.end(this.outSampleRate)}channelSoundsOffAll(e){this.channelInit(e).perNotePitchWheel.clear();for(let i of this._voices)i.playingPreset!==-1&&i.playingChannel===e&&(i.ampEnv.segment<we.Release||i.ampEnv.parameters.release===0)&&i.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this.channelInit(e).presetIndex=Z.int32ToUint16(t)}channelSetPresetNumber(e,t,i=!1){const s=this.channelInit(e);let r=0;return i?(r=this.getPresetIndex(128|s.bank&32767,t),r===-1&&(r=this.getPresetIndex(128,t)),r===-1&&(r=this.getPresetIndex(128,0)),r===-1&&(r=this.getPresetIndex(s.bank&2047,t))):r=this.getPresetIndex(s.bank&2047,t),s.presetIndex=r,r!==-1}channelSetBank(e,t){this.channelInit(e).bank=Z.int32ToUint16(t)}channelSetBankPreset(e,t,i){const s=this.channelInit(e),r=this.getPresetIndex(t,i);return r===-1?!1:(s.presetIndex=Z.int32ToUint16(r),s.bank=Z.int32ToUint16(t),!0)}channelSetPan(e,t){for(const i of this._voices)if(i.playingChannel===e&&i.playingPreset!==-1){let s=i.region.pan+t-.5;s<=-.5?(i.panFactorLeft=1,i.panFactorRight=0):s>=.5?(i.panFactorLeft=0,i.panFactorRight=1):(i.panFactorLeft=Math.sqrt(.5-s),i.panFactorRight=Math.sqrt(.5+s))}this.channelInit(e).panOffset=t-.5}channelSetVolume(e,t){const i=this.channelInit(e),s=Re.gainToDecibels(t),r=s-i.gainDb;if(r!==0){for(const a of this._voices)a.playingChannel===e&&a.playingPreset!==-1&&(a.noteGainDb+=r);i.gainDb=s}}channelSetPitchWheel(e,t){const i=this.channelInit(e);i.pitchWheel!==t&&(i.pitchWheel=Z.int32ToUint16(t),this.channelApplyPitch(e,i))}channelSetPerNotePitchWheel(e,t,i){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e));const s=this.channelInit(e);s.perNotePitchWheel.has(t)&&s.perNotePitchWheel.get(t)===i||(s.perNotePitchWheel.set(t,i),this.channelApplyPitch(e,s,t))}channelApplyPitch(e,t,i=-1){for(const s of this._voices)s.playingChannel===e&&s.playingPreset!==-1&&(i==-1||s.playingKey===i)&&s.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){const i=this.channelInit(e);i.pitchRange!==t&&(i.pitchRange=t,i.pitchWheel!==8192&&this.channelApplyPitch(e,i))}channelSetTuning(e,t){const i=this.channelInit(e);i.tuning!==t&&(i.tuning=t,this.channelApplyPitch(e,i))}channelMidiControl(e,t,i){let s=this.channelInit(e);switch(t){case ye.DataEntryFine:s.midiData=Z.int32ToUint16(s.midiData&16256|i),s.midiRpn===0?this.channelSetPitchRange(e,(s.midiData>>7)+.01*(s.midiData&127)):s.midiRpn===1?this.channelSetTuning(e,(s.tuning|0)+(s.midiData-8192)/8192):s.midiRpn===2&&this.channelSetTuning(e,i-64+(s.tuning-(s.tuning|0)));return;case ye.VolumeCoarse:s.midiVolume=Z.int32ToUint16(s.midiVolume&127|i<<7),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case ye.VolumeFine:s.midiVolume=Z.int32ToUint16(s.midiVolume&16256|i),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case ye.ExpressionControllerCoarse:s.midiExpression=Z.int32ToUint16(s.midiExpression&127|i<<7),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case ye.ExpressionControllerFine:s.midiExpression=Z.int32ToUint16(s.midiExpression&16256|i),this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));return;case ye.PanCoarse:s.midiPan=Z.int32ToUint16(s.midiPan&127|i<<7),this.channelSetPan(e,s.midiPan/16383);return;case ye.PanFine:s.midiPan=Z.int32ToUint16(s.midiPan&16256|i),this.channelSetPan(e,s.midiPan/16383);return;case ye.DataEntryCoarse:s.midiData=Z.int32ToUint16(s.midiData&127|i<<7),s.midiRpn===0?this.channelSetPitchRange(e,(s.midiData>>7)+.01*(s.midiData&127)):s.midiRpn===1?this.channelSetTuning(e,(s.tuning|0)+(s.midiData-8192)/8192):s.midiRpn===2&&t===ye.DataEntryCoarse&&this.channelSetTuning(e,i-64+(s.tuning-(s.tuning|0)));return;case ye.BankSelectCoarse:s.bank=Z.int32ToUint16(32768|i);return;case ye.BankSelectFine:s.bank=Z.int32ToUint16((s.bank&32768?(s.bank&127)<<7:0)|i);return;case ye.RegisteredParameterCourse:s.midiRpn=Z.int32ToUint16((s.midiRpn===65535?0:s.midiRpn)&127|i<<7);return;case ye.RegisteredParameterFine:s.midiRpn=Z.int32ToUint16((s.midiRpn===65535?0:s.midiRpn)&16256|i);return;case ye.NonRegisteredParameterFine:s.midiRpn=65535;return;case ye.NonRegisteredParameterCourse:s.midiRpn=65535;return;case ye.AllSoundOff:this.channelSoundsOffAll(e);return;case ye.AllNotesOff:this.channelNoteOffAll(e);return;case ye.ResetControllers:s.midiVolume=16383,s.midiExpression=16383,s.midiPan=8192,s.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),this.channelSetPitchRange(e,2);return}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].bank&32767:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Re.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(e,t){const i=[];for(let s=0;s<e.phdrs.length-1;s++){const r=e.phdrs[s];let a=0;const o=new Zn;i.push(o),o.name=r.presetName,o.bank=r.bank,o.presetNumber=r.preset,o.fontSamples=e.fontSamples;let h=0;for(let d=r.presetBagNdx;d<e.phdrs[s+1].presetBagNdx;d++){const c=e.pbags[d];let f=0,p=127,g=0,b=127;for(let w=c.genNdx;w<e.pbags[d+1].genNdx;w++){let D=e.pgens[w];if(D.genOper===kt.GenKeyRange){f=D.genAmount.lowByteAmount,p=D.genAmount.highByteAmount;continue}if(D.genOper===kt.GenVelRange){g=D.genAmount.lowByteAmount,b=D.genAmount.highByteAmount;continue}if(D.genOper!==kt.GenInstrument||D.genAmount.wordAmount>=e.insts.length)continue;let R=e.insts[D.genAmount.wordAmount];for(let B=R.instBagNdx;B<e.insts[D.genAmount.wordAmount+1].instBagNdx;B++){let X=e.ibags[B],C=0,be=127,Fe=0,Pe=127;for(let ge=X.instGenNdx;ge<e.ibags[B+1].instGenNdx;ge++){let ct=e.igens[ge];if(ct.genOper===kt.GenKeyRange){C=ct.genAmount.lowByteAmount,be=ct.genAmount.highByteAmount;continue}if(ct.genOper===kt.GenVelRange){Fe=ct.genAmount.lowByteAmount,Pe=ct.genAmount.highByteAmount;continue}ct.genOper===53&&be>=f&&C<=p&&Pe>=g&&Fe<=b&&h++}}}}o.regions=new Array(h);let l=new Yi;l.clear(!0);for(let d=r.presetBagNdx;d<e.phdrs[s+1].presetBagNdx;d++){const c=e.pbags[d],f=new Yi(l);let p=!1;for(let g=c.genNdx;g<e.pbags[d+1].genNdx;g++){const b=e.pgens[g];if(b.genOper===kt.GenInstrument){let w=b.genAmount.wordAmount;if(w>=e.insts.length)continue;let D=new Yi;D.clear(!1);let R=e.insts[w];for(let B=R.instBagNdx;B<e.insts[w+1].instBagNdx;B++){let X=e.ibags[B],C=new Yi(D),be=!1;for(let Fe=X.instGenNdx;Fe<e.ibags[B+1].instGenNdx;Fe++){let Pe=e.igens[Fe];if(Pe.genOper===kt.GenSampleId){if(C.hiKey<f.loKey||C.loKey>f.hiKey||C.hiVel<f.loVel||C.loVel>f.hiVel)continue;f.loKey>C.loKey&&(C.loKey=f.loKey),f.hiKey<C.hiKey&&(C.hiKey=f.hiKey),f.loVel>C.loVel&&(C.loVel=f.loVel),f.hiVel<C.hiVel&&(C.hiVel=f.hiVel),C.offset+=f.offset,C.end+=f.end,C.loopStart+=f.loopStart,C.loopEnd+=f.loopEnd,C.transpose+=f.transpose,C.tune+=f.tune,C.pitchKeyTrack+=f.pitchKeyTrack,C.attenuation+=f.attenuation,C.pan+=f.pan,C.ampEnv.delay+=f.ampEnv.delay,C.ampEnv.attack+=f.ampEnv.attack,C.ampEnv.hold+=f.ampEnv.hold,C.ampEnv.decay+=f.ampEnv.decay,C.ampEnv.sustain+=f.ampEnv.sustain,C.ampEnv.release+=f.ampEnv.release,C.modEnv.delay+=f.modEnv.delay,C.modEnv.attack+=f.modEnv.attack,C.modEnv.hold+=f.modEnv.hold,C.modEnv.decay+=f.modEnv.decay,C.modEnv.sustain+=f.modEnv.sustain,C.modEnv.release+=f.modEnv.release,C.initialFilterQ+=f.initialFilterQ,C.initialFilterFc+=f.initialFilterFc,C.modEnvToPitch+=f.modEnvToPitch,C.modEnvToFilterFc+=f.modEnvToFilterFc,C.delayModLFO+=f.delayModLFO,C.freqModLFO+=f.freqModLFO,C.modLfoToPitch+=f.modLfoToPitch,C.modLfoToFilterFc+=f.modLfoToFilterFc,C.modLfoToVolume+=f.modLfoToVolume,C.delayVibLFO+=f.delayVibLFO,C.freqVibLFO+=f.freqVibLFO,C.vibLfoToPitch+=f.vibLfoToPitch,C.ampEnv.envToSecs(!0),C.modEnv.envToSecs(!1),C.delayModLFO=C.delayModLFO<-11950?0:Re.timecents2Secs(C.delayModLFO),C.delayVibLFO=C.delayVibLFO<-11950?0:Re.timecents2Secs(C.delayVibLFO),C.pan<-.5?C.pan=-.5:C.pan>.5&&(C.pan=.5),(C.initialFilterQ<1500||C.initialFilterQ>13500)&&(C.initialFilterQ=0);let ge=e.sHdrs[Pe.genAmount.wordAmount];C.offset+=ge.start,C.end+=ge.end,C.loopStart+=ge.startLoop,C.loopEnd+=ge.endLoop,ge.endLoop>0&&(C.loopEnd-=1),C.pitchKeyCenter===-1&&(C.pitchKeyCenter=ge.originalPitch),C.tune+=ge.pitchCorrection,C.sampleRate=ge.sampleRate,C.end!==0&&C.end<o.fontSamples.length?C.end++:C.end=o.fontSamples.length,o.regions[a]=new Yi(C),a++,be=!0}else C.operator(Pe.genOper,Pe.genAmount)}X===e.ibags[R.instBagNdx]&&!be&&(D=new Yi(C))}p=!0}else f.operator(b.genOper,b.genAmount)}c===e.pbags[r.presetBagNdx]&&!p&&(l=f)}}if(!t||!this.presets)this.presets=i;else for(const s of i)this.presets.push(s)}}class Je{constructor(){this._listeners=[]}on(e){this._listeners.push(e)}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(){for(const e of this._listeners)e()}}class re{constructor(){this._listeners=[]}on(e){this._listeners.push(e)}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(e){for(const t of this._listeners)t(e)}}class Fa{constructor(e){this.events=e}}class Ea{constructor(e){this.playbackRange=e}}class eo{get isReadyForPlayback(){return this.isReady&&this._isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return _.logLevel}set logLevel(e){_.logLevel=e}get masterVolume(){return this._synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,K.MinVolume),this._synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,K.MinVolume),this._metronomeVolume=e,this._synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,K.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this._midiEventsPlayedFilter)}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=new Set(e)}get playbackSpeed(){return this._sequencer.playbackSpeed}set playbackSpeed(e){e=Re.clamp(e,K.MinPlaybackSpeed,K.MaxPlaybackSpeed);let t=this._sequencer.playbackSpeed;this._sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this._sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){_.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this._sequencer.mainSeek(e),this.updateTimePosition(e,!0),this._sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this._sequencer.mainPlaybackRange}set playbackRange(e){this._sequencer.mainPlaybackRange=e,e&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new Ea(e))}get isLooping(){return this._sequencer.isLooping}set isLooping(e){this._sequencer.isLooping=e}destroy(){_.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(e,t){this._isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this._playedEventsQueue=new kr,this._midiEventsPlayedFilter=new Set,this._notPlayedSamples=0,this._synthStopping=!1,this.isReady=!1,this.state=qe.Paused,this.ready=new Je,this.readyForPlayback=new Je,this.finished=new Je,this.soundFontLoaded=new Je,this.soundFontLoadFailed=new re,this.midiLoaded=new re,this.midiLoadFailed=new re,this.stateChanged=new re,this.positionChanged=new re,this.midiEventsPlayed=new re,this.playbackRangeChanged=new re,_.debug("AlphaSynth","Initializing player"),this.state=qe.Paused,_.debug("AlphaSynth","Creating output"),this.output=e,_.debug("AlphaSynth","Creating synthesizer"),this._synthesizer=new jn(this.output.sampleRate),this._sequencer=new Qn(this._synthesizer),_.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{if(this.state==qe.Playing&&(!this._sequencer.isFinished||this._synthesizer.activeVoiceCount>0)){let i=new Float32Array(K.MicroBufferSize*K.MicroBufferCount*K.AudioChannels),s=0;for(let r=0;r<K.MicroBufferCount;r++){this._sequencer.fillMidiEventQueue();const a=this._synthesizer.synthesize(i,s,K.MicroBufferSize);s+=K.MicroBufferSize*K.AudioChannels;for(const o of a)this._midiEventsPlayedFilter.has(o.event.type)&&this._playedEventsQueue.enqueue(o);if(this._sequencer.isFinished)break}s<i.length&&(i=i.subarray(0,s)),this._notPlayedSamples+=i.length,this.output.addSamples(i)}else{let i=new Float32Array(0);this.output.addSamples(i)}}),this.output.samplesPlayed.on(this.onSamplesPlayed.bind(this)),this.output.open(t)}play(){return this.state!==qe.Paused||!this._isMidiLoaded?!1:(this.output.activate(),this.playInternal(),this._countInVolume>0&&(_.debug("AlphaSynth","Starting countin"),this._sequencer.startCountIn(),this._synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),!0)}playInternal(){this._sequencer.isPlayingOneTimeMidi&&(_.debug("AlphaSynth","Cancelling one time midi"),this.stopOneTimeMidi()),_.debug("AlphaSynth","Starting playback"),this._synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=qe.Playing,this.stateChanged.trigger(new Ls(this.state,!1))}pause(){this.state===qe.Paused||!this._isMidiLoaded||(_.debug("AlphaSynth","Pausing playback"),this.state=qe.Paused,this.stateChanged.trigger(new Ls(this.state,!1)),this.output.pause(),this._synthesizer.noteOffAll(!1))}playPause(){this.state!==qe.Paused||!this._isMidiLoaded?this.pause():this.play()}stop(){this._isMidiLoaded&&(_.debug("AlphaSynth","Stopping playback"),this.state=qe.Paused,this.output.pause(),this._notPlayedSamples=0,this._sequencer.stop(),this._synthesizer.noteOffAll(!0),this.tickPosition=this._sequencer.mainPlaybackRange?this._sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new Ls(this.state,!0)))}playOneTimeMidiFile(e){this._sequencer.isPlayingOneTimeMidi?this.stopOneTimeMidi():this.pause(),this._sequencer.loadOneTimeMidi(e),this._synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this._synthesizer.resetPresets(),this._isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(e,t){this.pause();let i=Ke.fromBuffer(e);try{_.debug("AlphaSynth","Loading soundfont from bytes");let s=new fr;s.load(i),this._synthesizer.loadPresets(s,t),this._isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),_.debug("AlphaSynth","soundFont successfully loaded"),this.checkReadyForPlayback()}catch(s){_.error("AlphaSynth","Could not load soundfont from bytes "+s),this.soundFontLoadFailed.trigger(s)}}checkReadyForPlayback(){this.isReadyForPlayback&&(this._synthesizer.setupMetronomeChannel(this.metronomeVolume),this.readyForPlayback.trigger())}loadMidiFile(e){this.stop();try{_.debug("AlphaSynth","Loading midi from model"),this._sequencer.loadMidi(e),this._isMidiLoaded=!0,this.midiLoaded.trigger(new vs(0,this._sequencer.currentEndTime,0,this._sequencer.currentEndTick,!1)),_.debug("AlphaSynth","Midi successfully loaded"),this.checkReadyForPlayback(),this.tickPosition=0}catch(t){_.error("AlphaSynth","Could not load midi from model "+t),this.midiLoadFailed.trigger(t)}}applyTranspositionPitches(e){this._synthesizer.applyTranspositionPitches(e)}setChannelMute(e,t){this._synthesizer.channelSetMute(e,t)}resetChannelStates(){this._synthesizer.resetChannelStates()}setChannelSolo(e,t){this._synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,K.MinVolume),this._synthesizer.channelSetMixVolume(e,t)}onSamplesPlayed(e){if(e===0)return;let t=e/this._synthesizer.outSampleRate*1e3;this._notPlayedSamples-=e*K.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish()}checkForFinish(){let e=0,t=0;this.playbackRange&&this._sequencer.isPlayingMain?(e=this.playbackRange.startTick,t=this.playbackRange.endTick):t=this._sequencer.currentEndTick,this._tickPosition>=t&&this._notPlayedSamples<=0&&(this._notPlayedSamples=0,this._sequencer.isPlayingCountIn?(_.debug("AlphaSynth","Finished playback (count-in)"),this._sequencer.resetCountIn(),this.timePosition=this._sequencer.currentTime,this.playInternal(),this.output.resetSamples()):this._sequencer.isPlayingOneTimeMidi?(_.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=qe.Paused,this.stopOneTimeMidi()):this.isLooping?(_.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=e,this._synthStopping=!1):this._synthesizer.activeVoiceCount>0?this._synthStopping||(this._synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,_.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop()))}stopOneTimeMidi(){this.output.pause(),this._synthesizer.noteOffAll(!0),this._sequencer.resetOneTimeMidi(),this.timePosition=this._sequencer.currentTime}updateTimePosition(e,t){let i=e;this._timePosition=i;let s=this._sequencer.currentTimePositionToTickPosition(i);this._tickPosition=s;const r=this._sequencer.currentEndTime,a=this._sequencer.currentEndTick;i>r&&(i=r,s=a);const o=this._sequencer.isPlayingMain?"main":this._sequencer.isPlayingCountIn?"count-in":"one-time";if(_.debug("AlphaSynth",`Position changed: (time: ${i}/${r}, tick: ${s}/${a}, Active Voices: ${this._synthesizer.activeVoiceCount} (${o})`),this._sequencer.isPlayingMain&&this.positionChanged.trigger(new vs(i,r,s,a,t)),t)this._playedEventsQueue.clear();else{const h=new kr;for(;!this._playedEventsQueue.isEmpty&&this._playedEventsQueue.peek().time<i;){const l=this._playedEventsQueue.dequeue();h.enqueue(l.event)}h.isEmpty||this.midiEventsPlayed.trigger(new Fa(h.toArray()))}}}class F{static parseEnum(e,t){switch(typeof e){case"string":const i=parseInt(e);return isNaN(i)?t[Object.keys(t).find(s=>s.toLowerCase()===e.toLowerCase())]:i;case"number":return e;case"undefined":case"object":return null}throw new nt(at.Format,`Could not parse enum value '${e}'`)}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if(typeof e=="object")for(const i in e)t(e[i],i)}static getValue(e,t){return e instanceof Map?e.get(t):typeof e=="object"?e[t]:null}}class to{constructor(e,t,i){this.text=e,this.startPos=t,this.endPos=i}}class Xi{constructor(e){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=e,this._tokens=this.splitToTokens(e)}splitToTokens(e){const t=[];let i=0;for(;i<e.length;){let s=i;for(;s<e.length&&e.charAt(s)!==" ";)s++;s>i&&t.push(new to(e.substring(i,s),i,s)),i=s+1}return t}parse(){var e;if(this.reset(),this._tokens.length===1)switch((e=this._currentToken)==null?void 0:e.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.fontStyleVariantWeight(),this.fontSizeLineHeight()),this.fontFamily()}static parseFamilies(e){const t=new Xi(e);return t.parseOnlyFamilies=!0,t.parse(),t.families}fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const e=this._input.substr(this._currentToken.startPos).trim();let t=0;for(;t<e.length;){let i=e.charAt(t);if(i===" "||i==",")t++;else if(i==='"'||i==="'"){const s=this.findEndOfQuote(e,t+1,i);this.families.push(e.substring(t+1,s).split("\\"+i).join(i)),t=s+1}else{const s=this.findEndOfQuote(e,t+1,",");this.families.push(e.substring(t,s).trim()),t=s+1}}}findEndOfQuote(e,t,i){let s=!1;for(;t<e.length;){const r=e.charAt(t);if(!s&&r===i)return t;!s&&r==="\\"?s=!0:s=!1,t+=1}return e.length}fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");const e=this._currentToken.text.split("/");if(e.length>=3)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this.nextToken(),e.length>=2)if(e[1]==="/"){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.size=e[0],this.lineHeight=e[1];else if(e.length>=1){if(this.size=e[0],this._currentToken&&this._currentToken.text.indexOf("/")===0)if(this._currentToken.text==="/"){if(this.nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this.nextToken()}else throw new Error("Missing font size")}nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}fontStyleVariantWeight(){let e=!1,t=!1,i=!1,s=3,r=[];for(;;){if(!this._currentToken)return;let a=this._currentToken.text;switch(a){case"normal":case"inherit":r.push(a),s--,this.nextToken();break;case"italic":case"oblique":this.style=a,e=!0,s--,this.nextToken();break;case"small-caps":this.variant=a,t=!0,s--,this.nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=a,i=!0,s--,this.nextToken();break;default:return}if(s===0)break}for(;r.length>0;){const a=r.pop();i?t?e||(this.style=a):this.variant=a:this.weight=a}}reset(){this._currentTokenIndex=-1,this.nextToken()}static quoteFont(e){return e.indexOf(" ")===-1?e:`"${e.replaceAll('"','\\"')}"`}}var Ce;(function(n){n[n.Plain=0]="Plain",n[n.Italic=1]="Italic"})(Ce||(Ce={}));var _t;(function(n){n[n.Regular=0]="Regular",n[n.Bold=1]="Bold"})(_t||(_t={}));class ne{reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=Xi.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this.reset()}get size(){return this._size}set size(e){this._size=e,this.reset()}get style(){return this._style}set style(e){this._style=e,this.reset()}get weight(){return this._weight}set weight(e){this._weight=e,this.reset()}get isBold(){return this.weight===_t.Bold}get isItalic(){return this.style===Ce.Italic}constructor(e,t,i=Ce.Plain,s=_t.Regular){this._cssScale=0,this._families=Xi.parseFamilies(e),this._size=t,this._style=i,this._weight=s,this._css=this.toCssString()}static withFamilyList(e,t,i=Ce.Plain,s=_t.Regular){const r=new ne("",t,i,s);return r.families=e,r}toCssString(e=1){if(!this._css||!(Math.abs(e-this._cssScale)<.01)){let t="";this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+=this.size*e,t+="px ",t+=this.families.map(i=>Xi.quoteFont(i)).join(", "),this._css=t,this._cssScale=e}return this._css}static fromJson(e){if(e instanceof ne)return e;switch(typeof e){case"undefined":return null;case"object":{const t=e;let i=t.get("families"),s=t.get("size"),r=F.parseEnum(t.get("style"),Ce),a=F.parseEnum(t.get("weight"),_t);return ne.withFamilyList(i,s,r,a)}case"string":{const t=new Xi(e);t.parse();let i=t.families,s=t.size.toLowerCase(),r=0;switch(s){case"xx-small":r=7;break;case"x-small":r=10;break;case"small":case"smaller":r=13;break;case"medium":r=16;break;case"large":case"larger":r=18;break;case"x-large":r=24;break;case"xx-large":r=32;break;default:try{s.endsWith("em")?r=parseFloat(s.substr(0,s.length-2))*16:s.endsWith("pt")?r=parseFloat(s.substr(0,s.length-2))*16/12:s.endsWith("px")?r=parseFloat(s.substr(0,s.length-2)):r=12}catch{r=12}break}let a=Ce.Plain;t.style==="italic"&&(a=Ce.Italic);let o=_t.Regular;switch(t.weight.toLowerCase()){case"normal":case"lighter":break;default:o=_t.Bold;break}return ne.withFamilyList(i,r,a,o)}default:return null}}static toJson(e){const t=new Map;return t.set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}}class bt{constructor(){this.copyrightFont=new ne(bt.sansFont,12,Ce.Plain,_t.Bold),this.titleFont=new ne(bt.serifFont,32,Ce.Plain),this.subTitleFont=new ne(bt.serifFont,20,Ce.Plain),this.wordsFont=new ne(bt.serifFont,15,Ce.Plain),this.effectFont=new ne(bt.serifFont,12,Ce.Italic),this.fretboardNumberFont=new ne(bt.sansFont,11,Ce.Plain),this.tablatureFont=new ne(bt.sansFont,13,Ce.Plain),this.graceFont=new ne(bt.sansFont,11,Ce.Plain),this.staffLineColor=new fe(165,165,165,255),this.barSeparatorColor=new fe(34,34,17,255),this.barNumberFont=new ne(bt.sansFont,11,Ce.Plain),this.barNumberColor=new fe(200,0,0,255),this.fingeringFont=new ne(bt.serifFont,14,Ce.Plain),this.markerFont=new ne(bt.serifFont,14,Ce.Plain,_t.Bold),this.mainGlyphColor=new fe(0,0,0,255),this.secondaryGlyphColor=new fe(0,0,0,100),this.scoreInfoColor=new fe(0,0,0,255)}}bt.sansFont="Arial, sans-serif",bt.serifFont="Georgia, serif";var Bi;(function(n){n[n.Automatic=0]="Automatic",n[n.UseModelLayout=1]="UseModelLayout"})(Bi||(Bi={}));class io{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=ai.Page,this.staveProfile=Bt.Default,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.justifyLastSystem=!1,this.resources=new bt,this.padding=[35,35],this.firstSystemPaddingTop=5,this.systemPaddingTop=10,this.systemPaddingBottom=20,this.lastSystemPaddingBottom=0,this.systemLabelPaddingLeft=0,this.systemLabelPaddingRight=5,this.accoladeBarPaddingRight=3,this.notationStaffPaddingTop=5,this.notationStaffPaddingBottom=5,this.effectStaffPaddingTop=0,this.effectStaffPaddingBottom=0,this.systemsLayoutMode=Bi.Automatic}}class so{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}}var pi;(function(n){n[n.Off=0]="Off",n[n.Continuous=1]="Continuous",n[n.OffScreen=2]="OffScreen"})(pi||(pi={}));class ro{constructor(){this.noteWideLength=480,this.noteWideAmplitude=2,this.noteSlightLength=480,this.noteSlightAmplitude=2,this.beatWideLength=240,this.beatWideAmplitude=3,this.beatSlightLength=240,this.beatSlightAmplitude=3}}class ao{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}}var hs;(function(n){n[n.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",n[n.WebAudioScriptProcessor=1]="WebAudioScriptProcessor"})(hs||(hs={}));class no{constructor(){this.soundFont=null,this.scrollElement="html,body",this.outputMode=hs.WebAudioAudioWorklets,this.enablePlayer=!1,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=pi.Continuous,this.scrollSpeed=300,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new ro,this.slide=new ao,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}}class _r{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t}static setProperty(e,t,i){switch(t){case"scriptfile":return e.scriptFile=i,!0;case"fontdirectory":return e.fontDirectory=i,!0;case"file":return e.file=i,!0;case"tex":return e.tex=i,!0;case"tracks":return e.tracks=i,!0;case"enablelazyloading":return e.enableLazyLoading=i,!0;case"engine":return e.engine=i,!0;case"loglevel":return e.logLevel=F.parseEnum(i,Vt),!0;case"useworkers":return e.useWorkers=i,!0;case"includenotebounds":return e.includeNoteBounds=i,!0}return!1}}class Tr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("copyrightfont",ne.toJson(e.copyrightFont)),t.set("titlefont",ne.toJson(e.titleFont)),t.set("subtitlefont",ne.toJson(e.subTitleFont)),t.set("wordsfont",ne.toJson(e.wordsFont)),t.set("effectfont",ne.toJson(e.effectFont)),t.set("fretboardnumberfont",ne.toJson(e.fretboardNumberFont)),t.set("tablaturefont",ne.toJson(e.tablatureFont)),t.set("gracefont",ne.toJson(e.graceFont)),t.set("stafflinecolor",fe.toJson(e.staffLineColor)),t.set("barseparatorcolor",fe.toJson(e.barSeparatorColor)),t.set("barnumberfont",ne.toJson(e.barNumberFont)),t.set("barnumbercolor",fe.toJson(e.barNumberColor)),t.set("fingeringfont",ne.toJson(e.fingeringFont)),t.set("markerfont",ne.toJson(e.markerFont)),t.set("mainglyphcolor",fe.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",fe.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",fe.toJson(e.scoreInfoColor)),t}static setProperty(e,t,i){switch(t){case"copyrightfont":return e.copyrightFont=ne.fromJson(i),!0;case"titlefont":return e.titleFont=ne.fromJson(i),!0;case"subtitlefont":return e.subTitleFont=ne.fromJson(i),!0;case"wordsfont":return e.wordsFont=ne.fromJson(i),!0;case"effectfont":return e.effectFont=ne.fromJson(i),!0;case"fretboardnumberfont":return e.fretboardNumberFont=ne.fromJson(i),!0;case"tablaturefont":return e.tablatureFont=ne.fromJson(i),!0;case"gracefont":return e.graceFont=ne.fromJson(i),!0;case"stafflinecolor":return e.staffLineColor=fe.fromJson(i),!0;case"barseparatorcolor":return e.barSeparatorColor=fe.fromJson(i),!0;case"barnumberfont":return e.barNumberFont=ne.fromJson(i),!0;case"barnumbercolor":return e.barNumberColor=fe.fromJson(i),!0;case"fingeringfont":return e.fingeringFont=ne.fromJson(i),!0;case"markerfont":return e.markerFont=ne.fromJson(i),!0;case"mainglyphcolor":return e.mainGlyphColor=fe.fromJson(i),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=fe.fromJson(i),!0;case"scoreinfocolor":return e.scoreInfoColor=fe.fromJson(i),!0}return!1}}class xr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("justifylastsystem",e.justifyLastSystem),t.set("resources",Tr.toJson(e.resources)),t.set("padding",e.padding),t.set("firstsystempaddingtop",e.firstSystemPaddingTop),t.set("systempaddingtop",e.systemPaddingTop),t.set("systempaddingbottom",e.systemPaddingBottom),t.set("lastsystempaddingbottom",e.lastSystemPaddingBottom),t.set("systemlabelpaddingleft",e.systemLabelPaddingLeft),t.set("systemlabelpaddingright",e.systemLabelPaddingRight),t.set("accoladebarpaddingright",e.accoladeBarPaddingRight),t.set("notationstaffpaddingtop",e.notationStaffPaddingTop),t.set("notationstaffpaddingbottom",e.notationStaffPaddingBottom),t.set("effectstaffpaddingtop",e.effectStaffPaddingTop),t.set("effectstaffpaddingbottom",e.effectStaffPaddingBottom),t.set("systemslayoutmode",e.systemsLayoutMode),t}static setProperty(e,t,i){switch(t){case"scale":return e.scale=i,!0;case"stretchforce":return e.stretchForce=i,!0;case"layoutmode":return e.layoutMode=F.parseEnum(i,ai),!0;case"staveprofile":return e.staveProfile=F.parseEnum(i,Bt),!0;case"barsperrow":return e.barsPerRow=i,!0;case"startbar":return e.startBar=i,!0;case"barcount":return e.barCount=i,!0;case"barcountperpartial":return e.barCountPerPartial=i,!0;case"justifylastsystem":return e.justifyLastSystem=i,!0;case"padding":return e.padding=i,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=i,!0;case"systempaddingtop":return e.systemPaddingTop=i,!0;case"systempaddingbottom":return e.systemPaddingBottom=i,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=i,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=i,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=i,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=i,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=i,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=i,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=i,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=i,!0;case"systemslayoutmode":return e.systemsLayoutMode=F.parseEnum(i,Bi),!0}if(["resources"].indexOf(t)>=0)return Tr.fromJson(e.resources,i),!0;for(const s of["resources"])if(t.indexOf(s)===0&&Tr.setProperty(e.resources,t.substring(s.length),i))return!0;return!1}}class Nr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;t.set("notationmode",e.notationMode),t.set("fingeringmode",e.fingeringMode);{const i=new Map;t.set("elements",i);for(const[s,r]of e.elements)i.set(s.toString(),r)}return t.set("rhythmmode",e.rhythmMode),t.set("rhythmheight",e.rhythmHeight),t.set("transpositionpitches",e.transpositionPitches),t.set("displaytranspositionpitches",e.displayTranspositionPitches),t.set("smallgracetabnotes",e.smallGraceTabNotes),t.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),t.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),t.set("slurheight",e.slurHeight),t}static setProperty(e,t,i){switch(t){case"notationmode":return e.notationMode=F.parseEnum(i,Ye),!0;case"fingeringmode":return e.fingeringMode=F.parseEnum(i,Ot),!0;case"elements":return e.elements=new Map,F.forEach(i,(s,r)=>{e.elements.set(F.parseEnum(r,G),s)}),!0;case"rhythmmode":return e.rhythmMode=F.parseEnum(i,hi),!0;case"rhythmheight":return e.rhythmHeight=i,!0;case"transpositionpitches":return e.transpositionPitches=i,!0;case"displaytranspositionpitches":return e.displayTranspositionPitches=i,!0;case"smallgracetabnotes":return e.smallGraceTabNotes=i,!0;case"extendbendarrowsontiednotes":return e.extendBendArrowsOnTiedNotes=i,!0;case"extendlineeffectstobeatend":return e.extendLineEffectsToBeatEnd=i,!0;case"slurheight":return e.slurHeight=i,!0}return!1}}class Pr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t}static setProperty(e,t,i){switch(t){case"encoding":return e.encoding=i,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=i,!0;case"beattextaslyrics":return e.beatTextAsLyrics=i,!0}return!1}}class Cr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t}static setProperty(e,t,i){switch(t){case"notewidelength":return e.noteWideLength=i,!0;case"notewideamplitude":return e.noteWideAmplitude=i,!0;case"noteslightlength":return e.noteSlightLength=i,!0;case"noteslightamplitude":return e.noteSlightAmplitude=i,!0;case"beatwidelength":return e.beatWideLength=i,!0;case"beatwideamplitude":return e.beatWideAmplitude=i,!0;case"beatslightlength":return e.beatSlightLength=i,!0;case"beatslightamplitude":return e.beatSlightAmplitude=i,!0}return!1}}class Lr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t}static setProperty(e,t,i){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=i,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=i,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=i,!0}return!1}}class vr{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("soundfont",e.soundFont),t.set("outputmode",e.outputMode),t.set("enableplayer",e.enablePlayer),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",Cr.toJson(e.vibrato)),t.set("slide",Lr.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t}static setProperty(e,t,i){switch(t){case"soundfont":return e.soundFont=i,!0;case"scrollelement":return e.scrollElement=i,!0;case"outputmode":return e.outputMode=F.parseEnum(i,hs),!0;case"enableplayer":return e.enablePlayer=i,!0;case"enablecursor":return e.enableCursor=i,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=i,!0;case"enableelementhighlighting":return e.enableElementHighlighting=i,!0;case"enableuserinteraction":return e.enableUserInteraction=i,!0;case"scrolloffsetx":return e.scrollOffsetX=i,!0;case"scrolloffsety":return e.scrollOffsetY=i,!0;case"scrollmode":return e.scrollMode=F.parseEnum(i,pi),!0;case"scrollspeed":return e.scrollSpeed=i,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=i,!0;case"songbookbendduration":return e.songBookBendDuration=i,!0;case"songbookdipduration":return e.songBookDipDuration=i,!0;case"playtripletfeel":return e.playTripletFeel=i,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=i,!0}if(["vibrato"].indexOf(t)>=0)return Cr.fromJson(e.vibrato,i),!0;for(const s of["vibrato"])if(t.indexOf(s)===0&&Cr.setProperty(e.vibrato,t.substring(s.length),i))return!0;if(["slide"].indexOf(t)>=0)return Lr.fromJson(e.slide,i),!0;for(const s of["slide"])if(t.indexOf(s)===0&&Lr.setProperty(e.slide,t.substring(s.length),i))return!0;return!1}}class qi{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s.toLowerCase(),i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("core",_r.toJson(e.core)),t.set("display",xr.toJson(e.display)),t.set("notation",Nr.toJson(e.notation)),t.set("importer",Pr.toJson(e.importer)),t.set("player",vr.toJson(e.player)),t}static setProperty(e,t,i){if(["core",""].indexOf(t)>=0)return _r.fromJson(e.core,i),!0;for(const s of["core",""])if(t.indexOf(s)===0&&_r.setProperty(e.core,t.substring(s.length),i))return!0;if(["display",""].indexOf(t)>=0)return xr.fromJson(e.display,i),!0;for(const s of["display",""])if(t.indexOf(s)===0&&xr.setProperty(e.display,t.substring(s.length),i))return!0;if(["notation"].indexOf(t)>=0)return Nr.fromJson(e.notation,i),!0;for(const s of["notation"])if(t.indexOf(s)===0&&Nr.setProperty(e.notation,t.substring(s.length),i))return!0;if(["importer"].indexOf(t)>=0)return Pr.fromJson(e.importer,i),!0;for(const s of["importer"])if(t.indexOf(s)===0&&Pr.setProperty(e.importer,t.substring(s.length),i))return!0;if(["player"].indexOf(t)>=0)return vr.fromJson(e.player,i),!0;for(const s of["player"])if(t.indexOf(s)===0&&vr.setProperty(e.player,t.substring(s.length),i))return!0;return!1}}class Di{constructor(){this.core=new In,this.display=new io,this.notation=new ts,this.importer=new so,this.player=new no}setSongBookModeSettings(){this.notation.notationMode=Ye.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=Ot.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(G.ParenthesisOnTiedBends,!1),this.notation.elements.set(G.TabNotesOnTiedBends,!1),this.notation.elements.set(G.ZerosOnDiveWhammys,!0)}static get songBook(){let e=new Di;return e.setSongBookModeSettings(),e}fillFromJson(e){qi.fromJson(this,e)}}class Da{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("marker",e.marker),t.set("text",e.text),t}static setProperty(e,t,i){switch(t){case"marker":return e.marker=i,!0;case"text":return e.text=i,!0}return!1}}class Fs{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t}static setProperty(e,t,i){switch(t){case"islinear":return e.isLinear=i,!0;case"type":return e.type=F.parseEnum(i,Ge),!0;case"value":return e.value=i,!0;case"ratioposition":return e.ratioPosition=i,!0;case"text":return e.text=i,!0}return!1}}class Ra{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("type",e.type),t.set("length",e.length),t}static setProperty(e,t,i){switch(t){case"type":return e.type=F.parseEnum(i,Gt),!0;case"length":return e.length=i,!0}return!1}}class Ia{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("alternateendings",e.alternateEndings),t.set("keysignature",e.keySignature),t.set("keysignaturetype",e.keySignatureType),t.set("isdoublebar",e.isDoubleBar),t.set("isrepeatstart",e.isRepeatStart),t.set("repeatcount",e.repeatCount),t.set("timesignaturenumerator",e.timeSignatureNumerator),t.set("timesignaturedenominator",e.timeSignatureDenominator),t.set("timesignaturecommon",e.timeSignatureCommon),t.set("tripletfeel",e.tripletFeel),t.set("section",Da.toJson(e.section)),t.set("tempoautomations",e.tempoAutomations.map(i=>Fs.toJson(i))),e.fermata!==null){const i=new Map;t.set("fermata",i);for(const[s,r]of e.fermata)i.set(s.toString(),Ra.toJson(r))}return t.set("start",e.start),t.set("isanacrusis",e.isAnacrusis),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t}static setProperty(e,t,i){switch(t){case"alternateendings":return e.alternateEndings=i,!0;case"keysignature":return e.keySignature=F.parseEnum(i,Xe),!0;case"keysignaturetype":return e.keySignatureType=F.parseEnum(i,wi),!0;case"isdoublebar":return e.isDoubleBar=i,!0;case"isrepeatstart":return e.isRepeatStart=i,!0;case"repeatcount":return e.repeatCount=i,!0;case"timesignaturenumerator":return e.timeSignatureNumerator=i,!0;case"timesignaturedenominator":return e.timeSignatureDenominator=i,!0;case"timesignaturecommon":return e.timeSignatureCommon=i,!0;case"tripletfeel":return e.tripletFeel=F.parseEnum(i,ee),!0;case"tempoautomations":e.tempoAutomations=[];for(const s of i){const r=new st;Fs.fromJson(r,s),e.tempoAutomations.push(r)}return!0;case"fermata":return e.fermata=new Map,F.forEach(i,(s,r)=>{const a=new rr;Ra.fromJson(a,s),e.addFermata(parseInt(r),a)}),!0;case"start":return e.start=i,!0;case"isanacrusis":return e.isAnacrusis=i,!0;case"displayscale":return e.displayScale=i,!0;case"displaywidth":return e.displayWidth=i,!0}return["section"].indexOf(t)>=0?(i?(e.section=new xs,Da.fromJson(e.section,i)):e.section=null,!0):!1}}class Es{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("offset",e.offset),t.set("value",e.value),t}static setProperty(e,t,i){switch(t){case"offset":return e.offset=i,!0;case"value":return e.value=i,!0}return!1}}class Ma{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){var i;if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),e.bendPoints!==null&&t.set("bendpoints",(i=e.bendPoints)==null?void 0:i.map(s=>Es.toJson(s))),t.set("fret",e.fret),t.set("string",e.string),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("isfingering",e.isFingering),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),e.toJson(t),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"accentuated":return e.accentuated=F.parseEnum(i,He),!0;case"bendtype":return e.bendType=F.parseEnum(i,M),!0;case"bendstyle":return e.bendStyle=F.parseEnum(i,me),!0;case"iscontinuedbend":return e.isContinuedBend=i,!0;case"bendpoints":if(i){e.bendPoints=[];for(const s of i){const r=new L;Es.fromJson(r,s),e.addBendPoint(r)}}return!0;case"fret":return e.fret=i,!0;case"string":return e.string=i,!0;case"octave":return e.octave=i,!0;case"tone":return e.tone=i,!0;case"percussionarticulation":return e.percussionArticulation=i,!0;case"isvisible":return e.isVisible=i,!0;case"islefthandtapped":return e.isLeftHandTapped=i,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=i,!0;case"isslurdestination":return e.isSlurDestination=i,!0;case"harmonictype":return e.harmonicType=F.parseEnum(i,O),!0;case"harmonicvalue":return e.harmonicValue=i,!0;case"isghost":return e.isGhost=i,!0;case"isletring":return e.isLetRing=i,!0;case"ispalmmute":return e.isPalmMute=i,!0;case"isdead":return e.isDead=i,!0;case"isstaccato":return e.isStaccato=i,!0;case"slideintype":return e.slideInType=F.parseEnum(i,$e),!0;case"slideouttype":return e.slideOutType=F.parseEnum(i,Q),!0;case"vibrato":return e.vibrato=F.parseEnum(i,oe),!0;case"istiedestination":return e.isTieDestination=i,!0;case"lefthandfinger":return e.leftHandFinger=F.parseEnum(i,Y),!0;case"righthandfinger":return e.rightHandFinger=F.parseEnum(i,Y),!0;case"isfingering":return e.isFingering=i,!0;case"trillvalue":return e.trillValue=i,!0;case"trillspeed":return e.trillSpeed=F.parseEnum(i,m),!0;case"durationpercent":return e.durationPercent=i,!0;case"accidentalmode":return e.accidentalMode=F.parseEnum(i,Me),!0;case"dynamics":return e.dynamics=F.parseEnum(i,j),!0}return e.setProperty(t,i)}}class Aa{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){var i;if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("notes",e.notes.map(s=>Ma.toJson(s))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(s=>Fs.toJson(s))),t.set("dots",e.dots),t.set("fadein",e.fadeIn),t.set("lyrics",e.lyrics),t.set("hasrasgueado",e.hasRasgueado),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),e.whammyBarPoints!==null&&t.set("whammybarpoints",(i=e.whammyBarPoints)==null?void 0:i.map(s=>Es.toJson(s))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"notes":e.notes=[];for(const s of i){const r=new Ee;Ma.fromJson(r,s),e.addNote(r)}return!0;case"isempty":return e.isEmpty=i,!0;case"whammystyle":return e.whammyStyle=F.parseEnum(i,me),!0;case"ottava":return e.ottava=F.parseEnum(i,le),!0;case"islegatoorigin":return e.isLegatoOrigin=i,!0;case"duration":return e.duration=F.parseEnum(i,m),!0;case"automations":e.automations=[];for(const s of i){const r=new st;Fs.fromJson(r,s),e.automations.push(r)}return!0;case"dots":return e.dots=i,!0;case"fadein":return e.fadeIn=i,!0;case"lyrics":return e.lyrics=i,!0;case"hasrasgueado":return e.hasRasgueado=i,!0;case"pop":return e.pop=i,!0;case"slap":return e.slap=i,!0;case"tap":return e.tap=i,!0;case"text":return e.text=i,!0;case"brushtype":return e.brushType=F.parseEnum(i,Se),!0;case"brushduration":return e.brushDuration=i,!0;case"tupletdenominator":return e.tupletDenominator=i,!0;case"tupletnumerator":return e.tupletNumerator=i,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=i,!0;case"whammybartype":return e.whammyBarType=F.parseEnum(i,de),!0;case"whammybarpoints":if(i){e.whammyBarPoints=[];for(const s of i){const r=new L;Es.fromJson(r,s),e.addWhammyBarPoint(r)}}return!0;case"vibrato":return e.vibrato=F.parseEnum(i,oe),!0;case"chordid":return e.chordId=i,!0;case"gracetype":return e.graceType=F.parseEnum(i,W),!0;case"pickstroke":return e.pickStroke=F.parseEnum(i,je),!0;case"tremolospeed":return e.tremoloSpeed=F.parseEnum(i,m),!0;case"crescendo":return e.crescendo=F.parseEnum(i,mt),!0;case"displaystart":return e.displayStart=i,!0;case"playbackstart":return e.playbackStart=i,!0;case"displayduration":return e.displayDuration=i,!0;case"playbackduration":return e.playbackDuration=i,!0;case"dynamics":return e.dynamics=F.parseEnum(i,j),!0;case"invertbeamdirection":return e.invertBeamDirection=i,!0;case"preferredbeamdirection":return e.preferredBeamDirection=F.parseEnum(i,P),!0;case"beamingmode":return e.beamingMode=F.parseEnum(i,Wt),!0}return!1}}class Oa{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("beats",e.beats.map(i=>Aa.toJson(i))),t.set("isempty",e.isEmpty),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"beats":e.beats=[];for(const s of i){const r=new rt;Aa.fromJson(r,s),e.addBeat(r)}return!0;case"isempty":return e.isEmpty=i,!0}return!1}}class Va{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(i=>Oa.toJson(i))),t.set("similemark",e.simileMark),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"clef":return e.clef=F.parseEnum(i,U),!0;case"clefottava":return e.clefOttava=F.parseEnum(i,le),!0;case"voices":e.voices=[];for(const s of i){const r=new Qt;Oa.fromJson(r,s),e.addVoice(r)}return!0;case"similemark":return e.simileMark=F.parseEnum(i,Pt),!0;case"displayscale":return e.displayScale=i,!0;case"displaywidth":return e.displayWidth=i,!0}return!1}}class Wa{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t}static setProperty(e,t,i){switch(t){case"name":return e.name=i,!0;case"firstfret":return e.firstFret=i,!0;case"strings":return e.strings=i,!0;case"barrefrets":return e.barreFrets=i,!0;case"showname":return e.showName=i,!0;case"showdiagram":return e.showDiagram=i,!0;case"showfingering":return e.showFingering=i,!0}return!1}}class Ha{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t}static setProperty(e,t,i){switch(t){case"isstandard":return e.isStandard=i,!0;case"name":return e.name=i,!0;case"tunings":return e.tunings=i,!0}return!1}}class Ga{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("bars",e.bars.map(i=>Va.toJson(i))),e.chords!==null){const i=new Map;t.set("chords",i);for(const[s,r]of e.chords)i.set(s.toString(),Wa.toJson(r))}return t.set("capo",e.capo),t.set("transpositionpitch",e.transpositionPitch),t.set("displaytranspositionpitch",e.displayTranspositionPitch),t.set("stringtuning",Ha.toJson(e.stringTuning)),t.set("showslash",e.showSlash),t.set("showtablature",e.showTablature),t.set("showstandardnotation",e.showStandardNotation),t.set("ispercussion",e.isPercussion),t.set("standardnotationlinecount",e.standardNotationLineCount),t}static setProperty(e,t,i){switch(t){case"bars":e.bars=[];for(const s of i){const r=new oi;Va.fromJson(r,s),e.addBar(r)}return!0;case"chords":return e.chords=new Map,F.forEach(i,(s,r)=>{const a=new bi;Wa.fromJson(a,s),e.addChord(r,a)}),!0;case"capo":return e.capo=i,!0;case"transpositionpitch":return e.transpositionPitch=i,!0;case"displaytranspositionpitch":return e.displayTranspositionPitch=i,!0;case"showslash":return e.showSlash=i,!0;case"showtablature":return e.showTablature=i,!0;case"showstandardnotation":return e.showStandardNotation=i,!0;case"ispercussion":return e.isPercussion=i,!0;case"standardnotationlinecount":return e.standardNotationLineCount=i,!0}return["stringtuning"].indexOf(t)>=0?(Ha.fromJson(e.stringTuning,i),!0):!1}}class za{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t}static setProperty(e,t,i){switch(t){case"volume":return e.volume=i,!0;case"balance":return e.balance=i,!0;case"port":return e.port=i,!0;case"program":return e.program=i,!0;case"primarychannel":return e.primaryChannel=i,!0;case"secondarychannel":return e.secondaryChannel=i,!0;case"ismute":return e.isMute=i,!0;case"issolo":return e.isSolo=i,!0}return!1}}class Ua{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t}static setProperty(e,t,i){switch(t){case"elementtype":return e.elementType=i,!0;case"staffline":return e.staffLine=i,!0;case"noteheaddefault":return e.noteHeadDefault=F.parseEnum(i,u),!0;case"noteheadhalf":return e.noteHeadHalf=F.parseEnum(i,u),!0;case"noteheadwhole":return e.noteHeadWhole=F.parseEnum(i,u),!0;case"techniquesymbol":return e.techniqueSymbol=F.parseEnum(i,u),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=F.parseEnum(i,J),!0;case"outputmidinumber":return e.outputMidiNumber=i,!0}return!1}}class Ya{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("staves",e.staves.map(i=>Ga.toJson(i))),t.set("playbackinfo",za.toJson(e.playbackInfo)),t.set("color",fe.toJson(e.color)),t.set("name",e.name),t.set("isvisibleonmultitrack",e.isVisibleOnMultiTrack),t.set("shortname",e.shortName),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("percussionarticulations",e.percussionArticulations.map(i=>Ua.toJson(i))),t}static setProperty(e,t,i){switch(t){case"staves":e.staves=[];for(const s of i){const r=new da;Ga.fromJson(r,s),e.addStaff(r)}return!0;case"color":return e.color=fe.fromJson(i),!0;case"name":return e.name=i,!0;case"isvisibleonmultitrack":return e.isVisibleOnMultiTrack=i,!0;case"shortname":return e.shortName=i,!0;case"defaultsystemslayout":return e.defaultSystemsLayout=i,!0;case"systemslayout":return e.systemsLayout=i,!0;case"percussionarticulations":e.percussionArticulations=[];for(const s of i){const r=new E;Ua.fromJson(r,s),e.percussionArticulations.push(r)}return!0}return["playbackinfo"].indexOf(t)>=0?(za.fromJson(e.playbackInfo,i),!0):!1}}class Xa{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("hidedynamics",e.hideDynamics),t}static setProperty(e,t,i){switch(t){case"hidedynamics":return e.hideDynamics=i,!0}return!1}}class qa{static fromJson(e,t){t&&F.forEach(t,(i,s)=>this.setProperty(e,s,i))}static toJson(e){if(!e)return null;const t=new Map;return t.set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("tempo",e.tempo),t.set("tempolabel",e.tempoLabel),t.set("masterbars",e.masterBars.map(i=>Ia.toJson(i))),t.set("tracks",e.tracks.map(i=>Ya.toJson(i))),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("stylesheet",Xa.toJson(e.stylesheet)),t}static setProperty(e,t,i){switch(t){case"album":return e.album=i,!0;case"artist":return e.artist=i,!0;case"copyright":return e.copyright=i,!0;case"instructions":return e.instructions=i,!0;case"music":return e.music=i,!0;case"notices":return e.notices=i,!0;case"subtitle":return e.subTitle=i,!0;case"title":return e.title=i,!0;case"words":return e.words=i,!0;case"tab":return e.tab=i,!0;case"tempo":return e.tempo=i,!0;case"tempolabel":return e.tempoLabel=i,!0;case"masterbars":e.masterBars=[];for(const s of i){const r=new li;Ia.fromJson(r,s),e.addMasterBar(r)}return!0;case"tracks":e.tracks=[];for(const s of i){const r=new Jt;Ya.fromJson(r,s),e.addTrack(r)}return!0;case"defaultsystemslayout":return e.defaultSystemsLayout=i,!0;case"systemslayout":return e.systemsLayout=i,!0}return["stylesheet"].indexOf(t)>=0?(Xa.fromJson(e.stylesheet,i),!0):!1}}class Ve{static jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);{const i={};for(const[s,r]of t)i[s]=r;return i}}else if(ArrayBuffer.isView(t))return Array.apply([],[t]);return t}static scoreToJson(e){let t=Ve.scoreToJsObject(e);return JSON.stringify(t,Ve.jsonReplacer)}static jsonToScore(e,t){return Ve.jsObjectToScore(JSON.parse(e),t)}static scoreToJsObject(e){return qa.toJson(e)}static jsObjectToScore(e,t){let i=new Li;return qa.fromJson(i,e),i.finish(t??new Di),i}static settingsToJson(e){let t=Ve.settingsToJsObject(e);return JSON.stringify(t,Ve.jsonReplacer)}static jsonToSettings(e){return Ve.jsObjectToSettings(JSON.parse(e))}static settingsToJsObject(e){return qi.toJson(e)}static jsObjectToSettings(e){let t=new Di;return qi.fromJson(t,e),t}static jsObjectToMidiFile(e){let t=new Si;return F.forEach(e,(i,s)=>{switch(s){case"division":t.division=i;break;case"tracks":for(let r of i){let a=Ve.jsObjectToMidiTrack(r);t.tracks.push(a)}break}}),t}static jsObjectToMidiTrack(e){let t=new pa;return F.forEach(e,(i,s)=>{switch(s){case"events":for(let r of i){let a=Ve.jsObjectToMidiEvent(r);t.events.push(a)}break}}),t}static jsObjectToMidiEvent(e){let t=F.getValue(e,"track"),i=F.getValue(e,"tick"),s=F.getValue(e,"type");switch(s){case ie.TimeSignature:return new ga(t,i,F.getValue(e,"numerator"),F.getValue(e,"denominatorIndex"),F.getValue(e,"midiClocksPerMetronomeClick"),F.getValue(e,"thirdySecondNodesInQuarter"));case ie.AlphaTabRest:return new ya(t,i,F.getValue(e,"channel"));case ie.AlphaTabMetronome:return new ma(t,i,F.getValue(e,"metronomeNumerator"),F.getValue(e,"metronomeDurationInTicks"),F.getValue(e,"metronomeDurationInMilliseconds"));case ie.NoteOn:return new wa(t,i,F.getValue(e,"channel"),F.getValue(e,"noteKey"),F.getValue(e,"noteVelocity"));case ie.NoteOff:return new Sa(t,i,F.getValue(e,"channel"),F.getValue(e,"noteKey"),F.getValue(e,"noteVelocity"));case ie.ControlChange:return new Ba(t,i,F.getValue(e,"channel"),F.getValue(e,"controller"),F.getValue(e,"value"));case ie.ProgramChange:return new ka(t,i,F.getValue(e,"channel"),F.getValue(e,"program"));case ie.TempoChange:return new _a(i,F.getValue(e,"microSecondsPerQuarterNote"));case ie.PitchBend:return new Ta(t,i,F.getValue(e,"channel"),F.getValue(e,"value"));case ie.PerNotePitchBend:return new xa(t,i,F.getValue(e,"channel"),F.getValue(e,"noteKey"),F.getValue(e,"value"));case ie.EndOfTrack:return new Na(t,i)}throw new nt(at.Format,"Unknown Midi Event type: "+s)}static midiFileToJsObject(e){const t=new Map;t.set("division",e.division);const i=[];for(let s of e.tracks)i.push(Ve.midiTrackToJsObject(s));return t.set("tracks",i),t}static midiTrackToJsObject(e){const t=new Map,i=[];for(let s of e.events)i.push(Ve.midiEventToJsObject(s));return t.set("events",i),t}static midiEventToJsObject(e){const t=new Map;switch(t.set("track",e.track),t.set("tick",e.tick),t.set("type",e.type),e.type){case ie.TimeSignature:t.set("numerator",e.numerator),t.set("denominatorIndex",e.denominatorIndex),t.set("midiClocksPerMetronomeClick",e.midiClocksPerMetronomeClick),t.set("thirdySecondNodesInQuarter",e.thirtySecondNodesInQuarter);break;case ie.AlphaTabRest:t.set("channel",e.channel);break;case ie.AlphaTabMetronome:t.set("metronomeNumerator",e.metronomeNumerator),t.set("metronomeDurationInMilliseconds",e.metronomeDurationInMilliseconds),t.set("metronomeDurationInTicks",e.metronomeDurationInTicks);break;case ie.NoteOn:case ie.NoteOff:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("noteVelocity",e.noteVelocity);break;case ie.ControlChange:t.set("channel",e.channel),t.set("controller",e.controller),t.set("value",e.value);break;case ie.ProgramChange:t.set("channel",e.channel),t.set("program",e.program);break;case ie.TempoChange:t.set("microSecondsPerQuarterNote",e.microSecondsPerQuarterNote);break;case ie.PitchBend:t.set("channel",e.channel),t.set("value",e.value);break;case ie.PerNotePitchBend:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("value",e.value);break;case ie.EndOfTrack:break}return t}}class ke{constructor(){this.ready=new Je,this.samplesPlayed=new re,this.sampleRequest=new Je}get sampleRate(){return ke.preferredSampleRate}open(){_.debug("AlphaSynth","Initializing synth worker"),this._worker=v.globalThis,this._worker.addEventListener("message",this.handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}handleMessage(e){let t=e.data;switch(t.cmd){case ke.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case ke.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples);break}}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:e})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}}ke.CmdOutputPrefix="alphaSynth.output.",ke.CmdOutputAddSamples=ke.CmdOutputPrefix+"addSamples",ke.CmdOutputPlay=ke.CmdOutputPrefix+"play",ke.CmdOutputPause=ke.CmdOutputPrefix+"pause",ke.CmdOutputResetSamples=ke.CmdOutputPrefix+"resetSamples",ke.CmdOutputStop=ke.CmdOutputPrefix+"stop",ke.CmdOutputSampleRequest=ke.CmdOutputPrefix+"sampleRequest",ke.CmdOutputSamplesPlayed=ke.CmdOutputPrefix+"samplesPlayed",ke.preferredSampleRate=0;class Fr{constructor(e,t){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new eo(new ke,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){let e=v.globalThis;e.addEventListener("message",t=>{let i=t.data;switch(i.cmd){case"alphaSynth.initialize":ke.preferredSampleRate=i.sampleRate,_.logLevel=i.logLevel,v.globalThis.alphaSynthWebWorker=new Fr(e,i.bufferTimeInMilliseconds);break}})}handleMessage(e){let t=e.data;switch(t.cmd){case"alphaSynth.setLogLevel":_.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(Ve.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(Ve.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(t.transpositionPitches)));break}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.serializeException(e)})}serializeException(e){let t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this.serializeException(e)})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(Ve.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}}var Kt;(function(n){n[n.Browser=0]="Browser",n[n.NodeJs=1]="NodeJs",n[n.BrowserModule=2]="BrowserModule"})(Kt||(Kt={}));class Ja{constructor(e,t){this.characterWidths=e,this.fontSizeToHeight=t}}class lt{static generateFontLookup(e){if(!lt.FontSizeLookupTables.has(e))if(!v.isRunningInWorker&&v.webPlatform!=Kt.NodeJs){let i=document.createElement("canvas").getContext("2d");const s=11;i.font=`${s}px ${e}`;const r=[];let a="";for(let f=lt.ControlChars;f<255;f++){let p=String.fromCharCode(f);a+=p;const g=i.measureText(p);r.push(g.width)}const o=i.measureText(a+"ÄÖÜÁÈ"),h=0-Math.abs(o.fontBoundingBoxAscent),d=0+Math.abs(o.fontBoundingBoxDescent)-h,c=new Ja(new Uint8Array(r),d/s);lt.FontSizeLookupTables.set(e,c)}else{const t=new Ja(new Uint8Array([8]),1.2);lt.FontSizeLookupTables.set(e,t)}}static measureString(e,t,i,s,r){let a,o=11,h=t[0];for(let c=0;c<t.length;c++)if(lt.FontSizeLookupTables.has(t[c])){h=t[c];break}lt.FontSizeLookupTables.has(h)||lt.generateFontLookup(h),a=lt.FontSizeLookupTables.get(h);let l=1;s===Ce.Italic&&(l*=1.1),r===_t.Bold&&(l*=1.1);let d=0;for(let c=0;c<e.length;c++){let f=Math.min(a.characterWidths.length-1,e.charCodeAt(c)-lt.ControlChars);f>=0&&(d+=a.characterWidths[f]*i/o)}return l*=1.07,new Ts(d*l,i*a.fontSizeToHeight)}}lt.FontSizeLookupTables=new Map,lt.ControlChars=32;class Ri{constructor(){this.id=Be.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}}class Qa{constructor(){this.beats=[]}addBeat(e){e.barBounds=this,this.beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(let i of this.beats)if(!t||i.realBounds.x<e)t=i;else if(i.realBounds.x>e)break;return t}finish(){this.beats.sort((e,t)=>e.realBounds.x-t.realBounds.x)}}class $a{constructor(){this.notes=null}addNote(e){this.notes||(this.notes=[]),e.beatBounds=this,this.notes.push(e)}findNoteAtPos(e,t){const i=this.notes;if(!i)return null;for(let s of i){let r=s.noteHeadBounds.y+s.noteHeadBounds.h,a=s.noteHeadBounds.x+s.noteHeadBounds.w;if(s.noteHeadBounds.x<=e&&s.noteHeadBounds.y<=t&&e<=a&&t<=r)return s.note}return null}}class Ka{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staffSystemBounds=null}get staveGroupBounds(){return this.staffSystemBounds}addBar(e){e.masterBarBounds=this,this.bars.push(e)}findBeatAtPos(e,t){let i=null,s=1e7;for(let r of this.bars){let a=r.findBeatAtPos(e);if(a&&(!i||i.realBounds.x<a.realBounds.x)){const o=Math.abs(a.realBounds.x-e);(!i||o<s)&&(i=a)}}return i?i.beat:null}finish(){this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:e.realBounds.x>t.realBounds.x?1:0);for(const e of this.bars)e.finish()}addBeat(e){this.staffSystemBounds.boundsLookup.addBeat(e)}}class Ds{}class Za{constructor(){this.index=0,this.bars=[]}finish(){for(let e of this.bars)e.finish()}addBar(e){this.boundsLookup.addMasterBar(e),e.staffSystemBounds=this,this.bars.push(e)}findBarAtPos(e){let t=null;for(let i of this.bars)if(!t||i.realBounds.x<e)t=i;else if(e>i.realBounds.x+i.realBounds.w)break;return t}}class ls{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaffSystem=null,this.staffSystems=[],this.isFinished=!1}toJson(){let e={},t=[];e.staffSystems=t;for(let i of this.staffSystems){let s={};s.visualBounds=this.boundsToJson(i.visualBounds),s.realBounds=this.boundsToJson(i.realBounds),s.bars=[];for(let r of i.bars){let a={};a.lineAlignedBounds=this.boundsToJson(r.lineAlignedBounds),a.visualBounds=this.boundsToJson(r.visualBounds),a.realBounds=this.boundsToJson(r.realBounds),a.index=r.index,a.bars=[];for(let o of r.bars){let h={};h.visualBounds=this.boundsToJson(o.visualBounds),h.realBounds=this.boundsToJson(o.realBounds),h.beats=[];for(let l of o.beats){let d={};d.visualBounds=this.boundsToJson(l.visualBounds),d.realBounds=this.boundsToJson(l.realBounds);let c=d;if(c.beatIndex=l.beat.index,c.voiceIndex=l.beat.voice.index,c.barIndex=l.beat.voice.bar.index,c.staffIndex=l.beat.voice.bar.staff.index,c.trackIndex=l.beat.voice.bar.staff.track.index,l.notes){let f=d.notes=[];for(let p of l.notes){let g={},b=g;b.index=p.note.index,g.noteHeadBounds=this.boundsToJson(p.noteHeadBounds),f.push(g)}}h.beats.push(d)}a.bars.push(h)}s.bars.push(a)}t.push(s)}return e}static fromJson(e,t){let i=new ls,s=e.staffSystems;for(let r of s){let a=new Za;a.visualBounds=r.visualBounds,a.realBounds=r.realBounds,i.addStaffSystem(a);for(let o of r.bars){let h=new Ka;h.index=o.index,h.isFirstOfLine=o.isFirstOfLine,h.lineAlignedBounds=o.lineAlignedBounds,h.visualBounds=o.visualBounds,h.realBounds=o.realBounds,a.addBar(h);for(let l of o.bars){let d=new Qa;d.visualBounds=l.visualBounds,d.realBounds=l.realBounds,h.addBar(d);for(let c of l.beats){let f=new $a;f.visualBounds=c.visualBounds,f.realBounds=c.realBounds;let p=c;if(f.beat=t.tracks[p.trackIndex].staves[p.staffIndex].bars[p.barIndex].voices[p.voiceIndex].beats[p.beatIndex],c.notes){f.notes=[];for(let g of c.notes){let b=new Ds,w=g;b.note=f.beat.notes[w.index],b.noteHeadBounds=g.noteHeadBounds,f.addNote(b)}}d.addBeat(f)}}}}return i}boundsToJson(e){let t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(){for(let e of this.staffSystems)e.finish();this.isFinished=!0}addStaffSystem(e){e.index=this.staffSystems.length,e.boundsLookup=this,this.staffSystems.push(e),this._currentStaffSystem=e}addMasterBar(e){e.staffSystemBounds?this._masterBarLookup.set(e.index,e):(e.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(e.index,e),this._currentStaffSystem.addBar(e))}addBeat(e){var t;this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),(t=this._beatLookup.get(e.beat.id))==null||t.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){let t=e.index;return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findBeat(e){const t=this.findBeats(e);return t?t[0]:null}findBeats(e){let t=e.id;return this._beatLookup.has(t)?this._beatLookup.get(t):null}getBeatAtPos(e,t){let i=0,s=this.staffSystems.length-1,r=-1;for(;i<=s;){let h=(s+i)/2|0,l=this.staffSystems[h];if(t>=l.realBounds.y&&t<=l.realBounds.y+l.realBounds.h){r=h;break}t<l.realBounds.y?s=h-1:i=h+1}if(r===-1)return null;let o=this.staffSystems[r].findBarAtPos(e);return o?o.findBeatAtPos(e,t):null}getNoteAtPos(e,t,i){const s=this.findBeats(e);if(s)for(const r of s){const a=r.findNoteAtPos(t,i);if(a)return a}return null}}class ja{constructor(e){this._currentLayoutMode=ai.Page,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new re,this.renderFinished=new re,this.partialRenderFinished=new re,this.partialLayoutFinished=new re,this.postRenderFinished=new Je,this.error=new re,this.settings=e,this.recreateCanvas(),this.recreateLayout()}destroy(){var e;this.score=null,(e=this.canvas)==null||e.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}recreateCanvas(){var e;return this._currentRenderEngine!==this.settings.core.engine?((e=this.canvas)==null||e.destroy(),this.canvas=v.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0):!1}recreateLayout(){return!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode?(this.layout=v.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0):!1}renderScore(e,t){try{this.score=e;let i=null;if(e!=null&&t!=null){if(!t)i=e.tracks.slice(0);else{i=[];for(let s of t)s>=0&&s<e.tracks.length&&i.push(e.tracks[s])}i.length===0&&e.tracks.length>0&&i.push(e.tracks[0])}this.tracks=i,this.render()}catch(i){this.error.trigger(i)}}renderTracks(e){e.length===0?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{const t=this.layout;t?(_.debug("Rendering","Request render of lazy partial "+e),t.renderLazyPartial(e)):_.warning("Rendering","Request render of lazy partial "+e+" ignored, no layout exists")}catch(t){this.error.trigger(t)}}render(){if(this.width===0){_.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null);return}if(this.boundsLookup=new ls,this.recreateCanvas(),this.canvas.lineWidth=this.settings.display.scale,this.canvas.settings=this.settings,!this.tracks||this.tracks.length===0||!this.score)_.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this.onRenderFinished(),this.postRenderFinished.trigger(),_.debug("Rendering","Clearing finished");else{_.debug("Rendering","Rendering "+this.tracks.length+" tracks");for(let e=0;e<this.tracks.length;e++){let t=this.tracks[e];_.debug("Rendering","Track "+e+": "+t.name)}this.preRender.trigger(!1),this.recreateLayout(),this.layoutAndRender(),_.debug("Rendering","Rendering finished")}}resizeRender(){this.recreateLayout()||this.recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(_.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(_.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new ls,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.onRenderFinished(),this.postRenderFinished.trigger()):_.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),_.debug("Rendering","Resize finished")}layoutAndRender(){_.debug("Rendering","Rendering at scale "+this.settings.display.scale+" with layout "+this.layout.name,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this.onRenderFinished(),this.postRenderFinished.trigger()}onRenderFinished(){var t;(t=this.boundsLookup)==null||t.finish();const e=new Ri;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}}class Er{constructor(e){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this),!1)}static init(){v.globalThis.alphaTabWebWorker=new Er(v.globalThis)}handleMessage(e){let t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":let s=Ve.jsObjectToSettings(t.settings);_.logLevel=s.core.logLevel,this._renderer=new ja(s),this._renderer.partialRenderFinished.on(a=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:a})}),this._renderer.partialLayoutFinished.on(a=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:a})}),this._renderer.renderFinished.on(a=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:a})}),this._renderer.postRenderFinished.on(()=>{var a;this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:((a=this._renderer.boundsLookup)==null?void 0:a.toJson())??null})}),this._renderer.preRender.on(a=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:a})}),this._renderer.error.on(this.error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this.updateFontSizes(t.fontSizes);let r=t.score==null?null:Ve.jsObjectToScore(t.score,this._renderer.settings);this.renderMultiple(r,t.trackIndexes);break;case"alphaTab.updateSettings":this.updateSettings(t.settings);break}}updateFontSizes(e){if(!(e instanceof Map)){const t=e;e=new Map;for(const i in t)e.set(i,t[i])}if(e){lt.FontSizeLookupTables||(lt.FontSizeLookupTables=new Map);for(let[t,i]of e)lt.FontSizeLookupTables.set(t,i)}}updateSettings(e){qi.fromJson(this._renderer.settings,e)}renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(i){this.error(i)}}error(e){_.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}}class oo{constructor(){this._canvas=null,this._color=new fe(0,0,0,255),this._font=new ne("Arial",10,Ce.Plain),this._lineWidth=0;let e=document.createElement("span");e.classList.add("at"),document.body.appendChild(e);let t=window.getComputedStyle(e),i=t.fontFamily;(i.startsWith('"')||i.startsWith("'"))&&(i=i.substr(1,i.length-2)),this._musicFont=new ne(i,parseFloat(t.fontSize),Ce.Plain),this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(e,t){this._canvas=document.createElement("canvas"),this._canvas.width=e*v.HighDpiFactor|0,this._canvas.height=t*v.HighDpiFactor|0,this._canvas.style.width=e+"px",this._canvas.style.height=t+"px",this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(v.HighDpiFactor,v.HighDpiFactor),this._context.lineWidth=this._lineWidth}endRender(){let e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,i,s){i>0&&this._context.fillRect(e|0,t|0,i,s)}strokeRect(e,t,i,s){this._context.strokeRect(e|0,t|0,i,s)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,i,s){this._context.quadraticCurveTo(e,t,i,s)}bezierCurveTo(e,t,i,s,r,a){this._context.bezierCurveTo(e,t,i,s,r,a)}fillCircle(e,t,i){this._context.beginPath(),this._context.arc(e,t,i,0,Math.PI*2,!0),this.fill()}strokeCircle(e,t,i){this._context.beginPath(),this._context.arc(e,t,i,0,Math.PI*2,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(this.settings.display.scale)),this._measureContext.font=e.toCssString(this.settings.display.scale)}get textAlign(){switch(this._context.textAlign){case"left":return V.Left;case"center":return V.Center;case"right":return V.Right;default:return V.Left}}set textAlign(e){switch(e){case V.Left:this._context.textAlign="left";break;case V.Center:this._context.textAlign="center";break;case V.Right:this._context.textAlign="right";break}}get textBaseline(){switch(this._context.textBaseline){case"hanging":return J.Top;case"middle":return J.Middle;case"bottom":return J.Bottom;default:return J.Top}}set textBaseline(e){switch(e){case J.Top:this._context.textBaseline="hanging";break;case J.Middle:this._context.textBaseline="middle";break;case J.Bottom:this._context.textBaseline="bottom";break}}beginGroup(e){}endGroup(){}fillText(e,t,i){this._context.fillText(e,t,i)}measureText(e){const t=this._measureContext.measureText(e);return new Ts(t.width,t.actualBoundingBoxDescent-t.actualBoundingBoxAscent)}fillMusicFontSymbol(e,t,i,s,r=!1){s!==u.None&&this.fillMusicFontSymbolText(e,t,i,String.fromCharCode(s),r)}fillMusicFontSymbols(e,t,i,s,r=!1){let a="";for(let o of s)o!==u.None&&(a+=String.fromCharCode(o));this.fillMusicFontSymbolText(e,t,i,a,r)}fillMusicFontSymbolText(e,t,i,s,r=!1){let a=this._context.textAlign,o=this._context.textBaseline,h=this._context.font;this._context.font=this._musicFont.toCssString(i),this._context.textBaseline="middle",r?this._context.textAlign="center":this._context.textAlign="left",this._context.fillText(s,e,t),this._context.textBaseline=o,this._context.font=h,this._context.textAlign=a}beginRotate(e,t,i){this._context.save(),this._context.translate(e,t),this._context.rotate(i*Math.PI/180)}endRotate(){this._context.restore()}}class Zt{constructor(e,t=!1){this._midiFile=e,this._smf1Mode=t}addTimeSignature(e,t,i){let s=0,r=i;for(;r=r>>1,r>0;)s++;this._midiFile.addEvent(new ga(0,e,t,s,48,8))}addRest(e,t,i){this._smf1Mode||this._midiFile.addEvent(new ya(e,t,i))}addNote(e,t,i,s,r,a){this._midiFile.addEvent(new wa(e,t,a,Zt.fixValue(s),Zt.fixValue(r))),this._midiFile.addEvent(new Sa(e,t+i,a,Zt.fixValue(s),Zt.fixValue(r)))}static fixValue(e){return e>127?127:e<0?0:e}addControlChange(e,t,i,s,r){this._midiFile.addEvent(new Ba(e,t,i,s,Zt.fixValue(r)))}addProgramChange(e,t,i,s){this._midiFile.addEvent(new ka(e,t,i,s))}addTempo(e,t){const i=6e7/t|0;this._midiFile.addEvent(new _a(e,i))}addBend(e,t,i,s){s>=K.MaxPitchWheel?s=K.MaxPitchWheel:s=Math.floor(s),this._midiFile.addEvent(new Ta(e,t,i,s))}addNoteBend(e,t,i,s,r){this._smf1Mode?this.addBend(e,t,i,r):(r=r*K.MaxPitchWheel20/K.MaxPitchWheel,this._midiFile.addEvent(new xa(e,t,i,s,r)))}finishTrack(e,t){(this._midiFile.format==Ui.MultiTrack||e==0)&&this._midiFile.addEvent(new Na(e,t))}}class ho{constructor(e,t){this.closingIndex=0,this.group=e,this.opening=t,e.closings=e.closings.sort((i,s)=>i.index-s.index),this.iterations=e.closings.map(i=>0)}}class lo{get finished(){return this.index>=this._score.masterBars.length}constructor(e){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}processCurrent(){const e=this._score.masterBars[this.index];let t=e.alternateEndings;if(t===0&&(t=this._previousAlternateEndings),e===e.repeatGroup.opening&&e.repeatGroup.isClosed&&!this._groupsOnStack.has(e.repeatGroup)){const i=new ho(e.repeatGroup,e);this._repeatStack.push(i),this._groupsOnStack.add(e.repeatGroup),this._previousAlternateEndings=0,t=e.alternateEndings}if(this._repeatStack.length===0||t===0)this.shouldPlay=!0;else{const i=this._repeatStack[this._repeatStack.length-1],s=i.iterations[i.closingIndex];this._previousAlternateEndings=t,t&1<<s?this.shouldPlay=!0:this.shouldPlay=!1}this.shouldPlay&&(this.currentTick+=e.calculateDuration())}moveNext(){const t=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&t>0){const i=this._repeatStack[this._repeatStack.length-1];if(i.iterations[i.closingIndex]<t){this.index=i.opening.index,i.iterations[i.closingIndex]++;for(let r=0;r<i.closingIndex;r++)i.iterations[r]=0;i.closingIndex=0,this._previousAlternateEndings=0}else i.closingIndex<i.group.closings.length-1?(i.closingIndex++,this.index++):(this._repeatStack.pop(),this._groupsOnStack.delete(i.group),this.index++)}else this.index++}}class co{constructor(e,t){this.beat=e,this.playbackStart=t}}class Rt{get duration(){return this.end-this.start}constructor(e,t){this._highlightedBeats=new Map,this.highlightedBeats=[],this.nextBeat=null,this.previousBeat=null,this.start=e,this.end=t}highlightBeat(e,t){e.isEmpty&&!e.voice.isEmpty||this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.highlightedBeats.push(new co(e,t)))}getVisibleBeatAtStart(e){for(const t of this.highlightedBeats)if(t.playbackStart==this.start&&e.has(t.beat.voice.bar.staff.track.index))return t.beat;return null}}class Rs{constructor(e,t){this.tick=e,this.tempo=t}}class en{constructor(){this.start=0,this.end=0,this.tempoChanges=[],this.firstBeat=null,this.lastBeat=null,this.nextMasterBar=null,this.previousMasterBar=null}get tempo(){return this.tempoChanges[0].tempo}insertAfter(e,t){this.firstBeat==null||e==null||this.lastBeat==null?(this.firstBeat=t,this.lastBeat=t):(t.nextBeat=e.nextBeat,t.previousBeat=e,e.nextBeat&&(e.nextBeat.previousBeat=t),e.nextBeat=t,e==this.lastBeat&&(this.lastBeat=t))}insertBefore(e,t){this.firstBeat==null||e==null||this.lastBeat==null?(this.firstBeat=t,this.lastBeat=t):(t.previousBeat=e.previousBeat,t.nextBeat=e,e.previousBeat&&(e.previousBeat.nextBeat=t),e.previousBeat=t,e==this.firstBeat&&(this.firstBeat=t))}addBeat(e,t,i,s){const r=i+s;if(this.firstBeat==null){const a=new Rt(i,r);a.highlightBeat(e,t),this.insertAfter(this.firstBeat,a)}else if(i>=this.lastBeat.end){const a=new Rt(this.lastBeat.end,r);a.highlightBeat(e,t),this.insertAfter(this.lastBeat,a)}else{let a=null;if(i<this.firstBeat.start)a=this.firstBeat;else{let o=this.firstBeat;for(;o!=null;){if(i>=o.start&&i<o.end){a=o;break}o=o.nextBeat}if(a===null)throw new nt(at.General,"Error on building lookup, unknown variant")}if(i<a.start)if(r==a.start){const o=new Rt(i,a.start);o.highlightBeat(e,t),this.insertBefore(this.firstBeat,o)}else if(r<a.end){const o=new Rt(i,a.start);o.highlightBeat(e,t),this.insertBefore(a,o);const h=new Rt(a.start,r);for(const l of a.highlightedBeats)h.highlightBeat(l.beat,l.playbackStart);h.highlightBeat(e,t),this.insertBefore(a,h),a.start=r}else if(r==a.end){const o=new Rt(i,a.start);o.highlightBeat(e,t),a.highlightBeat(e,t),this.insertBefore(a,o)}else{const o=new Rt(i,a.start);o.highlightBeat(e,t),a.highlightBeat(e,t),this.insertBefore(a,o),this.addBeat(e,t,a.end,r-a.end)}else if(i>a.start)if(r==a.end){const o=new Rt(a.start,i);for(const h of a.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart);a.start=i,a.highlightBeat(e,t),this.insertBefore(a,o)}else if(r<a.end){const o=new Rt(a.start,i);this.insertBefore(a,o);const h=new Rt(i,r);this.insertBefore(a,h);for(const l of a.highlightedBeats)o.highlightBeat(l.beat,l.playbackStart),h.highlightBeat(l.beat,l.playbackStart);h.highlightBeat(e,t),a.start=r}else{const o=new Rt(a.start,i);for(const h of a.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart);a.start=i,a.highlightBeat(e,t),this.insertBefore(a,o),this.addBeat(e,t,a.end,r-a.end)}else if(r===a.end)a.highlightBeat(e,t);else if(r<a.end){const o=new Rt(a.start,r);for(const h of a.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart);o.highlightBeat(e,t),a.start=r,this.insertBefore(a,o)}else a.highlightBeat(e,t),this.addBeat(e,t,a.end,r-a.end)}}}class uo{get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(e){this.nextBeat=null,this.tickDuration=0,this.duration=0,this.masterBar=e}calculateDuration(){if(this.masterBar.tempoChanges.length===1)this.duration=q.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let e=0,t=this.start,i=this.masterBar.tempoChanges[0].tempo;const s=this.end;for(const r of this.masterBar.tempoChanges)if(r.tick<t)i=r.tempo;else{if(r.tick>s)break;e+=q.ticksToMillis(r.tick-t,i),i=r.tempo,t=r.tick}s>t&&(e+=q.ticksToMillis(s-t,i)),this.duration=e}}}class fo{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[]}findBeat(e,t,i=null){let s=null;return i&&(s=this.findBeatFast(e,i,t)),s||(s=this.findBeatSlow(e,i,t,!1)),s}findBeatFast(e,t,i){if(i>=t.start&&i<t.end)return t;if(t.nextBeat&&i>=t.nextBeat.start&&i<t.nextBeat.end){const s=t.nextBeat;return this.fillNextBeat(s,e),s}return null}fillNextBeat(e,t){e.nextBeat=this.findBeatInMasterBar(e.masterBar,e.beatLookup.nextBeat,e.end,t,!1,!0),e.nextBeat==null&&(e.nextBeat=this.findBeatSlow(t,e,e.end,!0)),e.nextBeat&&(e.tickDuration=e.nextBeat.start-e.start,e.calculateDuration()),e.nextBeat||(e.tickDuration=e.masterBar.end-e.start,e.calculateDuration())}findBeatSlow(e,t,i,s){let r=null;if(t!=null&&(t.masterBar.start<=i&&t.masterBar.end>i?r=t.masterBar:t.masterBar.nextMasterBar&&t.masterBar.nextMasterBar.start<=i&&t.masterBar.nextMasterBar.end>i&&(r=t.masterBar.nextMasterBar)),r||(r=this.findMasterBar(i)),!r)return null;for(;r;){if(r.firstBeat){let a=this.findBeatInMasterBar(r,r.firstBeat,i,e,!0,s);if(a)return a}r=r.nextMasterBar}return null}findBeatInMasterBar(e,t,i,s,r,a){if(!t)return null;let o=null,h=null;const l=i-e.start;for(;t!=null&&h==null;){if(t.start<=l&&l<t.end){if(o=t,h=t.getVisibleBeatAtStart(s),!h)if(a){let c=e;for(;c!=null&&h==null;){for(;t!=null;){if(h=t.getVisibleBeatAtStart(s),h){o=t,e=c;break}t=t.nextBeat}(!h||!o)&&(c=c.nextMasterBar,t=(c==null?void 0:c.firstBeat)??null)}}else{let c=e;for(;c!=null&&h==null;){for(;t!=null;){if(h=t.getVisibleBeatAtStart(s),h){o=t,e=c;break}t=t.previousBeat}(!h||!o)&&(c=c.previousMasterBar,t=(c==null?void 0:c.firstBeat)??null)}}}else if(t.end>l)break;t=(t==null?void 0:t.nextBeat)??null}return h==null?null:this.createResult(e,o,h,r,s)}createResult(e,t,i,s,r){const a=new uo(e);return a.beat=i,a.beatLookup=t,a.tickDuration=t.end-t.start,s&&this.fillNextBeat(a,r),a.calculateDuration(),a}findMasterBar(e){const t=this.masterBars;let i=0,s=t.length-1;for(;i<=s;){const r=(s+i)/2|0,a=t[r];if(e>=a.start&&e<a.end)return a;e<a.start?s=r-1:i=r+1}return null}getMasterBar(e){if(!this.masterBarLookup.has(e.index)){const t=new en;return t.masterBar=e,t}return this.masterBarLookup.get(e.index)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}getBeatStart(e){return this.masterBarLookup.has(e.voice.bar.index)?this.masterBarLookup.get(e.voice.bar.index).start+e.playbackStart:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar&&(e.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e,t,i){const s=this._currentMasterBar;if(s)if(t<0&&s.previousMasterBar){const r=s.previousMasterBar.end-s.previousMasterBar.start,a=r+t,o=a+i;if(s.previousMasterBar.addBeat(e,a,a,i),o>r){const h=i+t;s.addBeat(e,t,0,h)}}else s.addBeat(e,t,t,i)}}class po{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}}class go{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}}class ce{constructor(e,t,i){this._programsPerChannel=new Map,this.tickLookup=new fo,this.applyTranspositionPitches=!0,this.transpositionPitches=new Map,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=e,this._settings=t||new Di,this._handler=i}generate(){this.transpositionPitches.clear();for(const s of this._score.tracks)this.generateTrack(s);_.debug("Midi","Begin midi generation");const e=new lo(this._score);let t=null,i=this._score.tempo;for(;!e.finished;){const s=e.index,r=this._score.masterBars[s],a=e.currentTick;if(e.processCurrent(),e.shouldPlay){this.generateMasterBar(r,t,a,i),r.tempoAutomations.length>0&&(i=r.tempoAutomations[0].value);for(const o of this._score.tracks)for(const h of o.staves)s<h.bars.length&&this.generateBar(h.bars[s],a,i);r.tempoAutomations.length>0&&(i=r.tempoAutomations[r.tempoAutomations.length-1].value)}e.moveNext(),t=r}for(const s of this._score.tracks)this._handler.finishTrack(s.index,e.currentTick);_.debug("Midi","Midi generation done")}generateTrack(e){this.generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this.generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}addProgramChange(e,t,i,s){(!this._programsPerChannel.has(i)||this._programsPerChannel.get(i)!==s)&&(this._handler.addProgramChange(e.index,t,i,s),this._programsPerChannel.set(i,s))}static buildTranspositionPitches(e,t){const i=new Map;for(const s of e.tracks){const r=s.index<t.notation.transpositionPitches.length?t.notation.transpositionPitches[s.index]:0;i.set(s.playbackInfo.primaryChannel,r),i.set(s.playbackInfo.secondaryChannel,r)}return i}generateChannel(e,t,i){const s=e.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[e.index]:0;this.transpositionPitches.set(t,s);let r=ce.toChannelShort(i.volume),a=ce.toChannelShort(i.balance);this._handler.addControlChange(e.index,0,t,ye.VolumeCoarse,r),this._handler.addControlChange(e.index,0,t,ye.PanCoarse,a),this._handler.addControlChange(e.index,0,t,ye.ExpressionControllerCoarse,127),this._handler.addControlChange(e.index,0,t,ye.RegisteredParameterFine,0),this._handler.addControlChange(e.index,0,t,ye.RegisteredParameterCourse,0),this._handler.addControlChange(e.index,0,t,ye.DataEntryFine,0),this._handler.addControlChange(e.index,0,t,ye.DataEntryCoarse,ce.PitchBendRangeInSemitones),this.addProgramChange(e,0,t,i.program)}static toChannelShort(e){const t=Math.max(-32768,Math.min(32767,e*8-1));return Math.max(t,-1)+1}generateMasterBar(e,t,i,s){(!t||t.timeSignatureDenominator!==e.timeSignatureDenominator||t.timeSignatureNumerator!==e.timeSignatureNumerator)&&this._handler.addTimeSignature(i,e.timeSignatureNumerator,e.timeSignatureDenominator);const r=e.calculateDuration(),a=new en;if(e.tempoAutomations.length>0){e.tempoAutomations[0].ratioPosition>0&&a.tempoChanges.push(new Rs(i,s));for(const o of e.tempoAutomations){const h=i+r*o.ratioPosition;this._handler.addTempo(h,o.value),a.tempoChanges.push(new Rs(h,o.value))}}else t?a.tempoChanges.push(new Rs(i,s)):(this._handler.addTempo(i,e.score.tempo),a.tempoChanges.push(new Rs(i,e.score.tempo)));a.masterBar=e,a.start=i,a.end=a.start+r,this.tickLookup.addMasterBar(a)}generateBar(e,t,i){let s=this.getPlaybackBar(e);for(const r of s.voices)this.generateVoice(r,t,e,i)}getPlaybackBar(e){switch(e.simileMark){case Pt.Simple:e.previousBar&&(e=this.getPlaybackBar(e.previousBar));break;case Pt.FirstOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this.getPlaybackBar(e.previousBar.previousBar));break;case Pt.SecondOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this.getPlaybackBar(e.previousBar.previousBar));break}return e}generateVoice(e,t,i,s){if(e.isEmpty&&(!e.bar.isEmpty||e.index!==0))return;const r=i.masterBar.tempoAutomations.slice();let a=s;const o=i.masterBar.calculateDuration();for(const h of e.beats){const l=h.playbackStart/o;for(;r.length>0&&r[0].ratioPosition<=l;)a=r.shift().value;this.generateBeat(h,t,i,a)}}generateBeat(e,t,i,s){let r=e.playbackStart,a=e.playbackDuration;const o=e.voice.bar.masterBar.calculateDuration();e.voice.bar.isEmpty?a=o:e.voice.bar.masterBar.tripletFeel!==ee.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(r-=this._currentTripletFeel.secondBeatStartOffset,a=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=ce.calculateTripletFeelInfo(r,a,e),this._currentTripletFeel&&(a=this._currentTripletFeel.firstBeatDuration))),i===e.voice.bar?this.tickLookup.addBeat(e,r,a):this.tickLookup.addBeat(e,0,a);const h=e.voice.bar.staff.track;for(const l of e.automations)this.generateNonTempoAutomation(e,l,t);if(e.isRest)this._handler.addRest(h.index,t+r,h.playbackInfo.primaryChannel);else{let l=this.getBrushInfo(e);for(const d of e.notes)this.generateNote(d,t+r,a,s,l)}if(e.vibrato!==oe.None){let l=240,d=3;switch(e.vibrato){case oe.Slight:l=this._settings.player.vibrato.beatSlightLength,d=this._settings.player.vibrato.beatSlightAmplitude;break;case oe.Wide:l=this._settings.player.vibrato.beatWideLength,d=this._settings.player.vibrato.beatWideAmplitude;break}this.generateVibratorWithParams(t+r,e.playbackDuration,l,d,(c,f)=>{this._handler.addBend(e.voice.bar.staff.track.index,c,h.playbackInfo.secondaryChannel,f)})}}static calculateTripletFeelInfo(e,t,i){let s;switch(i.voice.bar.masterBar.tripletFeel){case ee.Triplet8th:case ee.Dotted8th:case ee.Scottish8th:s=m.Eighth;break;case ee.Triplet16th:case ee.Dotted16th:case ee.Scottish16th:s=m.Sixteenth;break;default:return null}const r=q.toTicks(s);if(t!==r||e%r!==0||!i.nextBeat||i.nextBeat.voice!==i.voice||i.playbackDuration!==r)return null;const a=new go;switch(i.voice.bar.masterBar.tripletFeel){case ee.Triplet8th:a.firstBeatDuration=q.applyTuplet(q.toTicks(m.Quarter),3,2),a.secondBeatDuration=q.applyTuplet(q.toTicks(m.Eighth),3,2);break;case ee.Dotted8th:a.firstBeatDuration=q.applyDot(q.toTicks(m.Eighth),!1),a.secondBeatDuration=q.toTicks(m.Sixteenth);break;case ee.Scottish8th:a.firstBeatDuration=q.toTicks(m.Sixteenth),a.secondBeatDuration=q.applyDot(q.toTicks(m.Eighth),!1);break;case ee.Triplet16th:a.firstBeatDuration=q.applyTuplet(q.toTicks(m.Eighth),3,2),a.secondBeatDuration=q.applyTuplet(q.toTicks(m.Sixteenth),3,2);break;case ee.Dotted16th:a.firstBeatDuration=q.applyDot(q.toTicks(m.Sixteenth),!1),a.secondBeatDuration=q.toTicks(m.ThirtySecond);break;case ee.Scottish16th:a.firstBeatDuration=q.toTicks(m.ThirtySecond),a.secondBeatDuration=q.applyDot(q.toTicks(m.Sixteenth),!1);break}return a.secondBeatStartOffset=t-a.firstBeatDuration,a}generateNote(e,t,i,s,r){const a=e.beat.voice.bar.staff.track,o=e.beat.voice.bar.staff;let h=e.calculateRealValue(this.applyTranspositionPitches,!0);if(e.isPercussion){const b=Ae.getArticulation(e);b&&(h=b.outputMidiNumber)}const l=e.isStringed&&e.string<=r.length?r[e.string-1]:0,d=t+l,c=this.getNoteDuration(e,i,s);c.untilTieOrSlideEnd-=l,c.noteOnly-=l,c.letRingEnd-=l;const f=ce.getNoteVelocity(e),p=e.hasBend||e.beat.hasWhammyBar||e.beat.vibrato!==oe.None?a.playbackInfo.secondaryChannel:a.playbackInfo.primaryChannel;let g=0;if(e.hasBend?g=ce.getPitchWheel(e.bendPoints[0].value):e.beat.hasWhammyBar?g=ce.getPitchWheel(e.beat.whammyBarPoints[0].value):e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===Q.Legato?g=-1:g=ce.getPitchWheel(0),g>=0&&this._handler.addNoteBend(a.index,d,p,h,g),e.beat.fadeIn&&this.generateFadeIn(e,d,c),e.isTrill&&!o.isPercussion){this.generateTrill(e,d,c,h,f,p);return}if(e.beat.isTremolo){this.generateTremoloPicking(e,d,c,h,f,p);return}if(e.hasBend?this.generateBend(e,d,c,h,p,s):e.beat.hasWhammyBar&&e.index===0?this.generateWhammy(e.beat,d,c,p,s):e.slideInType!==$e.None||e.slideOutType!==Q.None?this.generateSlide(e,d,c,h,p,s):(e.vibrato!==oe.None||e.isTieDestination&&e.tieOrigin.vibrato!==oe.None)&&this.generateVibrato(e,d,c,h,p),!e.isTieDestination&&(!e.slideOrigin||e.slideOrigin.slideOutType!==Q.Legato)){let b=Math.max(c.untilTieOrSlideEnd,c.letRingEnd);this._handler.addNote(a.index,d,b,h,f,p)}}getNoteDuration(e,t,i){const s=new po;if(s.noteOnly=t,s.untilTieOrSlideEnd=t,s.letRingEnd=t,e.isDead)return s.noteOnly=this.applyStaticDuration(ce.DefaultDurationDead,t,i),s.untilTieOrSlideEnd=s.noteOnly,s.letRingEnd=s.noteOnly,s;if(e.isPalmMute)return s.noteOnly=this.applyStaticDuration(ce.DefaultDurationPalmMute,t,i),s.untilTieOrSlideEnd=s.noteOnly,s.letRingEnd=s.noteOnly,s;if(e.isStaccato)return s.noteOnly=t/2|0,s.untilTieOrSlideEnd=s.noteOnly,s.letRingEnd=s.noteOnly,s;if(e.isTieOrigin){const r=e.tieDestination;if(r)if(e.isTieDestination){const a=this.getNoteDuration(r,r.beat.playbackDuration,i);s.untilTieOrSlideEnd=t+a.untilTieOrSlideEnd}else{const a=e.beat.absolutePlaybackStart,o=this.getNoteDuration(r,r.beat.playbackDuration,i),h=r.beat.absolutePlaybackStart+o.untilTieOrSlideEnd;s.untilTieOrSlideEnd=h-a}}else if(e.slideOutType===Q.Legato){const r=e.slideTarget;if(r){const a=e.beat.absolutePlaybackStart,o=this.getNoteDuration(r,r.beat.playbackDuration,i),h=r.beat.absolutePlaybackStart+o.untilTieOrSlideEnd;s.untilTieOrSlideEnd=h-a}}if(e.isLetRing&&this._settings.notation.notationMode===Ye.GuitarPro){let r=e.beat,a=0;const o=e.beat.voice.bar.masterBar.calculateDuration();for(;r.nextBeat;){let h=r.nextBeat;if(h.isRest||e.isStringed&&h.hasNoteOnString(e.string))break;if(r=r.nextBeat,a=r.absolutePlaybackStart-e.beat.absolutePlaybackStart+r.playbackDuration,a>o){a=o;break}}r===e.beat?s.letRingEnd=t:s.letRingEnd=a}else s.letRingEnd=s.untilTieOrSlideEnd;return s}applyStaticDuration(e,t,i){const s=i*e/L.MaxPosition|0;return Math.min(s,t)}static getNoteVelocity(e){let t=e.dynamics;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case He.Normal:t++;break;case He.Heavy:t+=2;break}return q.dynamicToVelocity(t)}generateFadeIn(e,t,i){const s=e.beat.voice.bar.staff.track,a=ce.toChannelShort(s.playbackInfo.volume)/i.noteOnly,o=120,h=i.noteOnly/o|0,l=t+i.noteOnly;for(let d=h-1;d>=0;d--){const c=l-d*o,f=(c-t)*a;d===h-1&&(this._handler.addControlChange(s.index,t,s.playbackInfo.primaryChannel,ye.VolumeCoarse,f),this._handler.addControlChange(s.index,t,s.playbackInfo.secondaryChannel,ye.VolumeCoarse,f)),this._handler.addControlChange(s.index,c,s.playbackInfo.primaryChannel,ye.VolumeCoarse,f),this._handler.addControlChange(s.index,c,s.playbackInfo.secondaryChannel,ye.VolumeCoarse,f)}}generateVibrato(e,t,i,s,r){let a=0,o=0;switch(e.vibrato!==oe.None?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:oe.Slight){case oe.Slight:a=this._settings.player.vibrato.noteSlightLength,o=this._settings.player.vibrato.noteSlightAmplitude;break;case oe.Wide:a=this._settings.player.vibrato.noteWideLength,o=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const l=e.beat.voice.bar.staff.track;this.generateVibratorWithParams(t,i.noteOnly,a,o,(d,c)=>{this._handler.addNoteBend(l.index,d,r,s,c)})}generateVibratorWithParams(e,t,i,s,r){const a=this.vibratoResolution,o=i/2|0;e+=i;const h=e+t;for(;e<h;){let l=0;const d=e+i<h?i:h-e;for(;l<d;){let c=s*Math.sin(l*Math.PI/o);r(e+l|0,ce.getPitchWheel(c)),l+=a}e+=i}}static getPitchWheel(e){return K.DefaultPitchWheel+e/2*ce.PitchValuePerSemitone}generateSlide(e,t,i,s,r,a){let o=e.slideOutType===Q.Legato?i.noteOnly:i.untilTieOrSlideEnd,h=[],l=e.beat.voice.bar.staff.track;const d=this._settings.player.slide.simpleSlidePitchOffset,c=Math.floor(L.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),f=Math.floor(L.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case $e.IntoFromAbove:h.push(new L(0,d)),h.push(new L(c,0));break;case $e.IntoFromBelow:h.push(new L(0,-d)),h.push(new L(c,0));break}switch(e.slideOutType){case Q.Legato:case Q.Shift:h.push(new L(f,0));const p=(e.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-e.calculateRealValue(this.applyTranspositionPitches,!0))*2;h.push(new L(L.MaxPosition,p));break;case Q.OutDown:h.push(new L(L.MaxPosition-c,0)),h.push(new L(L.MaxPosition,-d));break;case Q.OutUp:h.push(new L(L.MaxPosition-c,0)),h.push(new L(L.MaxPosition,d));break}this.generateWhammyOrBend(t,o,h,a,(p,g)=>{this._handler.addNoteBend(l.index,p,r,s,g)})}generateBend(e,t,i,s,r,a){let o=e.bendPoints,h=e.beat.voice.bar.staff.track;const l=(g,b)=>{this._handler.addNoteBend(h.index,g,r,s,b)};let d=null,c;if(e.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let g=e;for(;g.isTieOrigin&&!g.tieDestination.hasBend;)g=g.tieDestination;c=g.beat.absolutePlaybackStart-e.beat.absolutePlaybackStart+this.getNoteDuration(g,g.beat.playbackDuration,a).noteOnly}else if(e.isTieOrigin&&e.beat.graceType!==W.None){switch(e.tieDestination.bendType){case M.Bend:case M.BendRelease:case M.PrebendBend:d=e.tieDestination.bendPoints[1].value;break;case M.Prebend:case M.PrebendRelease:d=e.tieDestination.bendPoints[0].value;break}c=Math.max(i.noteOnly,q.millisToTicks(this._settings.player.songBookBendDuration,a))}else c=i.noteOnly;o[0].value>0&&!e.isContinuedBend&&t>0&&t--;const f=Math.min(c,q.millisToTicks(this._settings.player.songBookBendDuration,a));let p=[];switch(e.bendType){case M.Custom:p=o;break;case M.Bend:case M.Release:switch(e.bendStyle){case me.Default:p=o;break;case me.Gradual:p.push(new L(0,e.bendPoints[0].value)),(!d||d<e.bendPoints[1].value)&&(d=e.bendPoints[1].value),p.push(new L(L.MaxPosition,d));break;case me.Fast:(!d||d<e.bendPoints[1].value)&&(d=e.bendPoints[1].value),e.beat.graceType===W.BendGrace?this.generateSongBookWhammyOrBend(t,c,!0,[e.bendPoints[0].value,d],f,a,l):this.generateSongBookWhammyOrBend(t,c,!1,[e.bendPoints[0].value,d],f,a,l);return}break;case M.BendRelease:switch(e.bendStyle){case me.Default:p=o;break;case me.Gradual:p.push(new L(0,e.bendPoints[0].value)),p.push(new L(L.MaxPosition/2|0,e.bendPoints[1].value)),p.push(new L(L.MaxPosition,e.bendPoints[2].value));break;case me.Fast:this.generateSongBookWhammyOrBend(t,c,!1,[e.bendPoints[0].value,e.bendPoints[1].value,e.bendPoints[2].value],f,a,l);return}break;case M.Hold:p=o;break;case M.Prebend:p=o;break;case M.PrebendBend:switch(e.bendStyle){case me.Default:p=o;break;case me.Gradual:p.push(new L(0,e.bendPoints[0].value)),p.push(new L(L.MaxPosition,e.bendPoints[1].value));break;case me.Fast:const g=ce.getPitchWheel(e.bendPoints[0].value);l(t,g|0),(!d||d<e.bendPoints[1].value)&&(d=e.bendPoints[1].value),this.generateSongBookWhammyOrBend(t,c,!1,[e.bendPoints[0].value,d],f,a,l);return}break;case M.PrebendRelease:switch(e.bendStyle){case me.Default:p=o;break;case me.Gradual:p.push(new L(0,e.bendPoints[0].value)),p.push(new L(L.MaxPosition,e.bendPoints[1].value));break;case me.Fast:const g=ce.getPitchWheel(e.bendPoints[0].value);l(t,g|0),this.generateSongBookWhammyOrBend(t,c,!1,[e.bendPoints[0].value,e.bendPoints[1].value],f,a,l);return}break}this.generateWhammyOrBend(t,c,p,a,l)}generateSongBookWhammyOrBend(e,t,i,s,r,a,o){const h=i?e:e+t-r,l=r/(s.length-1);for(let d=0;d<s.length-1;d++){const c=ce.getPitchWheel(s[d]),f=ce.getPitchWheel(s[d+1]),p=h+l*d;this.generateBendValues(p,l,c,f,a,o)}}generateWhammy(e,t,i,s,r){const a=e.whammyBarPoints,o=e.voice.bar.staff.track,h=i.noteOnly;a[0].value>0&&!e.isContinuedWhammy&&t--;const l=(c,f)=>{this._handler.addBend(o.index,c,s,f)};let d=[];switch(e.whammyBarType){case de.Custom:d=a;break;case de.Dive:switch(e.whammyStyle){case me.Default:d=a;break;case me.Gradual:d.push(new L(0,a[0].value)),d.push(new L(L.MaxPosition,a[1].value));break;case me.Fast:const c=Math.min(h,q.millisToTicks(this._settings.player.songBookBendDuration,r));this.generateSongBookWhammyOrBend(t,h,!1,[a[0].value,a[1].value],c,r,l);return}break;case de.Dip:switch(e.whammyStyle){case me.Default:d=a;break;case me.Gradual:d.push(new L(0,a[0].value)),d.push(new L(L.MaxPosition/2|0,a[1].value)),d.push(new L(L.MaxPosition,a[2].value));break;case me.Fast:const c=Math.min(h,q.millisToTicks(this._settings.player.songBookDipDuration,r));this.generateSongBookWhammyOrBend(t,h,!0,[a[0].value,a[1].value,a[2].value],c,r,l);return}break;case de.Hold:d=a;break;case de.Predive:d=a;break;case de.PrediveDive:switch(e.whammyStyle){case me.Default:d=a;break;case me.Gradual:d.push(new L(0,a[0].value)),d.push(new L(L.MaxPosition/2|0,a[0].value)),d.push(new L(L.MaxPosition,a[1].value));break;case me.Fast:const c=ce.getPitchWheel(a[0].value);this._handler.addBend(o.index,t,s,c|0);const f=Math.min(h,q.millisToTicks(this._settings.player.songBookBendDuration,r));this.generateSongBookWhammyOrBend(t,h,!1,[a[0].value,a[1].value],f,r,l);return}break}this.generateWhammyOrBend(t,h,d,r,l)}generateWhammyOrBend(e,t,i,s,r){const a=t/L.MaxPosition;for(let o=0;o<i.length-1;o++){const h=i[o],l=i[o+1],d=ce.getPitchWheel(h.value),c=ce.getPitchWheel(l.value),f=a*(l.offset-h.offset),p=e+a*h.offset;this.generateBendValues(p,f,d,c,s,r)}}generateBendValues(e,t,i,s,r,a){const o=q.ticksToMillis(t,r),h=Math.abs(s-i)/ce.PitchValuePerSemitone,l=Math.max(ce.MinBreakpointsPerSemitone*h,o/ce.MillisecondsPerBreakpoint),d=t/l,c=(s-i)/l;for(let f=0;f<l;f++)a(e|0,Math.round(i)),i+=c,e+=d;i<s&&a(e|0,s)}generateTrill(e,t,i,s,r,a){const o=e.beat.voice.bar.staff.track,h=e.stringTuning+e.trillFret;let l=q.toTicks(e.trillSpeed),d=!0,c=t,f=t+i.untilTieOrSlideEnd;for(;c+10<f;)c+l>=f&&(l=f-c),this._handler.addNote(o.index,c,l,d?h:s,r,a),d=!d,c+=l}generateTremoloPicking(e,t,i,s,r,a){const o=e.beat.voice.bar.staff.track;let h=q.toTicks(e.beat.tremoloSpeed),l=t;const d=t+i.untilTieOrSlideEnd;for(;l+10<d;)l+h>=d&&(h=d-l),this._handler.addNote(o.index,l,h,s,r,a),l+=h}getBrushInfo(e){const t=new Int32Array(e.voice.bar.staff.tuning.length);if(e.brushType!==Se.None){let i=0,s=0;for(const r of e.notes)r.isTieDestination||(i|=1<<r.string-1,s++);if(e.notes.length>0){let r=0;const a=e.brushDuration/(s-1)|0;for(let o=0;o<e.voice.bar.staff.tuning.length;o++){let h=e.brushType===Se.ArpeggioDown||e.brushType===Se.BrushDown?o:t.length-1-o;i&1<<h&&(t[h]=r,r+=a)}}}return t}generateNonTempoAutomation(e,t,i){switch(t.type){case Ge.Instrument:this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,(t.value|0)&255),this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,(t.value|0)&255);break;case Ge.Balance:let s=ce.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,ye.PanCoarse,s),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,ye.PanCoarse,s);break;case Ge.Volume:let r=ce.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,ye.VolumeCoarse,r),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,ye.VolumeCoarse,r);break}}prepareSingleBeat(e){let t=-1,i=-1,s=e;for(;s&&(t===-1||i===-1);){for(const d of e.automations)switch(d.type){case Ge.Instrument:i=d.value;break;case Ge.Tempo:t=d.value;break}s=s.previousBeat}const r=e.voice.bar.staff.track,a=e.voice.bar.masterBar;t===-1&&(t=a.score.tempo);const o=e.playbackStart/a.calculateDuration();for(const d of a.tempoAutomations)if(d.ratioPosition<=o)t=d.value;else break;i===-1&&(i=r.playbackInfo.program);const h=r.playbackInfo.volume;this.generateTrack(r),this._handler.addTimeSignature(0,a.timeSignatureNumerator,a.timeSignatureDenominator),this._handler.addTempo(0,t);let l=ce.toChannelShort(h);return this._handler.addControlChange(0,0,r.playbackInfo.primaryChannel,ye.VolumeCoarse,l),this._handler.addControlChange(0,0,r.playbackInfo.secondaryChannel,ye.VolumeCoarse,l),t}generateSingleBeat(e){const t=this.prepareSingleBeat(e);this.generateBeat(e,-e.playbackStart,e.voice.bar,t)}generateSingleNote(e){const t=this.prepareSingleBeat(e.beat);this.generateNote(e,0,e.beat.playbackDuration,t,new Int32Array(e.beat.voice.bar.staff.tuning.length))}}ce.DefaultDurationDead=30,ce.DefaultDurationPalmMute=80,ce.PitchBendRangeInSemitones=8*2,ce.PitchValuePerSemitone=K.DefaultPitchWheel/ce.PitchBendRangeInSemitones,ce.MinBreakpointsPerSemitone=6,ce.MillisecondsPerBreakpoint=150;class mo{constructor(){this.startTick=0,this.endTick=0}}class Ie{constructor(e,t){this.width=0,this.height=0,this.x=e,this.y=t}get scale(){return this.renderer.scale}doLayout(){}paint(e,t,i){}}class Yt extends Ie{constructor(e=0,t=0){super(e,t),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}}class De extends Yt{constructor(e,t,i,s){super(e,t),this.glyphScale=0,this.glyphScale=i,this.symbol=s}paint(e,t,i){i.fillMusicFontSymbol(e+this.x,t+this.y,this.glyphScale*this.scale,this.symbol,!1)}}class $ extends De{constructor(e,t,i,s){super(e,t,s?$.GraceScale:1,$.getSymbol(i)),this._isGrace=s,this._duration=i}paint(e,t,i){let s=this._isGrace?this.scale:0;i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this.symbol,!1)}doLayout(){let e=(this._isGrace?$.GraceScale:1)*this.scale;switch(this._duration){case m.QuadrupleWhole:this.width=14*e;break;case m.DoubleWhole:this.width=14*(this._isGrace?$.GraceScale:1)*this.scale;break;case m.Whole:this.width=14*(this._isGrace?$.GraceScale:1)*this.scale;break;default:this.width=$.QuarterNoteHeadWidth*(this._isGrace?$.GraceScale:1)*this.scale;break}this.height=$.NoteHeadHeight*e}static getSymbol(e){switch(e){case m.QuadrupleWhole:return u.NoteheadDoubleWholeSquare;case m.DoubleWhole:return u.NoteheadDoubleWhole;case m.Whole:return u.NoteheadWhole;case m.Half:return u.NoteheadHalf;default:return u.NoteheadBlack}}}$.GraceScale=.75,$.NoteHeadHeight=8,$.QuarterNoteHeadWidth=9;class ds extends De{constructor(e,t,i,s,r){super(e,t,r?$.GraceScale:1,ds.getSymbol(i,s,r))}doLayout(){this.width=0}static getSymbol(e,t,i){if(i&&(e=m.Eighth),t===P.Up)switch(e){case m.Eighth:return u.FlagEighthUp;case m.Sixteenth:return u.FlagSixteenthUp;case m.ThirtySecond:return u.FlagThirtySecondUp;case m.SixtyFourth:return u.FlagSixtyFourthUp;case m.OneHundredTwentyEighth:return u.FlagOneHundredTwentyEighthUp;case m.TwoHundredFiftySixth:return u.FlagTwoHundredFiftySixthUp;default:return u.FlagEighthUp}switch(e){case m.Eighth:return u.FlagEighthDown;case m.Sixteenth:return u.FlagSixteenthDown;case m.ThirtySecond:return u.FlagThirtySecondDown;case m.SixtyFourth:return u.FlagSixtyFourthDown;case m.OneHundredTwentyEighth:return u.FlagOneHundredTwentyEighthDown;case m.TwoHundredFiftySixth:return u.FlagOneHundredTwentyEighthDown;default:return u.FlagEighthDown}}}ds.FlagWidth=11;class It extends Ie{get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){let t=this.preNotes.computedWidth+this.onNotes.centerX;this.beat.graceGroup&&!this.beat.graceGroup.isComplete&&(t+=It.GraceBeatPadding*this.renderer.scale);let i=this.onNotes.computedWidth-this.onNotes.centerX;const s=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(s&&this.drawBeamHelperAsFlags(s)||this.beat.graceType!==W.None)&&(i+=ds.FlagWidth*this.scale*(this.beat.graceType!==W.None?$.GraceScale:1));for(const r of this.ties)i+=r.width;this.beat.graceType!==W.None&&(i+=It.GraceBeatPadding*this.renderer.scale),e.addBeatSpring(this.beat,t,i),e.setPreBeatSize(this.beat,this.preNotes.computedWidth),e.setOnBeatSize(this.beat,this.onNotes.computedWidth),e.setBeatCenterX(this.beat,this.onNotes.centerX)}applyLayoutingInfo(e){let t=e.getBeatCenterX(this.beat)-this.onNotes.centerX;this.beat.graceGroup&&!this.beat.graceGroup.isComplete&&(t+=It.GraceBeatPadding*this.renderer.scale),this.preNotes.x=t,this.preNotes.width=e.getPreBeatSize(this.beat),this.onNotes.width=e.getOnBeatSize(this.beat),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest)if(this.onNotes.beamingHelper.beats.length===1)this.beat.duration>=m.Eighth&&(this.minWidth+=20*this.scale);else switch(this.beat.duration){case m.OneHundredTwentyEighth:case m.TwoHundredFiftySixth:this.minWidth+=10*this.scale;break}let e=0;for(let t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return"b"+e.id}paint(e,t,i){if(this.beat.voice.isEmpty||this.preNotes.isEmpty&&this.onNotes.isEmpty&&this.ties.length===0)return;i.beginGroup(It.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,i),this.onNotes.paint(e+this.x,t+this.y,i);let r=e-this.voiceContainer.x-this.renderer.x,a=t-this.voiceContainer.y-this.renderer.y;for(let o=0,h=this.ties.length;o<h;o++){let l=this.ties[o];l.renderer=this.renderer,l.paint(r,a,i)}i.endGroup()}buildBoundingsLookup(e,t,i,s){let r=new $a;r.beat=this.beat,r.visualBounds=new gt,r.visualBounds.x=t+this.x+this.onNotes.x,r.visualBounds.y=e.visualBounds.y,r.visualBounds.w=this.onNotes.width,r.visualBounds.h=e.visualBounds.h,r.realBounds=new gt,r.realBounds.x=t+this.x,r.realBounds.y=e.realBounds.y,r.realBounds.w=this.width,r.realBounds.h=e.realBounds.h,s&&(r.visualBounds.x=t+this.x,r.realBounds.x=r.visualBounds.x),e.addBeat(r),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(r,t+this.x,i+this.y)}}It.GraceBeatPadding=3;class tn{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}core(){return this.settings&&this.causeIssue()?this.settings.core:new In}causeIssue(){return this.settings=null,!0}}class yo{constructor(e){this.activeBeats=e}}class Is{constructor(e){this.bounds=null,this.beat=e}}class bo{constructor(e,t){this._startTime=0,this._trackIndexes=null,this._trackIndexLookup=null,this._isDestroyed=!1,this.score=null,this.tracks=[],this._tickCache=null,this.player=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._playerState=qe.Paused,this._currentBeat=null,this._currentBarBounds=null,this._previousStateForCursor=qe.Paused,this._previousCursorCache=null,this._lastScroll=0,this.playedBeatChanged=new re,this.activeBeatsChanged=new re,this._beatMouseDown=!1,this._noteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new re,this.beatMouseMove=new re,this.beatMouseUp=new re,this.noteMouseDown=new re,this.noteMouseMove=new re,this.noteMouseUp=new re,this.scoreLoaded=new re,this.resize=new re,this.renderStarted=new re,this.renderFinished=new re,this.postRenderFinished=new Je,this.error=new re,this.playerReady=new Je,this.playerFinished=new Je,this.soundFontLoaded=new Je,this.midiLoad=new re,this.midiLoaded=new re,this.playerStateChanged=new re,this.playerPositionChanged=new re,this.midiEventsPlayed=new re,this.playbackRangeChanged=new re,this.settingsUpdated=new Je,this.uiFacade=e,this.container=e.rootContainer,e.initialize(this,t),_.logLevel=this.settings.core.logLevel,this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&v.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.renderer=this.uiFacade.createWorkerRenderer():this.renderer=new ja(this.settings),this.container.resize.on(v.throttle(()=>{this._isDestroyed||this.container.width!==this.renderer.width&&this.triggerResize()},e.resizeThrottle));let i=new tn;i.oldWidth=this.renderer.width,i.newWidth=this.container.width|0,i.settings=this.settings,this.onResize(i),this.renderer.preRender.on(this.onRenderStarted.bind(this)),this.renderer.renderFinished.on(s=>{this.onRenderFinished(s)}),this.renderer.postRenderFinished.on(()=>{let s=Date.now()-this._startTime;_.debug("rendering","Rendering completed in "+s+"ms"),this.onPostRenderFinished()}),this.renderer.preRender.on(s=>{this._startTime=Date.now()}),this.renderer.partialLayoutFinished.on(this.appendRenderResult.bind(this)),this.renderer.partialRenderFinished.on(this.updateRenderResult.bind(this)),this.renderer.renderFinished.on(s=>{this.appendRenderResult(s),this.appendRenderResult(null)}),this.renderer.error.on(this.onError.bind(this)),this.settings.player.enablePlayer&&this.setupPlayer(),this.setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}destroy(){this._isDestroyed=!0,this.player&&this.player.destroy(),this.uiFacade.destroy(),this.renderer.destroy()}updateSettings(){var t;const e=this.score;e&&Be.applyPitchOffsets(this.settings,e),this.renderer.updateSettings(this.settings),this.settings.player.enablePlayer?(this.setupPlayer(),e&&((t=this.player)==null||t.applyTranspositionPitches(ce.buildTranspositionPitches(e,this.settings)))):this.destroyPlayer(),this.onSettingsUpdated()}load(e,t){try{return this.uiFacade.load(e,i=>{this.renderScore(i,t)},i=>{this.onError(i)})}catch(i){return this.onError(i),!1}}renderScore(e,t){let i=[];if(!t)e.tracks.length>0&&i.push(e.tracks[0]);else if(t.length===0)e.tracks.length>0&&i.push(e.tracks[0]);else if(t.length===1&&t[0]===-1)for(let s of e.tracks)i.push(s);else for(let s of t)s>=0&&s<=e.tracks.length&&i.push(e.tracks[s]);this.internalRenderTracks(e,i)}renderTracks(e){if(e.length>0){let t=e[0].score;for(let i of e)if(i.score!==t){this.onError(new nt(at.General,"All rendered tracks must belong to the same score."));return}this.internalRenderTracks(t,e)}}internalRenderTracks(e,t){if(Be.applyPitchOffsets(this.settings,e),e!==this.score){this.score=e,this.tracks=t,this._trackIndexes=[];for(let i of t)this._trackIndexes.push(i.index);this._trackIndexLookup=new Set(this._trackIndexes),this.onScoreLoaded(e),this.loadMidiForScore(),this.render()}else{this.tracks=t,this._trackIndexes=[];for(let i of t)this._trackIndexes.push(i.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render()}}triggerResize(){if(!this.container.isVisible)_.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{_.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()});else{let e=new tn;e.oldWidth=this.renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this.onResize(e),this.renderer.updateSettings(this.settings),this.renderer.width=this.container.width,this.renderer.resizeRender()}}appendRenderResult(e){e?(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight),(e.width>0||e.height>0)&&this.uiFacade.beginAppendRenderResults(e)):this.uiFacade.beginAppendRenderResults(e)}updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{let i=new ht;i.logErrors=!0,i.initFromString(e,this.settings);let s=i.readScore();this.renderScore(s,t)}catch(i){this.onError(i)}}loadSoundFont(e,t=!1){return this.player?this.uiFacade.loadSoundFont(e,t):!1}resetSoundFonts(){this.player&&this.player.resetSoundFonts()}render(){this.renderer&&(this.uiFacade.canRender?(this.renderer.width=this.container.width,this.renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render()))}get tickCache(){return this._tickCache}get isReadyForPlayback(){return this.player?this.player.isReadyForPlayback:!1}get playerState(){return this.player?this.player.state:qe.Paused}get masterVolume(){return this.player?this.player.masterVolume:0}set masterVolume(e){this.player&&(this.player.masterVolume=e)}get metronomeVolume(){return this.player?this.player.metronomeVolume:0}set metronomeVolume(e){this.player&&(this.player.metronomeVolume=e)}get countInVolume(){return this.player?this.player.countInVolume:0}set countInVolume(e){this.player&&(this.player.countInVolume=e)}get midiEventsPlayedFilter(){return this.player?this.player.midiEventsPlayedFilter:[]}set midiEventsPlayedFilter(e){this.player&&(this.player.midiEventsPlayedFilter=e)}get tickPosition(){return this.player?this.player.tickPosition:0}set tickPosition(e){this.player&&(this.player.tickPosition=e)}get timePosition(){return this.player?this.player.timePosition:0}set timePosition(e){this.player&&(this.player.timePosition=e)}get playbackRange(){return this.player?this.player.playbackRange:null}set playbackRange(e){this.player&&(this.player.playbackRange=e,this.settings.player.enableCursor&&this.updateSelectionCursor(e))}get playbackSpeed(){return this.player?this.player.playbackSpeed:0}set playbackSpeed(e){this.player&&(this.player.playbackSpeed=e)}get isLooping(){return this.player?this.player.isLooping:!1}set isLooping(e){this.player&&(this.player.isLooping=e)}destroyPlayer(){this.player&&(this.player.destroy(),this.player=null,this._previousTick=0,this._playerState=qe.Paused,this.destroyCursors())}setupPlayer(){this.updateCursors(),!this.player&&(this.player=this.uiFacade.createWorkerPlayer(),this.player&&(this.player.ready.on(()=>{this.loadMidiForScore()}),this.player.readyForPlayback.on(()=>{if(this.onPlayerReady(),this.tracks)for(let e of this.tracks){let t=e.playbackInfo.volume/16;this.player.setChannelVolume(e.playbackInfo.primaryChannel,t),this.player.setChannelVolume(e.playbackInfo.secondaryChannel,t)}}),this.player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.player.soundFontLoadFailed.on(e=>{this.onError(e)}),this.player.midiLoaded.on(this.onMidiLoaded.bind(this)),this.player.midiLoadFailed.on(e=>{this.onError(e)}),this.player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.player.positionChanged.on(this.onPlayerPositionChanged.bind(this)),this.player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this.player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this.player.finished.on(this.onPlayerFinished.bind(this)),this.setupPlayerEvents()))}loadMidiForScore(){if(!this.player||!this.score||!this.player.isReady)return;_.debug("AlphaTab","Generating Midi");let e=new Si,t=new Zt(e),i=new ce(this.score,this.settings,t);i.applyTranspositionPitches=!1,i.generate(),this._tickCache=i.tickLookup,this.onMidiLoad(e),this.player.loadMidiFile(e),this.player.applyTranspositionPitches(i.transpositionPitches)}changeTrackVolume(e,t){if(this.player)for(let i of e)this.player.setChannelVolume(i.playbackInfo.primaryChannel,t),this.player.setChannelVolume(i.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){if(this.player)for(let i of e)this.player.setChannelSolo(i.playbackInfo.primaryChannel,t),this.player.setChannelSolo(i.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){if(this.player)for(let i of e)this.player.setChannelMute(i.playbackInfo.primaryChannel,t),this.player.setChannelMute(i.playbackInfo.secondaryChannel,t)}play(){return this.player?this.player.play():!1}pause(){this.player&&this.player.pause()}playPause(){this.player&&this.player.playPause()}stop(){this.player&&this.player.stop()}playBeat(e){if(!this.player)return;let t=new Si,i=new Zt(t);new ce(e.voice.bar.staff.track.score,this.settings,i).generateSingleBeat(e),this.player.playOneTimeMidiFile(t)}playNote(e){if(!this.player)return;let t=new Si,i=new Zt(t);new ce(e.beat.voice.bar.staff.track.score,this.settings,i).generateSingleNote(e),this.player.playOneTimeMidiFile(t)}destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}updateCursors(){if(this.settings.player.enableCursor&&!this._cursorWrapper){let e=this.uiFacade.createCursors();e&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper),this._currentBeat!==null&&this.cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,!0)}else!this.settings.player.enableCursor&&this._cursorWrapper&&this.destroyCursors()}setupPlayerEvents(){this._previousTick=0,this._playerState=qe.Paused,this.renderer.postRenderFinished.on(()=>{this._currentBeat=null,this.cursorUpdateTick(this._previousTick,!1,this._previousTick>10)}),this.player&&(this.player.positionChanged.on(e=>{this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{this.cursorUpdateTick(e.currentTick,!1)})}),this.player.stateChanged.on(e=>{if(this._playerState=e.state,!e.stopped&&e.state===qe.Paused){let t=this._currentBeat,i=this._tickCache;t&&i&&(this.player.tickPosition=i.getBeatStart(t.beat))}}))}cursorUpdateTick(e,t,i=!1){let s=this._tickCache;if(s){let r=this._trackIndexLookup;if(r!=null&&r.size>0){let a=s.findBeat(r,e,this._currentBeat);a&&this.cursorUpdateBeat(a,t,i)}}}cursorUpdateBeat(e,t,i,s=!1){var g;const r=e.beat,a=((g=e.nextBeat)==null?void 0:g.beat)??null,o=e.duration,h=e.beatLookup.highlightedBeats;if(!r)return;let l=this.renderer.boundsLookup;if(!l)return;let d=this._currentBeat,c=this._previousCursorCache,f=this._previousStateForCursor;if(!s&&r===(d==null?void 0:d.beat)&&l===c&&f===this._playerState)return;let p=l.findBeat(r);p&&(this._currentBeat=e,this._previousCursorCache=l,this._previousStateForCursor=this._playerState,this.uiFacade.beginInvoke(()=>{this.internalCursorUpdateBeat(r,a,o,t,h,l,p,i)}))}scrollToCursor(){const e=this._currentBarBounds;e&&this.internalScrollToCursor(e)}internalScrollToCursor(e){let t=this.uiFacade.getScrollContainer(),i=v.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,s=this.settings.player.scrollMode;if(i){let r=e.realBounds.y+this.settings.player.scrollOffsetY;if(r!==this._lastScroll)switch(this._lastScroll=r,s){case pi.Continuous:let a=this.uiFacade.getOffset(t,this.container);this.uiFacade.scrollToY(t,a.y+r,this.settings.player.scrollSpeed);break;case pi.OffScreen:let o=t.scrollTop+this.uiFacade.getOffset(null,t).h;if(e.visualBounds.y+e.visualBounds.h>=o||e.visualBounds.y<t.scrollTop){let h=e.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(t,h,this.settings.player.scrollSpeed)}break}}else{let r=e.visualBounds.x;if(r!==this._lastScroll)switch(this._lastScroll=r,s){case pi.Continuous:let a=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,a,this.settings.player.scrollSpeed);break;case pi.OffScreen:let o=t.scrollLeft+this.uiFacade.getOffset(null,t).w;if(e.visualBounds.x+e.visualBounds.w>=o||e.visualBounds.x<t.scrollLeft){let h=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,h,this.settings.player.scrollSpeed)}break}}}internalCursorUpdateBeat(e,t,i,s,r,a,o,h){const l=this._barCursor,d=this._beatCursor;let c=o.barBounds.masterBarBounds,f=c.visualBounds;this._currentBarBounds=c,l&&l.setBounds(f.x,f.y,f.w,f.h),d&&(this.settings.player.enableAnimatedBeatCursor&&d.stopAnimation(),d.setBounds(o.visualBounds.x,f.y,1,f.h)),this.settings.player.enableElementHighlighting&&this.uiFacade.removeHighlights();let p=!1;if(this._playerState===qe.Playing&&!s){if(this.settings.player.enableElementHighlighting)for(let g of r){let b=It.getGroupId(g.beat);this.uiFacade.highlightElements(b,e.voice.bar.index)}if(this.settings.player.enableAnimatedBeatCursor){let g=c.visualBounds.x+c.visualBounds.w;if(t){let b=a.findBeat(t);b&&b.barBounds.masterBarBounds.staffSystemBounds===c.staffSystemBounds&&(g=b.visualBounds.x)}this.uiFacade.beginInvoke(()=>{d&&d.transitionToX(i/this.playbackSpeed,g)})}h=!s,p=!0}h&&!this._beatMouseDown&&this.settings.player.scrollMode!==pi.Off&&this.internalScrollToCursor(c),p&&(this.onPlayedBeatChanged(e),this.onActiveBeatsChanged(new yo(r.map(g=>g.beat))))}onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}onBeatMouseDown(e,t){this._isDestroyed||(this.settings.player.enablePlayer&&this.settings.player.enableCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new Is(t),this._selectionEnd=null),this._beatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}onNoteMouseDown(e,t){this._isDestroyed||(this._noteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}onBeatMouseMove(e,t){this._isDestroyed||(this.settings.player.enableUserInteraction&&(!this._selectionEnd||this._selectionEnd.beat!==t)&&(this._selectionEnd=new Is(t),this.cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}onBeatMouseUp(e,t){var i,s;if(!this._isDestroyed){if(this.settings.player.enablePlayer&&this.settings.player.enableCursor&&this.settings.player.enableUserInteraction){if(this._selectionEnd){let r=((i=this._tickCache)==null?void 0:i.getBeatStart(this._selectionStart.beat))??this._selectionStart.beat.absolutePlaybackStart;if((((s=this._tickCache)==null?void 0:s.getBeatStart(this._selectionEnd.beat))??this._selectionEnd.beat.absolutePlaybackStart)<r){let o=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=o}}if(this._selectionStart&&this._tickCache){let r=this._tickCache,a=r.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,this._playerState===qe.Paused&&this.cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1),this.tickPosition=a+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){let o=r.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),h=new mo;h.startTick=a+this._selectionStart.beat.playbackStart,h.endTick=o+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=h}else this._selectionStart=null,this.playbackRange=null,this.cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._beatMouseDown=!1}}onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._noteMouseDown=!1)}updateSelectionCursor(e){if(this._tickCache)if(e){const t=this._tickCache.findBeat(this._trackIndexLookup,e.startTick),i=this._tickCache.findBeat(this._trackIndexLookup,e.endTick);if(t&&i){const s=new Is(t.beat),r=new Is(i.beat);this.cursorSelectRange(s,r)}}else this.cursorSelectRange(null,null)}setupClickHandling(){this.canvasElement.mouseDown.on(e=>{var r,a;if(!e.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&e.preventDefault();let t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=((r=this.renderer.boundsLookup)==null?void 0:r.getBeatAtPos(t,i))??null;if(s&&(this.onBeatMouseDown(e,s),this.settings.core.includeNoteBounds)){const o=(a=this.renderer.boundsLookup)==null?void 0:a.getNoteAtPos(s,t,i);o&&this.onNoteMouseDown(e,o)}}),this.canvasElement.mouseMove.on(e=>{var r,a;if(!this._beatMouseDown)return;let t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=((r=this.renderer.boundsLookup)==null?void 0:r.getBeatAtPos(t,i))??null;if(s&&(this.onBeatMouseMove(e,s),this._noteMouseDown)){const o=(a=this.renderer.boundsLookup)==null?void 0:a.getNoteAtPos(s,t,i);o&&this.onNoteMouseMove(e,o)}}),this.canvasElement.mouseUp.on(e=>{var r,a;if(!this._beatMouseDown)return;this.settings.player.enableUserInteraction&&e.preventDefault();let t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=((r=this.renderer.boundsLookup)==null?void 0:r.getBeatAtPos(t,i))??null;if(this.onBeatMouseUp(e,s),this._noteMouseDown)if(s){const o=((a=this.renderer.boundsLookup)==null?void 0:a.getNoteAtPos(s,t,i))??null;this.onNoteMouseUp(e,o)}else this.onNoteMouseUp(e,null)}),this.renderer.postRenderFinished.on(()=>{!this._selectionStart||!this.settings.player.enablePlayer||!this.settings.player.enableCursor||!this.settings.player.enableUserInteraction||this.cursorSelectRange(this._selectionStart,this._selectionEnd)})}cursorSelectRange(e,t){var l,d;let i=this.renderer.boundsLookup;if(!i)return;let s=this._selectionWrapper;if(!s||(s.clear(),!e||!t||e.beat===t.beat))return;e.bounds||(e.bounds=i.findBeat(e.beat)),t.bounds||(t.bounds=i.findBeat(t.beat));let r=((l=this._tickCache)==null?void 0:l.getBeatStart(e.beat))??e.beat.absolutePlaybackStart;if((((d=this._tickCache)==null?void 0:d.getBeatStart(t.beat))??t.beat.absolutePlaybackStart)<r){let c=e;e=t,t=c}let o=e.bounds.realBounds.x,h=t.bounds.realBounds.x+t.bounds.realBounds.w;if(t.beat.index===t.beat.voice.beats.length-1&&(h=t.bounds.barBounds.masterBarBounds.realBounds.x+t.bounds.barBounds.masterBarBounds.realBounds.w),e.bounds.barBounds.masterBarBounds.staffSystemBounds!==t.bounds.barBounds.masterBarBounds.staffSystemBounds){let c=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,f=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,p=this.uiFacade.createSelectionElement();p.setBounds(o,e.bounds.barBounds.masterBarBounds.visualBounds.y,f-o,e.bounds.barBounds.masterBarBounds.visualBounds.h),s.appendChild(p);let g=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,b=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let D=g;D<b;D++){let R=i.staffSystems[D],B=this.uiFacade.createSelectionElement();B.setBounds(c,R.visualBounds.y,f-c,R.visualBounds.h),s.appendChild(B)}let w=this.uiFacade.createSelectionElement();w.setBounds(c,t.bounds.barBounds.masterBarBounds.visualBounds.y,h-c,t.bounds.barBounds.masterBarBounds.visualBounds.h),s.appendChild(w)}else{let c=this.uiFacade.createSelectionElement();c.setBounds(o,e.bounds.barBounds.masterBarBounds.visualBounds.y,h-o,e.bounds.barBounds.masterBarBounds.visualBounds.h),s.appendChild(c)}}onScoreLoaded(e){this._isDestroyed||(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e))}onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}onPostRenderFinished(){this._isDestroyed||(this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(e){this._isDestroyed||(_.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}onPlayerReady(){this._isDestroyed||(this.playerReady.trigger(),this.uiFacade.triggerEvent(this.container,"playerReady",null))}onPlayerFinished(){this._isDestroyed||(this.playerFinished.trigger(),this.uiFacade.triggerEvent(this.container,"playerFinished",null))}onSoundFontLoaded(){this._isDestroyed||(this.soundFontLoaded.trigger(),this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null))}onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}onPlayerStateChanged(e){this._isDestroyed||(this.playerStateChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playerStateChanged",e))}onPlayerPositionChanged(e){this._isDestroyed||this.score!==null&&this.tracks.length>0&&(this.playerPositionChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",e))}onMidiEventsPlayed(e){this._isDestroyed||(this.midiEventsPlayed.trigger(e),this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e))}onPlaybackRangeChanged(e){this._isDestroyed||(this.playbackRangeChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e))}onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}}class gi extends nt{constructor(e,t){super(at.General,e),this.xhr=t,Object.setPrototypeOf(this,gi.prototype)}}class Ji{static loadScoreAsync(e,t,i,s){let r=new XMLHttpRequest;r.open("GET",e,!0,null,null),r.responseType="arraybuffer",r.onreadystatechange=()=>{if(r.readyState===XMLHttpRequest.DONE){let a=r.response;if(r.status===200||r.status===0&&a)try{let o=r.response,h=new Uint8Array(o),l=Ji.loadScoreFromBytes(h,s);t(l)}catch(o){i(o)}else r.status===0?i(new gi(`You are offline!!
 Please Check Your Network.`,r)):r.status===404?i(new gi("Requested URL not found.",r)):r.status===500?i(new gi("Internel Server Error.",r)):r.statusText==="parsererror"?i(new gi(`Error.
Parsing JSON Request failed.`,r)):r.statusText==="timeout"?i(new gi("Request Time out.",r)):i(new gi("Unknow Error: "+r.responseText,r))}},r.send()}static loadScoreFromBytes(e,t){t||(t=new Di);let i=v.buildImporters();_.debug("ScoreLoader",`Loading score from ${e.length} bytes using ${i.length} importers`);let s=null,r=Ke.fromBuffer(e);for(let a of i){r.reset();try{_.debug("ScoreLoader","Importing using importer "+a.name),a.init(r,t),s=a.readScore(),_.debug("ScoreLoader","Score imported using "+a.name);break}catch(o){if(o instanceof xe)_.debug("ScoreLoader",a.name+" does not support the file");else throw _.error("ScoreLoader","Score import failed due to unexpected error: ",o),o}}if(s)return s;throw new xe("No compatible importer found for file")}}class Dr{get isLeftMouseButton(){return this.mouseEvent.button===0}getX(e){let t=e.element,s=t.getBoundingClientRect().left+t.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(e){let t=e.element,s=t.getBoundingClientRect().top+t.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(e){this.mouseEvent=e}}class jt{get width(){return this.element.offsetWidth}set width(e){this.element.style.width=e+"px"}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollTop=e}get scrollTop(){return this.element.scrollLeft}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){e>=0?this.element.style.height=e+"px":this.element.style.height="100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}constructor(e){this._resizeListeners=0,this.lastBounds=new gt,this.element=e,this.mouseDown={on:t=>{this.element.addEventListener("mousedown",i=>{t(new Dr(i))},!0)},off:t=>{}},this.mouseUp={on:t=>{this.element.addEventListener("mouseup",i=>{t(new Dr(i))},!0)},off:t=>{}},this.mouseMove={on:t=>{this.element.addEventListener("mousemove",i=>{t(new Dr(i))},!0)},off:t=>{}},this.resize={on:t=>{this._resizeListeners===0&&jt.resizeObserver.value.observe(this.element),this.element.addEventListener("resize",t,!0),this._resizeListeners++},off:t=>{this.element.removeEventListener("resize",t,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,jt.resizeObserver.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,NaN,NaN,NaN)}setBounds(e,t,i,s){isNaN(e)&&(e=this.lastBounds.x),isNaN(t)&&(t=this.lastBounds.y),isNaN(i)&&(i=this.lastBounds.w),isNaN(s)&&(s=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${i}, ${s})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=i,this.lastBounds.h=s}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}}jt.resizeObserver=new aa(()=>new ResizeObserver(n=>{for(const e of n){let t=new CustomEvent("resize",{detail:e});e.target.dispatchEvent(t)}}));class sn{constructor(e){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new re,this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(v.isRunningInWorker){this.isFontLoaded=!1;return}if(this._isStarted)return;this._isStarted=!0;let e=0,t=window.setInterval(()=>{_.warning("Rendering",`Could not load font '${this._families[0]}' within ${(e+1)*5} seconds`,null),this._families.length>1?(this._families.shift(),e=0):e++},5e3);_.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);let i=a=>{this._families.length>1?(_.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,a),this._families.shift(),window.setTimeout(()=>{r()},0)):(_.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,a),window.clearInterval(t))},s=a=>{_.debug("Font",`[${a}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},r=async()=>{for(const a of this._families)if(await this.isFontAvailable(a,!1)){s(a);return}try{await document.fonts.load(`1em ${this._families[0]}`)}catch(a){i(a)}return _.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this.isFontAvailable(this._families[0],!0)?s(this._families[0]):i("Font not available"),!0};document.fonts.ready.then(()=>{r()})}isFontAvailable(e,t){return new Promise(i=>{const s="1em "+e;if(document.fonts.check(s))i(!0);else if(t){_.debug("Font",`Font ${e} not available, creating test element to trigger load`);const r=document.createElement("div");r.style.font=s,r.style.opacity="0",r.style.position="absolute",r.style.top="0",r.style.left="0",r.innerText=`Trigger ${e} load`,document.body.appendChild(r),setTimeout(()=>{document.body.removeChild(r),document.fonts.check(s)?i(!0):i(!1)},200)}else i(!1)})}}class rn{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,i){let s=0;i>this._buffer.length-this.count&&(i=this._buffer.length-this.count);const r=Math.min(this._buffer.length-this._writePosition,i);return this._buffer.set(e.subarray(t,t+r),this._writePosition),this._writePosition+=r,this._writePosition%=this._buffer.length,s+=r,s<i&&(this._buffer.set(e.subarray(t+s,t+s+i-s),this._writePosition),this._writePosition+=i-s,s=i),this.count+=s,s}read(e,t,i){i>this.count&&(i=this.count);let s=0;const r=Math.min(this._buffer.length-this._readPosition,i);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+r),t),s+=r,this._readPosition+=r,this._readPosition%=this._buffer.length,s<i&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+i-s),t+s),this._readPosition+=i-s,s=i),this.count-=s,s}}class Mt{constructor(){this._context=null,this._buffer=null,this._source=null,this.ready=new Je,this.samplesPlayed=new re,this.sampleRequest=new Je}get sampleRate(){return this._context?this._context.sampleRate:Mt.PreferredSampleRate}activate(e){this._context||(this._context=this.createAudioContext()),(this._context.state==="suspended"||this._context.state==="interrupted")&&(_.debug("WebAudio","Audio Context is suspended, trying resume"),this._context.resume().then(()=>{var t,i;_.debug("WebAudio",`Audio Context resume success: state=${(t=this._context)==null?void 0:t.state}, sampleRate:${(i=this._context)==null?void 0:i.sampleRate}`),e&&e()},t=>{var i,s;_.warning("WebAudio",`Audio Context resume failed: state=${(i=this._context)==null?void 0:i.state}, sampleRate:${(s=this._context)==null?void 0:s.sampleRate}, reason=${t}`)}))}patchIosSampleRate(){let e=navigator.userAgent;if(e.indexOf("iPhone")!==-1||e.indexOf("iPad")!==-1){let t=this.createAudioContext(),i=t.createBuffer(1,1,Mt.PreferredSampleRate),s=t.createBufferSource();s.buffer=i,s.connect(t.destination),s.start(0),s.disconnect(0),t.close()}}createAudioContext(){if("AudioContext"in v.globalThis)return new AudioContext;if("webkitAudioContext"in v.globalThis)return new webkitAudioContext;throw new nt(at.General,"AudioContext not found")}open(e){this.patchIosSampleRate(),this._context=this.createAudioContext(),this._context.state==="suspended"&&this.registerResumeHandler()}registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this.unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}unregisterResumeHandler(){const e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){let e=this._context;this.activate(),this._buffer=e.createBuffer(2,Mt.BufferSize,e.sampleRate),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0}pause(){this._source&&(this._source.stop(0),this._source.disconnect()),this._source=null}destroy(){var e;this.pause(),(e=this._context)==null||e.close(),this._context=null,this.unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}}Mt.BufferSize=4096,Mt.PreferredSampleRate=44100;class wo extends Mt{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/Mt.BufferSize),this._circularBuffer=new rn(Mt.BufferSize*this._bufferCount),this.onReady()}play(){super.play();let e=this._context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this.generateSound.bind(this),this._circularBuffer.clear(),this.requestBuffers(),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,this._source.connect(this._audioNode,0,0),this._source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}requestBuffers(){const e=this._bufferCount/2|0;let t=e*Mt.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*Mt.BufferSize<t){for(let s=0;s<e;s++)this.onSampleRequest();this._requestedBufferCount+=e}}generateSound(e){let t=e.outputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(1),s=t.length+i.length,r=this._outputBuffer;r.length!==s&&(r=new Float32Array(s),this._outputBuffer=r);const a=this._circularBuffer.read(r,0,Math.min(r.length,this._circularBuffer.count));let o=0;const h=Math.min(t.length,a);for(let l=0;l<h;l++)t[l]=r[o++],i[l]=r[o++];if(a<t.length)for(let l=a;l<t.length;l++)t[l]=0,i[l]=0;this.onSamplesPlayed(a/K.AudioChannels),this.requestBuffers()}}class So{constructor(e,t){this.loaded=e,this.total=t}}class an{get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return _.logLevel}set logLevel(e){_.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,K.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,K.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,K.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:e})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=Re.clamp(e,K.MinPlaybackSpeed,K.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get tickPosition(){return this._tickPosition}set tickPosition(e){e<0&&(e=0),this._tickPosition=e,this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._timePosition}set timePosition(e){e<0&&(e=0),this._timePosition=e,this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0&&(e.endTick=0)),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:e})}constructor(e,t){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=qe.Paused,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._tickPosition=0,this._timePosition=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this.ready=new Je,this.readyForPlayback=new Je,this.finished=new Je,this.soundFontLoaded=new Je,this.soundFontLoadFailed=new re,this.midiLoaded=new re,this.midiLoadFailed=new re,this.stateChanged=new re,this.positionChanged=new re,this.midiEventsPlayed=new re,this.playbackRangeChanged=new re,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=qe.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._tickPosition=0,this._timePosition=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this.onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(t.player.bufferTimeInMilliseconds);try{this._synth=v.createWebWorker(t)}catch(i){_.error("AlphaSynth","Failed to create WebWorker: "+i)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:t.core.logLevel,bufferTimeInMilliseconds:t.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:Ve.midiFileToJsObject(e)})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:e,append:t})}loadSoundFontFromUrl(e,t,i){_.debug("AlphaSynth",`Start loading Soundfont from url ${e}`);let s=new XMLHttpRequest;s.open("GET",e,!0,null,null),s.responseType="arraybuffer",s.onload=r=>{let a=new Uint8Array(s.response);this.loadSoundFont(a,t)},s.onerror=r=>{_.error("AlphaSynth","Loading failed: "+r.message),this.soundFontLoadFailed.trigger(new gi(r.message,s))},s.onprogress=r=>{_.debug("AlphaSynth",`Soundfont downloading: ${r.loaded}/${r.total} bytes`),i(new So(r.loaded,r.total))},s.send()}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:Ve.midiFileToJsObject(e)})}applyTranspositionPitches(e){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(e.entries()))})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,K.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this.checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this.checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._timePosition=t.currentTime,this._tickPosition=t.currentTick,this.positionChanged.trigger(new vs(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek));break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Fa(t.events.map(Ve.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new Ls(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new Ea(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this.checkReadyForPlayback(),this.midiLoaded.trigger(new vs(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek));break;case"alphaSynth.midiLoadFailed":this.checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples();break}}checkReady(){this.isReady&&this.ready.trigger()}checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}onOutputReady(){this._outputIsReady=!0,this.checkReady()}}class Bo{constructor(e,t){this._width=0,this.boundsLookup=null,this.preRender=new re,this.partialRenderFinished=new re,this.partialLayoutFinished=new re,this.renderFinished=new re,this.postRenderFinished=new Je,this.error=new re,this._api=e;try{this._worker=v.createWebWorker(t)}catch(i){_.error("Rendering",`Failed to create WebWorker: ${i}`);return}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this.serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this.handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this.serializeSettingsForWorker(e)})}serializeSettingsForWorker(e){const t=Ve.settingsToJsObject(e);return t.delete("player"),t}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=ls.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error);break}}renderScore(e,t){let i=e==null?null:Ve.scoreToJsObject(e);this._worker.postMessage({cmd:"alphaTab.renderScore",score:i,trackIndexes:t,fontSizes:lt.FontSizeLookupTables})}}class ko{constructor(e,t,i,s){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=i,this.selectionWrapper=s}}class cs{static init(){var e;cs._isRegistered||(cs._isRegistered=!0,registerProcessor("alphatab",(e=class extends AudioWorkletProcessor{constructor(i){super(i),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,this._isStopped=!1,_.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(i.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/e.BufferSize),this._circularBuffer=new rn(e.BufferSize*this._bufferCount),this.port.onmessage=this.handleMessage.bind(this)}handleMessage(i){let s=i.data;switch(s.cmd){case ke.CmdOutputAddSamples:const a=s.samples;this._circularBuffer.write(a,0,a.length),this._requestedBufferCount--;break;case ke.CmdOutputResetSamples:this._circularBuffer.clear();break;case ke.CmdOutputStop:this._isStopped=!0;break}}process(i,s,r){if(s.length!==1&&s[0].length!==2)return!1;let a=s[0][0],o=s[0][1];if(!a||!o)return!0;let h=a.length+o.length,l=this._outputBuffer;l.length!==h&&(l=new Float32Array(h),this._outputBuffer=l);const d=this._circularBuffer.read(l,0,Math.min(l.length,this._circularBuffer.count));let c=0;const f=Math.min(a.length,d);for(let p=0;p<f;p++)a[p]=l[c++],o[p]=l[c++];if(d<a.length)for(let p=d;p<a.length;p++)a[p]=0,o[p]=0;return this.port.postMessage({cmd:ke.CmdOutputSamplesPlayed,samples:d/K.AudioChannels}),this.requestBuffers(),this._circularBuffer.count>0||!this._isStopped}requestBuffers(){const i=this._bufferCount/2|0;let s=i*e.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*e.BufferSize<s){for(let a=0;a<i;a++)this.port.postMessage({cmd:ke.CmdOutputSampleRequest});this._requestedBufferCount+=i}}},e.BufferSize=4096,e)))}}cs._isRegistered=!1;class _o extends Mt{constructor(e){super(),this._worklet=null,this._bufferTimeInMilliseconds=0,this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();let e=this._context;v.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this.handleMessage.bind(this),this._source.connect(this._worklet),this._source.start(0),this._worklet.connect(e.destination)},t=>{_.error("WebAudio",`Audio Worklet creation failed: reason=${t}`)})}handleMessage(e){let t=e.data;switch(t.cmd){case ke.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case ke.CmdOutputSampleRequest:this.onSampleRequest();break}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:ke.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){var t;(t=this._worklet)==null||t.port.postMessage({cmd:ke.CmdOutputAddSamples,samples:e})}resetSamples(){var e;(e=this._worklet)==null||e.port.postMessage({cmd:ke.CmdOutputResetSamples})}}class To extends jt{constructor(e,t,i){super(e),this._xscale=t,this._yscale=i}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=e*this._xscale+"px"}get height(){return this.element.offsetHeight/this._yscale}set height(e){e>=0?this.element.style.height=e*this._yscale+"px":this.element.style.height="100%"}setBounds(e,t,i,s){isNaN(e)&&(e=this.lastBounds.x),isNaN(t)&&(t=this.lastBounds.y),isNaN(i)?i=this.lastBounds.w:i=i/this._xscale,isNaN(s)?s=this.lastBounds.h:s=s/this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${i}, ${s})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=i,this.lastBounds.h=s}}var ei;(function(n){n[n.LayoutDone=0]="LayoutDone",n[n.RenderRequested=1]="RenderRequested",n[n.RenderDone=2]="RenderDone",n[n.Detached=3]="Detached"})(ei||(ei={}));class xo{get resizeThrottle(){return 10}get canRender(){return this.areAllFontsLoaded()}areAllFontsLoaded(){if(v.bravuraFontChecker.checkForFontAvailability(),!v.bravuraFontChecker.isFontLoaded)return!1;let e=!1;for(const t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return e?!1:(_.debug("Font","All fonts loaded: "+this._fontCheckers.size),!0)}onFontLoaded(e){lt.generateFontLookup(e),this.areAllFontsLoaded()&&this.canRenderChanged.trigger()}constructor(e){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new Je,this.canRenderChanged=new Je,this._highlightedElements=[],this._scrollContainer=null,v.webPlatform!==Kt.Browser&&v.webPlatform!==Kt.BrowserModule)throw new nt(at.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new jt(e),this.areWorkersSupported="Worker"in window,v.bravuraFontChecker.fontLoaded.on(this.onFontLoaded.bind(this)),this._intersectionObserver=new IntersectionObserver(this.onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(e)}onElementVisibilityChanged(e){for(const t of e){const i=t.target;if(i===this.rootContainer.element)t.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element));else if("layoutResultId"in i&&this._api.settings.core.enableLazyLoading){const s=i;t.isIntersecting?s.renderedResultId!==s.layoutResultId?this._resultIdToElementLookup.has(s.layoutResultId)?s.resultState!==ei.RenderRequested&&(s.resultState=ei.RenderRequested,this._api.renderer.renderResult(s.layoutResultId)):i.replaceChildren():s.resultState===ei.Detached&&(i.replaceChildren(...s.renderedResult),s.resultState=ei.RenderDone):s.resultState===ei.RenderDone&&(s.resultState=ei.Detached,s.replaceChildren())}}}createWorkerRenderer(){return new Bo(this._api,this._api.settings)}initialize(e,t){this._api=e;let i;t instanceof Di?i=t:i=Ve.jsObjectToSettings(t);let s=this.getDataAttributes();qi.fromJson(i,s),i.notation.notationMode===Ye.SongBook&&i.setSongBookModeSettings(),e.settings=i,this.setupFontCheckers(i),this._initialTrackIndexes=this.parseTracks(i.core.tracks),this._contents="";let r=e.container;i.core.tex&&(this._contents=r.element.innerHTML,r.element.innerHTML=""),this.createStyleElement(i),this._file=i.core.file}setupFontCheckers(e){this.registerFontChecker(e.display.resources.copyrightFont),this.registerFontChecker(e.display.resources.effectFont),this.registerFontChecker(e.display.resources.fingeringFont),this.registerFontChecker(e.display.resources.graceFont),this.registerFontChecker(e.display.resources.markerFont),this.registerFontChecker(e.display.resources.tablatureFont),this.registerFontChecker(e.display.resources.titleFont),this.registerFontChecker(e.display.resources.wordsFont),this.registerFontChecker(e.display.resources.barNumberFont),this.registerFontChecker(e.display.resources.fretboardNumberFont),this.registerFontChecker(e.display.resources.subTitleFont)}registerFontChecker(e){if(!this._fontCheckers.has(e.families.join(", "))){let t=new sn(e.families);this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this.onFontLoaded.bind(this)),t.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML=""}createCanvasElement(){let e=document.createElement("div");return e.className="at-surface",e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new jt(e)}triggerEvent(e,t,i=null,s){let r=e.element;t="alphaTab."+t;let a=document.createEvent("CustomEvent"),o=s?s.mouseEvent:null;if(a.initCustomEvent(t,!1,!1,i),o&&(a.originalEvent=o),r.dispatchEvent(a),window&&"jQuery"in window){let h=window.jQuery,l=[];l.push(i),o&&l.push(o),h(r).trigger(t,l)}}load(e,t,i){if(e instanceof Li)return t(e),!0;if(e instanceof ArrayBuffer){let s=new Uint8Array(e);return t(Ji.loadScoreFromBytes(s,this._api.settings)),!0}return e instanceof Uint8Array?(t(Ji.loadScoreFromBytes(e,this._api.settings)),!0):typeof e=="string"?(Ji.loadScoreAsync(e,t,i,this._api.settings),!0):!1}loadSoundFont(e,t){return this._api.player?e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),!0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),!0):typeof e=="string"?(this._api.loadSoundFontFromUrl(e,t),!0):!1:!1}initialRender(){this._api.renderer.preRender.on(t=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});const e=()=>{this._api.renderer.width=this.rootContainer.width|0,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&Ji.loadScoreAsync(this._file,t=>{this._api.renderScore(t,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},t=>{this._api.onError(t)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}createStyleElement(e){let t=this._api.container.element.ownerDocument;v.createStyleElement(t,e.core.fontDirectory)}parseTracks(e){if(!e)return[];let t=[];if(typeof e=="string")try{if(e==="all")return[-1];e=JSON.parse(e)}catch{e=[0]}if(typeof e=="number")t.push(e);else if("length"in e){let i=e.length,s=e;for(let r=0;r<i;r++){let a=s[r],o=0;typeof a=="number"?o=a:"index"in a?o=a.index:o=parseInt(a.toString()),(o>=0||o===-1)&&t.push(o)}}else"index"in e&&t.push(e.index);return t}getDataAttributes(){let e=new Map,t=this._api.container.element;if(t.dataset)for(let i of Object.keys(t.dataset)){let s=t.dataset[i];try{s=JSON.parse(s)}catch{s===""&&(s=null)}e.set(i,s)}else for(let i=0;i<t.attributes.length;i++){let s=t.attributes.item(i),r=s.nodeName;if(r.startsWith("data-")){let a=r.substr(5).split("-"),o=a[0];for(let l=1;l<a.length;l++)o+=a[l].substr(0,1).toUpperCase()+a[l].substr(1);let h=s.nodeValue;try{h=JSON.parse(h)}catch{h===""&&(h=null)}e.set(o,h)}}return e}beginUpdateRenderResults(e){if(!this._resultIdToElementLookup.has(e.id))return;const t=this._resultIdToElementLookup.get(e.id),i=e.renderResult;typeof i=="string"?t.innerHTML=i:"nodeType"in i&&t.replaceChildren(i),t.resultState=ei.RenderDone,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children)}beginAppendRenderResults(e){const t=this._api.canvasElement.element;if(e){let i;this._totalResultCount<t.childElementCount?i=t.childNodes.item(this._totalResultCount):(i=document.createElement("div"),t.appendChild(i)),i.style.zIndex="1",i.style.position="absolute",i.style.left=e.x+"px",i.style.top=e.y+"px",i.style.width=e.width+"px",i.style.height=e.height+"px",i.style.display="inline-block",i.layoutResultId=e.id,i.resultState=ei.LayoutDone,delete i.renderedResultId,delete i.renderedResult,this._resultIdToElementLookup.set(e.id,i);for(let s=e.firstMasterBarIndex;s<=e.lastMasterBarIndex;s++)s>=0&&this._barToElementLookup.set(s,i);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(i),this._intersectionObserver.observe(i)),this._totalResultCount++}else for(;t.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(t.lastChild),t.removeChild(t.lastElementChild)}createWorkerPlayer(){let e=null,t="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this._api.settings.player.outputMode===hs.WebAudioAudioWorklets?(_.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new an(new _o(this._api.settings),this._api.settings)):t&&(_.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new an(new wo,this._api.settings)),e?e.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):_.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e,t){const i=this._barToElementLookup.get(t);if(i){let s=i.getElementsByClassName(e);for(let r=0;r<s.length;r++)s.item(r).classList.add("at-highlight"),this._highlightedElements.push(s.item(r))}}removeHighlights(){const e=this._highlightedElements;if(e){for(const t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){let e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){let e=this._api.container.element,t=document.createElement("div");t.classList.add("at-cursors");let i=document.createElement("div");i.classList.add("at-selection");const s=this.createScalingElement(),r=this.createScalingElement();let a=s.element;a.classList.add("at-cursor-bar");let o=r.element;return o.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",i.style.position="absolute",a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.willChange="transform",s.width=1,s.height=1,s.setBounds(0,0,1,1),o.style.position="absolute",o.style.transition="all 0s linear",o.style.left="0",o.style.top="0",o.style.willChange="transform",r.width=3,r.height=1,r.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(i),t.appendChild(a),t.appendChild(o),new ko(new jt(t),s,r,new jt(i))}getOffset(e,t){let i=t.element,s=i.getBoundingClientRect(),r=s.top+i.ownerDocument.defaultView.pageYOffset,a=s.left+i.ownerDocument.defaultView.pageXOffset;if(e){let h=e.element,l=h.nodeName.toLowerCase();if(l!=="html"&&l!=="body"){let d=this.getOffset(null,e);r=r+h.scrollTop-d.y,a=a+h.scrollLeft-d.x}}let o=new gt;return o.x=a,o.y=r,o.w=s.width,o.h=s.height,o}getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let e=typeof this._api.settings.player.scrollElement=="string"?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement,t=e.nodeName.toLowerCase();return(t==="html"||t==="body")&&("scrollingElement"in document?e=document.scrollingElement:navigator.userAgent.indexOf("WebKit")!==-1?e=document.body:e=document.documentElement),this._scrollContainer=new jt(e),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const e=document.createElement("div");e.style.position="absolute";const t=new To(e,100,100);return t.width=1,t.height=1,t.setBounds(0,0,1,1),t}scrollToY(e,t,i){this.internalScrollToY(e.element,t,i)}scrollToX(e,t,i){this.internalScrollToX(e.element,t,i)}internalScrollToY(e,t,i){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({top:t,behavior:"smooth"});else{let s=e.scrollTop,r=t-s,a=0,o=h=>{a===0&&(a=h);let l=h-a,d=Math.min(l/i,1);e.scrollTop=s+r*d|0,l<i&&window.requestAnimationFrame(o)};window.requestAnimationFrame(o)}}internalScrollToX(e,t,i){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({left:t,behavior:"smooth"});else{let s=e.scrollLeft,r=t-s,a=0,o=h=>{a===0&&(a=h);let l=h-a,d=Math.min(l/i,1);e.scrollLeft=s+r*d|0,l<i&&window.requestAnimationFrame(o)};window.requestAnimationFrame(o)}}}class Rr extends bo{constructor(e,t){super(new xo(e),t),this.soundFontLoad=new re}tex(e,t){let i=this.uiFacade;super.tex(e,i.parseTracks(t))}print(e,t=null){let i=window.open("","","width=0,height=0"),s=i.document.createElement("div");e?s.style.width=e:this.settings.display.layoutMode===ai.Horizontal?s.style.width="297mm":s.style.width="210mm",i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
            .at-surface {
                width: auto !important;
                height: auto !important;
            }
            .at-surface > div {
                position: relative!important;
                left: auto !important;
                top: auto !important;
                break-inside: avoid;
            }
            </style>
          </head>
          <body></body>
        </html>
        `);const r=this.score;r&&(r.artist&&r.title?i.document.title=`${r.title} - ${r.artist}`:r.title&&(i.document.title=`${r.title}`)),i.document.body.appendChild(s);let a=typeof window.screenLeft<"u"?window.screenLeft:window.left,o=typeof window.screenTop<"u"?window.screenTop:window.top,h="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,l="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,d=s.offsetWidth+50,c=window.innerHeight,f=(h/2|0)-(d/2|0)+a,p=(l/2|0)-(c/2|0)+o;i.resizeTo(d,c),i.moveTo(f,p),i.focus();let g=Ve.jsObjectToSettings(Ve.settingsToJsObject(this.settings));g.core.enableLazyLoading=!1,g.core.useWorkers=!0,g.core.file=null,g.core.tracks=null,g.player.enableCursor=!1,g.player.enablePlayer=!1,g.player.enableElementHighlighting=!1,g.player.enableUserInteraction=!1,g.player.soundFont=null,g.display.scale=.8,g.display.stretchForce=.8,qi.fromJson(g,t);let b=new Rr(s,g);i.onunload=()=>{b.destroy()},b.renderer.postRenderFinished.on(()=>{i.print()}),b.renderTracks(this.tracks)}downloadMidi(e=Ui.SingleTrackMultiChannel){if(!this.score)return;let t=new Si;t.format=e;let i=new Zt(t,!0);new ce(this.score,this.settings,i).generate();let r=t.toBinary(),a=this.score.title?`${this.score.title}.mid`:"File.mid",o=document.createElement("a");o.download=a;let h=new Blob([r],{type:"audio/midi"}),l=URL.createObjectURL(h);o.href=l,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}changeTrackMute(e,t){let i=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(i,t)}changeTrackSolo(e,t){let i=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(i,t)}changeTrackVolume(e,t){let i=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(i,t)}trackIndexesToTracks(e){if(!this.score)return[];let t=[];if(e.length===1&&e[0]===-1)for(let i of this.score.tracks)t.push(i);else for(let i of e)i>=0&&i<this.score.tracks.length&&t.push(this.score.tracks[i]);return t}loadSoundFontFromUrl(e,t){this.player&&this.player.loadSoundFontFromUrl(e,t,i=>{this.soundFontLoad.trigger(i),this.uiFacade.triggerEvent(this.container,"soundFontLoad",i)})}}class nn{constructor(){this._initListeners=[]}exec(e,t,i){if(typeof t!="string"&&(i=[t],t="init"),t.charCodeAt(0)===95||t==="exec")return null;let s=new jQuery(e),r=s.data("alphaTab");if(t==="destroy"&&!r)return null;if(t!=="init"&&!r)throw new Error("alphaTab not initialized");let a=this[t];if(a){let o=[s,r].concat(i);return a.apply(this,o)}else return _.error("Api","Method '"+t+"' does not exist on jQuery.alphaTab"),null}init(e,t,i){if(!t){t=new Rr(e[0],i),e.data("alphaTab",t);for(let s of this._initListeners)s(e,t,i)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,i,s){t.print(i,s)}load(e,t,i,s){return t.load(i,s)}render(e,t){t.render()}renderScore(e,t,i,s){t.renderScore(i,s)}renderTracks(e,t,i){t.renderTracks(i)}invalidate(e,t){t.render()}tex(e,t,i,s){t.tex(i,s)}muteTrack(e,t,i,s){t.changeTrackMute(i,s)}soloTrack(e,t,i,s){t.changeTrackSolo(i,s)}trackVolume(e,t,i,s){t.changeTrackVolume(i,s)}loadSoundFont(e,t,i,s){t.loadSoundFont(i,s)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,i){return typeof i=="number"&&(t.masterVolume=i),t.masterVolume}metronomeVolume(e,t,i){return typeof i=="number"&&(t.metronomeVolume=i),t.metronomeVolume}countInVolume(e,t,i){return typeof i=="number"&&(t.countInVolume=i),t.countInVolume}midiEventsPlayedFilter(e,t,i){return Array.isArray(i)&&(t.midiEventsPlayedFilter=i),t.midiEventsPlayedFilter}playbackSpeed(e,t,i){return typeof i=="number"&&(t.playbackSpeed=i),t.playbackSpeed}tickPosition(e,t,i){return typeof i=="number"&&(t.tickPosition=i),t.tickPosition}timePosition(e,t,i){return typeof i=="number"&&(t.timePosition=i),t.timePosition}loop(e,t,i){return typeof i=="boolean"&&(t.isLooping=i),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}}class Ir{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.color=new fe(255,255,255,255),this.lineWidth=1,this.font=new ne("Arial",10,Ce.Plain),this.textAlign=V.Left,this.textBaseline=J.Top}destroy(){}beginRender(e,t){this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e|0}px" height="${t|0}px" class="at-surface-svg">
`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=J.Top}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,i,s){i>0&&(this.buffer+=`<rect x="${e|0}" y="${t|0}" width="${i}" height="${s}" fill="${this.color.rgba}" />
`)}strokeRect(e,t,i,s){this.buffer+=`<rect x="${e|0}" y="${t|0}" width="${i}" height="${s}" stroke="${this.color.rgba}"`,this.lineWidth!==1&&(this.buffer+=` stroke-width="${this.lineWidth}"`),this.buffer+=` fill="transparent" />
`}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e},${t}`}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e},${t}`}quadraticCurveTo(e,t,i,s){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e},${t},${i},${s}`}bezierCurveTo(e,t,i,s,r,a){this._currentPathIsEmpty=!1,this._currentPath+=` C${e},${t},${i},${s},${r},${a}`}fillCircle(e,t,i){this._currentPathIsEmpty=!1,this._currentPath+=` M${e-i},${t} A1,1 0 0,0 ${e+i},${t} A1,1 0 0,0 ${e-i},${t} z`,this.fill()}strokeCircle(e,t,i){this._currentPathIsEmpty=!1,this._currentPath+=` M${e-i},${t} A1,1 0 0,0 ${e+i},${t} A1,1 0 0,0 ${e-i},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,this.color.rgba!=="#000000"&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;this.lineWidth!==1&&(e+=` stroke-width="${this.lineWidth}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(e,t,i){if(e==="")return;let s=`<text x="${t|0}" y="${i|0}" style="stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}"`;this.color.rgba!=="#000000"&&(s+=` fill="${this.color.rgba}"`),this.textAlign!==V.Left&&(s+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),s+=`>${Ir.escapeText(e)}</text>`,this.buffer+=s}static escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case V.Left:return"start";case V.Center:return"middle";case V.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case J.Top:return"dominant-baseline: hanging";case J.Bottom:return"dominant-baseline: bottom";default:return""}}measureText(e){return e?lt.measureString(e,this.font.families,this.font.size,this.font.style,this.font.weight):new Ts(0,0)}onRenderFinished(){return null}beginRotate(e,t,i){this.buffer+='<g transform="translate('+e+" ,"+t+") rotate( "+i+')">'}endRotate(){this.buffer+="</g>"}}class No extends Ir{constructor(){super()}fillMusicFontSymbol(e,t,i,s,r){s!==u.None&&this.fillMusicFontSymbolText(e,t,i,`&#${s};`,r)}fillMusicFontSymbols(e,t,i,s,r){let a="";for(let o of s)o!==u.None&&(a+=`&#${o};`);this.fillMusicFontSymbolText(e,t,i,a,r)}fillMusicFontSymbolText(e,t,i,s,r){this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`,i!==1?this.buffer+=` style="font-size: ${i*100}%; stroke:none"`:this.buffer+=' style="stroke:none"',this.color.rgba!=="#000000"&&(this.buffer+=` fill="${this.color.rgba}"`),r&&(this.buffer+=' text-anchor="'+this.getSvgTextAlignment(V.Center)+'"'),this.buffer+=`>${s}</text></g>`}}class Ms{constructor(){this.isInAccolade=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}}var te;(function(n){n[n.PreNotes=0]="PreNotes",n[n.OnNotes=1]="OnNotes",n[n.MiddleNotes=2]="MiddleNotes",n[n.Stem=3]="Stem",n[n.PostNotes=4]="PostNotes",n[n.EndBeat=5]="EndBeat"})(te||(te={}));class Xt extends Ie{get isEmpty(){return!this.glyphs||this.glyphs.length===0}constructor(e,t){super(e,t),this.glyphs=null}doLayout(){if(!this.glyphs||this.glyphs.length===0){this.width=0;return}let e=0;for(let t=0,i=this.glyphs.length;t<i;t++){let s=this.glyphs[t];s.renderer=this.renderer,s.doLayout(),e=Math.max(e,s.width)}this.width=e}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,i){let s=this.glyphs;if(!(!s||s.length===0))for(let r of s)r.paint(e+this.x,t+this.y,i)}}class us extends Xt{constructor(){super(0,0),this.glyphs=[]}addGlyph(e){e.x=this.glyphs.length===0?0:this.glyphs[this.glyphs.length-1].x+this.glyphs[this.glyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width,super.addGlyph(e)}}class on extends Xt{constructor(e,t,i){super(e,t),this.voice=i,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){const t=this.renderer.scale;let i=this.renderer.layoutingInfo.spaceToForce(e/t);this.scaleToForce(i)}scaleToForce(e){const t=this.renderer.scale;this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e)*t;let i=this.renderer.layoutingInfo.buildOnTimePositions(e),s=this.beatGlyphs;for(let r=0,a=s.length;r<a;r++){let o=s[r];switch(o.beat.graceType){case W.None:o.x=i.get(o.beat.absoluteDisplayStart)*t-o.onTimeX;break;default:const h=o.beat.graceGroup.beats[0].absoluteDisplayStart,l=o.beat.graceGroup.id;if(o.beat.graceGroup.isComplete&&i.has(h)){o.x=i.get(h)*t-o.onTimeX;let d=this.renderer.layoutingInfo.allGraceRods.get(l);const c=o.beat.graceGroup.beats[o.beat.graceGroup.beats.length-1].nextBeat,f=c?this.renderer.layoutingInfo.getPreBeatSize(c)+It.GraceBeatPadding*this.renderer.scale:0;o.x-=f,o.x-=d[o.beat.graceIndex].postSpringWidth,o.x+=d[o.beat.graceIndex].graceBeatWidth;const p=d[o.beat.graceGroup.beats.length-1];o.x-=p.graceBeatWidth}else{let d=this.renderer.layoutingInfo.incompleteGraceRods.get(l);const c=d[o.beat.graceIndex].postSpringWidth-d[o.beat.graceIndex].preSpringWidth;r>0?o.beat.graceIndex===0?o.x=s[r-1].x+s[r-1].width:o.x=s[r-1].x+d[o.beat.graceIndex-1].postSpringWidth-d[o.beat.graceIndex-1].preSpringWidth-c:o.x=-c}break}if(r>0){let h=o.x-s[r-1].x;s[r-1].scaleToWidth(h)}if(r===a-1){let h=this.width-s[s.length-1].x;o.scaleToWidth(h)}}}registerLayoutingInfo(e){e.updateVoiceSize(this.width);let t=this.beatGlyphs;for(let i of t)i.registerLayoutingInfo(e)}applyLayoutingInfo(e){let t=this.beatGlyphs;for(let i of t)i.applyLayoutingInfo(e);this.scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){let t=e;e.x=this.beatGlyphs.length===0?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){}paint(e,t,i){i.color=this.voice.index===0?this.renderer.resources.mainGlyphColor:this.renderer.resources.secondaryGlyphColor;for(let s=0,r=this.beatGlyphs.length;s<r;s++)this.beatGlyphs[s].paint(e+this.x,t+this.y,i)}}on.KeySizeBeat="Beat";var ue;(function(n){n[n.None=0]="None",n[n.Natural=1]="Natural",n[n.Sharp=2]="Sharp",n[n.Flat=3]="Flat",n[n.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",n[n.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",n[n.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",n[n.DoubleSharp=7]="DoubleSharp",n[n.DoubleFlat=8]="DoubleFlat"})(ue||(ue={}));class Po{constructor(){this.maxLine=-1e3,this.minLine=-1e3}}class We{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){var i;return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:((i=Ae.getArticulationByValue(t))==null?void 0:i.staffLine)??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case Me.ForceDoubleFlat:t+=2;break;case Me.ForceDoubleSharp:t-=2;break;case Me.ForceFlat:t+=1;break;case Me.ForceSharp:t-=1;break}return t}applyAccidental(e){const t=We.getNoteValue(e);let i=e.hasQuarterToneOffset;return this.getAccidental(t,i,e.beat,!1,e)}applyAccidentalForValue(e,t,i,s){return this.getAccidental(t,i,e,s,null)}static computeLineWithoutAccidentals(e,t){let i=0;const s=We.getNoteValue(t);if(e.staff.isPercussion)i=We.getPercussionLine(e,s);else{const r=t?t.accidentalMode:Me.Default;i=We.calculateNoteLine(e,s,r)}return i}getAccidental(e,t,i,s,r=null){let a=ue.None,o=0;if(this._bar.staff.isPercussion)o=We.getPercussionLine(this._bar,e);else{const h=r?r.accidentalMode:Me.Default;o=We.calculateNoteLine(this._bar,e,h);let d=this._bar.masterBar.keySignature+7,c=e%12,f=d<7?ue.Flat:ue.Sharp,p=We.KeySignatureLookup[d][c],g=We.AccidentalNotes[c];if(t)switch(a=g?f:ue.Natural,a){case ue.Natural:a=ue.NaturalQuarterNoteUp;break;case ue.Sharp:a=ue.SharpQuarterNoteUp;break;case ue.Flat:a=ue.FlatQuarterNoteUp;break}else{switch(h){case Me.ForceSharp:a=ue.Sharp;break;case Me.ForceDoubleSharp:a=ue.DoubleSharp;break;case Me.ForceFlat:a=ue.Flat;break;case Me.ForceDoubleFlat:a=ue.DoubleFlat;break;default:g?a=f:p&&(a=ue.Natural);break}let b=!1;if(r&&r.isTieDestination&&r.beat.index===0){const w=this._barRenderer.previousRenderer;w&&w.accidentalHelper.getNoteLine(r.tieOrigin)===o&&(b=!0)}b?a=ue.None:a!==ue.None?(this._registeredAccidentals.has(o)?this._registeredAccidentals.get(o)===a&&(a=ue.None):p&&a===f&&(a=ue.None),a!==ue.None&&this._registeredAccidentals.set(o,a)):this._registeredAccidentals.has(o)?this._registeredAccidentals.get(o)===ue.Natural?a=ue.None:(a=ue.Natural,this._registeredAccidentals.set(o,a)):this._registeredAccidentals.delete(o)}}return r?(this._appliedScoreLines.set(r.id,o),this._notesByValue.set(e,r)):this._appliedScoreLinesByValue.set(e,o),(this.minLine===-1e3||this.minLine<o)&&(this.minLine=o,this.minLineBeat=i),(this.maxLine===-1e3||this.maxLine>o)&&(this.maxLine=o,this.maxLineBeat=i),s||this.registerLine(i,o),a}registerLine(e,t){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new Po,this._beatLines.set(e.id,i)),(i.minLine===-1e3||t<i.minLine)&&(i.minLine=t),(i.minLine===-1e3||t>i.maxLine)&&(i.maxLine=t)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}static calculateNoteLine(e,t,i){let s=t,r=e.masterBar.keySignature,a=e.clef,o=s%12,h=(s/12|0)-1,l=We.OctaveSteps[a];l-=h*We.StepsPerOctave;let d=Be.keySignatureIsSharp(r)||Be.keySignatureIsNatural(r)?We.SharpNoteSteps:We.FlatNoteSteps;return l-=d[o],l}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}We.KeySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],We.AccidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],We.StepsPerOctave=7,We.OctaveSteps=[38,32,30,26,38],We.SharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],We.FlatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];class Co{constructor(){this.staffId="",this.up=0,this.down=0}}class Lo{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}}class qt{get isRestBeamHelper(){return this.beats.length===1&&this.beats[0].isRest}hasLine(e,t){return e&&this.beatHasLine(t)||!e&&this.beats.length===1&&this.beatHasLine(t)}beatHasLine(e){return e.duration>m.Whole}hasFlag(e,t){return e&&this.beatHasFlag(t)||!e&&this.beats.length===1&&this.beatHasFlag(this.beats[0])}beatHasFlag(e){return!e.isRest&&(e.duration>m.Quarter||e.graceType!==W.None)}constructor(e,t){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=m.QuadrupleWhole,this.fingeringCount=0,this.hasTuplet=!1,this._firstBeatLowestNoteCompareValue=-1,this._firstBeatHighestNoteCompareValue=-1,this._lastBeatLowestNoteCompareValue=-1,this._lastBeatHighestNoteCompareValue=-1,this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isGrace=!1,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=P.Up,this.drawingInfos=new Map,this._staff=e,this._renderer=t,this.beats=[]}getBeatLineX(e){return this.hasBeatLineX(e)?this.direction===P.Up?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,i,s){let r=this.getOrCreateBeatPositions(t);r.staffId=e,r.up=i,r.down=s;for(const a of this.drawingInfos.values())a.startBeat==t?a.startX=this.getBeatLineX(t):a.endBeat==t&&(a.endX=this.getBeatLineX(t))}getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new Co),this._beatLineXPositions.get(e.index)}finish(){this.direction=this.calculateDirection()}calculateDirection(){let e=null;if(this.voice?this.preferredBeamDirection!==null?e=this.preferredBeamDirection:this.voice.index>0?e=this.invert(P.Down):this.voice.bar.isMultiVoice?e=this.invert(P.Up):this.beats[0].graceType!==W.None&&(e=this.invert(P.Up)):e=P.Up,this.highestNoteInHelper&&this.lowestNoteInHelper){let t=this._renderer.getNoteY(this.highestNoteInHelper,A.Center),i=this._renderer.getNoteY(this.lowestNoteInHelper,A.Center);if(e===null){const s=(t+i)/2;e=this.invert(this._renderer.middleYPosition<s?P.Up:P.Down)}this._renderer.completeBeamingHelper(this)}else e=this.invert(P.Up),this._renderer.completeBeamingHelper(this);return e}static computeLineHeightsForRest(e){switch(e){case m.QuadrupleWhole:return[2,2];case m.DoubleWhole:return[2,2];case m.Whole:return[0,1];case m.Half:return[1,0];case m.Quarter:return[3,3];case m.Eighth:return[2,2];case m.Sixteenth:return[2,4];case m.ThirtySecond:return[4,4];case m.SixtyFourth:return[4,6];case m.OneHundredTwentyEighth:return[6,6];case m.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(e,t){if(this._lastNonRestBeat&&e.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&e.index<=this._firstNonRestBeat.index)return;let i=t,s=t;const r=qt.computeLineHeightsForRest(e.duration);i-=r[0],s+=r[1];const a=this.minRestLine,o=this.maxRestLine;(a===null||a>i)&&(this.minRestLine=i,this.beatOfMinRestLine=e),(o===null||o<s)&&(this.maxRestLine=s,this.beatOfMaxRestLine=e)}invert(e){if(!this.invertBeamDirection)return e;switch(e){case P.Down:return P.Up;default:return P.Down}}checkBeat(e){e.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=e.voice);let t=!1;if(this.beats.length===0)t=!0;else switch(this.beats[this.beats.length-1].beamingMode){case Wt.Auto:t=qt.canJoin(this.beats[this.beats.length-1],e);break;case Wt.ForceSplitToNext:t=!1;break;case Wt.ForceMergeWithNext:t=!0;break}if(t){if(e.preferredBeamDirection!==null&&(this.preferredBeamDirection=e.preferredBeamDirection),e.isRest)this.beats.length===0&&this.beats.push(e);else{this.isRestBeamHelper&&(this.beats=[]),this.beats.push(e),e.graceType!==W.None&&(this.isGrace=!0),e.hasTuplet&&(this.hasTuplet=!0);let i=0;for(let s=0;s<e.notes.length;s++){let r=e.notes[s];(r.leftHandFinger!==Y.Unknown||r.rightHandFinger!==Y.Unknown)&&i++}i>this.fingeringCount&&(this.fingeringCount=i),this.checkNote(e.minNote),this.checkNote(e.maxNote),this.shortestDuration<e.duration&&(this.shortestDuration=e.duration),this._firstNonRestBeat||(this._firstNonRestBeat=e),this._lastNonRestBeat=e}e.hasTuplet&&(this.hasTuplet=!0)}return t}checkNote(e){if(!e)return;let t,i;this.voice&&e.isPercussion?(t=-We.getPercussionLine(this.voice.bar,We.getNoteValue(e)),i=t):(t=We.getNoteValue(e),i=t,e.harmonicType!==O.None&&e.harmonicType!==O.Natural&&(i=e.realValue-this._staff.displayTranspositionPitch)),this.beats.length===1&&this.beats[0]===e.beat&&((this._firstBeatLowestNoteCompareValue===-1||t<this._firstBeatLowestNoteCompareValue)&&(this._firstBeatLowestNoteCompareValue=t),(this._firstBeatHighestNoteCompareValue===-1||i>this._firstBeatHighestNoteCompareValue)&&(this._firstBeatHighestNoteCompareValue=i)),(this._lastBeatLowestNoteCompareValue===-1||t<this._lastBeatLowestNoteCompareValue)&&(this._lastBeatLowestNoteCompareValue=t),(this._lastBeatHighestNoteCompareValue===-1||i>this._lastBeatHighestNoteCompareValue)&&(this._lastBeatHighestNoteCompareValue=i),(!this.lowestNoteInHelper||t<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=e,this._lowestNoteCompareValueInHelper=t),(!this.highestNoteInHelper||i>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=e,this._highestNoteCompareValueInHelper=i)}static canJoin(e,t){if(!e||!t||e.graceType!==t.graceType||e.graceType===W.BendGrace||t.graceType===W.BendGrace)return!1;if(e.graceType!==W.None&&t.graceType!==W.None)return!0;let i=e.voice.bar,s=t.voice.bar;if(i!==s)return!1;let r=e.playbackStart,a=t.playbackStart;if(!qt.canJoinDuration(e.duration)||!qt.canJoinDuration(t.duration))return r===a;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let o=q.QuarterTime;switch(i.masterBar.timeSignatureDenominator){case 8:i.masterBar.timeSignatureNumerator%3===0&&(o+=q.QuarterTime/2|0);break}let h=(o+r)/o|0|0,l=(o+a)/o|0|0;return h===l}static canJoinDuration(e){switch(e){case m.Whole:case m.Half:case m.Quarter:return!1;default:return!0}}static isFullBarJoin(e,t,i){return Be.getIndex(e.duration)-2-i>0&&Be.getIndex(t.duration)-2-i>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return this._beatLineXPositions.has(t.index)?this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId:!0}}class vo{constructor(e,t){this.topY=0,this.bottomY=0,this.topY=e,this.bottomY=t}}class Fo{constructor(e){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=e}addSlot(e,t){if(this.slots.push(new vo(e,t)),this.topY===-1e3)this.topY=e,this.bottomY=t;else{const i=Math.min(e,t),s=Math.max(e,t);i<this.topY&&(this.topY=i),s>this.bottomY&&(this.bottomY=s)}}}class Eo{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let e=-1e3,t=-1e3;for(const i of this.reservedLayoutAreasByDisplayTime.values())e===-1e3?(e=i.topY,t=i.bottomY):(e>i.topY&&(e=i.topY),t<i.bottomY&&(t=i.bottomY));return e===-1e3?[0,0]:[e,t]}reserveBeatSlot(e,t,i){t!=i&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new Fo(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,i),e.isRest&&this.registerRest(e))}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(e,t,i){if(e.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(e.playbackStart)){const s=qt.computeLineHeightsForRest(e.duration).map(d=>d*i);let r=t-s[0],a=t+s[1],o=r;const h=this.reservedLayoutAreasByDisplayTime.get(e.playbackStart);let l=!1;for(const d of h.slots)if(r>=d.topY&&r<=d.bottomY||a>=d.topY&&a<=d.bottomY){l=!0;break}if(l){e.voice.index==1?o=h.topY-s[1]-s[0]:o=h.bottomY;let d=o+s[0]+s[1];const c=i*2;let f=Math.ceil(Math.abs(o-r)/c);return h.addSlot(o,d),o<r?f*-c:f*c}}return 0}}class Do{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[],this._renderer=e,this.collisionHelper=new Eo}initialize(){var e=this._renderer,t=this._renderer.bar;let i=null,s=null;for(let r=0,a=t.voices.length;r<a;r++){let o=t.voices[r];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let h=0,l=o.beats.length;h<l;h++){let d=o.beats[h],c;d.graceType!==W.None?c=s:(c=i,s=null),(!c||!c.checkBeat(d))&&(c&&c.finish(),c=new qt(t.staff,e),c.checkBeat(d),d.graceType!==W.None?s=c:i=c,this.beamHelpers[o.index].push(c)),this.beamHelperLookup[o.index].set(d.index,c)}i&&i.finish(),s&&s.finish(),i=null,s=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}}class it extends Yt{constructor(e,t,i){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=i}doLayout(){super.doLayout();const e=this.scale;let t=this.renderer.resources;this._textRow=t.effectFont.size*1.5*e,this._fretRow=t.effectFont.size*1.5*e,this._chord.firstFret>1?this._firstFretSpacing=it.FretSpacing*e:this._firstFretSpacing=0,this.height=this._textRow+this._fretRow+(it.Frets-1)*it.FretSpacing*e+2*it.Padding*e,this.width=this._firstFretSpacing+(this._chord.staff.tuning.length-1)*it.StringSpacing*e+2*it.Padding*e}paint(e,t,i){e+=this.x+it.Padding*this.scale+this._firstFretSpacing,t+=this.y;let s=this.width-2*it.Padding*this.scale+this.scale-this._firstFretSpacing,r=it.StringSpacing*this.scale,a=it.FretSpacing*this.scale,o=this.renderer.resources,h=it.CircleRadius*this.scale,l=i.textAlign,d=i.textBaseline;i.font=o.effectFont,i.textAlign=V.Center,i.textBaseline=J.Top,this._chord.showName&&i.fillText(this._chord.name,e+this.width/2,t+o.effectFont.size/2),t+=this._textRow,e+=r/2,i.font=o.fretboardNumberFont,i.textBaseline=J.Middle;for(let f=0;f<this._chord.staff.tuning.length;f++){let p=e+f*r,g=t+this._fretRow/2,b=this._chord.strings[this._chord.staff.tuning.length-f-1];b<0?i.fillMusicFontSymbol(p,g,this.scale,u.FretboardX,!0):b===0?i.fillMusicFontSymbol(p,g,this.scale,u.FretboardO,!0):(b-=this._chord.firstFret-1,i.fillText(b.toString(),p,g))}t+=this._fretRow;for(let f=0;f<this._chord.staff.tuning.length;f++){let p=e+f*r;i.fillRect(p,t,1,a*it.Frets+this.scale)}this._chord.firstFret>1&&(i.textAlign=V.Left,i.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,t+a/2)),i.fillRect(e,t-this.scale,s,2*this.scale);for(let f=0;f<=it.Frets;f++){let p=t+f*a;i.fillRect(e,p,s,this.scale)}let c=new Map;for(let f of this._chord.barreFrets){let p=[-1,-1];c.set(f-this._chord.firstFret,p)}for(let f=0;f<this._chord.strings.length;f++){let p=this._chord.strings[f];if(p>0){if(p-=this._chord.firstFret,c.has(p)){let w=c.get(p);(w[0]===-1||f<w[0])&&(w[0]=f),(w[1]===-1||f>w[1])&&(w[1]=f)}let g=t+p*a+a/2+.5*this.scale,b=e+(this._chord.strings.length-f-1)*r;i.fillCircle(b,g,h)}}for(const[f,p]of c){let g=t+f*a+a/2+.5*this.scale,b=e+(this._chord.strings.length-p[1]-1)*r,w=e+(this._chord.strings.length-p[0]-1)*r;i.fillRect(b,g-h,w-b,h*2)}i.textAlign=l,i.textBaseline=d}}it.Padding=5,it.Frets=5,it.CircleRadius=2.5,it.StringSpacing=10,it.FretSpacing=12;class hn extends Xt{constructor(e,t,i=V.Center){super(e,t),this._glyphWidth=0,this.glyphs=[],this._align=i}doLayout(){let e=0;switch(this._align){case V.Left:e=0;break;case V.Center:e=(this.width-this._glyphWidth)/2;break;case V.Right:e=this.width-this._glyphWidth;break}for(let t of this.glyphs)t.x=e,e+=t.width}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width,e.height>this.height&&(this.height=e.height)}}class fs extends Xt{constructor(e,t,i=V.Center){super(e,t),this._rows=[],this.height=0,this.glyphs=[],this._align=i}doLayout(){let e=0,t=0,i=fs.Padding*this.scale;this._rows=[];let s=new hn(e,t,this._align);s.width=this.width;for(let r of this.glyphs)e+r.width<this.width?(s.addGlyphToRow(r),e+=r.width):(s.isEmpty||(s.doLayout(),this._rows.push(s),t+=s.height+i),e=0,s=new hn(e,t,this._align),s.width=this.width,s.addGlyphToRow(r),e+=r.width);s.isEmpty||(s.doLayout(),this._rows.push(s),t+=s.height+i),this.height=t}paint(e,t,i){for(let s of this._rows)s.paint(e+this.x,t+this.y,i)}}fs.Padding=3;class Ro extends fs{constructor(e,t){super(e,t)}addChord(e){if(e.strings.length>0){let t=new it(0,0,e);t.renderer=this.renderer,t.doLayout(),this.glyphs.push(t)}}}class dt extends Yt{constructor(e,t,i,s,r=V.Left){super(e,t),this._lineHeights=null,this._lines=i.split(`
`),this.font=s,this.textAlign=r}doLayout(){super.doLayout(),this._lineHeights=[];const e=this.renderer.scoreRenderer.canvas;for(const t of this._lines){e.font=this.font;const i=e.measureText(t).height*this.scale;this._lineHeights.push(i),this.height+=i}}paint(e,t,i){let s=i.color;i.color=s,i.font=this.font;let r=i.textAlign;i.textAlign=this.textAlign;let a=t+this.y;for(let o=0;o<this._lines.length;o++)i.fillText(this._lines[o],e+this.x,a),a+=this._lineHeights[o];i.textAlign=r}}class Io{get staveId(){return this._factory.staffId}constructor(e,t,i){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.trackIndex=0,this.staveTop=0,this.topSpacing=0,this.bottomSpacing=0,this.staveBottom=0,this.isFirstInAccolade=!1,this.isLastInAccolade=!1,this._factory=i,this.trackIndex=e,this.modelStaff=t}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInAccolade(){return this._factory.isInAccolade}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.system.layout.registerBarRenderer(this.staveId,e)}addBar(e,t){let i;e?i=this._factory.create(this.system.layout.renderer,e):i=new Le(this.system.layout.renderer,e),i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=t,i.doLayout(),i.registerLayoutingInfo();const s=i.barDisplayWidth;s>0&&this.system.layout.systemsLayoutMode==Tt.FromModelWithWidths&&(i.width=s),this.barRenderers.push(i),e&&this.system.layout.registerBarRenderer(this.staveId,i)}revertLastBar(){let e=this.barRenderers[this.barRenderers.length-1];return this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staveId,e),e}scaleToWidth(e){this._sharedLayoutData=new Map;let t=this.topOverflow,i=0;switch(this.system.layout.systemsLayoutMode){case Tt.Automatic:let r=(e-this.system.computedWidth)/this.barRenderers.length;for(const o of this.barRenderers){o.x=i,o.y=this.topSpacing+t;let h=o.computedWidth+r;o.scaleToWidth(h),i+=o.width}break;case Tt.FromModelWithScale:e-=this.system.accoladeWidth;const a=this.system.totalBarDisplayScale;for(const o of this.barRenderers){o.x=i,o.y=this.topSpacing+t;const h=o.barDisplayScale*e/a;o.scaleToWidth(h),i+=o.width}break;case Tt.FromModelWithWidths:for(const o of this.barRenderers){o.x=i,o.y=this.topSpacing+t;const h=o.barDisplayWidth;h>0?o.scaleToWidth(h):o.scaleToWidth(o.computedWidth),i+=o.width}break}}get topOverflow(){let e=0;for(let t=0,i=this.barRenderers.length;t<i;t++){let s=this.barRenderers[t];s.topOverflow>e&&(e=s.topOverflow)}return e}get bottomOverflow(){let e=0;for(let t=0,i=this.barRenderers.length;t<i;t++){let s=this.barRenderers[t];s.bottomOverflow>e&&(e=s.bottomOverflow)}return e}finalizeStaff(){const e=this.system.layout.renderer.settings;this.topSpacing=this._factory.getStaffPaddingTop(this)*e.display.scale,this.bottomSpacing=this._factory.getStaffPaddingBottom(this)*e.display.scale,this.height=0;let t=!1,i=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+i,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(t=!0);if(t){i=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+i,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+i+this.bottomOverflow+this.bottomSpacing)}paint(e,t,i,s,r){if(!(this.height===0||r===0))for(let a=s,o=Math.min(s+r,this.barRenderers.length);a<o;a++)this.barRenderers[a].paint(e+this.x,t+this.y,i)}}class ln{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}}class Qi{constructor(){this._timeSortedSprings=[],this._xMin=0,this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this.version=0,this.preBeatSizes=new Map,this.onBeatSizes=new Map,this.onBeatCenterX=new Map,this.preBeatSize=0,this.postBeatSize=0,this.voiceSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}updateVoiceSize(e){e>this.voiceSize&&(this.voiceSize=e,this.version++)}setPreBeatSize(e,t){(!this.preBeatSizes.has(e.id)||this.preBeatSizes.get(e.id)<t)&&(this.preBeatSizes.set(e.id,t),this.version++)}getPreBeatSize(e){return this.preBeatSizes.has(e.id)?this.preBeatSizes.get(e.id):0}setOnBeatSize(e,t){(!this.onBeatSizes.has(e.id)||this.onBeatSizes.get(e.id)<t)&&(this.onBeatSizes.set(e.id,t),this.version++)}getOnBeatSize(e){return this.onBeatSizes.has(e.id)?this.onBeatSizes.get(e.id):0}getBeatCenterX(e){return this.onBeatCenterX.has(e.id)?this.onBeatCenterX.get(e.id):0}setBeatCenterX(e,t){(!this.onBeatCenterX.has(e.id)||this.onBeatCenterX.get(e.id)<t)&&(this.onBeatCenterX.set(e.id,t),this.version++)}updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}addSpring(e,t,i,s,r){this.version++;let a;if(this.springs.has(e))a=this.springs.get(e),a.postSpringWidth<r&&(a.postSpringWidth=r),a.graceBeatWidth<i&&(a.graceBeatWidth=i),a.preBeatWidth<s&&(a.preBeatWidth=s),t<a.smallestDuration&&(a.smallestDuration=t),t>a.longestDuration&&(a.longestDuration=t),a.allDurations.add(t);else{if(a=new ln,a.timePosition=e,a.allDurations.add(t),this._timeSortedSprings.length>0){let l=this._timeSortedSprings[this._timeSortedSprings.length-1];for(const d of l.allDurations)l.timePosition+d}a.longestDuration=t,a.postSpringWidth=r,a.graceBeatWidth=i,a.preBeatWidth=s,this.springs.set(e,a);let o=this._timeSortedSprings,h=o.length-1;for(;h>0&&o[h].timePosition>e;)h--;this._timeSortedSprings.splice(h+1,0,a)}return(this._minTime===-1||this._minTime>e)&&(this._minTime=e),a}addBeatSpring(e,t,i){let s=e.absoluteDisplayStart;if(e.graceType!==W.None){const r=e.graceGroup.id;this.allGraceRods.has(r)||this.allGraceRods.set(r,new Array(e.graceGroup.beats.length)),!e.graceGroup.isComplete&&!this.incompleteGraceRods.has(r)&&this.incompleteGraceRods.set(r,new Array(e.graceGroup.beats.length));let a=this.allGraceRods.get(r)[e.graceIndex];if(a)a.postSpringWidth<i&&(a.postSpringWidth=i),a.preBeatWidth<t&&(a.preBeatWidth=t);else{const o=new ln;o.timePosition=s,o.postSpringWidth=i,o.preBeatWidth=t,e.graceGroup.isComplete||(this.incompleteGraceRods.get(r)[e.graceIndex]=o),this.allGraceRods.get(r)[e.graceIndex]=o}}else{let r=0;if(e.graceGroup&&this.allGraceRods.has(e.graceGroup.id))for(const a of this.allGraceRods.get(e.graceGroup.id))r+=a.springWidth;this.addSpring(s,e.displayDuration,r,t,i)}}finish(){for(const[e,t]of this.allGraceRods){let i=0;if(this.incompleteGraceRods.has(e))for(const s of t)i+=s.preBeatWidth,s.graceBeatWidth=i,i+=s.postSpringWidth;else for(let s=t.length-1;s>=0;s--)t[s].graceBeatWidth=i,i-=t[s].preBeatWidth+t[s].postSpringWidth}this._incompleteGraceRodsWidth=0;for(const e of this.incompleteGraceRods.values())for(const t of e)this._incompleteGraceRodsWidth+=t.preBeatWidth+t.postSpringWidth;this.calculateSpringConstants(),this.version++}calculateSpringConstants(){this._xMin=0;let e=this.springs;for(const s of e.values())s.springWidth<this._xMin&&(this._xMin=s.springWidth);let t=0,i=this._timeSortedSprings;if(i.length===0){this.totalSpringConstant=-1,this.minStretchForce=-1;return}for(let s=0;s<i.length;s++){let r=i[s],a=0;if(s===i.length-1)a=r.longestDuration;else{let o=i[s+1];a=Math.abs(o.timePosition-r.timePosition)}r.springConstant=this.calculateSpringConstant(r,a),t+=1/r.springConstant}this.totalSpringConstant=1/t,this.minStretchForce=0;for(let s=0;s<i.length;s++){let r=i[s],a=0;if(s===i.length-1)a=r.postSpringWidth;else{let h=i[s+1];a=r.postSpringWidth+h.preSpringWidth}s===0&&(a+=r.preSpringWidth);let o=a*r.springConstant;this.updateMinStretchForce(o)}}paint(e,t,i){}calculateSpringConstant(e,t){t<=0&&(t=q.toTicks(m.SixtyFourth)),e.smallestDuration===0&&(e.smallestDuration=t);let i=e.smallestDuration,s=1+.85*Math.log2(t/Qi.MinDuration);return i/t*(1/(s*Qi.MinDurationWidth))}spaceToForce(e){return this.totalSpringConstant!==-1?(this._timeSortedSprings.length>0&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return this.totalSpringConstant!==-1&&(t=this.calculateWidth(e,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth,t}calculateWidth(e,t){return e/t}buildOnTimePositions(e){if(this.totalSpringConstant===-1)return new Map;if(Be.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;let t=new Map;this._onTimePositions=t;let i=this._timeSortedSprings;if(i.length===0)return t;let s=i[0].preSpringWidth;for(let r=0;r<i.length;r++)t.set(i[r].timePosition,s),s+=this.calculateWidth(e,i[r].springConstant);return t}}Qi.MinDuration=30,Qi.MinDurationWidth=7;class Mo{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.renderers=[]}}class Ao{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInAccolade=null,this.lastStaffInAccolade=null,this.staffSystem=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}}class ps{constructor(e){this._allStaves=[],this._firstStaffInAccolade=null,this._lastStaffInAccolade=null,this._accoladeSpacingCalculated=!1,this.x=0,this.y=0,this.index=0,this.accoladeWidth=0,this.isFull=!1,this.width=0,this.computedWidth=0,this.totalBarDisplayScale=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[],this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].masterBar.index}addMasterBarRenderers(e,t){if(e.length===0)return null;this.masterBarsRenderers.push(t),this.calculateAccoladeSpacing(e),t.layoutingInfo.preBeatSize=0;let i=0;for(let s=0,r=this.staves.length;s<r;s++){let a=this.staves[s];for(let o=0,h=a.staves.length;o<h;o++){let l=a.staves[o],d=t.renderers[i++];l.addBarRenderer(d)}}return this.updateWidthFromLastBar(),t}addBars(e,t){if(e.length===0)return null;let i=new Mo;i.layoutingInfo=new Qi,i.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(i),this.calculateAccoladeSpacing(e);let s=i.layoutingInfo;for(let r of this.staves)for(let a of r.staves){let o=r.track.staves[a.modelStaff.index].bars[t];a.addBar(o,s);let h=a.barRenderers[a.barRenderers.length-1];i.renderers.push(h),h.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),h.canWrap||(i.canWrap=!1)}return s.finish(),i.width=this.updateWidthFromLastBar(),i}revertLastBar(){if(this.masterBarsRenderers.length>1){let e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let t=0,i=0;for(let s=0,r=this._allStaves.length;s<r;s++){let o=this._allStaves[s].revertLastBar();const h=o.computedWidth;h>t&&(t=h);const l=o.barDisplayScale;l>i&&(i=l)}return this.width-=t,this.computedWidth-=t,this.totalBarDisplayScale-=i,e}return null}updateWidthFromLastBar(){let e=0,t=0;for(let i=0,s=this._allStaves.length;i<s;i++){let r=this._allStaves[i];const a=r.barRenderers[r.barRenderers.length-1];a.applyLayoutingInfo(),a.computedWidth>e&&(e=a.computedWidth);const o=a.barDisplayScale;o>t&&(t=o)}return this.width+=e,this.computedWidth+=e,this.totalBarDisplayScale+=t,e}calculateAccoladeSpacing(e){const t=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){if(this._accoladeSpacingCalculated=!0,this.index===0&&this.layout.renderer.settings.notation.isNotationElementVisible(G.TrackNames)){let i=this.layout.renderer.canvas,s=t.display.resources.effectFont;i.font=s;for(let r of e)this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,i.measureText(r.shortName).width));this.accoladeWidth*=this.layout.scale,this.accoladeWidth+=t.display.systemLabelPaddingLeft*this.layout.scale,this.accoladeWidth+=t.display.systemLabelPaddingRight*this.layout.scale}else this.accoladeWidth=0;this.accoladeWidth+=ps.AccoladeBarSize*this.layout.scale,this.accoladeWidth+=t.display.accoladeBarPaddingRight*this.layout.scale,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}getStaffTrackGroup(e){for(let t=0,i=this.staves.length;t<i;t++){let s=this.staves[t];if(s.track===e)return s}return null}addStaff(e,t){let i=this.getStaffTrackGroup(e);i||(i=new Ao(this,e),this.staves.push(i)),t.staffTrackGroup=i,t.system=this,t.index=this._allStaves.length,this._allStaves.push(t),i.addStaff(t),t.isInAccolade&&(this._firstStaffInAccolade||(this._firstStaffInAccolade=t,t.isFirstInAccolade=!0),i.firstStaffInAccolade||(i.firstStaffInAccolade=t),this._lastStaffInAccolade||(this._lastStaffInAccolade=t,t.isLastInAccolade=!0),this._lastStaffInAccolade&&(this._lastStaffInAccolade.isLastInAccolade=!1),this._lastStaffInAccolade=t,this._lastStaffInAccolade.isLastInAccolade=!0,i.lastStaffInAccolade=t)}get height(){return this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding}scaleToWidth(e){for(let t=0,i=this._allStaves.length;t<i;t++)this._allStaves[t].scaleToWidth(e);this.width=e}paint(e,t,i){t+=this.topPadding,this.paintPartial(e+this.x,t+this.y,i,0,this.masterBarsRenderers.length)}paintPartial(e,t,i,s,r){for(let o=0,h=this._allStaves.length;o<h;o++)this._allStaves[o].paint(e,t,i,s,r);let a=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&s===0){if(i.color=a.barSeparatorColor,this._firstStaffInAccolade&&this._lastStaffInAccolade){let h=t+this._firstStaffInAccolade.y+this._firstStaffInAccolade.staveTop+this._firstStaffInAccolade.topSpacing+this._firstStaffInAccolade.topOverflow,l=t+this._lastStaffInAccolade.y+this._lastStaffInAccolade.topSpacing+this._lastStaffInAccolade.topOverflow+this._lastStaffInAccolade.staveBottom,d=e+this._firstStaffInAccolade.x;i.beginPath(),i.moveTo(d,h),i.lineTo(d,l),i.stroke()}i.font=a.effectFont;const o=this.layout.renderer.settings;for(let h=0,l=this.staves.length;h<l;h++){let d=this.staves[h];if(d.firstStaffInAccolade&&d.lastStaffInAccolade){let c=t+d.firstStaffInAccolade.y+d.firstStaffInAccolade.staveTop+d.firstStaffInAccolade.topSpacing+d.firstStaffInAccolade.topOverflow,f=t+d.lastStaffInAccolade.y+d.lastStaffInAccolade.topSpacing+d.lastStaffInAccolade.topOverflow+d.lastStaffInAccolade.staveBottom;const p=this.index===0&&this.layout.renderer.settings.notation.isNotationElementVisible(G.TrackNames);let g=e+d.firstStaffInAccolade.x,b=ps.AccoladeBarSize*this.layout.scale,w=o.display.accoladeBarPaddingRight*this.layout.scale,D=c-b*4,R=f+b*4;p&&i.fillText(d.track.shortName,e+o.display.systemLabelPaddingLeft*this.layout.scale,c),i.fillRect(g-w-b,D,b,R-D);let B=g-w-b,X=g+b*2;i.beginPath(),i.moveTo(B,D),i.bezierCurveTo(B,D,B,D,X,D-b),i.bezierCurveTo(g,D+b,B,D+b,B,D+b),i.closePath(),i.fill(),i.beginPath(),i.moveTo(B,R),i.bezierCurveTo(B,R,g,R,X,R+b),i.bezierCurveTo(g,R-b,B,R-b,B,R-b),i.closePath(),i.fill()}}}}finalizeSystem(){const e=this.layout.renderer.settings;this.index===0&&(this.topPadding=e.display.firstSystemPaddingTop*e.display.scale),this.isLast&&(this.bottomPadding=e.display.lastSystemPaddingBottom*e.display.scale);let t=0;for(let i of this._allStaves)i.x=this.accoladeWidth,i.y=t,i.finalizeStaff(),t+=i.height}buildBoundingsLookup(e,t){if(this.layout.renderer.boundsLookup.isFinished||!this._firstStaffInAccolade||!this._lastStaffInAccolade)return;t+=this.topPadding;let i=this._allStaves[this._allStaves.length-1],s=t+this.y+this._firstStaffInAccolade.y,r=t+this.y+this._lastStaffInAccolade.y+this._lastStaffInAccolade.height,a=t+this.y+this._allStaves[0].y,o=t+this.y+i.y+i.height,h=t+this.y+this._firstStaffInAccolade.y+this._firstStaffInAccolade.topSpacing+this._firstStaffInAccolade.topOverflow+(this._firstStaffInAccolade.barRenderers.length>0?this._firstStaffInAccolade.barRenderers[0].topPadding:0),l=t+this.y+i.y+i.height-i.bottomSpacing-i.bottomOverflow-(i.barRenderers.length>0?i.barRenderers[0].bottomPadding:0),d=r-s,c=l-h,f=o-a,p=this.x+this._firstStaffInAccolade.x,g=new Za;g.visualBounds=new gt,g.visualBounds.x=e,g.visualBounds.y=t+this.y,g.visualBounds.w=this.width,g.visualBounds.h=this.height-this.topPadding-this.bottomPadding,g.realBounds=new gt,g.realBounds.x=e,g.realBounds.y=t+this.y,g.realBounds.w=this.width,g.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(g);let b=new Map;for(let w=0;w<this.staves.length;w++)for(let D of this.staves[w].stavesRelevantForBoundsLookup)for(let R of D.barRenderers){let B;b.has(R.bar.masterBar.index)?B=b.get(R.bar.masterBar.index):(B=new Ka,B.index=R.bar.masterBar.index,B.isFirstOfLine=R.isFirstOfLine,B.realBounds=new gt,B.realBounds.x=p+R.x,B.realBounds.y=a,B.realBounds.w=R.width,B.realBounds.h=f,B.visualBounds=new gt,B.visualBounds.x=p+R.x,B.visualBounds.y=s,B.visualBounds.w=R.width,B.visualBounds.h=d,B.lineAlignedBounds=new gt,B.lineAlignedBounds.x=p+R.x,B.lineAlignedBounds.y=h,B.lineAlignedBounds.w=R.width,B.lineAlignedBounds.h=c,this.layout.renderer.boundsLookup.addMasterBar(B),b.set(B.index,B)),R.buildBoundingsLookup(B,p,t+this.y+D.y)}}getBarX(e){if(!this._firstStaffInAccolade||this.layout.renderer.tracks.length===0)return 0;let t=this.layout.renderer.tracks[0].staves[0].bars[e];return this.layout.getRendererForBar(this._firstStaffInAccolade.staveId,t).x}}ps.AccoladeBarSize=3;class As extends Xt{constructor(e,t,i,s){super(e,t),this._tuning=i,this._trackLabel=s,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.createGlyphs(this._tuning);for(const e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,t,i){i.textBaseline=J.Middle,super.paint(e,t,i)}createGlyphs(e){const t=this.renderer.scale,i=this.renderer.resources;this.height=0;const s=15*t;if(this._trackLabel.length>0){const o=new dt(0,this.height,this._trackLabel,i.effectFont,V.Left);o.renderer=this.renderer,o.doLayout(),this.height+=o.height,o.y+=o.height/2,this.addGlyph(o)}const r=new dt(0,this.height,e.name,i.effectFont,V.Left);r.renderer=this.renderer,r.doLayout(),this.height+=r.height,r.y+=r.height/2,this.addGlyph(r);const a=64*t;if(this.renderer.scoreRenderer.canvas.font=i.effectFont,this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width*t,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width*t,2*a)),!e.isStandard){this.height+=s;const o=.7,h=As.CircleNumberHeight*o*t;let l=Math.ceil(e.tunings.length/2)|0,d=0,c=this.height;for(let f=0,p=e.tunings.length;f<p;f++){const g=u.GuitarString0+(f+1);this.addGlyph(new De(d,c+h/2.5,o,g));const b="= "+x.getTextForTuning(e.tunings[f],!1);this.addGlyph(new dt(d+h+1*t,c,b,i.effectFont,V.Left)),c+=s,f===l-1&&(c=this.height,d+=a)}this.height+=l*s}this.width+=15*t}}As.CircleNumberHeight=20;class Oo extends fs{constructor(e,t){super(e,t,V.Left)}addTuning(e,t){if(e.tunings.length>0){let i=new As(0,0,e,t);i.renderer=this.renderer,i.doLayout(),this.glyphs.push(i)}}}class Vo{constructor(e,t){this.args=e,this.renderCallback=t}}var Tt;(function(n){n[n.Automatic=0]="Automatic",n[n.FromModelWithScale=1]="FromModelWithScale",n[n.FromModelWithWidths=2]="FromModelWithWidths"})(Tt||(Tt={}));class dn{constructor(e){this._barRendererLookup=new Map,this.width=0,this.height=0,this.scoreInfoGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.systemsLayoutMode=Tt.Automatic,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();let e=this.renderer.score,t=this.renderer.settings.display.startBar;t--,t=Math.min(e.masterBars.length-1,Math.max(0,t)),this.firstBarIndex=t;let i=this.renderer.settings.display.barCount;i<0&&(i=e.masterBars.length),i=t+i-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),this.lastBarIndex=i,this.createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(e,t){e.height!=0&&(this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(e.id,new Vo(e,t)),this.renderer.partialLayoutFinished.trigger(e)):(this.renderer.partialLayoutFinished.trigger(e),this.internalRenderLazyPartial(e,t)))}internalRenderLazyPartial(e,t){const i=this.renderer.canvas;i.beginRender(e.width,e.height),t(i),e.renderResult=i.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){if(this._lazyPartials.has(e)){const t=this._lazyPartials.get(e);this.internalRenderLazyPartial(t.args,t.renderCallback)}}createScoreInfoGlyphs(){_.debug("ScoreLayout","Creating score info glyphs");let e=this.renderer.settings.notation,t=this.renderer.score,i=this.renderer.settings.display.resources;this.scoreInfoGlyphs=new Map,t.title&&e.isNotationElementVisible(G.ScoreTitle)&&this.scoreInfoGlyphs.set(G.ScoreTitle,new dt(0,0,t.title,i.titleFont,V.Center)),t.subTitle&&e.isNotationElementVisible(G.ScoreSubTitle)&&this.scoreInfoGlyphs.set(G.ScoreSubTitle,new dt(0,0,t.subTitle,i.subTitleFont,V.Center)),t.artist&&e.isNotationElementVisible(G.ScoreArtist)&&this.scoreInfoGlyphs.set(G.ScoreArtist,new dt(0,0,t.artist,i.subTitleFont,V.Center)),t.album&&e.isNotationElementVisible(G.ScoreAlbum)&&this.scoreInfoGlyphs.set(G.ScoreAlbum,new dt(0,0,t.album,i.subTitleFont,V.Center)),t.music&&t.music===t.words&&e.isNotationElementVisible(G.ScoreWordsAndMusic)?this.scoreInfoGlyphs.set(G.ScoreWordsAndMusic,new dt(0,0,"Music and Words by "+t.words,i.wordsFont,V.Center)):(t.music&&e.isNotationElementVisible(G.ScoreMusic)&&this.scoreInfoGlyphs.set(G.ScoreMusic,new dt(0,0,"Music by "+t.music,i.wordsFont,V.Right)),t.words&&e.isNotationElementVisible(G.ScoreWords)&&this.scoreInfoGlyphs.set(G.ScoreWords,new dt(0,0,"Words by "+t.words,i.wordsFont,V.Left)));const s=new Le(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[r,a]of this.scoreInfoGlyphs)a.renderer=s,a.doLayout();if(e.isNotationElementVisible(G.GuitarTuning)){let r=[];for(let a of this.renderer.tracks)for(let o of a.staves)if(!o.isPercussion&&o.isStringed&&o.tuning.length>0&&o.showTablature){r.push(o);break}if(r.length>0){this.tuningGlyph=new Oo(0,0),this.tuningGlyph.renderer=s;for(const a of r)this.tuningGlyph.addTuning(a.stringTuning,r.length>1?a.track.name:"")}}if(e.isNotationElementVisible(G.ChordDiagrams)){this.chordDiagrams=new Ro(0,0),this.chordDiagrams.renderer=s;let r=new Set;for(let a of this.renderer.tracks)for(let o of a.staves){const h=o.chords;if(h)for(const[,l]of h)r.has(l.uniqueId)||l.showDiagram&&(r.add(l.uniqueId),this.chordDiagrams.addChord(l))}}}get scale(){return this.renderer.settings.display.scale}createEmptyStaffSystem(){let e=new ps(this);for(let t=0;t<this.renderer.tracks.length;t++){let i=this.renderer.tracks[t],s=!1;for(let r of i.staves)if(r.showStandardNotation){s=!0;break}for(let r=0;r<i.staves.length;r++){let a=i.staves[r],o;if(a.isPercussion)o=Bt.Score;else if(this.renderer.settings.display.staveProfile!==Bt.Default)o=this.renderer.settings.display.staveProfile;else if(a.showTablature&&a.showStandardNotation)o=Bt.ScoreTab;else if(a.showTablature)o=s?Bt.TabMixed:Bt.Tab;else if(a.showStandardNotation)o=Bt.Score;else continue;let h=v.staveProfiles.get(o);for(let l of h)l.canCreate(i,a)&&e.addStaff(i,new Io(t,a,l))}}return e}registerBarRenderer(e,t){this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t)}unregisterBarRenderer(e,t){this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).delete(t.bar.id)}getRendererForBar(e,t){let i=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(i)?this._barRendererLookup.get(e).get(i):null}layoutAndRenderAnnotation(e){let t="rendered by alphaTab",i=this.renderer.settings.display.resources,s=12*this.renderer.settings.display.scale,r=Math.floor(s);const a=new Ri,o=ne.withFamilyList(i.copyrightFont.families,s,Ce.Plain,_t.Bold);this.renderer.canvas.font=o;const h=v.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical;return a.width=this.renderer.canvas.measureText(t).width,a.height=r,a.x=h?(this.width-a.width)/2:this.firstBarX,a.y=e,a.totalWidth=this.width,a.totalHeight=e+r,a.firstMasterBarIndex=-1,a.lastMasterBarIndex=-1,this.registerPartial(a,l=>{l.color=i.mainGlyphColor,l.font=o,l.textAlign=V.Left,l.textBaseline=J.Top,l.fillText(t,0,0)}),e+r}}var A;(function(n){n[n.TopWithStem=0]="TopWithStem",n[n.Top=1]="Top",n[n.Center=2]="Center",n[n.Bottom=3]="Bottom",n[n.BottomWithStem=4]="BottomWithStem"})(A||(A={}));var Te;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(Te||(Te={}));class Le{get nextRenderer(){return!this.bar||!this.bar.nextBar?null:this.scoreRenderer.layout.getRendererForBar(this.staff.staveId,this.bar.nextBar)}get previousRenderer(){return!this.bar||!this.bar.previousBar?null:this.scoreRenderer.layout.getRendererForBar(this.staff.staveId,this.bar.previousBar)}constructor(e,t){this._preBeatGlyphs=new us,this._voiceContainers=new Map,this._postBeatGlyphs=new us,this._ties=[],this.x=0,this.y=0,this.width=0,this.computedWidth=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this._wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,this.bar=t,t&&(this.helpers=new Do(this))}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return e>this.topOverflow?(this.topOverflow=e,!0):!1}registerOverflowBottom(e){return e>this.bottomOverflow?(this.bottomOverflow=e,!0):!1}scaleToWidth(e){let t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(const i of this._voiceContainers.values())i.scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get settings(){return this.scoreRenderer.settings}get scale(){return this.settings.display.scale}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}get isFirstOfLine(){return this.index===0}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){let e=this.layoutingInfo,t=this._preBeatGlyphs.width;e.preBeatSize<t&&(e.preBeatSize=t);for(const s of this._voiceContainers.values())s.registerLayoutingInfo(e),s.x+s.width;let i=this._postBeatGlyphs.width;e.postBeatSize<i&&(e.postBeatSize=i)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(const i of this._voiceContainers.values()){i.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,i.applyLayoutingInfo(this.layoutingInfo);let s=i.x+i.width;e<s&&(e=s)}this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;const t=this.barDisplayWidth;return t>0&&this.scoreRenderer.layout.systemsLayoutMode==Tt.FromModelWithWidths&&(this.width=t,this.computedWidth=t),!0}finalizeRenderer(){this.isFinalized=!0;let e=!1;const t=this.y-this.staff.topSpacing,i=this.y+this.height+this.staff.bottomSpacing;for(const s of this._ties)if(s.doLayout(),s.height>0){const r=s.y+s.height-i;r>0&&this.registerOverflowBottom(r)&&(e=!0);const a=s.y-t;a<0&&this.registerOverflowTop(a*-1)&&(e=!0)}return e}doLayout(){if(this.bar){this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new us,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new us,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){let t=this.bar.voices[e];if(this.hasVoiceContainer(t)){let i=new on(0,0,t);i.renderer=this,this._voiceContainers.set(this.bar.voices[e].index,i)}}this.bar.simileMark===Pt.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.createBeatGlyphs(),this.createPostBeatGlyphs(),this.updateSizes();for(const e of this.helpers.beamHelpers)for(const t of e)t.finish();this.computedWidth=this.width}}hasVoiceContainer(e){return!e.isEmpty||e.index===0}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);let e=this._voiceContainers,t=this.beatGlyphsStart,i=t;for(const s of e.values()){s.x=t,s.doLayout();let r=s.x+s.width;i<r&&(i=r)}this._postBeatGlyphs.x=Math.floor(i),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height*this.scale}addPreBeatGlyph(e){e.renderer=this,this._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){var t,i;return(i=(t=this.getVoiceContainer(e.voice))==null?void 0:t.beatGlyphs)==null?void 0:i[e.index]}getPreNotesGlyphForBeat(e){var t;return(t=this.getBeatContainer(e))==null?void 0:t.preNotes}getOnNotesGlyphForBeat(e){var t;return(t=this.getBeatContainer(e))==null?void 0:t.onNotes}paint(e,t,i){this.paintBackground(e,t,i),i.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,i);for(const s of this._voiceContainers.values())i.color=s.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.paint(e+this.x,t+this.y,i);i.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,i)}paintBackground(e,t,i){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,i)}buildBoundingsLookup(e,t,i){let s=new Qa;s.bar=this.bar,s.visualBounds=new gt,s.visualBounds.x=t+this.x,s.visualBounds.y=i+this.y+this.topPadding,s.visualBounds.w=this.width,s.visualBounds.h=this.height-this.topPadding-this.bottomPadding,s.realBounds=new gt,s.realBounds.x=t+this.x,s.realBounds.y=i+this.y,s.realBounds.w=this.width,s.realBounds.h=this.height,e.addBar(s);for(const[r,a]of this._voiceContainers){let o=this.bar.isEmpty&&r===0;if(!a.voice.isEmpty||o)for(let h=0,l=a.beatGlyphs.length;h<l;h++)a.beatGlyphs[h].buildBoundingsLookup(s,t+this.x+a.x,i+this.y+a.y,o)}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this._wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(const e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e)}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=te.PreNotes){let i=this.getBeatContainer(e);if(i)switch(t){case te.PreNotes:return i.voiceContainer.x+i.x;case te.OnNotes:return i.voiceContainer.x+i.x+i.onNotes.x;case te.MiddleNotes:return i.voiceContainer.x+i.x+i.onTimeX;case te.Stem:const s=i.onNotes.beamingHelper?i.onNotes.beamingHelper.getBeatLineX(e):i.onNotes.x+i.onNotes.width/2;return i.voiceContainer.x+s;case te.PostNotes:return i.voiceContainer.x+i.x+i.onNotes.x+i.onNotes.width;case te.EndBeat:return i.voiceContainer.x+i.x+i.width}return 0}getNoteX(e,t){let i=this.getBeatContainer(e.beat);return i?i.voiceContainer.x+i.x+i.onNotes.x+i.onNotes.getNoteX(e,t):0}getNoteY(e,t){let i=this.getOnNotesGlyphForBeat(e.beat);return i?i.getNoteY(e,t):NaN}reLayout(){(this._wasFirstOfLine&&!this.isFirstOfLine||!this._wasFirstOfLine&&this.isFirstOfLine)&&(this._preBeatGlyphs=new us,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()),this.updateSizes(),this.registerLayoutingInfo()}paintSimileMark(e,t,i){switch(this.bar.simileMark){case Pt.Simple:i.fillMusicFontSymbol(e+this.x+(this.width-20*this.scale)/2,t+this.y+this.height/2,1,u.Repeat1Bar,!1);break;case Pt.SecondOfDouble:i.fillMusicFontSymbol(e+this.x-28*this.scale/2,t+this.y+this.height/2,1,u.Repeat2Bars,!1);break}}completeBeamingHelper(e){}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}}Le.RawLineSpacing=8,Le.StemWidth=.12*Le.RawLineSpacing,Le.StaffLineThickness=.13*Le.RawLineSpacing,Le.BeamThickness=.5*Le.RawLineSpacing,Le.BeamSpacing=.25*Le.RawLineSpacing;var ae;(function(n){n[n.SinglePreBeat=0]="SinglePreBeat",n[n.SingleOnBeat=1]="SingleOnBeat",n[n.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",n[n.GroupedOnBeat=3]="GroupedOnBeat",n[n.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",n[n.FullBar=5]="FullBar"})(ae||(ae={}));class Wo extends Ie{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||this.renderer.staff.trackIndex===0)){if(this.isEmpty=!1,(!this.firstBeat||e.isBefore(this.firstBeat))&&(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case ae.SingleOnBeatToEnd:case ae.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat);break}let t=this.createOrResizeGlyph(this.info.sizingMode,e);t.height>this.height&&(this.height=t.height)}}createOrResizeGlyph(e,t){let i;switch(e){case ae.FullBar:return i=this.info.createNewGlyph(this.renderer,t),i.renderer=this.renderer,i.beat=t,i.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,i),this._uniqueEffectGlyphs[t.voice.index].push(i),i;case ae.SinglePreBeat:case ae.SingleOnBeat:case ae.SingleOnBeatToEnd:return i=this.info.createNewGlyph(this.renderer,t),i.renderer=this.renderer,i.beat=t,i.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,i),this._uniqueEffectGlyphs[t.voice.index].push(i),i;case ae.GroupedOnBeat:case ae.GroupedOnBeatToEnd:let s=e===ae.GroupedOnBeat?ae.SingleOnBeat:ae.SingleOnBeatToEnd;if(t.index>0||this.renderer.index>0){let r=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,r)){let a=null;if(t.index>0&&this._effectGlyphs[t.voice.index].has(r.index))a=this._effectGlyphs[t.voice.index].get(r.index);else if(this.renderer.index>0){let l=this.renderer.previousRenderer.getBand(r.voice,this.info.effectId);if(l){let d=l._effectGlyphs[r.voice.index];d.has(r.index)&&(a=d.get(r.index))}}let o=this.createOrResizeGlyph(s,t);return a&&this.info.canExpand(r,t)&&(a.nextGlyph=o,o.previousGlyph=a,this.isLinkedToPrevious=!0),o}return this.createOrResizeGlyph(s,t)}return this.createOrResizeGlyph(s,t);default:return this.createOrResizeGlyph(ae.SingleOnBeat,t)}}paint(e,t,i){super.paint(e,t,i);for(let s=0,r=this._uniqueEffectGlyphs.length;s<r;s++){let a=this._uniqueEffectGlyphs[s];for(let o=0,h=a.length;o<h;o++)a[o].paint(e+this.x,t+this.y,i)}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(const t of this._effectGlyphs[e].keys())this.alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}alignGlyph(e,t){let i=this._effectGlyphs[t.voice.index].get(t.index),s,r=this.renderer.getBeatContainer(t);switch(e){case ae.SinglePreBeat:s=r.preNotes,i.x=this.renderer.beatGlyphsStart+s.x+r.x,i.width=s.width;break;case ae.SingleOnBeat:case ae.GroupedOnBeat:s=r.onNotes,i.x=this.renderer.beatGlyphsStart+s.x+r.x,i.width=s.width;break;case ae.SingleOnBeatToEnd:case ae.GroupedOnBeatToEnd:s=r.onNotes,i.x=this.renderer.beatGlyphsStart+s.x+r.x,r.beat.isLastOfVoice?i.width=this.renderer.width-i.x:i.width=r.width-r.preNotes.width-r.preNotes.x;break;case ae.FullBar:i.width=this.renderer.width;break}}}class Ho{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}}class Go{constructor(){this.bands=[],this.shared=new Ho}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),e.slot=this,this.bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),(!this.shared.firstBeat||e.firstBeat.isBefore(this.shared.firstBeat))&&(this.shared.firstBeat=e.firstBeat),(!this.shared.lastBeat||e.lastBeat.isAfter(this.shared.lastBeat))&&(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class zo{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){let i=this._effectSlot.get(e.info.effectId);if(i.canBeUsed(e))return i}for(let i of this.slots)if(i.canBeUsed(e))return i;let t=new Go;return this.slots.push(t),t}register(e){let t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}}class gs extends Xt{constructor(){super(0,0),this.computedWidth=0}doLayout(){let e=0;if(this.glyphs)for(let t=0,i=this.glyphs.length;t<i;t++){let s=this.glyphs[t];s.x=e,s.renderer=this.renderer,s.doLayout(),e+=s.width}this.width=e,this.computedWidth=e}noteLoop(e){for(let t=this.container.beat.notes.length-1;t>=0;t--)e(this.container.beat.notes[t])}}class ms extends gs{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(e,t,i){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}}class Uo extends Le{constructor(e,t,i){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=i}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return this.updateHeight()&&(e=!0),e}updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(let t of this.sizingInfo.slots){t.shared.y=e;for(let i of t.bands)i.y=e,i.height=t.shared.height;e+=t.shared.height}return e!==this.height?(this.height=e,!0):!1}applyLayoutingInfo(){if(!super.applyLayoutingInfo())return!1;if(this.index>0){let e=this.previousRenderer;this.sizingInfo=e.sizingInfo}else this.sizingInfo=new zo;for(let e of this._bands)e.alignGlyphs(),e.isEmpty||this.sizingInfo.register(e);return this.updateHeight(),!0}scaleToWidth(e){super.scaleToWidth(e);for(let t of this._bands)t.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(let e of this.bar.voices)if(this.hasVoiceContainer(e))for(let t of this._infos){let i=new Wo(e,t);i.renderer=this,i.doLayout(),this._bands.push(i),this._bandLookup.set(e.index+"."+t.effectId,i)}for(let e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e);for(let e of this._bands)e.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(let t of e.beats){let i=new It(t,this.getVoiceContainer(e));i.preNotes=new gs,i.onNotes=new ms,this.addBeatGlyph(i);for(let s of this._bands)s.createGlyph(t)}}paint(e,t,i){this.paintBackground(e,t,i);for(let s of this._bands)i.color=s.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isEmpty||s.paint(e+this.x,t+this.y,i)}getBand(e,t){let i=e.index+"."+t;return this._bandLookup.has(i)?this._bandLookup.get(i):null}}class ti extends Ms{get staffId(){return this._staffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(e,t){super(),this._infos=t,this._staffId=e,this.isInAccolade=!1,this.isRelevantForBoundsLookup=!1}create(e,t){return new Uo(e,t,this._infos.filter(i=>e.settings.notation.isNotationElementVisible(i.notationElement)))}}class ys extends Yt{constructor(e,t,i){super(e,t),this._endingsString="",this._endings=[];for(let s=0;s<li.MaxAlternateEndings;s++)i&1<<s&&this._endings.push(s)}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+(ys.Padding*this.scale+2);let e="";for(let t=0,i=this._endings.length;t<i;t++)e+=this._endings[t]+1,e+=". ";this._endingsString=e}paint(e,t,i){super.paint(e,t,i);let s=i.textBaseline;if(i.textBaseline=J.Top,this._endings.length>0){let r=this.renderer.resources;i.font=r.wordsFont,i.moveTo(e+this.x,t+this.y+this.height),i.lineTo(e+this.x,t+this.y),i.lineTo(e+this.x+this.width,t+this.y),i.stroke(),i.fillText(this._endingsString,e+this.x+ys.Padding*this.scale,t+this.y*this.scale)}i.textBaseline=s}}ys.Padding=3;class Ze{get effectId(){return this.notationElement.toString()}}class Mr extends Ze{get notationElement(){return G.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ae.FullBar}shouldCreateGlyph(e,t){return t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.alternateEndings!==0}createNewGlyph(e,t){return new ys(0,0,t.voice.bar.masterBar.alternateEndings)}canExpand(e,t){return!0}}class cn extends Ze{get notationElement(){return G.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.index===0&&t.voice.bar.index===0&&t.voice.bar.staff.capo!==0}createNewGlyph(e,t){return new dt(0,0,"Capo. fret "+t.voice.bar.staff.capo,e.resources.effectFont,V.Left)}canExpand(e,t){return!1}}class Ar extends Ze{get notationElement(){return G.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return new dt(0,0,t.chord.name,e.resources.effectFont,V.Center)}canExpand(e,t){return!1}}class bs extends Yt{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(e,t,i){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering){this.paintNonGrouped(e,t,i);return}let s;if(!this.isLinkedWithNext&&this.forceGroupedRendering)s=this;else for(s=this.nextGlyph;s.isLinkedWithNext;)s=s.nextGlyph;let r=s.renderer,a=s.beat,o=this.endPosition,h=e-this.renderer.x,l=this.calculateEndX(r,a,h,o);this.paintGrouped(e,t,l,i)}calculateEndX(e,t,i,s){return t?i+e.x+e.getBeatX(t,s):i+e.x+this.x+this.width}paintNonGrouped(e,t,i){let s=e-this.renderer.x,r=this.calculateEndX(this.renderer,this.beat,s,this.endPosition);this.paintGrouped(e,t,r,i)}}class ws extends bs{constructor(e,t,i){super(te.EndBeat),this._crescendo=mt.None,this._crescendo=i,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=17*this.scale}paintGrouped(e,t,i,s){let r=e+this.x,a=this.height*this.scale;s.beginPath(),this._crescendo===mt.Crescendo?(i-=ws.Padding*this.scale,s.moveTo(i,t+this.y),s.lineTo(r,t+this.y+a/2),s.lineTo(i,t+this.y+a)):(i-=ws.Padding*this.scale,s.moveTo(r,t+this.y),s.lineTo(i,t+this.y+a/2),s.lineTo(r,t+this.y+a)),s.stroke()}}ws.Padding=$.QuarterNoteHeadWidth/2|0;class un extends Ze{get notationElement(){return G.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.crescendo!==mt.None}createNewGlyph(e,t){return new ws(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}}class Or extends De{constructor(e,t,i){super(e,t,.6,Or.getSymbol(i))}doLayout(){super.doLayout(),this.height=17*this.scale,this.y+=this.height/2}static getSymbol(e){switch(e){case j.PPP:return u.DynamicPPP;case j.PP:return u.DynamicPP;case j.P:return u.DynamicPiano;case j.MP:return u.DynamicMP;case j.MF:return u.DynamicMF;case j.F:return u.DynamicForte;case j.FF:return u.DynamicFF;case j.FFF:return u.DynamicFFF;default:return u.None}}}class fn extends Ze{get notationElement(){return G.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return this.internalShouldCreateGlyph(t)}internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest||e.graceType!==W.None)return!1;let t=this.getPreviousDynamicsBeat(e),i=e.voice.index===0&&!t||e.dynamics!==(t==null?void 0:t.dynamics);if(i&&e.voice.index>0){for(let s of e.voice.bar.voices)if(s.index<e.voice.index){let r=s.getBeatAtPlaybackStart(e.playbackStart);r&&e.dynamics===r.dynamics&&this.internalShouldCreateGlyph(r)&&(i=!1)}}return i}getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;t!=null;){if(!t.isRest&&t.graceType===W.None)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new Or(0,0,t.dynamics)}canExpand(e,t){return!0}}class Yo extends Yt{doLayout(){super.doLayout(),this.height=17*this.scale}paint(e,t,i){let s=6*this.scale,r=Math.max(this.width,14*this.scale),a=this.height/2;i.beginPath(),i.moveTo(e+this.x,t+this.y+a),i.quadraticCurveTo(e+this.x+r/2,t+this.y+a,e+this.x+r,t+this.y+a-s),i.moveTo(e+this.x,t+this.y+a),i.quadraticCurveTo(e+this.x+r/2,t+this.y+a,e+this.x+r,t+this.y+a+s),i.stroke()}}class Vr extends Ze{get notationElement(){return G.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.fadeIn}createNewGlyph(e,t){return new Yo}canExpand(e,t){return!0}}class Wr extends De{constructor(e,t,i){super(e,t,1,Wr.getSymbol(i))}static getSymbol(e){switch(e){case Gt.Short:return u.FermataShortAbove;case Gt.Medium:return u.FermataAbove;case Gt.Long:return u.FermataLongAbove;default:return u.None}}doLayout(){this.width=23*this.scale,this.height=12*this.scale}paint(e,t,i){super.paint(e-this.width/2,t+this.height,i)}}class Hr extends Ze{get notationElement(){return G.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.voice.index===0&&!!t.fermata}createNewGlyph(e,t){return new Wr(0,0,t.fermata.type)}canExpand(e,t){return!0}}class pn extends Ze{get notationElement(){return G.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.voice.index!==0||t.isRest||e.notation.fingeringMode!==Ot.SingleNoteEffectBand&&e.notation.fingeringMode!==Ot.SingleNoteEffectBandForcePiano||t.notes.length!==1?!1:t.notes[0].isFingering}createNewGlyph(e,t){let i=Y.Unknown,s=!1,r=t.notes[0];r.leftHandFinger!==Y.Unknown?(i=r.leftHandFinger,s=!0):r.rightHandFinger!==Y.Unknown&&(i=r.rightHandFinger);let a=Be.fingerToString(e.settings,t,i,s)??"";return new dt(0,0,a,e.resources.fingeringFont,V.Left)}canExpand(e,t){return!0}}class Ii extends Ze{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(e,t){this.lastCreateInfo=[];for(let i=0,s=t.notes.length;i<s;i++){let r=t.notes[i];this.shouldCreateGlyphForNote(r)&&this.lastCreateInfo.push(r)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}}class mi extends bs{constructor(e){super(te.OnNotes),this._label=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=te.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.height=this.renderer.resources.effectFont.size}paintNonGrouped(e,t,i){let s=this.renderer.resources;i.font=s.effectFont;let r=i.textAlign;i.textAlign=V.Center,i.fillText(this._label,e+this.x,t+this.y),i.textAlign=r}paintGrouped(e,t,i,s){this.paintNonGrouped(e,t,s);let r=3*this.scale,a=s.measureText(this._label).width,o=e+this.x+a/2+r,h=t+this.y+4*this.scale,l=8*this.scale;if(i>o){let d=o;for(;d<i;)s.beginPath(),s.moveTo(d,h|0),s.lineTo(Math.min(d+l,i),h|0),d+=l+r,s.stroke();s.beginPath(),s.moveTo(i,h-5*this.scale|0),s.lineTo(i,h+5*this.scale|0),s.stroke()}}}mi.LineSpacing=3,mi.LineTopPadding=4,mi.LineTopOffset=5,mi.LineSize=8;class Lt extends Ii{get effectId(){return this._effectId}get notationElement(){return G.EffectHarmonics}constructor(e){switch(super(),this._beat=null,this._harmonicType=e,e){case O.None:this._effectId="harmonics-none";break;case O.Natural:this._effectId="harmonics-natural";break;case O.Artificial:this._effectId="harmonics-artificial";break;case O.Pinch:this._effectId="harmonics-pinch";break;case O.Tap:this._effectId="harmonics-tap";break;case O.Semi:this._effectId="harmonics-semi";break;case O.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId="";break}}shouldCreateGlyphForNote(e){return!e.isHarmonic||e.harmonicType!==this._harmonicType?!1:(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new mi(Lt.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case O.Natural:return"N.H.";case O.Artificial:return"A.H.";case O.Pinch:return"P.H.";case O.Tap:return"T.H.";case O.Semi:return"S.H.";case O.Feedback:return"Fdbk."}return""}}class Gr extends Ze{get notationElement(){return G.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new mi("LetRing")}canExpand(e,t){return!0}}class Xo extends Yt{constructor(e,t,i,s,r=V.Center){super(e,t),this._lines=i,this.font=s,this.textAlign=r}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,i){i.font=this.font;let s=i.textAlign;i.textAlign=this.textAlign;for(let r=0;r<this._lines.length;r++)this._lines[r]&&i.fillText(this._lines[r],e+this.x,t+this.y+r*this.font.size);i.textAlign=s}}class Os extends Ze{get notationElement(){return G.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new Xo(0,0,t.lyrics,e.resources.effectFont,V.Center)}canExpand(e,t){return!0}}class zr extends Ze{get notationElement(){return G.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return ae.SinglePreBeat}shouldCreateGlyph(e,t){return t.voice.bar.staff.index===0&&t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new dt(0,0,t.voice.bar.masterBar.section.marker?"["+t.voice.bar.masterBar.section.marker+"] "+t.voice.bar.masterBar.section.text:t.voice.bar.masterBar.section.text,e.resources.markerFont,V.Left)}canExpand(e,t){return!0}}class qo extends bs{constructor(e,t){super(te.PostNotes),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=13*this.scale}paintNonGrouped(e,t,i){this.paintOttava(e,t,i)}paintOttava(e,t,i){let s=0;switch(this._ottava){case le._15ma:s=37*this.scale,i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,u.QuindicesimaAlta,!1);break;case le._8va:s=26*this.scale,i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,u.OttavaAlta,!1);break;case le._8vb:s=23*this.scale,i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,u.OttavaBassaVb,!1);break;case le._15mb:s=36*this.scale,i.fillMusicFontSymbols(e+this.x-s/2,t+this.y+this.height,.8,[u.Quindicesima,u.OctaveBaselineM,u.OctaveBaselineB],!1);break}return s/2}paintGrouped(e,t,i,s){let r=this.paintOttava(e,t,s),a=3*this.scale,o=e+this.x+r+a,h=t+this.y;h+=this._aboveStaff?2*this.scale:this.height-2*this.scale;let l=8*this.scale;if(i>o){let d=o;for(;d<i;)s.beginPath(),s.moveTo(d,h|0),s.lineTo(Math.min(d+l,i),h|0),d+=l+a,s.stroke();s.beginPath(),this._aboveStaff?(s.moveTo(i,h),s.lineTo(i,t+this.y+this.height)):(s.moveTo(i,h),s.lineTo(i,t+this.y)),s.stroke()}}}class Vs extends Ze{get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get notationElement(){return G.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeat}constructor(e){super(),this._aboveStaff=e}shouldCreateGlyph(e,t){switch(t.ottava){case le._15ma:return this._aboveStaff;case le._8va:return this._aboveStaff;case le._8vb:return!this._aboveStaff;case le._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new qo(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}}class Ur extends Ii{get notationElement(){return G.EffectPalmMute}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new mi("P.M.")}constructor(){super()}}class Yr extends Ii{get notationElement(){return G.EffectPickSlide}shouldCreateGlyphForNote(e){return e.slideOutType===Q.PickSlideDown||e.slideOutType===Q.PickSlideUp}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new mi("P.S.")}constructor(){super()}}class Ss extends De{constructor(e,t,i){super(e,t,$.GraceScale,Ss.getSymbol(i))}doLayout(){this.width=9*this.scale,this.height=13*this.scale}paint(e,t,i){super.paint(e,t+this.height,i)}static getSymbol(e){switch(e){case je.Up:return u.StringsUpBow;case je.Down:return u.StringsDownBow;default:return u.None}}}class Xr extends Ze{get notationElement(){return G.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.pickStroke!==je.None}createNewGlyph(e,t){return new Ss(0,0,t.pickStroke)}canExpand(e,t){return!0}}class gn extends bs{constructor(e){super(te.EndBeat),this._stepSize=0,this._type=e}doLayout(){switch(super.doLayout(),this._type){case oe.Slight:this._stepSize=12*this.scale;break;case oe.Wide:this._stepSize=23*this.scale;break}this.height=18*this.scale}paintGrouped(e,t,i,s){let r=e+this.x,a=i-r,o=Math.max(1,a/this._stepSize);s.beginPath(),s.moveTo(r,t+this.y);for(let h=0;h<o;h++)s.lineTo(r+this._stepSize/2,t+this.y+this.height),s.lineTo(r+this._stepSize,t+this.y),r+=this._stepSize;s.stroke()}}class Ws extends Ze{get notationElement(){return G.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===oe.Slight}createNewGlyph(e,t){return new gn(oe.Slight)}canExpand(e,t){return!0}}class Mi extends bs{constructor(e,t,i,s=1.2,r=!1){super(te.EndBeat),this._scale=0,this._symbol=u.None,this._symbolSize=0,this._type=i,this._scale=s,this.x=e,this.y=t,this._partialWaves=r}doLayout(){super.doLayout();let e=0;switch(this._type){case oe.Slight:this._symbol=u.WiggleTrill,this._symbolSize=9*this._scale,e=6*this._scale;break;case oe.Wide:this._symbol=u.WiggleVibratoMediumFast,this._symbolSize=10*this._scale,e=10*this._scale;break}this.height=e*this.scale}paintGrouped(e,t,i,s){let r=e+this.x,a=i-r,o=this._symbolSize*this.scale,h=a/o;this._partialWaves||(h=Math.floor(h)),h<1&&(h=1);let l=0;for(let d=0;d<h;d++)s.fillMusicFontSymbol(e+this.x+l,t+this.y+this.height*2,this._scale*this.scale,this._symbol,!1),l+=o}}class Hs extends Ii{get notationElement(){return G.EffectSlightNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===oe.Slight||e.isTieDestination&&e.tieOrigin.vibrato===oe.Slight}get sizingMode(){return ae.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Mi(0,0,oe.Slight,1.2)}constructor(){super()}}class mn extends Ze{get notationElement(){return G.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){let i=e.resources;return t.slap?new dt(0,0,"S",i.effectFont,V.Left):t.pop?new dt(0,0,"P",i.effectFont,V.Left):new dt(0,0,"T",i.effectFont,V.Left)}canExpand(e,t){return!0}}class Jo extends Yt{constructor(e){super(0,0),this.tempoAutomations=e}doLayout(){super.doLayout(),this.height=25*this.scale}paint(e,t,i){const s=e+this.x,r=e+this.renderer.postBeatGlyphsStart;for(const a of this.tempoAutomations){const o=e+this.x+(r-s)*a.ratioPosition,h=this.renderer.resources;i.font=h.markerFont,i.fillMusicFontSymbol(o,t+this.y+this.height*.8,this.scale*$.GraceScale,u.NoteQuarterUp,!1),i.textBaseline=J.Top,i.fillText("= "+a.value.toString(),o+this.height/2,t+this.y+i.font.size/2)}}}class qr extends Ze{get notationElement(){return G.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ae.SinglePreBeat}shouldCreateGlyph(e,t){return t.voice.bar.staff.index===0&&t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.tempoAutomations.length>0}createNewGlyph(e,t){return new Jo(t.voice.bar.masterBar.tempoAutomations)}canExpand(e,t){return!0}}class Jr extends Ze{get notationElement(){return G.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new dt(0,0,t.text,e.resources.effectFont,V.Left)}canExpand(e,t){return!0}}class Qo extends Yt{constructor(e,t){super(e,t)}doLayout(){super.doLayout(),this.height=this.renderer.resources.markerFont.size*this.scale}paint(e,t,i){let s=this.renderer.resources;i.font=s.markerFont;let r=i.measureText("tr").width;i.fillText("tr",e+this.x,t+this.y);let a=r+3*this.scale,o=this.width-a,h=1.2,l=11*this.scale*h,d=Math.max(1,(o-a)/l),c=a,f=t+this.y+this.height*1.2;for(let p=0;p<d;p++)i.fillMusicFontSymbol(e+this.x+c,f,h,u.WiggleTrill,!1),c+=l}}class Gs extends Ii{get notationElement(){return G.EffectTrill}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return ae.SingleOnBeat}createNewGlyph(e,t){return new Qo(0,0)}}var Ne;(function(n){n[n.Full=0]="Full",n[n.PartialLeft=1]="PartialLeft",n[n.PartialRight=2]="PartialRight"})(Ne||(Ne={}));class pe extends Yt{constructor(e){super(0,0),this._tripletFeel=e}doLayout(){super.doLayout(),this.height=25*this.scale}paint(e,t,i){e+=this.x,t+=this.y;let s=t+this.height*$.GraceScale;i.font=this.renderer.resources.effectFont,i.fillText("(",e,t+this.height*.3);let r=e+10*this.scale,a=e+40*this.scale;switch(this._tripletFeel){case ee.NoTripletFeel:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full]),this.renderBarNote(a,s,pe.NoteScale,i,[Ne.Full]);break;case ee.Triplet8th:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full]),i.fillMusicFontSymbol(a,s,pe.NoteScale,u.NoteQuarterUp,!1),i.fillMusicFontSymbol(a+pe.NoteSeparation*this.scale,s,pe.NoteScale,u.NoteEighthUp,!1),this.renderTriplet(a,t,i);break;case ee.Triplet16th:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full,Ne.Full]),this.renderBarNote(a,s,pe.NoteScale,i,[Ne.Full,Ne.PartialRight]),this.renderTriplet(a,t,i);break;case ee.Dotted8th:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full]),this.renderBarNote(a,s,pe.NoteScale,i,[Ne.Full,Ne.PartialRight]),i.fillCircle(a+9*this.scale,s,this.scale);break;case ee.Dotted16th:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full,Ne.Full]),this.renderBarNote(a,s,pe.NoteScale,i,[Ne.Full,Ne.Full,Ne.PartialRight]),i.fillCircle(a+9*this.scale,s,this.scale);break;case ee.Scottish8th:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full]),this.renderBarNote(a,s,pe.NoteScale,i,[Ne.Full,Ne.PartialLeft]),i.fillCircle(a+pe.NoteSeparation*this.scale+8*this.scale,s,this.scale);break;case ee.Scottish16th:this.renderBarNote(r,s,pe.NoteScale,i,[Ne.Full,Ne.Full]),this.renderBarNote(a,s,pe.NoteScale,i,[Ne.Full,Ne.Full,Ne.PartialLeft]),i.fillCircle(a+pe.NoteSeparation*this.scale+8*this.scale,s,this.scale);break}i.fillText("=",e+30*this.scale,t+5*this.scale),i.fillText(")",e+65*this.scale,t+this.height*.3)}renderBarNote(e,t,i,s,r){s.fillMusicFontSymbol(e,t,i,u.NoteQuarterUp,!1);let a=pe.NoteSeparation/2*this.scale;for(let o=0;o<r.length;o++)switch(r[o]){case Ne.Full:s.fillRect(e+4*this.scale,t-pe.NoteHeight*this.scale+pe.BarSeparation*this.scale*o,pe.NoteSeparation*this.scale,pe.BarHeight*this.scale);break;case Ne.PartialLeft:s.fillRect(e+4*this.scale,t-pe.NoteHeight*this.scale+pe.BarSeparation*this.scale*o,a,pe.BarHeight*this.scale);break;case Ne.PartialRight:s.fillRect(e+4*this.scale+a,t-pe.NoteHeight*this.scale+pe.BarSeparation*this.scale*o,a,pe.BarHeight*this.scale);break}s.fillMusicFontSymbol(e+pe.NoteSeparation*this.scale,t,i,u.NoteQuarterUp,!1)}renderTriplet(e,t,i){t+=2*this.scale;let s=this.renderer.resources.effectFont;i.font=ne.withFamilyList(s.families,s.size*.8,s.style);let r=e+pe.NoteSeparation*this.scale+3*this.scale;i.beginPath(),i.moveTo(e,t+3*this.scale),i.lineTo(e,t),i.lineTo(e+5*this.scale,t),i.moveTo(r+5*this.scale,t+3*this.scale),i.lineTo(r+5*this.scale,t),i.lineTo(r,t),i.stroke(),i.fillText("3",e+7*this.scale,t-10*this.scale),i.font=s}}pe.NoteScale=.4,pe.NoteHeight=12,pe.NoteSeparation=12,pe.BarHeight=2,pe.BarSeparation=3;class Qr extends Ze{get notationElement(){return G.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ae.SinglePreBeat}shouldCreateGlyph(e,t){return t.index===0&&(t.voice.bar.masterBar.index===0&&t.voice.bar.masterBar.tripletFeel!==ee.NoTripletFeel||t.voice.bar.masterBar.index>0&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new pe(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}}class yn extends Ze{get notationElement(){return G.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.GroupedOnBeat}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new mi("w/bar")}canExpand(e,t){return!0}}class zs extends Ze{get notationElement(){return G.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===oe.Wide}createNewGlyph(e,t){return new gn(oe.Wide)}canExpand(e,t){return!0}}class Us extends Ii{get notationElement(){return G.EffectWideNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===oe.Wide||e.isTieDestination&&e.tieOrigin.vibrato===oe.Wide}get sizingMode(){return ae.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Mi(0,0,oe.Wide,1.2)}}class bn{constructor(){this.x=0,this.width=0,this.masterBars=[]}}class $o extends dn{get name(){return"HorizontalScreen"}constructor(e){super(e),this._system=null,this._pagePadding=null}get supportsResize(){return!1}get firstBarX(){let e=this._pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(){switch(this._pagePadding=this.renderer.settings.display.padding,this.renderer.settings.display.systemsLayoutMode){case Bi.Automatic:this.systemsLayoutMode=Tt.Automatic;break;case Bi.UseModelLayout:this.systemsLayoutMode=Tt.FromModelWithWidths;break}this._pagePadding||(this._pagePadding=[0,0,0,0]),this._pagePadding.length===1?this._pagePadding=[this._pagePadding[0],this._pagePadding[0],this._pagePadding[0],this._pagePadding[0]]:this._pagePadding.length===2&&(this._pagePadding=[this._pagePadding[0],this._pagePadding[1],this._pagePadding[0],this._pagePadding[1]]);let e=this.renderer.score,t=this.renderer.settings.display.startBar;t--,t=Math.min(e.masterBars.length-1,Math.max(0,t));let i=t,s=this.renderer.settings.display.barCount;s<=0&&(s=e.masterBars.length),s=t+s-1,s=Math.min(e.masterBars.length-1,Math.max(0,s)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this._pagePadding[0],this._system.y=this._pagePadding[1];let r=this.renderer.settings.display.barCountPerPartial,a=[],o=new bn,h=0;for(;i<=s;){let d=this._system.addBars(this.renderer.tracks,i);if(d)if(o.masterBars.length===0&&d.isLinkedToPrevious&&a.length>0){let c=a[a.length-1];c.masterBars.push(e.masterBars[i]),c.width+=d.width,h+=d.width,o.x+=h}else o.masterBars.push(e.masterBars[i]),o.width+=d.width,o.masterBars.length>=r&&(a.length===0&&(o.width+=this._system.accoladeWidth+this._pagePadding[0]),h+=o.width,a.push(o),_.debug(this.name,"Finished partial from bar "+o.masterBars[0].index+" to "+o.masterBars[o.masterBars.length-1].index,null),o=new bn,o.x=h);i++}o.masterBars.length>0&&(a.length===0&&(o.width+=this._system.accoladeWidth+this._pagePadding[0]),a.push(o),_.debug(this.name,"Finished partial from bar "+o.masterBars[0].index+" to "+o.masterBars[o.masterBars.length-1].index,null)),this.finalizeStaffSystem(),this.height=Math.floor(this._system.y+this._system.height),this.width=this._system.x+this._system.width+this._pagePadding[2],i=0;let l=0;for(let d=0;d<a.length;d++){const c=a[d],f=new Ri;f.x=l,f.y=0,f.totalWidth=this.width,f.totalHeight=this.height,f.width=c.width,f.height=this.height,f.firstMasterBarIndex=c.masterBars[0].index,f.lastMasterBarIndex=c.masterBars[c.masterBars.length-1].index,l+=c.width;const p=i,g=d;this._system.buildBoundingsLookup(0,0),this.registerPartial(f,b=>{let w=this._system.getBarX(c.masterBars[0].index)+this._system.accoladeWidth;g===0&&(w-=this._system.x+this._system.accoladeWidth),b.color=this.renderer.settings.display.resources.mainGlyphColor,b.textAlign=V.Left,_.debug(this.name,"Rendering partial from bar "+c.masterBars[0].index+" to "+c.masterBars[c.masterBars.length-1].index,null),this._system.paintPartial(-w,this._system.y,b,p,c.masterBars.length)}),i+=c.masterBars.length}this.height=this.layoutAndRenderAnnotation(this.height)+this._pagePadding[3]}finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}}class Ko extends dn{get name(){return"PageView"}constructor(e){super(e),this._systems=[],this._allMasterBarRenderers=[],this._barsFromPreviousSystem=[],this._pagePadding=null}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case Bi.Automatic:this.systemsLayoutMode=Tt.Automatic;break;case Bi.UseModelLayout:this.systemsLayoutMode=Tt.FromModelWithScale;break}this._pagePadding=this.renderer.settings.display.padding,this._pagePadding||(this._pagePadding=[0,0,0,0]),this._pagePadding.length===1?this._pagePadding=[this._pagePadding[0],this._pagePadding[0],this._pagePadding[0],this._pagePadding[0]]:this._pagePadding.length===2&&(this._pagePadding=[this._pagePadding[0],this._pagePadding[1],this._pagePadding[0],this._pagePadding[1]]);let e=this._pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],e=this.layoutAndRenderScoreInfo(e,-1),e=this.layoutAndRenderTunings(e,-1),e=this.layoutAndRenderChordDiagrams(e,-1),e=this.layoutAndRenderScore(e),e=this.layoutAndRenderAnnotation(e),this.height=e+this._pagePadding[3]}get supportsResize(){return!0}get firstBarX(){let e=this._pagePadding[0];return this._systems.length>0&&(e+=this._systems[0].accoladeWidth),e}doResize(){let e=this._pagePadding[1];this.width=this.renderer.width;let t=this.height;e=this.layoutAndRenderScoreInfo(e,t),e=this.layoutAndRenderTunings(e,t),e=this.layoutAndRenderChordDiagrams(e,t),e=this.resizeAndRenderScore(e,t),e=this.layoutAndRenderAnnotation(e),this.height=e+this._pagePadding[3]}layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;let i=this.renderer.settings.display.resources;this.tuningGlyph.x=this._pagePadding[0],this.tuningGlyph.width=this.width,this.tuningGlyph.doLayout();let s=this.tuningGlyph.height;const r=new Ri;return r.x=0,r.y=e,r.width=this.width,r.height=s,r.totalWidth=this.width,r.totalHeight=t<0?e+r.height:t,this.registerPartial(r,a=>{a.color=i.scoreInfoColor,a.textAlign=V.Center,this.tuningGlyph.paint(0,0,a)}),e+s}layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;const i=this.renderer.settings.display.resources;this.chordDiagrams.width=this.width,this.chordDiagrams.doLayout();const s=Math.floor(this.chordDiagrams.height),r=new Ri;return r.x=0,r.y=e,r.width=this.width,r.height=s,r.totalWidth=this.width,r.totalHeight=t<0?e+s:t,this.registerPartial(r,a=>{a.color=i.scoreInfoColor,a.textAlign=V.Center,this.chordDiagrams.paint(0,0,a)}),e+s}layoutAndRenderScoreInfo(e,t=-1){_.debug(this.name,"Layouting score info");const i=new Ri;i.x=0,i.y=e;let s=0,r=this.scale,a=this.renderer.settings.display.resources,o=[G.ScoreTitle,G.ScoreSubTitle,G.ScoreArtist,G.ScoreAlbum,G.ScoreWordsAndMusic];for(let d=0;d<o.length;d++)if(this.scoreInfoGlyphs.has(o[d])){let c=this.scoreInfoGlyphs.get(o[d]);c.x=this.width/2,c.y=s,c.textAlign=V.Center,s+=c.font.size*r}let h=!1,l=0;if(this.scoreInfoGlyphs.has(G.ScoreMusic)){let d=this.scoreInfoGlyphs.get(G.ScoreMusic);d.x=this.width-this._pagePadding[2],d.y=s,d.textAlign=V.Right,h=!0,l=d.font.size*r}if(this.scoreInfoGlyphs.has(G.ScoreWords)){let d=this.scoreInfoGlyphs.get(G.ScoreWords);d.x=this._pagePadding[0],d.y=s,d.textAlign=V.Left,h=!0,l=d.font.size*r}return h&&(s+=l),this.scoreInfoGlyphs.size>0&&(s=Math.floor(s+17*this.scale),i.width=this.width,i.height=s,i.totalWidth=this.width,i.totalHeight=t<0?e+i.height:t,this.registerPartial(i,d=>{d.color=a.scoreInfoColor,d.textAlign=V.Center;for(const c of this.scoreInfoGlyphs.values())c.paint(0,0,d)})),e+s}resizeAndRenderScore(e,t){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode==Tt.FromModelWithScale)for(let s=0;s<this._systems.length;s++){let r=this._systems[s];this.fitSystem(r),e+=this.paintSystem(r,t)}else{this._systems=[];let s=0,r=this.maxWidth,a=this.createEmptyStaffSystem();for(a.index=this._systems.length,a.x=this._pagePadding[0],a.y=e;s<this._allMasterBarRenderers.length;){let o=this._allMasterBarRenderers[s];if(a.width+o.width<=r||a.masterBarsRenderers.length===0)a.addMasterBarRenderers(this.renderer.tracks,o),s++;else{for(;o&&!o.canWrap&&a.masterBarsRenderers.length>1;)o=a.revertLastBar(),s--;a.isFull=!0,a.isLast=this.lastBarIndex===a.lastBarIndex,this._systems.push(a),this.fitSystem(a),e+=this.paintSystem(a,t),a=this.createEmptyStaffSystem(),a.index=this._systems.length,a.x=this._pagePadding[0],a.y=e}}a.isLast=this.lastBarIndex===a.lastBarIndex,this.fitSystem(a),e+=this.paintSystem(a,t)}return e}layoutAndRenderScore(e){let i=this.firstBarIndex,s=this.lastBarIndex;for(this._systems=[];i<=s;){let r=this.createStaffSystem(i,s);this._systems.push(r),r.x=this._pagePadding[0],r.y=e,i=r.lastBarIndex+1,this.fitSystem(r),_.debug(this.name,"Rendering partial from bar "+r.firstBarIndex+" to "+r.lastBarIndex,null),e+=this.paintSystem(r,e)}return e}paintSystem(e,t){let i=Math.floor(e.height);const s=new Ri;return s.x=0,s.y=e.y,s.totalWidth=this.width,s.totalHeight=t,s.width=this.width,s.height=i,s.firstMasterBarIndex=e.firstBarIndex,s.lastMasterBarIndex=e.lastBarIndex,e.buildBoundingsLookup(0,0),this.registerPartial(s,r=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=V.Left,e.paint(0,-s.y,r)}),t+=i,i}fitSystem(e){e.isFull||e.width>this.maxWidth||this.renderer.settings.display.justifyLastSystem?e.scaleToWidth(this.maxWidth):e.scaleToWidth(e.width),e.finalizeSystem()}getBarsPerSystem(e){let t=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode==Tt.FromModelWithScale){let i,s;this.renderer.tracks.length>1?(i=this.renderer.score.defaultSystemsLayout,s=this.renderer.score.systemsLayout):(i=this.renderer.tracks[0].defaultSystemsLayout,s=this.renderer.tracks[0].systemsLayout),t=e<s.length?s[e]:i}return t}createStaffSystem(e,t){let i=this.createEmptyStaffSystem();i.index=this._systems.length;let s=this.getBarsPerSystem(i.index),r=this.maxWidth,a=t+1,o=e;for(;o<a;){if(this._barsFromPreviousSystem.length>0)for(let l of this._barsFromPreviousSystem)i.addMasterBarRenderers(this.renderer.tracks,l),o=l.masterBar.index;else{let l=i.addBars(this.renderer.tracks,o);l&&this._allMasterBarRenderers.push(l)}this._barsFromPreviousSystem=[];let h=!1;if((s===-1&&i.width>=r&&i.masterBarsRenderers.length!==0||i.masterBarsRenderers.length===s+1)&&(h=!0),h){let l=i.revertLastBar();if(l)for(this._barsFromPreviousSystem.push(l);l&&!l.canWrap&&i.masterBarsRenderers.length>1;)l=i.revertLastBar(),l&&this._barsFromPreviousSystem.push(l);return i.isFull=!0,i.isLast=!1,this._barsFromPreviousSystem.reverse(),i}i.x=0,o++}return i.isLast=t===i.lastBarIndex,i}get maxWidth(){return this.renderer.width-this._pagePadding[0]-this._pagePadding[2]}}class ki extends De{constructor(e,t,i,s=!1){super(e,t,s?$.GraceScale:1,ki.getMusicSymbol(i)),this._isGrace=s,this._accidentalType=i}static getMusicSymbol(e){switch(e){case ue.Natural:return u.AccidentalNatural;case ue.Sharp:return u.AccidentalSharp;case ue.Flat:return u.AccidentalFlat;case ue.NaturalQuarterNoteUp:return u.AccidentalQuarterToneNaturalArrowUp;case ue.SharpQuarterNoteUp:return u.AccidentalQuarterToneSharpArrowUp;case ue.FlatQuarterNoteUp:return u.AccidentalQuarterToneFlatArrowUp;case ue.DoubleSharp:return u.AccidentalDoubleSharp;case ue.DoubleFlat:return u.AccidentalDoubleFlat}return u.None}doLayout(){switch(this._accidentalType){case ue.DoubleFlat:this.width=18;break;default:this.width=8;break}this.width=this.width*(this._isGrace?$.GraceScale:1)*this.scale}}class $r extends De{constructor(e,t,i,s){super(e,t,1,$r.getSymbol(i)),this._clef=i,this._clefOttava=s}doLayout(){switch(this._clef){case U.Neutral:this.width=15*this.scale;break;case U.C3:case U.C4:case U.F4:case U.G2:this.width=28*this.scale;break}}static getSymbol(e){switch(e){case U.Neutral:return u.UnpitchedPercussionClef1;case U.C3:return u.CClef;case U.C4:return u.CClef;case U.F4:return u.FClef;case U.G2:return u.GClef;default:return u.None}}paint(e,t,i){super.paint(e,t,i);let s,r=!1;switch(this._clefOttava){case le._15ma:s=new De(-4*this.scale,0,.5,u.Quindicesima),r=!0;break;case le._8va:s=new De(-2*this.scale,0,.5,u.Ottava),r=!0;break;case le._8vb:s=new De(-6*this.scale,0,.5,u.Ottava);break;case le._15mb:s=new De(-8*this.scale,0,.5,u.Quindicesima);break;default:return}let a=0,o=0;switch(this._clef){case U.Neutral:a=r?-12:15,o=0;break;case U.C3:a=r?-19:27,o=0;break;case U.C4:a=r?-19:27,o=0;break;case U.F4:a=r?-9:27,o=-4;break;case U.G2:a=r?-37:30,o=0;break;default:return}s.renderer=this.renderer,s.doLayout();let h=this.width/2;s.paint(e+this.x+h+o*this.scale,t+this.y+a*this.scale,i)}}class Ys extends De{constructor(e,t,i){super(e,t,1,Ys.getSymbol(i))}static getSymbol(e){switch(e){case He.None:return u.None;case He.Normal:return u.ArticAccentAbove;case He.Heavy:return u.ArticMarcatoAbove;default:return u.None}}doLayout(){this.width=9*this.scale,this.height=9*this.scale}paint(e,t,i){super.paint(e-2*this.scale,t+this.height,i)}}class Xs extends Ie{constructor(e,t,i){super(e,t),this._size=0,this._size=i}doLayout(){this.width=this._size+3*this.scale}paint(e,t,i){i.fillCircle(e+this.x,t+this.y,this._size)}}class Zo extends De{constructor(e,t,i){super(e,t,i?$.GraceScale:1,u.NoteheadXOrnate),this._isGrace=i}doLayout(){this.width=9*(this._isGrace?$.GraceScale:1)*this.scale,this.height=$.NoteHeadHeight*this.scale}}class qs extends De{constructor(e,t,i,s){super(e,t,s?$.GraceScale:1,qs.getSymbol(i)),this._isGrace=s}static getSymbol(e){switch(e){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:case m.Half:return u.NoteheadDiamondWhiteWide;default:return u.NoteheadDiamondBlackWide}}doLayout(){this.width=9*(this._isGrace?$.GraceScale:1)*this.scale,this.height=$.NoteHeadHeight*this.scale}}class Qe extends Ie{constructor(e,t,i){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=P.Up,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=t,this.forEnd=i}doLayout(){if(this.width=0,!this.endBeat){this._shouldDraw=!1;return}let e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.startBeat.voice.bar);this.startNoteRenderer=e;let t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.endBeat.voice.bar);this.endNoteRenderer=t,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,t),!this.forEnd&&e?(e!==t?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,!t||e.staff!==t.staff?(this._endX=e.x+e.width,this._endY=this._startY):(this._endX=t.x+this.getEndX(),this._endY=t.y+this.getEndY()+this.yOffset)):(this._startX=e.x+this.getStartX(),this._endX=t.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=t.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):(!e||e.staff!==t.staff)&&(this._startX=t.x,this._endX=t.x+this.getEndX(),this._startY=t.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw&&(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur()?this._tieHeight=0:(this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY),this.height=Qe.calculateActualTieHeight(this.renderer.scale,this._startX,this._startY,this._endX,this._endY,this.tieDirection===P.Down,this._tieHeight,4).h),this.tieDirection===P.Up&&(this.y-=this.height))}paint(e,t,i){this._shouldDraw&&(this.shouldDrawBendSlur()?Qe.drawBendSlur(i,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===P.Down,this.scale):Qe.paintTie(i,this.scale,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===P.Down,this._tieHeight,4))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,i,s){return 22}getBeamDirection(e,t){return P.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,t,i,s,r,a,o,h){const l=Qe.computeBezierControlPoints(e,t,i,s,r,a,o,h);t=l[0],i=l[1];const d=l[2],c=l[3];s=l[6],r=l[7];const f=(t-d)/(t-2*d+s),p=Qe.calculateExtrema(t,i,d,c,s,r,f),g=p.length>0?Math.min(t,s,p[0]):Math.min(t,s),b=p.length>0?Math.max(t,s,p[0]):Math.max(t,s),w=(i-c)/(i-2*c+r),D=Qe.calculateExtrema(t,i,d,c,s,r,w),R=D.length>0?Math.min(i,r,D[1]):Math.min(i,r),B=D.length>0?Math.max(i,r,D[1]):Math.max(i,r),X=new gt;return X.x=g,X.y=R,X.w=b-g,X.h=B-R,X}static calculateExtrema(e,t,i,s,r,a,o){if(o<=0||1<=o)return[];const h=e+(i-e)*o,l=t+(s-t)*o,d=i+(r-i)*o,c=s+(a-s)*o;return[h+(d-h)*o,l+(c-l)*o]}static computeBezierControlPoints(e,t,i,s,r,a,o,h){if(t===s&&i===r)return[];if(s<t){let R=t;t=s,s=R,R=i,i=r,r=R}o*=e,h*=e;let l=r-i,d=s-t,c=Math.sqrt(l*l+d*d);a?l*=-1:d*=-1,l/=c,d/=c;let f=(s+t)/2,p=(r+i)/2,g=f+o*l,b=p+o*d,w=f+(o-h)*l,D=p+(o-h)*d;return[t,i,g,b,w,D,s,r]}static paintTie(e,t,i,s,r,a,o=!1,h=22,l=4){const d=Qe.computeBezierControlPoints(t,i,s,r,a,o,h,l);e.beginPath(),e.moveTo(d[0],d[1]),e.quadraticCurveTo(d[2],d[3],d[6],d[7]),e.quadraticCurveTo(d[4],d[5],d[0],d[1]),e.closePath(),e.fill()}static drawBendSlur(e,t,i,s,r,a,o,h){let l=r-i,d=s-t,c=Math.sqrt(l*l+d*d);a?l*=-1:d*=-1,l/=c,d/=c;let f=(s+t)/2,p=(r+i)/2,g=Qe.BendSlurHeight*o;s-t<20&&(g/=2);let b=f+g*l,w=p+g*d;if(e.beginPath(),e.moveTo(t,i),e.lineTo(b,w),e.lineTo(s,r),e.stroke(),h){let D=e.measureText(h).width,R=a?0:-e.font.size;e.fillText(h,b-D/2,w+R)}}}Qe.BendSlurHeight=11;class Js extends Ie{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=Js.Size*this.scale}paint(e,t,i){this._isOpen?Qe.paintTie(i,this.scale,e+this.x+this.width,t+this.y+this.height,e+this.x+this.width,t+this.y,!1,6,3):Qe.paintTie(i,this.scale,e+this.x,t+this.y,e+this.x,t+this.y+this.height,!1,6,3)}}Js.Size=6;class jo{constructor(e,t){this.line=0,this.line=e,this.isGhost=t}}class Qs extends Ie{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(e){let t=this.renderer,i=t.getNoteLine(e),s=e.isGhost||this.isTiedBend(e)&&t.settings.notation.isNotationElementVisible(G.ParenthesisOnTiedBends);this.addParenthesisOnLine(i,s)}addParenthesisOnLine(e,t){let i=new jo(e,t);this._infos.push(i),t&&(this.isEmpty=!1)}isTiedBend(e){return e.isTieDestination?e.tieOrigin.hasBend?!0:this.isTiedBend(e.tieOrigin):!1}doLayout(){let e=this.renderer;this._infos.sort((s,r)=>s.line-r.line);let t=null,i=e.getScoreHeight(1);for(let s=0,r=this._infos.length;s<r;s++){let a;if(!this._infos[s].isGhost)t=null;else if(!t)a=new Js(this._isOpen),a.renderer=this.renderer,a.y=e.getScoreY(this._infos[s].line)-i,a.height=i*2,a.doLayout(),this._glyphs.push(a),t=a;else{let o=e.getScoreY(this._infos[s].line)+i;t.height=o-t.y}}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,t,i){super.paint(e,t,i);for(let s of this._glyphs)s.paint(e+this.x,t+this.y,i)}}class eh{constructor(e,t){this.line=0,this.glyph=e,this.line=t}}class wn extends Ie{constructor(){super(0,0),this._infos=[],this._noteHeadPadding=0,this.minNote=null,this.maxNote=null,this.spacingChanged=new Je,this.upLineX=0,this.downLineX=0,this.displacedX=0,this.noteStartX=0}add(e,t){let i=new eh(e,t);this._infos.push(i),(!this.minNote||this.minNote.line>i.line)&&(this.minNote=i),(!this.maxNote||this.maxNote.line<i.line)&&(this.maxNote=i)}get hasTopOverflow(){return!!this.minNote&&this.minNote.line<=0}get hasBottomOverflow(){return!!this.maxNote&&this.maxNote.line>8}doLayout(){this._infos.sort((o,h)=>h.line-o.line);let e=0,t=!1,i=0,s=!1,r=this.direction,a=0;for(let o=0,h=this._infos.length;o<h;o++){let l=this._infos[o].glyph;l.renderer=this.renderer,l.doLayout();let d=!1;o===0?e=l.width:Math.abs(i-this._infos[o].line)<=1?t?t=!1:(d=!0,l.x=e,s=!0,t=!0):t=!1,r===P.Down?l.x=d?0:e:l.x=d?e:0,l.x+=this.noteStartX,i=this._infos[o].line,a=Math.max(a,l.x+l.width)}s?(this._noteHeadPadding=0,this.upLineX=e,this.downLineX=e):(this._noteHeadPadding=r===P.Down?-e:0,a+=this._noteHeadPadding,this.upLineX=a,this.downLineX=0),this.displacedX=e,this.width=a}paint(e,t,i){e+=this.x,t+=this.y;let s=this.renderer,r=3*this.scale,a=this.width-this.noteStartX+r*2;if(this.hasTopOverflow){let l=i.color;i.color=s.resources.staffLineColor;let d=-2;for(;d>=this.minNote.line;){let c=t+s.getScoreY(d);i.fillRect(e-r+this.noteStartX,c,a,this.scale),d-=2}i.color=l}if(this.hasBottomOverflow){let l=i.color;i.color=s.resources.staffLineColor;let d=10;for(;d<=this.maxNote.line;){let c=t+s.getScoreY(d);i.fillRect(e-r+this.noteStartX,c,a,this.scale),d+=2}i.color=l}let o=this._infos,h=e+this._noteHeadPadding;for(let l of o)l.glyph.renderer=this.renderer,l.glyph.paint(h,t,i)}}class $s extends De{constructor(e,t,i){super(e,t,1,$s.getSymbol(i))}doLayout(){this.width=12*this.scale}static getSymbol(e){switch(e){case m.ThirtySecond:return u.Tremolo3;case m.Sixteenth:return u.Tremolo2;case m.Eighth:return u.Tremolo1;default:return u.None}}}class th extends wn{constructor(){super(),this._noteGlyphLookup=new Map,this._notes=[],this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}getNoteX(e,t){if(this._noteGlyphLookup.has(e.id)){let i=this._noteGlyphLookup.get(e.id),s=this.x+i.x+this._noteHeadPadding;switch(t){case Te.Left:break;case Te.Center:s+=i.width/2;break;case Te.Right:s+=i.width;break}return s}return 0}getNoteY(e,t){if(this._noteGlyphLookup.has(e.id)){const i=this._noteGlyphLookup.get(e.id);let s=this.y+i.y;switch(t){case A.TopWithStem:s-=this.renderer.getStemSize(this.beamingHelper);break;case A.Top:s-=i.height/2;break;case A.Center:break;case A.Bottom:s+=i.height/2;break;case A.BottomWithStem:s+=this.renderer.getStemSize(this.beamingHelper);break}return s}return 0}addNoteGlyph(e,t,i){super.add(e,i),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();let e=this.direction;for(const t of this.aboveBeatEffects.values())t.renderer=this.renderer,t.doLayout();for(const t of this.belowBeatEffects.values())t.renderer=this.renderer,t.doLayout();if(this.beat.isTremolo){let t=0,i=e===P.Up?this.minNote:this.maxNote,s=e===P.Up?this.displacedX:0,r=this.beat.tremoloSpeed;switch(r){case m.ThirtySecond:t=e===P.Up?-15:15;break;case m.Sixteenth:t=e===P.Up?-12:15;break;case m.Eighth:t=e===P.Up?-10:10;break;default:t=e===P.Up?-10:15;break}this._tremoloPicking=new $s(s,i.glyph.y+t*this.scale,r),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,i){for(let s of this._notes)if(this._noteGlyphLookup.has(s.id)){let r=this._noteGlyphLookup.get(s.id),a=new Ds;a.note=s,a.noteHeadBounds=new gt,a.noteHeadBounds.x=t+this.x+this._noteHeadPadding+r.x,a.noteHeadBounds.y=i+this.y+r.y-r.height/2,a.noteHeadBounds.w=r.width,a.noteHeadBounds.h=r.height,e.addNote(a)}}paint(e,t,i){let s=this.renderer,r=0,a=0,o=1,h=-o;this.beamingHelper.direction===P.Up?(a=s.getScoreY(this.minNote.line),r=s.getScoreY(this.maxNote.line-2)):(a=s.getScoreY(this.maxNote.line-1),r=s.getScoreY(this.minNote.line+1),h*=-1,o*=-1);for(const l of this.aboveBeatEffects.values())r+=h*l.height,l.paint(e+this.x+2*this.scale,t+this.y+r,i);for(const l of this.belowBeatEffects.values())a+=o*l.height,l.paint(e+this.x+2*this.scale,t+this.y+a,i);super.paint(e,t,i),this._tremoloPicking&&this._tremoloPicking.paint(e,t,i)}}class Ai extends De{constructor(e,t,i){super(e,t,1,Ai.getSymbol(i)),this._duration=i}static getSymbol(e){switch(e){case m.QuadrupleWhole:return u.RestLonga;case m.DoubleWhole:return u.RestDoubleWhole;case m.Whole:return u.RestWhole;case m.Half:return u.RestHalf;case m.Quarter:return u.RestQuarter;case m.Eighth:return u.RestEighth;case m.Sixteenth:return u.RestSixteenth;case m.ThirtySecond:return u.RestThirtySecond;case m.SixtyFourth:return u.RestSixtyFourth;case m.OneHundredTwentyEighth:return u.RestOneHundredTwentyEighth;case m.TwoHundredFiftySixth:return u.RestTwoHundredFiftySixth;default:return u.None}}static getSize(e){switch(e){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:case m.Half:case m.Quarter:case m.Eighth:case m.Sixteenth:return 9;case m.ThirtySecond:return 12;case m.SixtyFourth:return 14;case m.OneHundredTwentyEighth:case m.TwoHundredFiftySixth:return 20}return 10}doLayout(){this.width=Ai.getSize(this._duration)*this.scale}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class Sn{constructor(){this.x=0,this.y=-3e3,this.width=0}}class Bn extends Xt{constructor(){super(0,0)}doLayout(){if(!this.glyphs||this.glyphs.length===0){this.width=0;return}this.glyphs.sort((i,s)=>i.y<s.y?-1:i.y>s.y?1:0);let e=[];e.push(new Sn);let t=21*this.scale;for(let i=0,s=this.glyphs.length;i<s;i++){let r=this.glyphs[i];r.renderer=this.renderer,r.doLayout();let a=0;for(;e[a].y>r.y;)a++,a===e.length&&e.push(new Sn);r.x=a,e[a].y=r.y+t,e[a].width<r.width&&(e[a].width=r.width)}this.width=0;for(const i of e)this.width+=i.width,i.x=this.width;for(let i=0,s=this.glyphs.length;i<s;i++){let r=this.glyphs[i];const a=e[r.x];r.x=this.width-a.x}}}class wt extends wn{get direction(){return P.Up}constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new Bn,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,this._showParenthesis=t,t&&(this._preNoteParenthesis=new Qs(!0),this._postNoteParenthesis=new Qs(!1))}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t=!1){let i=this.renderer,s=new $(0,0,m.Quarter,!0),r=i.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),a=i.accidentalHelper.getNoteLineForValue(e,!1);if(s.y=i.getScoreY(a),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(a,!0),this._postNoteParenthesis.addParenthesisOnLine(a,!0)),r!==ue.None){let o=new ki(0,s.y,r,!0);o.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(o)}this._noteValueLookup.set(e,s),this.add(s,a),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+wt.ElementPadding*this.scale),this._accidentals.isEmpty||(e+=this._accidentals.width+wt.ElementPadding*this.scale,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+wt.ElementPadding*this.scale),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+wt.ElementPadding*this.scale,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+wt.ElementPadding*this.scale)}paint(e,t,i){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,i),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,i),this._postNoteParenthesis.paint(e+this.x,t+this.y,i)),super.paint(e,t,i)}}wt.ElementPadding=2;class Kr extends Ie{constructor(){super(...arguments),this.BendNoteHeads=[]}drawBendSlur(e,t,i,s,r,a,o,h){Qe.drawBendSlur(e,t,i,s,r,a,o,h)}doLayout(){super.doLayout(),this.width=0;for(let e of this.BendNoteHeads)e.doLayout(),this.width+=e.width+10*this.scale}getTieDirection(e,t){switch(t.getBeatDirection(e)){case P.Up:return P.Down;default:return P.Up}}}Kr.EndPadding=(10/2|0)+3;class _i extends L{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}}class At extends Ie{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);let t=this.createRenderingPoints(e);this._renderPoints.set(e.id,t),(this._maxBendValue===-1||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let i=0;switch(e.bendType){case M.Bend:i=t[1].value,e.isTieOrigin?(this._bendEndContinuedMinValue===-1||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(this._bendEndMinValue===-1||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case M.Release:i=t[1].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(this._releaseMinValue===-1||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case M.BendRelease:i=t[1].value,(this._bendMiddleMinValue===-1||i<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=i),i=t[2].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(this._releaseMinValue===-1||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case M.Prebend:i=t[0].value,(this._preBendMinValue===-1||i<this._preBendMinValue)&&(this._preBendMinValue=i);break;case M.PrebendBend:i=t[0].value,(this._preBendMinValue===-1||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=t[1].value,e.isTieOrigin?(this._bendEndContinuedMinValue===-1||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(this._bendEndMinValue===-1||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case M.PrebendRelease:i=t[0].value,(this._preBendMinValue===-1||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=t[1].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(this._releaseMinValue===-1||i<this._releaseMinValue)&&(this._releaseMinValue=i);break}}doLayout(){super.doLayout();let e=this._maxBendValue*At.BendValueHeight*this.scale;this.renderer.registerOverflowTop(e);let t=0;for(let i of this._notes){let s=this._renderPoints.get(i.id);switch(i.bendType){case M.Bend:s[1].lineValue=i.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case M.Release:t=i.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t);break;case M.BendRelease:s[1].lineValue=this._bendMiddleMinValue,t=i.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[2].lineValue=t);break;case M.Prebend:s[0].lineValue=this._preBendMinValue;break;case M.PrebendBend:s[0].lineValue=this._preBendMinValue,s[1].lineValue=i.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case M.PrebendRelease:s[0].lineValue=this._preBendMinValue,t=i.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t);break}}this.width=0,this._notes.sort((i,s)=>i.isStringed?i.string-s.string:i.realValue-s.realValue)}createRenderingPoints(e){let t=[];switch(e.bendType){case M.Custom:for(let i of e.bendPoints)t.push(new _i(i.offset,i.value));break;case M.BendRelease:t.push(new _i(0,e.bendPoints[0].value)),t.push(new _i(L.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new _i(L.MaxPosition,e.bendPoints[3].value));break;case M.Bend:case M.Hold:case M.Prebend:case M.PrebendBend:case M.PrebendRelease:case M.Release:t.push(new _i(0,e.bendPoints[0].value)),t.push(new _i(L.MaxPosition,e.bendPoints[1].value));break}return t}paint(e,t,i){let s=i.color;this._notes.length>1&&(i.color=this.renderer.resources.secondaryGlyphColor);for(let r of this._notes){let a=this._renderPoints.get(r.id),o=this.renderer,h=r,l=!1,d=null,c=!1,f=r.bendStyle===me.Gradual?"grad.":"",p=null;for(;h.isTieOrigin;){let B=h.tieDestination;if(d=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,B.beat.voice.bar),!d||o.staff!==d.staff)break;if(h=B,l=!0,h.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes){c=!0;break}}p=h.beat,d=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,p.voice.bar),p.isLastOfVoice&&!h.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(p=null);let g=0,b=0,w=t+o.y;g=e+o.x,a[0].value>0||r.isContinuedBend?g+=o.getBeatX(r.beat,te.MiddleNotes):g+=o.getNoteX(r,Te.Right),!p||p.isLastOfVoice&&!c?b=e+d.x+d.postBeatGlyphsStart:c||!p.nextBeat?b=e+d.x+d.getBeatX(p,te.MiddleNotes):r.bendType===M.Hold?b=e+d.x+d.getBeatX(p.nextBeat,te.OnNotes):b=e+d.x+d.getBeatX(p.nextBeat,te.PreNotes),l||(b-=At.ArrowSize*this.scale);let R=(b-g)/L.MaxPosition;i.beginPath();for(let B=0,X=a.length-1;B<X;B++){let C=a[B],be=a[B+1];B===0&&C.value!==0&&!r.isTieDestination&&this.paintBend(r,new _i(0,0),C,g,w,R,f,i),r.bendType!==M.Prebend?(B===0&&(g+=2*this.scale),this.paintBend(r,C,be,g,w,R,f,i)):r.isTieOrigin&&r.tieDestination.hasBend&&(be=new _i(L.MaxPosition,C.value),be.lineValue=C.lineValue,this.paintBend(r,C,be,g,w,R,f,i))}i.color=s}}paintBend(e,t,i,s,r,a,o,h){let l=this.renderer,d=this.renderer.resources,c=l.lineOffset/2,f=s+a*t.offset,p=At.BendValueHeight*this.scale,g=r-p*t.lineValue;t.value===0?i.offset===t.offset?g+=l.getNoteY(e.beat.maxStringNote,A.Top):g+=l.getNoteY(e,A.Center):g+=c;let b=s+a*i.offset,w=r-p*i.lineValue;i.lineValue===0?w+=l.getNoteY(e,A.Center):w+=c;let D=0,R=At.ArrowSize*this.scale;if(i.value>t.value?(w+R>g&&(w=g-R),h.beginPath(),h.moveTo(b,w),h.lineTo(b-R*.5,w+R),h.lineTo(b+R*.5,w+R),h.closePath(),h.fill(),D=R):i.value!==t.value&&(w<g&&(w=g+R),h.beginPath(),h.moveTo(b,w),h.lineTo(b-R*.5,w-R),h.lineTo(b+R*.5,w-R),h.closePath(),h.fill(),D=-R),h.stroke(),t.value===i.value){if(t.lineValue>0){let B=b,X=At.DashSize*this.scale,C=f+X;if((B-f)/(X*2)<1)h.moveTo(B,g),h.lineTo(f,g);else for(;B>C;)h.moveTo(B,g),h.lineTo(B-X,g),B-=X*2;h.stroke()}}else b>f?(h.moveTo(f,g),h.bezierCurveTo((f+b)/2,g,b,g,b,w+D),h.stroke()):(h.moveTo(f,g),h.lineTo(b,w),h.stroke());if(o&&t.offset<i.offset){h.font=d.graceFont;let B=h.measureText(o).width,X=0,C=0;if(g>w){let be=Math.abs(g-w);X=be>h.font.size*1.3?g-be/2:g,C=(f+b-B)/2}else X=g,C=b-B;h.fillText(o,C,X)}if(i.value!==0&&t.value!==i.value){let B=i.value,X=i.value>t.value;B=Math.abs(B);let C="";if(B===4)C="full",B-=4;else if(B>=4||B<=-4){let be=B/4|0;C+=be,B-=be*4}if(B>0&&(C+=At.getFractionSign(B)),C!==""){w=r-p*i.value;let be=w;X||(be=g+Math.abs(w-g)*1/3),h.font=d.tablatureFont;let Fe=h.measureText(C).width,Pe=be-d.tablatureFont.size*.5-2*this.scale,ge=b-Fe/2;h.fillText(C,ge,Pe)}}}static getFractionSign(e){switch(e){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return e+"/ 4"}}}At.ArrowSize=6,At.DashSize=3,At.BendValueHeight=6;class vt extends Ie{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this.createRenderingPoints(e)}createRenderingPoints(e){if(e.whammyBarType===de.Custom)return e.whammyBarPoints;let t=[];switch(e.whammyBarType){case de.Dive:case de.Hold:case de.PrediveDive:case de.Predive:t.push(new L(0,e.whammyBarPoints[0].value)),t.push(new L(L.MaxPosition,e.whammyBarPoints[1].value));break;case de.Dip:t.push(new L(0,e.whammyBarPoints[0].value)),t.push(new L(L.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new L(L.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value));break}return t}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===Ye.SongBook&&this._beat.whammyBarType===de.Dip;let e=null,t=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!e||e.value>i.minWhammyPoint.value)&&(e=i.minWhammyPoint),(!t||t.value<i.maxWhammyPoint.value)&&(t=i.maxWhammyPoint),i=i.nextBeat;let s=t.value>0?Math.abs(this.getOffset(t.value)):0;(s>0||this._beat.whammyBarPoints[0].value!==0||this.renderer.settings.notation.isNotationElementVisible(G.ZerosOnDiveWhammys))&&(s+=this.renderer.resources.tablatureFont.size*2);let r=e.value<0?Math.abs(this.getOffset(e.value)):0;this.renderer.registerOverflowTop(s+r);let a=this.renderer.staff.getSharedLayoutData(vt.TopOffsetSharedDataKey,-1);s>a&&this.renderer.staff.setSharedLayoutData(vt.TopOffsetSharedDataKey,s)}getOffset(e){if(e===0)return 0;let t=vt.PerHalfSize*this.scale+Math.log2(Math.abs(e)/2)*vt.PerHalfSize*this.scale;return e<0&&(t=-t),t}paint(e,t,i){let s=this.renderer,r=this._beat.nextBeat,a=null,o=te.PreNotes;r&&(a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,r.voice.bar),!a||a.staff!==s.staff||a!==s&&!r.hasWhammyBar?(r=null,a=null):o=r.hasWhammyBar&&(s.settings.notation.notationMode!==Ye.SongBook||r.whammyBarType!==de.Dip)?te.MiddleNotes:te.PreNotes);let h=0,l=0;this._isSimpleDip?(h=e+s.x+s.getBeatX(this._beat,te.OnNotes)-2*this.scale,l=e+s.x+s.getBeatX(this._beat,te.PostNotes)+2*this.scale):(h=e+s.x+s.getBeatX(this._beat,te.MiddleNotes),l=a?e+a.x+a.getBeatX(r,o):e+s.x+s.width-2*this.scale);let d=i.textAlign;if(i.textAlign=V.Center,this._renderPoints.length>=2){let c=(l-h)/L.MaxPosition;i.beginPath();let f=t+this.renderer.staff.getSharedLayoutData(vt.TopOffsetSharedDataKey,0),p=this._beat.whammyStyle===me.Gradual?"grad.":"";for(let g=0,b=this._renderPoints.length-1;g<b;g++){let w=this._renderPoints[g],D=this._renderPoints[g+1],R=g<b-2?this._renderPoints[g+2]:null,B=g===0;g===0&&w.value!==0&&!this._beat.isContinuedWhammy&&(this.paintWhammy(!1,new L(0,0),w,D,h,f,c,i),B=!1),this.paintWhammy(B,w,D,R,h,f,c,i,p),p=""}i.stroke()}i.textAlign=d}paintWhammy(e,t,i,s,r,a,o,h,l){let d=r+o*t.offset,c=r+o*i.offset,f=a-this.getOffset(t.value),p=a-this.getOffset(i.value);if(t.offset===i.offset){let w=vt.DashSize*this.scale;if(Math.abs(p-f)/(w*2)<1)h.moveTo(d,f),h.lineTo(c,p);else{let R=Math.max(f,p),B=Math.min(f,p);for(;R>B;)h.moveTo(d,B),h.lineTo(d,B+w),B+=w*2}h.stroke()}else if(t.value===i.value){let w=vt.DashSize*this.scale;if(Math.abs(c-d)/(w*2)<1)h.moveTo(d,f),h.lineTo(c,p);else{let R=Math.max(d,c),B=Math.min(d,c);for(;R>B;)h.moveTo(R,f),h.lineTo(R-w,f),R-=w*2}h.stroke()}else h.moveTo(d,f),h.lineTo(c,p);let g=this.renderer.resources;if(e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip){let w=f;w-=g.tablatureFont.size+2*this.scale,this.renderer.settings.notation.isNotationElementVisible(G.ZerosOnDiveWhammys)&&h.fillText("0",d,w),l&&(w-=g.tablatureFont.size+2*this.scale,h.fillText(l,d,w))}let b=Math.abs(i.value);if((b!==0||this.renderer.settings.notation.isNotationElementVisible(G.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&t.value!==i.value){let w="";if(i.value<0&&(w+="-"),b>=4){let B=b/4|0;w+=B,b-=B*4}else b===0&&(w+="0");b>0&&(w+=At.getFractionSign(b));let D=0;this._isSimpleDip?D=Math.min(f,p)-g.tablatureFont.size-2*this.scale:(D=t.offset===i.offset?Math.min(f,p):p,D-=g.tablatureFont.size+2*this.scale,s&&s.value>i.value&&(D-=2*this.scale));let R=c;h.fillText(w,R,D)}}}vt.TopOffsetSharedDataKey="tab.whammy.topoffset",vt.PerHalfSize=6,vt.DashSize=3;class Oi extends Kr{constructor(e){super(0,0),this._beat=e}doLayout(){let e=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case de.None:case de.Custom:case de.Hold:return;case de.Dive:case de.PrediveDive:{let t=new wt(this._beat,!1);t.renderer=this.renderer;let i=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let s of this._beat.notes)s.isTieOrigin||t.addGlyph(this.getBendNoteValue(s,i),i.value%2!==0);t.doLayout(),this.BendNoteHeads.push(t)}break;case de.Dip:if(e===Ye.SongBook){let t=this.renderer.resources;this.renderer.simpleWhammyOverflow=t.tablatureFont.size*1.5+Oi.SimpleDipHeight*this.scale+Oi.SimpleDipPadding*this.scale}else{let t=new wt(this._beat,!1);if(t.renderer=this.renderer,this.renderer.settings.notation.notationMode===Ye.GuitarPro){let s=this._beat.whammyBarPoints[1];for(let r of this._beat.notes)t.addGlyph(this.getBendNoteValue(r,this._beat.whammyBarPoints[1]),s.value%2!==0)}t.doLayout(),this.BendNoteHeads.push(t);let i=new wt(this._beat,!1);if(i.renderer=this.renderer,this.renderer.settings.notation.notationMode===Ye.GuitarPro){let s=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let r of this._beat.notes)i.addGlyph(this.getBendNoteValue(r,s),s.value%2!==0)}i.doLayout(),this.BendNoteHeads.push(i)}break;case de.Predive:break}super.doLayout()}paint(e,t,i){let s=this._beat;switch(s.whammyBarType){case de.None:case de.Custom:return}let r=this.renderer.settings.notation.notationMode,a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,s.voice.bar),o=e+a.x+a.getBeatX(s,te.MiddleNotes),h=this.getTieDirection(s,a),l=this._beat.notes.length===1?h:P.Up,d=i.textAlign;for(let c=0;c<s.notes.length;c++){let f=s.notes[c],p=t+a.y;c>0&&c>=(this._beat.notes.length/2|0)&&(l=P.Down),l===P.Down?p+=a.getNoteY(f,A.Bottom):p+=a.getNoteY(f,A.Top);let g=e+a.x;s.isLastOfVoice?g+=a.width:g+=a.getBeatX(s,te.EndBeat),g-=8*this.scale;let b=s.whammyStyle===me.Gradual&&c===0?"grad.":"",w=null;f.isTieOrigin&&(w=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,f.tieDestination.beat.voice.bar),w&&w.staff===a.staff?g=e+w.x+w.getBeatX(f.tieDestination.beat,te.MiddleNotes):w=null);let D=$.NoteHeadHeight*this.scale*$.GraceScale*.5;l===P.Up&&(D=-D);let R=s.whammyBarPoints.length>0?this.getBendNoteValue(f,s.whammyBarPoints[s.whammyBarPoints.length-1]):0,B=0,X=!1;switch(this.BendNoteHeads.length>0&&this.BendNoteHeads[0].containsNoteValue(R)?(B=this.BendNoteHeads[0].getNoteValueY(R)+D,X=!0):w&&(f.isTieOrigin&&f.tieDestination.beat.hasWhammyBar||f.beat.isContinuedWhammy)?(B=t+w.y+w.getNoteY(f.tieDestination,A.Top),X=!0,l===P.Down&&(B+=$.NoteHeadHeight*this.scale)):f.isTieOrigin&&(w?B=t+w.y+w.getNoteY(f.tieDestination,A.Top):B=p,l===P.Down&&(B+=$.NoteHeadHeight*this.scale)),s.whammyBarType){case de.Hold:f.isTieOrigin&&Qe.paintTie(i,this.scale,o,p,g,B,h===P.Down,22,4);break;case de.Dive:c===0&&(this.BendNoteHeads[0].x=g-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=t+a.y,this.BendNoteHeads[0].paint(0,0,i),this.BendNoteHeads[0].containsNoteValue(R)&&(B+=this.BendNoteHeads[0].y)),X?this.drawBendSlur(i,o,p,g,B,l===P.Down,this.scale,b):f.isTieOrigin&&Qe.paintTie(i,this.scale,o,p,g,B,h===P.Down,22,4);break;case de.Dip:if(r===Ye.SongBook){if(c===0){let Fe=e+a.x+a.getBeatX(this._beat,te.OnNotes)-2*this.scale,Pe=e+a.x+a.getBeatX(this._beat,te.PostNotes)+2*this.scale,ge=(Fe+Pe)/2,ct=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();i.font=this.renderer.resources.tablatureFont,i.fillText(ct,ge,t+this.y);let Nt=t+this.y+i.font.size+2*this.scale,si=Nt+Oi.SimpleDipHeight*this.scale;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(i.moveTo(Fe,si),i.lineTo(ge,Nt),i.lineTo(Pe,si)):(i.moveTo(Fe,Nt),i.lineTo(ge,si),i.lineTo(Pe,Nt)),i.stroke()}f.isTieOrigin&&Qe.paintTie(i,this.scale,o,p,g,B,h===P.Down,22,4)}else{let Fe=(o+g)/2;this.BendNoteHeads[0].x=Fe-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=t+a.y,this.BendNoteHeads[0].paint(0,0,i);let Pe=this.getBendNoteValue(f,s.whammyBarPoints[1]),ge=this.BendNoteHeads[0].getNoteValueY(Pe)+D;this.drawBendSlur(i,o,p,Fe,ge,l===P.Down,this.scale,b),this.BendNoteHeads[1].x=g-this.BendNoteHeads[1].noteHeadOffset,this.BendNoteHeads[1].y=t+a.y,this.BendNoteHeads[1].paint(0,0,i),B=this.BendNoteHeads[1].getNoteValueY(R)+D,this.drawBendSlur(i,Fe,ge,g,B,l===P.Down,this.scale,b)}break;case de.PrediveDive:case de.Predive:let C=e+a.x+a.getBeatX(f.beat,te.PreNotes);C+=a.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset;let be=t+a.y+a.getScoreY(a.accidentalHelper.getNoteLineForValue(f.displayValue-(f.beat.whammyBarPoints[0].value/2|0),!1))+D;this.drawBendSlur(i,C,be,o,p,l===P.Down,this.scale,b),this.BendNoteHeads.length>0&&(this.BendNoteHeads[0].x=g-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=t+a.y,this.BendNoteHeads[0].paint(0,0,i),this.drawBendSlur(i,o,p,g,B,l===P.Down,this.scale,b));break}}i.textAlign=d}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}Oi.SimpleDipHeight=vt.PerHalfSize*2,Oi.SimpleDipPadding=2;class St extends Ie{constructor(e,t,i){super(e,t),this.width=i}}class ih extends De{constructor(e,t,i,s,r){super(e,t,r?$.GraceScale:1,i.getSymbol(s)),this._isGrace=r,this._articulation=i}paint(e,t,i){let s=this._isGrace?this.scale:0;i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this.symbol,!1),this._articulation.techniqueSymbol!==u.None&&this._articulation.techniqueSymbolPlacement===J.Middle&&i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this._articulation.techniqueSymbol,!1)}doLayout(){let e=(this._isGrace?$.GraceScale:1)*this.scale;switch(this.symbol){case u.NoteheadWhole:this.width=14;break;case u.NoteheadCircleX:case u.NoteheadDiamondWhite:this.width=9;break;case u.NoteheadHeavyXHat:case u.NoteheadHeavyX:this.width=13;break;default:this.width=10;break}this.width=this.width*(this._isGrace?$.GraceScale:1)*this.scale,this.height=$.NoteHeadHeight*e}}class kn extends De{constructor(e,t){super(e,t,$.GraceScale,u.ArticStaccatoAbove)}doLayout(){this.width=$.QuarterNoteHeadWidth*this.scale,this.height=7*this.scale}paint(e,t,i){super.paint(e+3*this.scale,t+5*this.scale,i)}}class sh extends De{constructor(e,t){super(e,t,.5,u.PictEdgeOfCymbal)}doLayout(){this.width=22*this.scale,this.height=15*this.scale}paint(e,t,i){super.paint(e-3*this.scale,t+this.height,i)}}class rh extends De{constructor(e,t){super(e,t,$.GraceScale,u.GuitarGolpe)}doLayout(){this.width=9*this.scale,this.height=10*this.scale}paint(e,t,i){super.paint(e,t+this.height,i)}}class ah extends ms{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.noteHeads=null,this.restGlyph=null}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,i){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,i+this.y)}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&this._collisionOffset===-1e3)){this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;const e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;e.has(this.container.beat.playbackStart)&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}paint(e,t,i){this._skipPaint||super.paint(e,t,i)}doLayout(){let e=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2)*2;this.container.beat.duration===m.Whole&&this.renderer.bar.staff.standardNotationLineCount!==1&&this.renderer.bar.staff.standardNotationLineCount!==3&&(t-=2);const i=new Ai(0,e.getScoreY(t),this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addGlyph(i),this.renderer.bar.isMultiVoice)if(this.container.beat.voice.index===0){const s=qt.computeLineHeightsForRest(this.container.beat.duration);let r=i.y-e.getScoreHeight(s[0]),a=i.y+e.getScoreHeight(s[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,r,a)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),this.container.beat.dots>0){this.addGlyph(new St(0,0,5*this.scale));for(let s=0;s<this.container.beat.dots;s++){let r=new Xt(0,0);r.renderer=this.renderer,this.createBeatDot(t,r),this.addGlyph(r)}}}else{const t=new th;this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper;let i=new Qs(!1);i.renderer=this.renderer;for(let s of this.container.beat.notes)s.isVisible&&(this.createNoteGlyph(s),i.addParenthesis(s));if(this.addGlyph(t),i.isEmpty||(this.addGlyph(new St(0,0,4*(this.container.beat.graceType!==W.None?$.GraceScale:1)*this.scale)),this.addGlyph(i)),this.container.beat.hasWhammyBar){let s=new Oi(this.container.beat);s.renderer=this.renderer,s.doLayout(),this.container.ties.push(s)}if(this.container.beat.dots>0){this.addGlyph(new St(0,0,5*this.scale));for(let s=0;s<this.container.beat.dots;s++){let r=new Xt(0,0);r.renderer=this.renderer;for(let a of this.container.beat.notes)this.createBeatDot(e.getNoteLine(a),r);this.addGlyph(r)}}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteHeads.x+this.noteHeads.width/2}createBeatDot(e,t){let i=this.renderer;t.addGlyph(new Xs(0,i.getScoreY(e),1.5*this.scale))}createNoteHeadGlyph(e){let t=this.container.beat.graceType!==W.None;if(e.beat.voice.bar.staff.isPercussion){const i=Ae.getArticulation(e);if(i)return new ih(0,0,i,e.beat.duration,t);_.warning("Rendering",`No articulation found for percussion instrument ${e.percussionArticulation}`)}return e.isDead?new Zo(0,0,t):e.beat.graceType===W.BendGrace?new $(0,0,m.Quarter,!0):e.harmonicType===O.Natural?new qs(0,0,e.beat.duration,t):new $(0,0,e.beat.duration,t)}createNoteGlyph(e){if(e.beat.graceType===W.BendGrace&&!e.hasBend)return;let t=this.renderer,i=this.createNoteHeadGlyph(e),s=t.getNoteLine(e);if(i.y=t.getScoreY(s),this.noteHeads.addNoteGlyph(i,e,s),e.harmonicType!==O.None&&e.harmonicType!==O.Natural){let r=e.displayValue+e.harmonicPitch;i=new qs(0,0,e.beat.duration,this.container.beat.graceType!==W.None),s=t.accidentalHelper.getNoteLineForValue(r,!1),i.y=t.getScoreY(s),this.noteHeads.addNoteGlyph(i,e,s)}if(e.isStaccato&&!this.noteHeads.aboveBeatEffects.has("Staccato")&&this.noteHeads.belowBeatEffects.set("Staccato",new kn(0,0)),e.accentuated===He.Normal&&!this.noteHeads.aboveBeatEffects.has("Accent")&&this.noteHeads.belowBeatEffects.set("Accent",new Ys(0,0,He.Normal)),e.accentuated===He.Heavy&&!this.noteHeads.aboveBeatEffects.has("HAccent")&&this.noteHeads.belowBeatEffects.set("HAccent",new Ys(0,0,He.Heavy)),e.isPercussion){const r=Ae.getArticulation(e);if(r&&r.techniqueSymbolPlacement!==J.Middle){const a=r.techniqueSymbolPlacement===J.Top?this.noteHeads.aboveBeatEffects:this.noteHeads.belowBeatEffects;switch(r.techniqueSymbol){case u.PictEdgeOfCymbal:a.set("PictEdgeOfCymbal",new sh(0,0));break;case u.ArticStaccatoAbove:a.set("ArticStaccatoAbove",new kn(0,0));break;case u.StringsUpBow:a.set("StringsUpBow",new Ss(0,0,je.Up));break;case u.StringsDownBow:a.set("StringsDownBow",new Ss(0,0,je.Down));break;case u.GuitarGolpe:a.set("GuitarGolpe",new rh(0,0));break}}}}}class nh extends Ie{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=this._beat.brushType===Se.ArpeggioUp||this._beat.brushType===Se.ArpeggioDown?10*this.scale:0}paint(e,t,i){if(this._beat.brushType===Se.ArpeggioUp||this._beat.brushType===Se.ArpeggioDown){let s=this.renderer,r=s.lineOffset,a=t+this.y+(s.getNoteY(this._beat.maxNote,A.Bottom)-r),o=t+this.y+s.getNoteY(this._beat.minNote,A.Top)+r,h=e+this.x+this.width/2,l=8*this.scale,d=new Mi(0,0,oe.Slight,1.2,!0);d.renderer=this.renderer,d.doLayout();let c=-d.height/2;if(this._beat.brushType===Se.ArpeggioUp){let f=a+l,p=o-l;d.width=Math.abs(p-f),i.beginRotate(e+this.x+5*this.scale,p,-90),d.paint(0,c,i),i.endRotate(),i.beginPath(),i.moveTo(h,o),i.lineTo(h+l/2,o-l),i.lineTo(h-l/2,o-l),i.closePath(),i.fill()}else if(this._beat.brushType===Se.ArpeggioDown){let f=a+l,p=o;d.width=Math.abs(p-f),i.beginRotate(e+this.x+5*this.scale,f,90),d.paint(0,c,i),i.endRotate(),i.beginPath(),i.moveTo(h,a),i.lineTo(h+l/2,a+l),i.lineTo(h-l/2,a+l),i.closePath(),i.fill()}}}}class oh extends gs{get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}doLayout(){if(!this.container.beat.isRest){let e=new Bn;e.renderer=this.renderer;let t=new Qs(!0);t.renderer=this.renderer;const i=new wt(this.container.beat,!0);this._prebends=i,i.renderer=this.renderer;for(let s of this.container.beat.notes)if(s.isVisible){if(s.hasBend)switch(s.bendType){case M.PrebendBend:case M.Prebend:case M.PrebendRelease:i.addGlyph(s.displayValue-(s.bendPoints[0].value/2|0),!1);break}else if(s.beat.hasWhammyBar)switch(s.beat.whammyBarType){case de.PrediveDive:case de.Predive:this._prebends.addGlyph(s.displayValue-(s.beat.whammyBarPoints[0].value/2|0),!1);break}this.createAccidentalGlyph(s,e),t.addParenthesis(s)}i.isEmpty||(this.addGlyph(i),this.addGlyph(new St(0,0,4*(this.container.beat.graceType!==W.None?$.GraceScale:1)*this.scale))),this.container.beat.brushType!==Se.None&&(this.addGlyph(new nh(this.container.beat)),this.addGlyph(new St(0,0,4*this.scale))),t.isEmpty||(this.addGlyph(t),this.addGlyph(new St(0,0,4*(this.container.beat.graceType!==W.None?$.GraceScale:1)*this.scale))),e.isEmpty||(this.accidentals=e,this.addGlyph(new St(0,0,2*(this.container.beat.graceType!==W.None?$.GraceScale:1)*this.scale)),this.addGlyph(e),this.addGlyph(new St(0,0,2*(this.container.beat.graceType!==W.None?$.GraceScale:1)*this.scale)))}super.doLayout()}createAccidentalGlyph(e,t){let i=this.renderer,s=i.accidentalHelper.applyAccidental(e),r=i.getNoteLine(e),a=this.container.beat.graceType!==W.None;if(s!==ue.None){let o=new ki(0,i.getScoreY(r),s,a);o.renderer=this.renderer,t.addGlyph(o)}if(e.harmonicType!==O.None&&e.harmonicType!==O.Natural){let o=e.displayValue+e.harmonicPitch;s=i.accidentalHelper.applyAccidentalForValue(e.beat,o,a,!1),r=i.accidentalHelper.getNoteLineForValue(o,!1);let h=new ki(0,i.getScoreY(r),s,a);h.renderer=this.renderer,t.addGlyph(h)}}constructor(){super(),this._prebends=null,this.accidentals=null}}class Zr extends De{constructor(e,t,i,s){super(e,t,s,Zr.getSymbol(i)),this._digit=0,this._scale=0,this._digit=i,this._scale=s}doLayout(){this.width=this.getDigitWidth(this._digit)*this.scale*this._scale}getDigitWidth(e){switch(e){case 0:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:return 14;case 1:return 10;default:return 0}}static getSymbol(e){switch(e){case 0:return u.TimeSig0;case 1:return u.TimeSig1;case 2:return u.TimeSig2;case 3:return u.TimeSig3;case 4:return u.TimeSig4;case 5:return u.TimeSig5;case 6:return u.TimeSig6;case 7:return u.TimeSig7;case 8:return u.TimeSig8;case 9:return u.TimeSig9;default:return u.None}}}class Ks extends Xt{constructor(e,t,i,s=1){super(e,t),this._number=0,this._scale=0,this._number=i,this._scale=s}doLayout(){let e=this._number;for(;e>0;){let t=e%10,i=new Zr(0,0,t,this._scale);this.addGlyph(i),e=e/10|0}if(this.glyphs){this.glyphs.reverse();let t=0;for(let i=0,s=this.glyphs.length;i<s;i++){let r=this.glyphs[i];r.x=t,r.y=0,r.renderer=this.renderer,r.doLayout(),t+=r.width}this.width=t}}}Ks.numberHeight=18;class _n extends Xt{constructor(e,t,i,s,r){super(e,t),this._numerator=0,this._denominator=0,this._numerator=i,this._denominator=s,this._isCommon=r}doLayout(){if(this._isCommon&&this._numerator===2&&this._denominator===2){let e=new De(0,0,this.commonScale,u.TimeSigCutCommon);e.width=14*this.scale,this.addGlyph(e),super.doLayout()}else if(this._isCommon&&this._numerator===4&&this._denominator===4){let e=new De(0,0,this.commonScale,u.TimeSigCommon);e.width=14*this.scale,this.addGlyph(e),super.doLayout()}else{const e=Ks.numberHeight*this.scale;let t=new Ks(0,-e/2,this._numerator,this.numberScale),i=new Ks(0,e/2,this._denominator,this.numberScale);this.addGlyph(t),this.addGlyph(i),super.doLayout();for(let s=0,r=this.glyphs.length;s<r;s++){let a=this.glyphs[s];a.x=(this.width-a.width)/2}}}}class hh extends _n{get commonScale(){return 1}get numberScale(){return 1}}class lh extends Kr{constructor(e){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(e){if(this._notes.push(e),!e.isTieOrigin)switch(e.bendType){case M.Bend:case M.PrebendRelease:case M.PrebendBend:{let t=this._endNoteGlyph;t||(t=new wt(e.beat,!1),t.renderer=this.renderer,this._endNoteGlyph=t,this.BendNoteHeads.push(t));let i=e.bendPoints[e.bendPoints.length-1];t.addGlyph(this.getBendNoteValue(e,i),i.value%2!==0)}break;case M.Release:if(!e.isTieOrigin){let t=this._endNoteGlyph;t||(t=new wt(e.beat,!1),t.renderer=this.renderer,this._endNoteGlyph=t,this.BendNoteHeads.push(t));let i=e.bendPoints[e.bendPoints.length-1];t.addGlyph(this.getBendNoteValue(e,i),i.value%2!==0)}break;case M.BendRelease:{let t=this._middleNoteGlyph;t||(t=new wt(e.beat,!1),this._middleNoteGlyph=t,t.renderer=this.renderer,this.BendNoteHeads.push(t));let i=e.bendPoints[1];t.addGlyph(this.getBendNoteValue(e,e.bendPoints[1]),i.value%2!==0);let s=this._endNoteGlyph;s||(s=new wt(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.BendNoteHeads.push(s));let r=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this.getBendNoteValue(e,r),r.value%2!==0)}break}}paint(e,t,i){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._beat.voice.bar),r=e+s.x+s.getBeatX(this._beat,te.MiddleNotes),a=e+s.x;this._beat.isLastOfVoice?a+=s.postBeatGlyphsStart:a+=s.getBeatX(this._beat.nextBeat,te.PreNotes),a-=8*this.scale;let o=(r+a)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=o-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=t+s.y,this._middleNoteGlyph.paint(0,0,i)),this._endNoteGlyph&&(this._endNoteGlyph.x=a-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=t+s.y,this._endNoteGlyph.paint(0,0,i)),this._notes.sort((d,c)=>c.displayValue-d.displayValue);let h=this._beat.graceType===W.BendGrace?this._beat.nextBeat:this._beat,l=this._notes.length===1?this.getTieDirection(h,s):P.Up;for(let d=0;d<this._notes.length;d++){let c=this._notes[d];d>0&&d>=(this._notes.length/2|0)&&(l=P.Down);let f=t+s.y+s.getNoteY(c,A.Top),p=$.NoteHeadHeight*this.scale*$.GraceScale*.5;l===P.Down&&(f+=$.NoteHeadHeight*this.scale);let g=c.bendStyle===me.Gradual?"grad.":"";if(c.isTieOrigin){let b=c.tieDestination,w=b?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,b.beat.voice.bar):null;if(!w||w.staff!==s.staff){let D=e+s.x+s.width,R=c.tieDestination.realValue;s.accidentalHelper.applyAccidentalForValue(c.beat,R,!1,!0);let B=t+s.y+s.getScoreY(s.accidentalHelper.getNoteLineForValue(R,!1));c.bendType===M.Hold||c.bendType===M.Prebend?Qe.paintTie(i,this.scale,r,f,D,B,l===P.Down,22,4):this.drawBendSlur(i,r,f,D,B,l===P.Down,this.scale,g)}else{let D=e+w.x+w.getBeatX(b.beat,te.MiddleNotes),R=t+w.y+w.getNoteY(b,A.Top);l===P.Down&&(R+=$.NoteHeadHeight*this.scale),c.bendType===M.Hold||c.bendType===M.Prebend?Qe.paintTie(i,this.scale,r,f,D,R,l===P.Down,22,4):this.drawBendSlur(i,r,f,D,R,l===P.Down,this.scale,g)}switch(c.bendType){case M.Prebend:case M.PrebendBend:case M.PrebendRelease:let D=e+s.x+s.getBeatX(c.beat,te.PreNotes);D+=s.getPreNotesGlyphForBeat(c.beat).prebendNoteHeadOffset;let R=t+s.y+s.getScoreY(s.accidentalHelper.getNoteLineForValue(c.displayValue-(c.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(i,D,R,r,f,l===P.Down,this.scale);break}}else{l===P.Up&&(p=-p);let b=0,w=0;switch(c.bendType){case M.Bend:b=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),w=this._endNoteGlyph.getNoteValueY(b)+p,this.drawBendSlur(i,r,f,a,w,l===P.Down,this.scale,g);break;case M.BendRelease:let D=this.getBendNoteValue(c,c.bendPoints[1]),R=this._middleNoteGlyph.getNoteValueY(D)+p;this.drawBendSlur(i,r,f,o,R,l===P.Down,this.scale,g),b=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),w=this._endNoteGlyph.getNoteValueY(b)+p,this.drawBendSlur(i,o,R,a,w,l===P.Down,this.scale,g);break;case M.Release:this.BendNoteHeads.length>0&&(b=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),w=this.BendNoteHeads[0].getNoteValueY(b)+p,this.drawBendSlur(i,r,f,a,w,l===P.Down,this.scale,g));break;case M.Prebend:case M.PrebendBend:case M.PrebendRelease:let B=e+s.x+s.getBeatX(c.beat,te.PreNotes);B+=s.getPreNotesGlyphForBeat(c.beat).prebendNoteHeadOffset;let X=t+s.y+s.getScoreY(s.accidentalHelper.getNoteLineForValue(c.displayValue-(c.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(i,B,X,r,f,l===P.Down,this.scale),this.BendNoteHeads.length>0&&(b=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),w=this.BendNoteHeads[0].getNoteValueY(b)+p,this.drawBendSlur(i,r,f,a,w,l===P.Down,this.scale,g));break}}}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class jr extends Qe{constructor(e,t,i=!1){super(e,t,i)}doLayout(){super.doLayout()}getBeamDirection(e,t){if(e.isRest)return P.Up;switch(t.getBeatDirection(e)){case P.Up:return P.Down;default:return P.Up}}getStartY(){if(this.startBeat.isRest)return this.startNoteRenderer.getScoreY(9);switch(this.tieDirection){case P.Up:return this.startNoteRenderer.getNoteY(this.startBeat.maxNote,A.Top);default:return this.startNoteRenderer.getNoteY(this.startBeat.minNote,A.Bottom)}}getEndY(){const e=this.endNoteRenderer;if(this.endBeat.isRest)switch(this.tieDirection){case P.Up:return e.getScoreY(9);default:return e.getScoreY(0)}const t=this.startNoteRenderer.getBeatDirection(this.startBeat),i=e.getBeatDirection(this.endBeat);if(t!==i&&this.startBeat.graceType===W.None)if(i===this.tieDirection)switch(this.tieDirection){case P.Up:return e.getNoteY(this.endBeat.maxNote,A.TopWithStem);default:return e.getNoteY(this.endBeat.minNote,A.BottomWithStem)}else switch(this.tieDirection){case P.Up:return e.getNoteY(this.endBeat.maxNote,A.BottomWithStem);default:return e.getNoteY(this.endBeat.minNote,A.TopWithStem)}switch(this.tieDirection){case P.Up:return e.getNoteY(this.endBeat.maxNote,A.Top);default:return e.getNoteY(this.endBeat.minNote,A.Bottom)}}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,te.MiddleNotes)}getEndX(){const e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>m.Whole&&e===this.tieDirection?te.Stem:te.MiddleNotes)}}class dh extends Ie{constructor(e,t,i,s){super(0,0),this._outType=t,this._inType=e,this._startNote=i,this._parent=s}doLayout(){this.width=0}paint(e,t,i){this.paintSlideIn(e,t,i),this.drawSlideOut(e,t,i)}paintSlideIn(e,t,i){let s=this.renderer,r=12*this.scale,a=e+s.x+s.getNoteX(this._startNote,Te.Left)-2*this.scale,o=t+s.y+s.getNoteY(this._startNote,A.Center),h=a-r,l=t+s.y;switch(this._inType){case $e.IntoFromBelow:l+=s.getNoteY(this._startNote,A.Bottom);break;case $e.IntoFromAbove:l+=s.getNoteY(this._startNote,A.Top);break;default:return}let d=this.getAccidentalsWidth(s,this._startNote.beat);h-=d,a-=d,this.paintSlideLine(i,!1,h,a,l,o)}getAccidentalsWidth(e,t){let i=e.getPreNotesGlyphForBeat(t);return i&&i.accidentals?i.accidentals.width:0}drawSlideOut(e,t,i){let s=this.renderer,r=12*this.scale,a=1*this.scale,o=2*this.scale,h=0,l=0,d=0,c=0,f=!1;switch(this._outType){case Q.Shift:case Q.Legato:if(h=e+s.x+s.getBeatX(this._startNote.beat,te.PostNotes),l=t+s.y+s.getNoteY(this._startNote,A.Center),this._startNote.slideTarget){let p=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._startNote.slideTarget.beat.voice.bar);!p||p.staff!==s.staff?(d=e+s.x+s.width,c=l):(d=e+p.x+p.getBeatX(this._startNote.slideTarget.beat,te.PreNotes)-a,c=t+p.y+p.getNoteY(this._startNote.slideTarget,A.Center)),this._startNote.slideTarget.realValue>this._startNote.realValue?(l+=o,c-=o):(l-=o,c+=o)}else d=e+s.x+this._parent.x,c=l;break;case Q.OutUp:h=e+s.x+s.getNoteX(this._startNote,Te.Right),l=t+s.y+s.getNoteY(this._startNote,A.Center),d=h+r,c=t+s.y+s.getNoteY(this._startNote,A.Top);break;case Q.OutDown:h=e+s.x+s.getNoteX(this._startNote,Te.Right),l=t+s.y+s.getNoteY(this._startNote,A.Center),d=h+r,c=t+s.y+s.getNoteY(this._startNote,A.Bottom);break;case Q.PickSlideUp:h=e+s.x+s.getNoteX(this._startNote,Te.Right),l=t+s.y+s.getNoteY(this._startNote,A.Center),c=t+s.y+s.getNoteY(this._startNote,A.Top),d=e+s.x+s.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=e+s.x+s.getBeatX(this._startNote.beat.nextBeat,te.PreNotes)),f=!0;break;case Q.PickSlideDown:h=e+s.x+s.getNoteX(this._startNote,Te.Right),l=t+s.y+s.getNoteY(this._startNote,A.Center),c=t+s.y+s.getNoteY(this._startNote,A.Bottom),d=e+s.x+s.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=e+s.x+s.getBeatX(this._startNote.beat.nextBeat,te.PreNotes)),f=!0;break;default:return}this.paintSlideLine(i,f,h,d,l,c)}paintSlideLine(e,t,i,s,r,a){if(t){let o=new Mi(0,0,oe.Slight,1.2);o.renderer=this.renderer,o.doLayout(),r-=o.height/2,a-=o.height/2;let h=s-i,l=a-r,d=Math.sqrt(Math.pow(l,2)+Math.pow(h,2));o.width=h;let c=Math.asin(l/d)*(180/Math.PI);e.beginRotate(i,r,c),o.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(i,r),e.lineTo(s,a),e.stroke()}}class Zs extends jr{constructor(e,t,i=!1){super(e.beat,t.beat,i),this._startNote=e,this._endNote=t}getTieHeight(e,t,i,s){return Math.log2(i-e+1)*this.renderer.settings.notation.slurHeight}getStartY(){if(this.isStartCentered())switch(this.tieDirection){case P.Up:return this.startNoteRenderer.getNoteY(this._startNote,A.Top);default:return this.startNoteRenderer.getNoteY(this._startNote,A.Bottom)}return this.startNoteRenderer.getNoteY(this._startNote,A.Center)}getEndY(){if(this.isEndCentered())if(this.isEndOnStem())switch(this.tieDirection){case P.Up:return this.endNoteRenderer.getNoteY(this._endNote,A.TopWithStem);default:return this.endNoteRenderer.getNoteY(this._endNote,A.BottomWithStem)}else switch(this.tieDirection){case P.Up:return this.endNoteRenderer.getNoteY(this._endNote,A.Top);default:return this.endNoteRenderer.getNoteY(this._endNote,A.Bottom)}else return this.endNoteRenderer.getNoteY(this._endNote,A.Center)}isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&this.tieDirection===P.Up||this._startNote===this._startNote.beat.minNote&&this.tieDirection===P.Down}isEndCentered(){return this._startNote.beat.graceType===W.None&&(this._endNote===this._endNote.beat.maxNote&&this.tieDirection===P.Up||this._endNote===this._endNote.beat.minNote&&this.tieDirection===P.Down)}isEndOnStem(){const e=this.endNoteRenderer,t=this.startNoteRenderer.getBeatDirection(this.startBeat),i=e.getBeatDirection(this.endBeat);return t!==i&&this.startBeat.graceType===W.None}getStartX(){return this.isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,te.MiddleNotes):this.startNoteRenderer.getNoteX(this._startNote,Te.Right)}getEndX(){return this.isEndCentered()?this.isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,te.Stem):this.endNoteRenderer.getNoteX(this._endNote,Te.Center):this.endNoteRenderer.getBeatX(this._endNote.beat,te.PreNotes)}}class Tn extends Qe{constructor(e,t,i=!1){super(e?e.beat:null,t?t.beat:null,i),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){switch(t.getBeatDirection(e)){case P.Up:return P.Down;default:return P.Up}}getStartY(){if(this.startBeat.isRest)return this.startNoteRenderer.getScoreY(9);switch(this.tieDirection){case P.Up:return this.startNoteRenderer.getNoteY(this.startNote,A.Top);default:return this.startNoteRenderer.getNoteY(this.startNote,A.Bottom)}}getEndY(){const e=this.endNoteRenderer;if(this.endBeat.isRest)switch(this.tieDirection){case P.Up:return e.getScoreY(9);default:return e.getScoreY(0)}switch(this.tieDirection){case P.Up:return e.getNoteY(this.endNote,A.Top);default:return e.getNoteY(this.endNote,A.Bottom)}}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,te.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,te.PreNotes)}}class ch extends It{constructor(e,t){super(e,t),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){if(this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new jr(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new jr(e,this.beat,!0))}this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==W.BendGrace&&e.tieDestination&&e.tieDestination.isVisible){let t=new Tn(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){let t=new Tn(e.tieOrigin,e,!0);this.addTie(t)}if(e.slideInType!==$e.None||e.slideOutType!==Q.None){let t=new dh(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){let t=new Zs(e,e.slurDestination,!1);this.addTie(t)}if(e.isSlurDestination){let t=new Zs(e.slurOrigin,e,!0);this.addTie(t)}if(!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination){const t=new Zs(e,e.effectSlurDestination,!1);this._effectSlur=t,this.addTie(t)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){let t=this.onNotes.beamingHelper.direction,i=t===P.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,s=t===P.Up?e.beat.minNote:e.beat.maxNote;const r=new Zs(i,s,!0);this._effectEndSlur=r,this.addTie(r)}if(e.hasBend){if(!this._bend){const t=new lh(e.beat);this._bend=t,t.renderer=this.renderer,this.addTie(t)}this._bend.addBends(e)}}}}class uh extends Ie{constructor(e,t,i,s){super(e,t),this._dotOffset=0,this._circleSize=0,this._dotOffset=0,this._circleSize=0,this._dotOffset=s,this._circleSize=i}doLayout(){this.width=13*this.scale}paint(e,t,i){let s=4*this.scale,r=t+this.y+this.renderer.topPadding,a=t+this.y+this.renderer.height-this.renderer.bottomPadding,o=e+this.x+.5,h=a-r;i.fillRect(o,r,s,h),o+=s*2-.5,i.beginPath(),i.moveTo(o,r),i.lineTo(o,a),i.stroke(),o+=3*this.scale;let l=this._circleSize*this.scale,d=(r+a)/2;i.fillCircle(o,d-l*this._dotOffset,l),i.fillCircle(o,d+l*this._dotOffset,l)}}class fh extends Ie{constructor(e,t){super(e,t)}doLayout(){this.renderer.isLast?this.width=15*this.scale:!this.renderer.nextRenderer||this.renderer.nextRenderer.staff!==this.renderer.staff||!this.renderer.nextRenderer.bar.masterBar.isRepeatStart?(this.width=2*this.scale,this.renderer.bar.masterBar.isDoubleBar&&(this.width+=2*this.scale)):this.width=2*this.scale}paint(e,t,i){let s=4*this.scale,r=t+this.y+this.renderer.topPadding,a=t+this.y+this.renderer.height-this.renderer.bottomPadding,o=e+this.x,h=a-r;this.renderer.isLast?(i.fillRect(o+this.width-s-s,r,this.scale,h),i.fillRect(o+this.width-s,r,s,h)):(!this.renderer.nextRenderer||this.renderer.nextRenderer.staff!==this.renderer.staff||!this.renderer.nextRenderer.bar.masterBar.isRepeatStart)&&(i.fillRect(o+this.width-this.scale,r,this.scale,h),this.renderer.bar.masterBar.isDoubleBar&&i.fillRect(o+this.width-5*this.scale,r,this.scale,h))}}class ph extends Ie{constructor(e,t){super(e,t)}doLayout(){this.width=11*this.scale}paint(e,t,i){let s=4*this.scale,r=t+this.y+this.renderer.topPadding,a=t+this.y+this.renderer.height-this.renderer.bottomPadding,o=e+this.x,h=a-r,l=1.5*this.scale,d=(r+a)/2,c=3;i.fillCircle(o,d-l*c,l),i.fillCircle(o,d+l*c,l),o+=4*this.scale,i.beginPath(),i.moveTo(o,r),i.lineTo(o,a),i.stroke(),o+=3*this.scale+.5,i.fillRect(o,r,s,h)}}class gh extends Ie{constructor(e,t,i){super(e,t),this._count=0,this._count=0,this._count=i}doLayout(){this.width=0}paint(e,t,i){let s=this.renderer.resources,r=i.textAlign;i.font=s.barNumberFont,i.textAlign=V.Right;let a="x"+this._count,o=i.measureText(a).width/1.5;i.fillText(a,e+this.x-o,t+this.y),i.textAlign=r}}class mh extends Ie{constructor(e,t,i){super(e,t),this._number=0,this._number=i}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number.toString()).width+5*this.scale}paint(e,t,i){if(!this.renderer.staff.isFirstInAccolade)return;let s=this.renderer.resources,r=i.color;const a=i.textBaseline;i.textBaseline=J.Top,i.color=s.barNumberColor,i.font=s.barNumberFont,i.fillText(this._number.toString(),e+this.x,t+this.y),i.color=r,i.textBaseline=a}}class $i extends Le{constructor(e,t){super(e,t),this.firstLineY=0,this._startSpacing=!1,this.tupletSize=0}get lineOffset(){return(this.lineSpacing+1)*this.scale}get topGlyphOverflow(){const e=this.resources;return(e.tablatureFont.size/2+e.tablatureFont.size*.2)*this.scale}get bottomGlyphOverflow(){const e=this.resources;return(e.tablatureFont.size/2+e.tablatureFont.size*.2)*this.scale}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){let e=this.lineOffset*(this.heightLineCount-1),t=(this.drawnLineCount-1)*this.lineOffset;this.firstLineY=this.topPadding+(e-t)/2}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=15*this.scale+this.resources.effectFont.size*.3,super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintBackground(e,t,i){super.paintBackground(e,t,i);const s=this.resources;i.color=s.staffLineColor;const r=[];for(let a=0,o=this.drawnLineCount;a<o;a++)r.push([]);this.collectSpaces(r);for(const a of r)a.sort((o,h)=>o[0]>h[0]?1:o[0]<h[0]?-1:0);for(let a=0;a<this.drawnLineCount;a++){const o=this.getLineY(a);let h=0;for(let l of r[a])i.fillRect(e+this.x+h,t+this.y+o|0,l[0]-h,this.scale*Le.StaffLineThickness),h=l[0]+l[1];i.fillRect(e+this.x+h,t+this.y+o|0,this.width-h,this.scale*Le.StaffLineThickness)}i.color=s.mainGlyphColor,this.paintSimileMark(e,t,i)}collectSpaces(e){}createStartSpacing(){this._startSpacing||(this.addPreBeatGlyph(new St(0,0,2*this.scale)),this._startSpacing=!0)}paintTuplets(e,t,i){for(const s of this.bar.voices)if(this.hasVoiceContainer(s)){const r=this.getVoiceContainer(s);for(const a of r.tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,i,a)}}paintTupletHelper(e,t,i,s){const r=this.resources;let a=i.textAlign,o=i.textBaseline;i.color=s.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.textAlign=V.Center,i.textBaseline=J.Middle;let h,l=s.beats[0].tupletNumerator,d=s.beats[0].tupletDenominator;l===2&&d===3?h="2":l===3&&d===2?h="3":l===4&&d===6?h="4":l===5&&d===4?h="5":l===6&&d===4?h="6":l===7&&d===4?h="7":l===9&&d===8?h="9":l===10&&d===8?h="10":l===11&&d===8?h="11":l===12&&d===8?h="12":l===13&&d===8?h="13":h=l+":"+d;let c=10*this.scale,f=5*this.scale;if(s.beats.length===1||!s.isFull)for(const p of s.beats){let g=this.helpers.beamHelperLookup[s.voice.index].get(p.index);if(!g)continue;let b=this.getBeamDirection(g),w=g.getBeatLineX(p),D=this.calculateBeamYWithDirection(g,w,b);b===P.Down?D+=c+f:D-=c+f,i.font=r.effectFont,i.fillText(h,e+this.x+w,t+this.y+D)}else{let p=s.beats[0],g=s.beats[s.beats.length-1],b=null,w=null;for(let ut=0;ut<s.beats.length;ut++)if(!s.beats[ut].isRest){b=s.beats[ut];break}for(let ut=s.beats.length-1;ut>=0;ut--)if(!s.beats[ut].isRest){w=s.beats[ut];break}let D=!1;b||(b=p,D=!0),w||(w=g);let R=this.helpers.beamHelperLookup[s.voice.index].get(p.index),B=this.helpers.beamHelperLookup[s.voice.index].get(g.index),X=R.getBeatLineX(p),C=B.getBeatLineX(g),be=this.helpers.beamHelperLookup[s.voice.index].get(b.index),Fe=this.helpers.beamHelperLookup[s.voice.index].get(w.index),Pe=this.getBeamDirection(R),ge=this.calculateBeamYWithDirection(be,X,Pe),ct=this.calculateBeamYWithDirection(Fe,C,Pe);D&&(ge=Math.max(ge,ct),ct=ge),i.font=r.effectFont;let Nt=i.measureText(h).width,si=3*this.scale,xi=(X+C)/2,Zi=xi-Nt/2-si,ks=xi+Nt/2+si,Ni=(ct-ge)/(C-X),Hi=ge-Ni*X,ri=Ni*Zi+Hi,ji=Ni*xi+Hi,es=Ni*ks+Hi;Pe===P.Down&&(c*=-1,f*=-1),i.beginPath(),i.moveTo(e+this.x+X,t+this.y+ge-c|0),i.lineTo(e+this.x+X,t+this.y+ge-c-f|0),i.lineTo(e+this.x+Zi,t+this.y+ri-c-f|0),i.stroke(),i.beginPath(),i.moveTo(e+this.x+ks,t+this.y+es-c-f|0),i.lineTo(e+this.x+C,t+this.y+ct-c-f|0),i.lineTo(e+this.x+C,t+this.y+ct-c|0),i.stroke(),i.fillText(h,e+this.x+xi,t+this.y+ji-c-f)}i.textAlign=a,i.textBaseline=o}paintBeams(e,t,i){for(const s of this.helpers.beamHelpers)for(const r of s)this.paintBeamHelper(e+this.beatGlyphsStart,t,i,r)}drawBeamHelperAsFlags(e){return e.beats.length===1}paintBeamHelper(e,t,i,s){i.color=s.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isRestBeamHelper||(this.drawBeamHelperAsFlags(s)?this.paintFlag(e,t,i,s):this.paintBar(e,t,i,s))}shouldPaintFlag(e,t){return!(e.graceType===W.BendGrace||!t.hasBeatLineX(e)||e.graceType!==W.None&&this.settings.notation.notationMode===Ye.SongBook||e.duration===m.Whole||e.duration===m.DoubleWhole||e.duration===m.QuadrupleWhole)}paintFlag(e,t,i,s){for(const r of s.beats){if(!this.shouldPaintFlag(r,s))continue;let a=r.graceType!==W.None,o=a?$.GraceScale:1,h=this.getFlagStemSize(s.shortestDuration),l=s.getBeatLineX(r),d=this.getBeamDirection(s),c=this.getFlagTopY(r),f=this.getFlagBottomY(r),p=0,g=0;if(d===P.Down?(f+=h*o,p=f,g=t+this.y+f):(c-=h*o,p=c,g=t+this.y+c),this.paintFingering(i,r,e+this.x+l,d,g),!!s.hasLine(!0,r)){if(this.paintBeamingStem(r,t+this.y,e+this.x+l,t+this.y+c,t+this.y+f,i),r.graceType===W.BeforeBeat){let b=15*this.scale,w=12*this.scale;i.beginPath(),d===P.Down?(i.moveTo(e+this.x+l-w/2,t+this.y+f-b),i.lineTo(e+this.x+l+w/2,t+this.y+f)):(i.moveTo(e+this.x+l-w/2,t+this.y+c+b),i.lineTo(e+this.x+l+w/2,t+this.y+c)),i.stroke()}if(s.hasFlag(!0,r)){let b=new ds(l-this.scale/2,p,r.duration,d,a);b.renderer=this,b.doLayout(),b.paint(e+this.x,t+this.y,i)}}}}paintFingering(e,t,i,s,r){let a=this.settings;if(a.notation.fingeringMode!==Ot.ScoreDefault&&a.notation.fingeringMode!==Ot.ScoreForcePiano)return;s===P.Up?i-=10*this.scale:i+=3*this.scale;let o=t.notes.slice(0);o.sort((h,l)=>h.realValue-l.realValue);for(let h=0;h<o.length;h++){let l=o[h],d=null;l.leftHandFinger!==Y.Unknown?d=Be.fingerToString(a,t,l.leftHandFinger,!0):l.rightHandFinger!==Y.Unknown&&(d=Be.fingerToString(a,t,l.rightHandFinger,!1)),d&&(e.fillText(d,i,r),r-=e.font.size|0)}}getFlagStemSize(e){let t=0;switch(e){case m.QuadrupleWhole:case m.Half:case m.Quarter:case m.Eighth:case m.Sixteenth:case m.ThirtySecond:case m.SixtyFourth:case m.OneHundredTwentyEighth:case m.TwoHundredFiftySixth:t=3;break;default:t=0;break}return this.getLineHeight(t)}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.bar.masterBar.isRepeatStart&&this.addPreBeatGlyph(new uh(0,0,1.5,3)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new mh(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs(),this.bar.masterBar.isRepeatEnd?(this.addPostBeatGlyph(new ph(this.x,0)),this.bar.masterBar.repeatCount>2&&this.addPostBeatGlyph(new gh(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))):this.addPostBeatGlyph(new fh(0,0))}paintBar(e,t,i,s){for(let r=0,a=s.beats.length;r<a;r++){let o=s.beats[r];if(!s.hasBeatLineX(o))continue;let l=o.graceType!==W.None?$.GraceScale:1,d=s.getBeatLineX(o),c=this.getBeamDirection(s),f=t+this.y+this.getBarLineStart(o,c),p=t+this.y+this.calculateBeamY(s,d);this.paintBeamingStem(o,t+this.y,e+this.x+d,f,p,i);let g=p;c===P.Down?g+=i.font.size*2:r!==0&&(g-=i.font.size*1.5),this.paintFingering(i,o,e+this.x+d,c,g);let b=6*this.scale*l,w=(Le.BeamSpacing+Le.BeamThickness)*this.scale*l,D=Le.BeamThickness*this.scale*l,R=Be.getIndex(o.duration)-2,B=t+this.y;c===P.Down&&(w=-w,D=-D);for(let X=0;X<R;X++){let C=0,be=0,Fe=0,Pe=0,ge=B+X*w;if(r<s.beats.length-1){if(qt.isFullBarJoin(o,s.beats[r+1],X))C=d,be=s.getBeatLineX(s.beats[r+1]);else if(r===0||!qt.isFullBarJoin(s.beats[r-1],o,X))C=d,be=C+b;else continue;Fe=ge+this.calculateBeamY(s,C),Pe=ge+this.calculateBeamY(s,be),$i.paintSingleBar(i,e+this.x+C,Fe,e+this.x+be,Pe,D)}else r>0&&!qt.isFullBarJoin(o,s.beats[r-1],X)&&(C=d-b,be=d,Fe=ge+this.calculateBeamY(s,C),Pe=ge+this.calculateBeamY(s,be),$i.paintSingleBar(i,e+this.x+C,Fe,e+this.x+be,Pe,D))}}}static paintSingleBar(e,t,i,s,r,a){e.beginPath(),e.moveTo(t,i),e.lineTo(s,r),e.lineTo(s,r+a),e.lineTo(t,i+a),e.closePath(),e.fill()}}class ii extends $i{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.accidentalHelper=new We(this)}get lineSpacing(){return Le.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){let e=this.getScoreY(-2),t=this.getScoreY(10),i=this.simpleWhammyOverflow;this.registerOverflowTop(i);let s=this.getScoreY(this.accidentalHelper.maxLine),r=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.maxLineBeat);r.direction===P.Up&&(s-=this.getStemSize(r),s-=r.fingeringCount*this.resources.graceFont.size,r.hasTuplet&&(s-=this.tupletSize)),s<e&&this.registerOverflowTop(Math.abs(s)+i);let a=this.getScoreY(this.accidentalHelper.minLine),o=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.minLineBeat);o.direction===P.Down&&(a+=this.getStemSize(o),a+=o.fingeringCount*this.resources.graceFont.size,o.hasTuplet&&(a+=this.tupletSize)),a>t&&this.registerOverflowBottom(Math.abs(a)-t)}}paint(e,t,i){super.paint(e,t,i),this.paintBeams(e,t,i),this.paintTuplets(e,t,i)}getFlagTopY(e){return this.getScoreY(this.accidentalHelper.getMinLine(e))}getFlagBottomY(e){return this.getScoreY(this.accidentalHelper.getMaxLine(e))}getBeamDirection(e){return e.direction}getStemSize(e){let t=e.beats.length===1?this.getFlagStemSize(e.shortestDuration):this.getBarStemSize(e.shortestDuration);return e.isGrace&&(t=t*$.GraceScale),t}getBarStemSize(e){let t=0;switch(e){case m.QuadrupleWhole:case m.Half:case m.Quarter:case m.Eighth:case m.Sixteenth:t=6;break;case m.ThirtySecond:t=8;break;case m.SixtyFourth:t=9;break;case m.OneHundredTwentyEighth:t=9;break;case m.TwoHundredFiftySixth:t=10;break;default:t=0;break}return this.getScoreHeight(t)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){let i=super.getNoteY(e,t);if(isNaN(i)){const s=We.computeLineWithoutAccidentals(this.bar,e);i=this.getScoreY(s)}return i}applyLayoutingInfo(){const e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){let t=this.getScoreY(-2),i=this.getScoreY(10),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<t&&this.registerOverflowTop(Math.abs(s[0])),s[1]>i&&this.registerOverflowBottom(Math.abs(s[1])-i)}return e}calculateBeamYWithDirection(e,t,i){let s=this.getStemSize(e);if(!e.drawingInfos.has(i)){let r=new Lo;e.drawingInfos.set(i,r);const a=e.beats[0],o=e.beats[e.beats.length-1];let h=e.isRestBeamHelper;r.startBeat=a,r.startX=e.getBeatLineX(a),h?r.startY=i===P.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):r.startY=i===P.Up?this.getScoreY(this.accidentalHelper.getMinLine(a))-s:this.getScoreY(this.accidentalHelper.getMaxLine(a))+s,r.endBeat=o,r.endX=e.getBeatLineX(o),h?r.endY=i===P.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):r.endY=i===P.Up?this.getScoreY(this.accidentalHelper.getMinLine(o))-s:this.getScoreY(this.accidentalHelper.getMaxLine(o))+s;let l=10*this.scale;if(i===P.Down&&r.startY>r.endY&&r.startY-r.endY>l&&(r.endY=r.startY-l),i===P.Down&&r.endY>r.startY&&r.endY-r.startY>l&&(r.startY=r.endY-l),i===P.Up&&r.startY<r.endY&&r.endY-r.startY>l&&(r.endY=r.startY+l),i===P.Up&&r.endY<r.startY&&r.startY-r.endY>l&&(r.startY=r.endY+l),e.beats.length>1){if(i===P.Up){let d=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-s;const f=r.calcY(e.getBeatLineX(e.beatOfHighestNote))-d;f>0&&(r.startY-=f,r.endY-=f)}else{let d=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+s;const c=r.calcY(e.getBeatLineX(e.beatOfLowestNote)),f=d-c;f>0&&(r.startY+=f,r.endY+=f)}if(e.minRestLine!==null||e.maxRestLine!==null){const d=Be.getIndex(e.shortestDuration)-2;let c=e.isGrace?$.GraceScale:1,f=d*(Le.BeamSpacing+Le.BeamThickness)*this.scale*c;if(f+=Le.BeamSpacing,i===P.Up&&e.minRestLine!==null){let p=this.getScoreY(e.minRestLine)-f;const b=r.calcY(e.getBeatLineX(e.beatOfMinRestLine))-p;b>0&&(r.startY-=b,r.endY-=b)}else if(i===P.Down&&e.maxRestLine!==null){let p=this.getScoreY(e.maxRestLine)+f;const g=r.calcY(e.getBeatLineX(e.beatOfMaxRestLine)),b=p-g;b>0&&(r.startY+=b,r.endY+=b)}}}}return e.drawingInfos.get(i).calcY(t)}getBarLineStart(e,t){return t===P.Up?this.getScoreY(this.accidentalHelper.getMaxLine(e)):this.getScoreY(this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case U.Neutral:e=this.bar.staff.standardNotationLineCount-1;break;case U.F4:e=2;break;case U.C3:e=4;break;case U.C4:e=2;break;case U.G2:e=6;break}this.createStartSpacing(),this.addPreBeatGlyph(new $r(0,this.getScoreY(e)+.5*Le.StaffLineThickness,this.bar.clef,this.bar.clefOttava))}(this.index===0&&this.bar.masterBar.keySignature!==Xe.C||this.bar.previousBar&&this.bar.masterBar.keySignature!==this.bar.previousBar.masterBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){let e=0,t=this.bar.masterBar.keySignature,i=this.bar.previousBar?this.bar.previousBar.masterBar.keySignature:0;switch(this.bar.clef){case U.Neutral:e=0;break;case U.G2:e=1;break;case U.F4:e=3;break;case U.C3:e=2;break;case U.C4:e=0;break}let s=new Map,r=[];if(Be.keySignatureIsSharp(t))for(let h=0;h<Math.abs(t);h++){let l=ii.SharpKsSteps[h]+e;r.push(new ki(0,this.getScoreY(l),ue.Sharp,!1)),s.set(l,!0)}else for(let h=0;h<Math.abs(t);h++){let l=ii.FlatKsSteps[h]+e;r.push(new ki(0,this.getScoreY(l),ue.Flat,!1)),s.set(l,!0)}let a=Math.abs(i),o=Be.keySignatureIsSharp(i)?ii.SharpKsSteps:ii.FlatKsSteps;for(let h=0;h<a;h++){let l=o[h]+e;s.has(l)||this.addPreBeatGlyph(new ki(0,this.getScoreY(o[h]+e),ue.Natural,!1))}for(let h of r)this.addPreBeatGlyph(h)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new St(0,0,5*this.scale));const e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new hh(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon))}createVoiceGlyphs(e){for(const t of e.beats){let i=new ch(t,this.getVoiceContainer(e));i.preNotes=new oh,i.onNotes=new ah,this.addBeatGlyph(i)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(e){if(this.bar.isMultiVoice&&e.highestNoteInHelper&&e.lowestNoteInHelper){let t=this.getNoteY(e.highestNoteInHelper,A.Center),i=this.getNoteY(e.lowestNoteInHelper,A.Center),s=this.getStemSize(e);e.hasTuplet&&(s+=this.resources.effectFont.size*2),e.direction==P.Up?t-=s:i+=s;for(const r of e.beats)this.helpers.collisionHelper.reserveBeatSlot(r,t,i)}}paintBeamingStem(e,t,i,s,r,a){a.lineWidth=Le.StemWidth*this.scale,a.beginPath(),a.moveTo(i,s),a.lineTo(i,r),a.stroke(),a.lineWidth=this.scale}}ii.StaffId="score",ii.SharpKsSteps=[-1,2,-2,1,4,0,3],ii.FlatKsSteps=[3,0,4,1,5,2,6];class xn extends Ms{get staffId(){return ii.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new ii(e,t)}constructor(){super()}}class yh extends Ie{constructor(e,t,i,s){super(0,0),this._inType=e,this._outType=t,this._startNote=i,this._parent=s}doLayout(){this.width=0}paint(e,t,i){this.paintSlideIn(e,t,i),this.paintSlideOut(e,t,i)}paintSlideIn(e,t,i){let s=this.renderer,r=12*this.scale,a=3*this.scale,o=0,h=0,l=0,d=0;switch(this._inType){case $e.IntoFromBelow:l=e+s.x+s.getNoteX(this._startNote,Te.Left),d=t+s.y+s.getNoteY(this._startNote,A.Center),o=l-r,h=t+s.y+s.getNoteY(this._startNote,A.Center)+a;break;case $e.IntoFromAbove:l=e+s.x+s.getNoteX(this._startNote,Te.Left),d=t+s.y+s.getNoteY(this._startNote,A.Center),o=l-r,h=t+s.y+s.getNoteY(this._startNote,A.Center)-a;break;default:return}this.paintSlideLine(i,!1,o,l,h,d)}paintSlideOut(e,t,i){let s=this.renderer,r=12*this.scale,a=3*this.scale,o=0,h=0,l=0,d=0,c=!1;const f=2*this.scale;switch(this._outType){case Q.Shift:case Q.Legato:if(o=e+s.x+s.getBeatX(this._startNote.beat,te.PostNotes),h=t+s.y+s.getNoteY(this._startNote,A.Center),this._startNote.slideTarget){let p=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._startNote.slideTarget.beat.voice.bar);!p||p.staff!==s.staff?(l=e+s.x+s.width,d=h):(l=e+p.x+p.getBeatX(this._startNote.slideTarget.beat,te.OnNotes)-f,d=t+p.y+p.getNoteY(this._startNote.slideTarget,A.Center)),this._startNote.slideTarget.fret>this._startNote.fret?(h+=a,d-=a):(h-=a,d+=a)}else l=e+s.x+this._parent.x,d=h;break;case Q.OutUp:o=e+s.x+s.getNoteX(this._startNote,Te.Right),h=t+s.y+s.getNoteY(this._startNote,A.Center),l=o+r-f,d=t+s.y+s.getNoteY(this._startNote,A.Center)-a;break;case Q.OutDown:o=e+s.x+s.getNoteX(this._startNote,Te.Right),h=t+s.y+s.getNoteY(this._startNote,A.Center),l=o+r-f,d=t+s.y+s.getNoteY(this._startNote,A.Center)+a;break;case Q.PickSlideDown:o=e+s.x+s.getNoteX(this._startNote,Te.Right),h=t+s.y+s.getNoteY(this._startNote,A.Center),l=e+s.x+s.getBeatX(this._startNote.beat,te.EndBeat),d=h+a*3,c=!0;break;case Q.PickSlideUp:o=e+s.x+s.getNoteX(this._startNote,Te.Right),h=t+s.y+s.getNoteY(this._startNote,A.Center),l=e+s.x+s.getBeatX(this._startNote.beat,te.EndBeat),d=h-a*3,c=!0;break;default:return}this.paintSlideLine(i,c,o,l,h,d)}paintSlideLine(e,t,i,s,r,a){if(t){let o=new Mi(0,0,oe.Slight,1.2);o.renderer=this.renderer,o.doLayout(),r-=o.height/2,a-=o.height/2;let h=s-i,l=a-r,d=Math.sqrt(Math.pow(l,2)+Math.pow(h,2));o.width=h;let c=Math.asin(l/d)*(180/Math.PI);e.beginRotate(i,r,c),o.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(i,r),e.lineTo(s,a),e.stroke()}}class Ti extends Qe{constructor(e,t,i=!1){super(e.beat,t.beat,i),this.startNote=e,this.endNote=t}getTieHeight(e,t,i,s){return this.startNote===this.endNote?15:super.getTieHeight(e,t,i,s)}getBeamDirection(e,t){return this.startNote===this.endNote?P.Up:Ti.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return e.string>3?P.Up:P.Down}getStartY(){return this.startNote===this.endNote?this.startNoteRenderer.getNoteY(this.startNote,A.Center):this.tieDirection===P.Up?this.startNoteRenderer.getNoteY(this.startNote,A.Top):this.startNoteRenderer.getNoteY(this.startNote,A.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20*this.scale:this.startNoteRenderer.getNoteX(this.startNote,Te.Center)}getEndX(){return this.startNote===this.endNote?this.endNoteRenderer.getNoteX(this.endNote,Te.Left):this.endNoteRenderer.getNoteX(this.endNote,Te.Center)}}class Nn extends Ti{constructor(e,t,i,s=!1){super(e,t,s),this._direction=Ti.getBeamDirectionForNote(e),this._forSlide=i}getTieHeight(e,t,i,s){return Math.log(i-e+1)*this.renderer.settings.notation.slurHeight}tryExpand(e,t,i,s){if(this._forSlide!==i||this.forEnd!==s||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id||this._direction!==Ti.getBeamDirectionForNote(e))return!1;switch(this._direction){case P.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case P.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break}return!0}paint(e,t,i){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.startBeat.voice.bar),r=this.getBeamDirection(this.startBeat,s),a="tab.slur."+this.startNote.beat.id+"."+this.endNote.beat.id+"."+r,o=this.renderer;o.staff.getSharedLayoutData(a,!1)||(o.staff.setSharedLayoutData(a,!0),super.paint(e,t,i))}}class bh extends It{constructor(e,t){super(e,t),this._bend=null,this._effectSlurs=[]}drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;let t=this.renderer;if(e.isTieOrigin&&t.showTiedNotes&&e.tieDestination.isVisible){let i=new Ti(e,e.tieDestination,!1);this.addTie(i)}if(e.isTieDestination&&t.showTiedNotes){let i=new Ti(e.tieOrigin,e,!0);this.addTie(i)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){let i=new Ti(e,e,!1);this.addTie(i)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let i=!1;for(let s of this._effectSlurs)if(s.tryExpand(e,e.effectSlurDestination,!1,!1)){i=!0;break}if(!i){let s=new Nn(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(s),this.addTie(s)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let i=!1;for(let s of this._effectSlurs)if(s.tryExpand(e.effectSlurOrigin,e,!1,!0)){i=!0;break}if(!i){let s=new Nn(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(s),this.addTie(s)}}if(e.slideInType!==$e.None||e.slideOutType!==Q.None){let i=new yh(e.slideInType,e.slideOutType,e,this);this.addTie(i)}if(e.hasBend){if(!this._bend){const i=new At;this._bend=i,i.renderer=this.renderer,this.addTie(i)}this._bend.addBends(e)}}}class wh extends Ie{constructor(e,t,i){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=i}doLayout(){let e=this._note,t=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===O.Natural&&e.harmonicValue!==0&&(t=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)e.beat.index===0&&this.renderer.settings.notation.notationMode==Ye.GuitarPro||(e.bendType===M.Bend||e.bendType===M.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(G.TabNotesOnTiedBends)?this._noteString="("+(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()+")":this._noteString="";else if(this._noteString=e.isDead?"x":t.toString(),e.isGhost)this._noteString="("+this._noteString+")";else if(e.harmonicType===O.Natural){let i=this._noteString.indexOf(".");i>=0&&(this._noteString=this._noteString.substr(0,i+2)),this._noteString="<"+this._noteString+">"}if(e.isTrill)this._trillNoteString="("+(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()+")";else if(Be.isAlmostEqualTo(e.harmonicValue,0))this._trillNoteString="";else switch(e.harmonicType){case O.Artificial:case O.Pinch:case O.Tap:case O.Semi:case O.Feedback:let i=(t+e.harmonicValue).toString(),s=i.indexOf(".");s>=0&&(i=i.substr(0,s+2)),this._trillNoteString="<"+i+">";break;default:this._trillNoteString="";break}this.isEmpty=!this._noteString,this.isEmpty||(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont,this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString).width*this.scale,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,this._trillNoteString&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3*this.scale+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth))}paint(e,t,i){if(this.isEmpty)return;let s=this.noteStringWidth+this._trillNoteStringWidth,r=e+this.x+(this.width-s)/2,a=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,i.fillText(this._trillNoteString,r+this.noteStringWidth+3*this.scale,t+this.y),this.renderer.scoreRenderer.canvas.font=a,i.fillText(this._noteString,r,t+this.y)}buildBoundingsLookup(e,t,i){let s=new Ds;s.note=this._note,s.noteHeadBounds=new gt,s.noteHeadBounds.x=t+this.x,s.noteHeadBounds.y=i+this.y-this.height/2,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,e.addNote(s)}}class Sh extends Ie{constructor(e,t,i){super(e,t),this._notes=[],this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=i}buildBoundingsLookup(e,t,i){for(const s of this._notes)s.buildBoundingsLookup(e,t+this.x,i+this.y)}getNoteX(e,t){if(this.notesPerString.has(e.string)){let i=this.notesPerString.get(e.string),s=this.x+i.x;switch(t){case Te.Left:break;case Te.Center:s+=i.noteStringWidth/2;break;case Te.Right:s+=i.width;break}return s}return 0}getNoteY(e,t){if(this.notesPerString.has(e.string)){const i=this.notesPerString.get(e.string);let s=this.y+i.y;switch(t){case A.Top:case A.TopWithStem:s-=i.height/2+2*this.scale;break;case A.Center:break;case A.Bottom:case A.BottomWithStem:s+=i.height/2;break}return s}return 0}doLayout(){let e=0,t=0;for(let a=0,o=this._notes.length;a<o;a++){let h=this._notes[a];h.renderer=this.renderer,h.doLayout(),h.width>e&&(e=h.width),h.noteStringWidth>t&&(t=h.noteStringWidth)}this.noteStringWidth=t;let i=this.renderer.resources.tablatureFont.size,s=this.getNoteY(this.minStringNote,A.Center)+i/2,r=7*this.scale;for(const a of this.beatEffects.values())a.y+=s,a.x+=this.width/2,a.renderer=this.renderer,s+=r,a.doLayout();this.width=e}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t)}paint(e,t,i){e+=this.x,t+=this.y;let s=this.renderer.resources,r=i.textBaseline;i.textBaseline=J.Middle,i.font=this._isGrace?s.graceFont:s.tablatureFont;let a=this._notes,o=this.width;for(let h of a)h.renderer=this.renderer,h.width=o,h.paint(e,t,i);i.textBaseline=r;for(const h of this.beatEffects.values())h.paint(e,t,i)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class Bh extends De{constructor(e,t,i,s){super(e,t,1,Ai.getSymbol(s)),this._isVisibleRest=i,this._duration=s}doLayout(){this._isVisibleRest?this.width=Ai.getSize(this._duration)*this.scale:this.width=10*this.scale}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,i){this._isVisibleRest&&super.paint(e,t,i)}}class kh extends ms{constructor(){super(...arguments),this.noteNumbers=null,this.restGlyph=null}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}buildBoundingsLookup(e,t,i){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,i+this.y)}doLayout(){let e=this.renderer;if(this.container.beat.isRest){let i=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=e.getTabY(i);const r=new Bh(0,s,e.showRests,this.container.beat.duration);if(this.restGlyph=r,r.beat=this.container.beat,r.beamingHelper=this.beamingHelper,this.addGlyph(r),this.container.beat.dots>0&&e.showRests){this.addGlyph(new St(0,0,5*this.scale));for(let a=0;a<this.container.beat.dots;a++)this.addGlyph(new Xs(0,s,1.5*this.scale))}}else{let i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==W.None;const s=new Sh(0,0,i);this.noteNumbers=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper;for(let r of this.container.beat.notes)r.isVisible&&this.createNoteGlyph(r);if(this.addGlyph(s),this.container.beat.hasWhammyBar){let r=new vt(this.container.beat);r.renderer=this.renderer,r.doLayout(),this.container.ties.push(r)}if(this.container.beat.isTremolo&&!this.noteNumbers.beatEffects.has("tremolo")){let r=0,a=this.container.beat.tremoloSpeed;switch(a){case m.ThirtySecond:r=10;break;case m.Sixteenth:r=5;break;case m.Eighth:r=0;break}this.noteNumbers.beatEffects.set("tremolo",new $s(5*this.scale,r*this.scale,a))}if(this.container.beat.dots>0&&e.settings.notation.rhythmMode!==hi.Hidden){this.addGlyph(new St(0,0,5*this.scale));for(let r=0;r<this.container.beat.dots;r++)this.addGlyph(new Xs(0,e.lineOffset*e.bar.staff.tuning.length+e.settings.notation.rhythmHeight*e.scale,1.5*this.scale))}}if(!this.glyphs)return;let t=0;for(let i=0,s=this.glyphs.length;i<s;i++){let r=this.glyphs[i];r.x=t,r.renderer=this.renderer,r.doLayout(),t+=r.width}this.width=t,this.computedWidth=t,this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2}updateBeamingHelper(){this.container.beat.isRest?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.noteNumbers.updateBeamingHelper(this.container.x+this.x)}createNoteGlyph(e){let t=this.renderer,i=new wh(0,0,e),s=e.beat.voice.bar.staff.tuning.length-e.string;i.y=t.getTabY(s),i.renderer=this.renderer,i.doLayout(),this.noteNumbers.addNoteGlyph(i,e);let r=i.y-i.height/2,a=r+i.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,r,a)}}class _h extends Ie{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10*this.scale}paint(e,t,i){let s=this.renderer,r=t+this.x+s.getNoteY(this._beat.maxStringNote,A.Top),a=t+this.y+s.getNoteY(this._beat.minStringNote,A.Bottom),o=e+this.x+this.width/2|0,h=8*this.scale;if(this._beat.brushType!==Se.None){if(this._beat.brushType===Se.BrushUp||this._beat.brushType===Se.BrushDown)i.beginPath(),i.moveTo(o,r),i.lineTo(o,a),i.stroke();else if(this._beat.brushType===Se.ArpeggioUp){let l=new Mi(0,0,oe.Slight,1.2,!0);l.renderer=this.renderer,l.doLayout();let d=r,c=a-h;l.width=Math.abs(c-d),i.beginRotate(e+this.x+4*this.scale,c,-90),l.paint(0,-l.height/2,i),i.endRotate()}else if(this._beat.brushType===Se.ArpeggioDown){let l=new Mi(0,0,oe.Slight,1.2,!0);l.renderer=this.renderer,l.doLayout();let d=r+h,c=a;l.width=Math.abs(c-d),i.beginRotate(e+this.x+4*this.scale,d,90),l.paint(0,-l.height/2,i),i.endRotate()}this._beat.brushType===Se.BrushUp||this._beat.brushType===Se.ArpeggioUp?(i.beginPath(),i.moveTo(o,a),i.lineTo(o+h/2,a-h),i.lineTo(o-h/2,a-h),i.closePath(),i.fill()):(i.beginPath(),i.moveTo(o,r),i.lineTo(o+h/2,r+h),i.lineTo(o-h/2,r+h),i.closePath(),i.fill())}}}class Th extends gs{doLayout(){this.container.beat.brushType!==Se.None&&!this.container.beat.isRest&&(this.addGlyph(new _h(this.container.beat)),this.addGlyph(new St(0,0,4*this.scale))),super.doLayout()}constructor(){super()}}class xh extends Ie{constructor(e,t){super(e,t)}doLayout(){this.width=28*this.scale}paint(e,t,i){let s=this.renderer.bar.staff.tuning.length,r=s<=4?u.FourStringTabClef:u.SixStringTabClef,a=s<=4?s/4.5:s/6.5;i.fillMusicFontSymbol(e+this.x+5*this.scale,t+this.y,a*this.scale,r,!1)}}class Nh extends _n{get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?$.GraceScale:1}}class Ki extends $i{constructor(e,t){super(e,t),this._hasTuplets=!1,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1}get lineSpacing(){return Ki.TabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){const t=this.scale;for(let i of this.bar.voices)if(this.hasVoiceContainer(i)){let s=this.getVoiceContainer(i);for(let r of s.beatGlyphs){let a=r.onNotes,o=a.noteNumbers;if(o)for(const[h,l]of o.notesPerString)l.isEmpty||e[this.bar.staff.tuning.length-h].push(new Float32Array([s.x+r.x+a.x+o.x,o.width+t]))}}}adjustSizes(){this.settings.notation.rhythmMode!==hi.Hidden&&(this.height+=this.settings.notation.rhythmHeight*this.settings.display.scale,this.bottomPadding+=this.settings.notation.rhythmHeight*this.settings.display.scale)}doLayout(){if(super.doLayout(),this.settings.notation.rhythmMode!==hi.Hidden){this._hasTuplets=!1;for(let e of this.bar.voices)if(this.hasVoiceContainer(e)&&this.getVoiceContainer(e).tupletGroups.length>0){this._hasTuplets=!0;break}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){let e=(this.bar.staff.tuning.length-1)/2;this.addPreBeatGlyph(new xh(5*this.scale,this.getTabY(e)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new St(0,0,5*this.scale));const e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new Nh(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon))}createVoiceGlyphs(e){for(const t of e.beats){let i=new bh(t,this.getVoiceContainer(e));i.preNotes=new Th,i.onNotes=new kh,this.addBeatGlyph(i)}}paint(e,t,i){super.paint(e,t,i),this.settings.notation.rhythmMode!==hi.Hidden&&(this.paintBeams(e,t,i),this.paintTuplets(e,t,i))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.settings.notation.rhythmMode===hi.ShowWithBeams}getFlagTopY(e){const t=this.getOnNotesGlyphForBeat(e);return!t.noteNumbers||e.duration===m.Half?this.height-this.settings.notation.rhythmHeight*this.settings.display.scale-this.tupletSize:t.noteNumbers.getNoteY(t.noteNumbers.minStringNote,A.Bottom)}getFlagBottomY(e){return this.getFlagAndBarPos()}getFlagStemSize(e){return 0}getBarLineStart(e,t){let i=this.getOnNotesGlyphForBeat(e);return!i.noteNumbers||e.duration===m.Half?this.height-this.settings.notation.rhythmHeight*this.settings.display.scale-this.tupletSize:i.noteNumbers.getNoteY(i.noteNumbers.minStringNote,A.Bottom)+this.lineOffset/2}getBeamDirection(e){return P.Down}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,t,i){return this.getFlagAndBarPos()}shouldPaintFlag(e,t){return!super.shouldPaintFlag(e,t)||e.graceType!==W.None?!1:this.drawBeamHelperAsFlags(t)}paintBeamingStem(e,t,i,s,r,a){if(r<s){const l=r;r=s,s=l}a.lineWidth=Le.StemWidth*this.scale,a.beginPath();let o=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(o=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice(),o.sort((l,d)=>l.topY-d.topY));let h=r;for(;h>s;){a.moveTo(i,h);let l=s;if(o.length>0&&o[o.length-1].bottomY>l){const d=o.pop();l=t+d.bottomY,a.lineTo(i,l),h=t+d.topY}else{a.lineTo(i,l);break}}a.stroke(),a.lineWidth=this.scale}}Ki.StaffId="tab",Ki.TabLineSpacing=10;class ea extends Ms{get staffId(){return Ki.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(e,t,i){super(),this._showTimeSignature=e,this._showRests=t,this._showTiedNotes=i,this.hideOnPercussionTrack=!0}canCreate(e,t){return t.tuning.length>0&&super.canCreate(e,t)}create(e,t){let i=new Ki(e,t);return i.showRests=this._showRests,i.showTimeSignature=this._showTimeSignature,i.showTiedNotes=this._showTiedNotes,i}}class Bs extends Yt{constructor(){super(0,0)}doLayout(){super.doLayout();const e=this.renderer.resources.effectFont;this.height=e.size+Bs.Padding*this.scale}paint(e,t,i){let s=this.renderer.resources;i.font=s.effectFont;let r=i.textAlign;i.textAlign=V.Center,i.fillText("T",e+this.x,t+this.y+i.font.size/2),i.textAlign=r,i.strokeCircle(e+this.x,t+this.y+i.font.size/2+(Bs.Padding-1)*this.scale,i.font.size/1.6)}}Bs.Padding=4;class js extends Ii{get notationElement(){return G.EffectTap}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new Bs}}class yi{constructor(){this.noteRange=1,this.x=0,this.y=0}}var Vi;(function(n){n[n.None=0]="None",n[n.Rectangle=1]="Rectangle",n[n.Ellipse=2]="Ellipse",n[n.Circle=3]="Circle"})(Vi||(Vi={}));class ta extends yi{constructor(){super(...arguments),this.align=V.Left,this.frame=Vi.None,this.text="",this.fontFace="",this.weight=0,this.height=0}}class Pn extends yi{constructor(){super(...arguments),this.chord=new bi}}class Cn extends yi{}class Ln extends yi{}class Ph extends yi{constructor(){super(...arguments),this.number=0}}class vn extends yi{constructor(){super(...arguments),this.decrescendo=!1}}class ia extends yi{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}}class Ch extends yi{constructor(){super(...arguments),this.octave=1}}class Lh extends yi{}class vh{constructor(){this.defaultClef=U.G2,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}}class Fh{constructor(){this.from=0,this.to=0,this.curly=!1}}class Eh{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}}class er{constructor(){this._trackChannel=0,this._beamingMode=Wt.Auto,this._isFirstSystem=!0,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new li,this._voiceStates=new Map}parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;let i=new Ps;try{i.parse(e)}catch(s){throw new xe("Could not parse XML",s)}this.parseDom(i),this.consolidate(),this.score.finish(t)}consolidate(){for(const e of this.score.tracks){const t=this._voiceCounts.get(e.index);for(const i of e.staves){for(;i.bars.length<this.score.masterBars.length;)this.addNewBar(i);for(const s of i.bars){for(;s.voices.length<t;)s.addVoice(new Qt);for(const r of s.voices)if(r.beats.length===0){const a=new rt;a.isEmpty=!0,r.addBeat(a)}}}}er.applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),er.applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?mt.Decrescendo:mt.Crescendo})}static applyEffectRange(e,t){for(const[i,s]of e){const r=s.noteRange;let a=i;for(let o=0;o<r;o++)if(t(s,a),a.index+1<a.voice.beats.length)a=a.voice.beats[a.index+1];else if(a.voice.bar.index+1<a.voice.bar.staff.bars.length)a=a.voice.bar.staff.bars[a.voice.bar.index+1].voices[a.voice.index].beats[0];else break}}parseDom(e){let t=e.firstElement;if(!t)throw new xe("No valid XML");if(t.localName==="score"){this.score=new Li,this.score.tempo=120;for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"info":this.parseInfo(i);break;case"layout":this.parseLayout(i);break;case"gallery":this.parseGallery(i);break;case"pageObjects":this.parsePageObjects(i);break;case"systems":this.parseSystems(i);break}}else throw new xe('Root node of XML was not "score"')}parseLayout(e){for(let r of e.childNodes)if(r.nodeType===k.Element)switch(r.localName){case"staves":this.parseLayoutStaves(r);break;case"brackets":this.parseBrackets(r);break}const t=this._brackets.filter(r=>!!r.curly);t.sort((r,a)=>r.from-a.from);let i=0,s=null;for(let r=0;r<this._staffLayouts.length;r++){const a=this._staffLayouts[r];for(;i<t.length&&r>t[i].to;)i++;s&&i<t.length&&r>t[i].from&&r<=t[i].to?s.ensureStaveCount(s.staves.length+1):(s=new Jt,s.ensureStaveCount(1),s.name=a.description,s.playbackInfo.volume=Math.floor(a.volume/128*16),s.playbackInfo.program=a.instrument,a.percussion?(s.playbackInfo.primaryChannel=9,s.playbackInfo.secondaryChannel=9):(s.playbackInfo.primaryChannel=this._trackChannel++,s.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(s));const o=s.staves[s.staves.length-1];o.isPercussion=a.percussion,o.transpositionPitch=a.transpose,o.displayTranspositionPitch=0,o.showTablature=!1,this._staffLookup.set(a.index,o)}}parseBrackets(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"bracket":this.parseBracket(t);break}}parseBracket(e){const t=new Fh;t.from=parseInt(e.getAttribute("from")),t.to=parseInt(e.getAttribute("to")),e.attributes.has("curly")&&(t.curly=e.attributes.get("curly")==="true"),this._brackets.push(t)}parseLayoutStaves(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"staffLayout":this.parseStaffLayout(t);break}}parseStaffLayout(e){const t=new vh;t.description=e.getAttribute("description");for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"notation":i.attributes.has("defaultClef")&&(t.defaultClef=this.parseClef(i.attributes.get("defaultClef")));break;case"sound":i.attributes.has("percussion")&&(t.percussion=i.attributes.get("percussion")==="true"),i.attributes.has("instr")&&(t.instrument=parseInt(i.attributes.get("instr"))),i.attributes.has("volume")&&(t.volume=parseInt(i.attributes.get("volume"))),i.attributes.has("transpose")&&(t.transpose=parseInt(i.attributes.get("transpose")));break}this._staffLayoutLookup.set(t.description,t),t.index=this._staffLayouts.length,this._staffLayouts.push(t)}parseClef(e){switch(e){case"treble":return U.G2;case"bass":return U.F4;case"alto":return U.C4;case"tenor":return U.C4}return U.G2}parseClefOttava(e){return e.endsWith("-")?le._8vb:e.endsWith("+")?le._8va:le.Regular}parseSystems(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"system":this.parseSystem(t);break}}parseSystem(e){e.attributes.has("tempo")&&this.score.masterBars.length===0&&(this.score.tempo=parseInt(e.attributes.get("tempo"))),e.getAttribute("beamGrouping")==="0"&&(this._beamingMode=Wt.ForceSplitToNext);for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"staves":this.parseStaves(e,t);break}this._isFirstSystem=!1}parseStaves(e,t){let i=this.score.masterBars.length;for(let s of t.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"staff":this.parseStaff(e,i,s);break}}parseStaff(e,t,i){const s=i.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(s),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this.parseTime(i.getAttribute("defaultTime"));const r=this._staffLookup.get(this._currentStaffLayout.index);for(;r.bars.length<t;)this.addNewBar(r);for(let a of i.childNodes)if(a.nodeType===k.Element)switch(a.localName){case"voices":this.parseVoices(s,r,e,t,a);break}}parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(e.indexOf("/")>0){const t=e.split("/");this._timeSignature.timeSignatureNumerator=parseInt(t[0]),this._timeSignature.timeSignatureDenominator=parseInt(t[1]),this._timeSignature.timeSignatureCommon=!1}break}}parseVoices(e,t,i,s,r){let a=0;for(let o of r.childNodes)if(o.nodeType===k.Element)switch(o.localName){case"voice":this.parseVoice(e,t,i,a,s,o),a++;break}}getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this.addNewBar(e)}addNewBar(e){let t=new oi;if(e.bars.length>0?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length){let i=new li;this.score.addMasterBar(i),i.index>0&&(i.keySignature=i.previousMasterBar.keySignature,i.keySignatureType=i.previousMasterBar.keySignatureType,i.tripletFeel=i.previousMasterBar.tripletFeel),i.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,i.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,i.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return t}newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this.getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this.ensureVoice(e,t)}parseVoice(e,t,i,s,r,a){const o=e+"_"+s;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(o)?(this._currentVoiceState=this._voiceStates.get(o),this._currentBar=this.getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this.ensureVoice(t,s)):(this._currentVoiceState=new Eh,this._currentVoiceState.currentBarIndex=r-1,this._voiceStates.set(o,this._currentVoiceState),this.newBar(t,s)),a.attributes.has("stemDir"))switch(a.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=P.Up;break;case"down":this._currentVoiceState.voiceStemDir=P.Down;break;default:this._currentVoiceState.voiceStemDir=null;break}else this._currentVoiceState.voiceStemDir=null;const h=a.findChildElement("noteObjects");if(i.attributes.has("tempo")){const l=new st;l.isLinear=!0,l.type=Ge.Tempo,l.value=parseInt(i.attributes.get("tempo")),l.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(l)}if(h){for(let l of h.childNodes)if(l.nodeType===k.Element)switch(this._currentVoiceState.currentBarComplete&&l.localName!=="barline"&&this.newBar(t,s),l.localName){case"clefSign":this._currentBar.clef=this.parseClef(l.getAttribute("clef")),this._currentBar.clefOttava=this.parseClefOttava(l.getAttribute("clef"));break;case"keySign":this._currentBar.masterBar.keySignature=parseInt(l.getAttribute("fifths"));break;case"timeSign":this.parseTime(l.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(l.getAttribute("type")){case"double":this._currentBar.masterBar.isDoubleBar=!0,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(l),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this.newBar(t,s),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(l),this.newBar(t,s),this._currentBar.masterBar.isRepeatStart=!0;break;case"dashed":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break}break;case"chord":let d=new rt;this.initFromPreviousBeat(d,this._currentVoice),d.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(d.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this.parseDuration(this._currentBar,d,l.findChildElement("duration")),d.updateDurations(),this._currentVoiceState.currentPosition+=d.playbackDuration,this._currentVoice.addBeat(d),this.parseChord(d,l),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":const c=this.parseRestDurations(this._currentBar,l.findChildElement("duration"));c&&(this.initFromPreviousBeat(c,this._currentVoice),c.updateDurations(),this._currentVoiceState.currentPosition+=c.playbackDuration,this._currentVoice.addBeat(c),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0));break}}}initFromPreviousBeat(e,t){let i=this.getLastBeat(t);i&&(e.dynamics=i.dynamics)}getLastBeat(e){if(e.beats.length>0)return e.beats[e.beats.length-1];if(e.bar.index>0){const t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length){const i=t.voices[e.index];return this.getLastBeat(i)}}return null}ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new Qt);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}parseChord(e,t){const i=new Ee;for(let s of t.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"stem":switch(s.getAttribute("dir")){case"up":e.preferredBeamDirection=P.Up;break;case"down":e.preferredBeamDirection=P.Down;break}break;case"articulation":switch(s.getAttribute("type")){case"staccato":i.isStaccato=!0;break;case"normalAccent":i.accentuated=He.Normal;break;case"strongAccent":i.accentuated=He.Heavy;break}break;case"lyric":this.parseLyric(e,s);break;case"drawObjects":this.parseBeatDrawObject(e,s);break;case"heads":this.parseHeads(e,i,s);break;case"beam":switch(s.getAttribute("group")){case"force":e.beamingMode=Wt.ForceMergeWithNext;break;case"divide":e.beamingMode=Wt.ForceSplitToNext;break}break}}parseHeads(e,t,i){for(let s of i.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"head":this.parseHead(e,t,s);break}}parseHead(e,t,i){const s=new Ee,r=Be.parseTuning(i.getAttribute("pitch"));s.octave=r.octave-1,s.tone=r.noteValue,s.isStaccato=t.isStaccato,s.accentuated=t.accentuated,e.addNote(s);for(let a of i.childNodes)if(a.nodeType===k.Element)switch(a.localName){case"alter":a.attributes.has("step")&&(s.tone+=parseInt(a.attributes.get("step")));break;case"tie":a.attributes.has("begin")?this._tieStartIds.has(s.id)||(this._tieStartIds.set(s.id,!0),this._tieStarts.push(s)):a.attributes.has("end")&&this._tieStarts.length>0&&!s.isTieDestination&&(s.isTieDestination=!0,s.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(s.id));break}}parseBeatDrawObject(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"drawObj":const s=this.parseDrawObj(i);if(s){if(s instanceof ta)s.fontFace.startsWith("capella")?s.text==="u"?(e.fermata=new rr,e.fermata.type=Gt.Medium):s.text==="f"?e.dynamics=j.F:s.text==="j"&&(e.dynamics=j.MF):this._isFirstSystem&&this.score.title===""&&s.align===V.Center&&s.height>16&&s.weight>400?this.score.title=s.text:this._isFirstSystem&&this.score.artist===""&&s.align===V.Center&&s.y<0?this.score.artist=s.text:this._isFirstSystem&&this.score.music===""&&s.align===V.Right&&s.y<0?this.score.music=s.text:s.text.startsWith("by capella")||(e.text=s.text);else if(!(s instanceof Pn))if(s instanceof Ln)e.vibrato=oe.Slight;else if(s instanceof vn)e.crescendo=s.decrescendo?mt.Decrescendo:mt.Crescendo,s.noteRange++,this._crescendo.set(e,s);else if(s instanceof Cn){const r=s;this._slurs.set(e,r)}else s instanceof ia&&this.applyVolta(s)}break}}parseBarDrawObject(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"drawObj":const i=this.parseDrawObj(t);i&&i instanceof ia&&this.applyVolta(i);break}}applyVolta(e){if(e.lastNumber>0?(this._currentVoiceState.repeatCount=e.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):e.firstNumber>0&&(this._currentVoiceState.repeatCount=e.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),e.lastNumber>0&&e.firstNumber>0){let t=0;for(let i=e.firstNumber;i<=e.lastNumber;i++)t=t|1<<i-1;this._currentBar.masterBar.alternateEndings=t}else e.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<e.lastNumber-1:e.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<e.firstNumber-1)}parseLyric(e,t){for(let i of t.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"verse":e.lyrics||(e.lyrics=[]);let s=i.innerText;i.getAttribute("hyphen")==="true"&&(s+="-"),e.lyrics.push(s);break}}parseRestDurations(e,t){const i=t.getAttribute("base");if(i.indexOf("/")!==-1){let r=new rt;return r.beamingMode=this._beamingMode,this.parseDuration(e,r,t),r}if(parseInt(i)===1){let r=new rt;return r.beamingMode=this._beamingMode,r.duration=m.Whole,r}else return _.warning("Importer","Multi-Bar rests are not supported"),null}parseDurationValue(e){switch(e){case"2/1":return m.DoubleWhole;case"1/1":return m.Whole;case"1/2":return m.Half;case"1/4":return m.Quarter;case"1/8":return m.Eighth;case"1/16":return m.Sixteenth;case"1/32":return m.ThirtySecond;case"1/64":return m.SixtyFourth;case"1/128":return m.OneHundredTwentyEighth;default:return _.warning("Importer","Unsupported duration"),m.Quarter}}parseDuration(e,t,i){const s=i.getAttribute("base");t.duration=this.parseDurationValue(s),i.attributes.has("dots")&&(t.dots=parseInt(i.attributes.get("dots")));const r=i.findChildElement("tuplet");if(r){t.tupletNumerator=parseInt(r.getAttribute("count"));const a=r.getAttribute("tripartite")==="true"?3:1,o=r.getAttribute("prolong")==="true"?0:1;let h=0;for(;a*Math.pow(2,h+o)<t.tupletNumerator;)h++;t.tupletDenominator=a*Math.pow(2,h)}}parsePageObjects(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"drawObj":const i=this.parseDrawObj(t);if(i&&i instanceof ta)switch(i.align){case V.Center:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case V.Right:this.score.artist||(this.score.artist=t.innerText);break}break}}parseGallery(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"drawObj":const i=this.parseDrawObj(t);i&&this._galleryObjects.set(t.getAttribute("name"),i);break}}parseDrawObj(e){let t=null,i=1;for(let s of e.childNodes)if(s.nodeType===k.Element)switch(s.localName){case"text":t=this.parseText(s);break;case"guitar":t=this.parseGuitar(s);break;case"slur":t=this.parseSlur(s);break;case"wavyLine":t=this.parseWavyLine(s);break;case"bracket":t=this.parseTupletBracket(s);break;case"wedge":t=this.parseWedge(s);break;case"volta":t=this.parseVolta(s);break;case"octaveClef":t=this.parseOctaveClef(s);break;case"trill":t=this.parseTrill(s);break;case"basic":s.attributes.has("noteRange")&&(i=parseInt(s.attributes.get("noteRange")));break}return t&&(t.noteRange=i),t}parseTrill(e){return new Lh}parseOctaveClef(e){const t=new Ch;return e.attributes.has("octave")&&(t.octave=parseInt(e.attributes.get("octave"))),t}parseVolta(e){const t=new ia;return t.allNumbers=e.attributes.get("allNumbers")==="true",e.attributes.has("firstNumber")&&(t.firstNumber=parseInt(e.attributes.get("firstNumber"))),e.attributes.has("lastNumber")&&(t.lastNumber=parseInt(e.attributes.get("lastNumber"))),t}parseWedge(e){const t=new vn;return t.decrescendo=e.attributes.get("decrescendo")==="true",t}parseTupletBracket(e){const t=new Ph;return e.attributes.has("number")&&(t.number=parseInt(e.attributes.get("number"))),t}parseWavyLine(e){return new Ln}parseSlur(e){return new Cn}parseGuitar(e){const t=new Pn,i=e.innerText.trim();for(let s=0;s<i.length;s++)i.charAt(s)==="/"?t.chord.strings.push(0):t.chord.strings.push(parseInt(i.charAt(s)));return t}parseText(e){const t=new ta;switch(e.attributes.has("x")&&(t.x=parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=V.Left;break;case"center":t.align=V.Center;break;case"right":t.align=V.Right;break}switch(e.getAttribute("frame")){case"rectangle":t.frame=Vi.Rectangle;break;case"ellipse":t.frame=Vi.Ellipse;break;case"circle":t.frame=Vi.Circle;break;case"none":t.frame=Vi.None;break}if(e.firstElement){for(let i of e.childNodes)if(i.nodeType===k.Element)switch(i.localName){case"font":t.fontFace=i.getAttribute("face"),i.attributes.has("weight")&&(t.weight=parseInt(i.attributes.get("weight"))),i.attributes.has("height")&&(t.height=parseInt(i.attributes.get("height")));break;case"content":t.text=i.innerText;break}}else t.text=e.innerText;return t}parseInfo(e){for(let t of e.childNodes)if(t.nodeType===k.Element)switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText;break}}}class Dh extends Gi{get name(){return"Capella"}constructor(){super()}readScore(){_.debug(this.name,"Loading ZIP entries");let e=new lr(this.data),t,i=null;if(t=e.read(),_.debug(this.name,"Zip entries loaded"),t.length>0)for(let s of t)switch(s.fileName){case"score.xml":i=S.toString(s.data,this.settings.importer.encoding);break}else this.data.reset(),i=S.toString(this.data.readAll(),this.settings.importer.encoding);if(!i)throw new xe("No valid capella file");_.debug(this.name,"Start Parsing score.xml");try{let s=new er;return s.parseXml(i,this.settings),_.debug(this.name,"score.xml parsed"),s.score}catch(s){throw new xe("Failed to parse CapXML",s)}}}class Rh{constructor(e){this._targets=new Set,this._callback=e,window.addEventListener("resize",this.onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}onWindowResize(){const e=[];for(const t of this._targets)e.push({target:t,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(e,this)}}class Ih{constructor(e){this._elements=[];let t=null;const i=this._check.bind(this);this._check=()=>{t||(t=setTimeout(()=>{i(),t=null},100))},this._callback=e,window.addEventListener("resize",this._check,!0),document.addEventListener("scroll",this._check,!0)}observe(e){this._elements.indexOf(e)>=0||(this._elements.push(e),this._check())}unobserve(e){this._elements=this._elements.filter(t=>t!=e)}_check(){const e=[];this._elements.forEach(t=>{const i=t.getBoundingClientRect();i.top+i.height>=0&&i.top<=window.innerHeight&&i.left+i.width>=0&&i.left<=window.innerWidth&&e.push({target:t,isIntersecting:!0})}),e.length&&this._callback(e,this)}}function Fn(n,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var i,s;if(i===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=e[Symbol.dispose]}if(typeof i!="function")throw new TypeError("Object not disposable.");s&&(i=function(){try{s.call(this)}catch(r){return Promise.reject(r)}}),n.stack.push({value:e,dispose:i,async:t})}return e}var Mh=typeof SuppressedError=="function"?SuppressedError:function(n,e,t){var i=new Error(t);return i.name="SuppressedError",i.error=n,i.suppressed=e,i};function En(n){function e(i){n.error=n.hasError?new Mh(i,n.error,"An error was suppressed during disposal."):i,n.hasError=!0}function t(){for(;n.stack.length;){var i=n.stack.pop();try{var s=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(s).then(t,function(r){return e(r),t()})}catch(r){e(r)}}if(n.hasError)throw n.error}return t()}class _e{static enable(e,t){_e.alphaSkia=t,_e.initializeMusicFont(_e.alphaSkia.AlphaSkiaTypeface.register(e))}static initializeMusicFont(e){_e.musicFont=e}static registerFont(e,t){const i=_e.alphaSkia.AlphaSkiaTypeface.register(e.buffer);t||(t=ne.withFamilyList([i.familyName],12,i.isItalic?Ce.Italic:Ce.Plain,i.isBold?_t.Bold:_t.Regular));for(const s of t.families)this.customTypeFaces.set(_e.customTypefaceKey(s,t.isBold,t.isItalic),i);return t}static customTypefaceKey(e,t,i){return e.toLowerCase()+"_"+t+"_"+i}getTypeFace(){if(this._typeFaceCache!=this.font.toCssString(this.settings.display.scale)){if(this._typeFaceIsSystem){const t={stack:[],error:void 0,hasError:!1};try{const i=Fn(t,this._typeFace,!1)}catch(i){t.error=i,t.hasError=!0}finally{En(t)}}for(const t of this.font.families){var e=_e.customTypefaceKey(t,this.font.isBold,this.font.isItalic);_e.customTypeFaces.has(e)?(this._typeFaceIsSystem=!1,this._typeFace=_e.customTypeFaces.get(e)):(this._typeFaceIsSystem=!0,this._typeFace=_e.alphaSkia.AlphaSkiaTypeface.create(t,this.font.isBold,this.font.isItalic))}this._typeFaceCache=this.font.toCssString(this.settings.display.scale)}return this._typeFace}constructor(){this._color=new fe(0,0,0,0),this._lineWidth=0,this._typeFaceCache="",this._typeFaceIsSystem=!1,this._typeFace=null,this.font=new ne("Arial",10,Ce.Plain),this.textAlign=V.Left,this.textBaseline=J.Top,this._canvas=new _e.alphaSkia.AlphaSkiaCanvas,this.color=new fe(0,0,0,255)}destroy(){const e={stack:[],error:void 0,hasError:!1};try{const t=Fn(e,this._canvas,!1)}catch(t){e.error=t,e.hasError=!0}finally{En(e)}}onRenderFinished(){return null}beginRender(e,t){this._canvas.beginRender(e,t,v.HighDpiFactor)}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._canvas.color=_e.alphaSkia.AlphaSkiaCanvas.rgbaToColor(e.r,e.g,e.b,e.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,t,i,s){i>0&&this._canvas.fillRect(e|0,t|0,i,s)}strokeRect(e,t,i,s){this._canvas.strokeRect(e|0,t|0,i,s)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,t){this._canvas.moveTo(e,t)}lineTo(e,t){this._canvas.lineTo(e,t)}quadraticCurveTo(e,t,i,s){this._canvas.quadraticCurveTo(e,t,i,s)}bezierCurveTo(e,t,i,s,r,a){this._canvas.bezierCurveTo(e,t,i,s,r,a)}fillCircle(e,t,i){this._canvas.fillCircle(e,t,i)}strokeCircle(e,t,i){this._canvas.strokeCircle(e,t,i)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(e){}endGroup(){}fillText(e,t,i){if(e.length==0)return;let s=_e.alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case V.Left:s=_e.alphaSkia.AlphaSkiaTextAlign.Left;break;case V.Center:s=_e.alphaSkia.AlphaSkiaTextAlign.Center;break;case V.Right:s=_e.alphaSkia.AlphaSkiaTextAlign.Right;break}let r=_e.alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case J.Top:r=_e.alphaSkia.AlphaSkiaTextBaseline.Top;break;case J.Middle:r=_e.alphaSkia.AlphaSkiaTextBaseline.Middle;break;case J.Bottom:r=_e.alphaSkia.AlphaSkiaTextBaseline.Bottom;break}this._canvas.fillText(e,this.getTypeFace(),this.font.size*this.settings.display.scale,t,i,s,r)}measureText(e){return new Ts(this._canvas.measureText(e,this.getTypeFace(),this.font.size*this.settings.display.scale),this.font.size*_e.FontSizeToLineHeight)}fillMusicFontSymbol(e,t,i,s,r){s!==u.None&&this.fillMusicFontSymbolText(e,t,i,String.fromCharCode(s),r)}fillMusicFontSymbols(e,t,i,s,r){let a="";for(let o of s)o!==u.None&&(a+=String.fromCharCode(o));this.fillMusicFontSymbolText(e,t,i,a,r)}fillMusicFontSymbolText(e,t,i,s,r){this._canvas.fillText(s,_e.musicFont,v.MusicFontSize*this.settings.display.scale*i,e,t,r?_e.alphaSkia.AlphaSkiaTextAlign.Center:_e.alphaSkia.AlphaSkiaTextAlign.Left,_e.alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,t,i){this._canvas.beginRotate(e,t,i)}endRotate(){this._canvas.endRotate()}}_e.musicFont=null,_e.customTypeFaces=new Map,_e.FontSizeToLineHeight=1.2;class xt extends De{constructor(e,t,i,s){super(e,t,s?$.GraceScale:1,xt.getSymbol(i)),this._isGrace=s,this._duration=i}paint(e,t,i){let s=this._isGrace?this.scale:0;i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this.symbol,!1)}doLayout(){const e=(this._isGrace?$.GraceScale:1)*this.scale;switch(this._duration){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:this.width=xt.WholeNoteHeadWidth*e;break;case m.Half:this.width=xt.HalfNoteHeadWidth*e;break;default:this.width=xt.QuarterNoteHeadWidth*e;break}this.height=xt.NoteHeadHeight*e}static getSymbol(e){switch(e){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:return u.NoteheadSlashWhiteWhole;case m.Half:return u.NoteheadSlashWhiteHalf;default:return u.NoteheadSlashVerticalEnds}}}xt.NoteHeadHeight=17,xt.QuarterNoteHeadWidth=12,xt.HalfNoteHeadWidth=25,xt.WholeNoteHeadWidth=32;class Dn extends Qe{constructor(e,t,i=!1){super(e.beat,t.beat,i),this.startNote=e,this.endNote=t}getTieHeight(e,t,i,s){return this.startNote===this.endNote?15:super.getTieHeight(e,t,i,s)}getBeamDirection(e,t){return P.Down}static getBeamDirectionForNote(e){return P.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,A.Center)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20*this.scale:this.startNoteRenderer.getNoteX(this.startNote,Te.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,Te.Left)}}class Ah extends It{constructor(e,t){super(e,t),this._tiedNoteTie=null}createTies(e){if(e.isVisible){if(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible){let t=new Dn(e,e.tieDestination,!1);this._tiedNoteTie=t,this.addTie(t)}if(!this._tiedNoteTie&&e.isTieDestination){let t=new Dn(e.tieOrigin,e,!0);this._tiedNoteTie=t,this.addTie(t)}}}}class Oh extends Ai{constructor(e,t,i){super(e,t,i)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class Vh extends ms{constructor(){super(...arguments),this.noteHeads=null,this.restGlyph=null}getNoteX(e,t){if(this.noteHeads){let i=this.noteHeads.x;switch(t){case Te.Left:break;case Te.Center:i+=this.noteHeads.width/2;break;case Te.Right:i+=this.noteHeads.width;break}return i}return 0}buildBoundingsLookup(e,t,i){if(this.noteHeads&&this.container.beat.notes.length>0){const s=new Ds;s.note=this.container.beat.notes[0],s.noteHeadBounds=new gt,s.noteHeadBounds.x=t+this.x+this.noteHeads.x,s.noteHeadBounds.y=i+this.y+this.noteHeads.y-this.noteHeads.height/2,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,e.addNote(s)}}getNoteY(e,t){if(this.noteHeads){let i=this.y+this.noteHeads.y;switch(t){case A.Top:case A.TopWithStem:i-=this.noteHeads.height/2+2*this.scale;break;case A.Center:break;case A.Bottom:case A.BottomWithStem:i+=this.noteHeads.height/2;break}return i}return 0}updateBeamingHelper(){this.noteHeads?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.noteHeads.x+this.noteHeads.width,this.container.x+this.x+this.noteHeads.x+this.noteHeads.width):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){let e=this.renderer;const t=e.getNoteLine(),i=e.getLineY(t);if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const s=new Oh(0,i,this.container.beat.duration);this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addGlyph(s),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{const s=this.container.beat.graceType!==W.None,r=new xt(0,i,this.container.beat.duration,s);this.noteHeads=r,this.addGlyph(r)}if(this.container.beat.dots>0){this.addGlyph(new St(0,0,5*this.scale));for(let s=0;s<this.container.beat.dots;s++)this.addGlyph(new Xs(0,e.getLineY(e.getNoteLine())-e.getLineHeight(.5),1.5*this.scale))}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteHeads.x+this.noteHeads.width/2}}class sa extends $i{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0}get lineSpacing(){return Le.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,t,i){super.paint(e,t,i),this.paintBeams(e,t,i),this.paintTuplets(e,t,i)}doLayout(){super.doLayout();let e=!1;for(let t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e){return this.getLineY(0)-xt.NoteHeadHeight/2*this.scale}getFlagBottomY(e){return this.getLineY(0)-xt.NoteHeadHeight/2*this.scale}getBeamDirection(e){return P.Up}getNoteY(e,t){let i=super.getNoteY(e,t);return isNaN(i)&&(i=this.getLineY(0)),i}calculateBeamYWithDirection(e,t,i){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,t){return this.getLineY(0)-xt.NoteHeadHeight/2*this.scale}createLinePreBeatGlyphs(){}createVoiceGlyphs(e){for(const t of e.beats){let i=new Ah(t,this.getVoiceContainer(e));i.preNotes=new gs,i.onNotes=e.index==0?new Vh:new ms,this.addBeatGlyph(i)}}paintBeamingStem(e,t,i,s,r,a){a.lineWidth=Le.StemWidth*this.scale,a.beginPath(),a.moveTo(i,s),a.lineTo(i,r),a.stroke(),a.lineWidth=this.scale}}sa.StaffId="slash";class tr extends Ms{get staffId(){return sa.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new sa(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showSlash}constructor(){super()}}class Rn{constructor(e,t){this.vertical=e,this.createLayout=t}}class ra{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}}class v{static createStyleElement(e,t){let i=e.getElementById("alphaTabStyle");if(!i){if(!t){_.error("AlphaTab","Font directory could not be detected, cannot create style element");return}i=e.createElement("style"),i.id="alphaTabStyle";let s=`
            @font-face {
                font-family: 'alphaTab';
                 src: url('${t}Bravura.eot');
                 src: url('${t}Bravura.eot?#iefix') format('embedded-opentype')
                      , url('${t}Bravura.woff') format('woff')
                      , url('${t}Bravura.otf') format('opentype')
                      , url('${t}Bravura.svg#Bravura') format('svg');
                 font-weight: normal;
                 font-style: normal;
            }
            .at-surface * {
                cursor: default;
                vertical-align: top;
                overflow: visible;
            }
            .at-surface-svg text {
                dominant-baseline: central;
            }
            .at {
                 font-family: 'alphaTab';
                 speak: none;
                 font-style: normal;
                 font-weight: normal;
                 font-variant: normal;
                 text-transform: none;
                 line-height: 1;
                 line-height: 1;
                 -webkit-font-smoothing: antialiased;
                 -moz-osx-font-smoothing: grayscale;
                 font-size: ${v.MusicFontSize}px;
                 overflow: visible !important;
            }`;i.innerHTML=s,e.getElementsByTagName("head").item(0).appendChild(i),v.bravuraFontChecker.checkForFontAvailability()}}static get globalThis(){if(v._globalThis===void 0){try{v._globalThis=globalThis}catch{}typeof v._globalThis>"u"&&(v._globalThis=self),typeof v._globalThis>"u"&&(v._globalThis=global),typeof v._globalThis>"u"&&(v._globalThis=window),typeof v._globalThis>"u"&&(v._globalThis=Function("return this")())}return this._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in v.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in v.globalThis}static throttle(e,t){let i=0;return()=>{v.globalThis.clearTimeout(i),i=v.globalThis.setTimeout(e,t)}}static detectScriptFile(){if(!v.isRunningInWorker&&v.globalThis.ALPHATAB_ROOT){let e=v.globalThis.ALPHATAB_ROOT;return e=v.ensureFullUrl(e),e=v.appendScriptName(e),e}try{const e=self.location.href;if(e&&e.indexOf("file://")===-1)return e}catch{}return"document"in v.globalThis&&document.currentScript?document.currentScript.src:null}static ensureFullUrl(e){var t,i,s;if(!e)return"";if(!e.startsWith("http")&&!e.startsWith("https")&&!e.startsWith("file")){let r="",a=v.globalThis.location;if(r+=(t=a.protocol)==null?void 0:t.toString(),r+="//",a.hostname&&(r+=(i=a.hostname)==null?void 0:i.toString()),a.port&&(r+=":",r+=(s=a.port)==null?void 0:s.toString()),!e.startsWith("/")){let o=a.pathname.split("/").slice(0,-1).join("/");o.length>0&&(o.startsWith("/")||(r+="/"),r+=o==null?void 0:o.toString())}return e.startsWith("/")||(r+="/"),r+=e==null?void 0:e.toString(),r}return e}static appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static detectFontDirectory(){if(!v.isRunningInWorker&&v.globalThis.ALPHATAB_FONT)return v.ensureFullUrl(v.globalThis.ALPHATAB_FONT);const e=v.scriptFile;if(e){let t=e.lastIndexOf("/");if(t>=0)return e.substr(0,t)+"/font/"}return null}static registerJQueryPlugin(){if(!v.isRunningInWorker&&v.globalThis&&"jQuery"in v.globalThis){let e=v.globalThis.jQuery,t=new nn;e.fn.alphaTab=function(i){const s=Array.prototype.slice.call(arguments,1);return this.length===1?t.exec(this[0],i,s):this.each((r,a)=>{t.exec(a,i,s)})},e.alphaTab={restore:nn.restore},e.fn.alphaTab.fn=t}}static getRenderEngineFactory(e){return!e||!v.renderEngines.has(e)?v.renderEngines.get("default"):v.renderEngines.get(e)}static getLayoutEngineFactory(e){return!e||!v.layoutEngines.has(e)?v.layoutEngines.get(ai.Page):v.layoutEngines.get(e)}static buildImporters(){return[new $t,new qn,new Yn,new Jn,new Dh,new ht]}static createDefaultRenderEngines(){const e=new Map;return e.set("svg",new ra(!0,()=>new No)),e.set("default",e.get("svg")),e.set("skia",new ra(!1,()=>new _e)),v.createPlatformSpecificRenderEngines(e),e}static enableAlphaSkia(e,t){_e.enable(e,t)}static registerAlphaSkiaCustomFont(e,t){return _e.registerFont(e,t)}static createPlatformSpecificRenderEngines(e){e.set("html5",new ra(!1,()=>new oo))}static createDefaultStaveProfiles(){const e=new Map;e.set(Bt.ScoreTab,[new ti("top-effects",[new qr,new Qr,new zr,new Jr,new Ar]),new tr,new ti("score-effects",[new Hr,new yn,new Gs,new Vs(!0),new zs,new Ws,new Us,new Hs,new js,new Mr]),new xn,new ti("tab-effects",[new un,new Vs(!1),new fn,new Os,new Gs,new zs,new Ws,new Us,new Hs,new mn,new Vr,new Lt(O.Natural),new Lt(O.Artificial),new Lt(O.Pinch),new Lt(O.Tap),new Lt(O.Semi),new Lt(O.Feedback),new Gr,new cn,new pn,new Ur,new Xr,new Yr,new js]),new ea(!1,!1,!1)]),e.set(Bt.Score,[new ti("top-effects",[new qr,new Qr,new zr,new Jr,new Ar]),new tr,new ti("score-effects",[new Hr,new yn,new Gs,new Vs(!0),new zs,new Ws,new Us,new Hs,new Vr,new Gr,new Ur,new Xr,new Yr,new js,new Mr]),new xn,new ti("score-bottom-effects",[new un,new Vs(!1),new fn,new Os])]);let t=[new qr,new Qr,new zr,new Jr,new Ar,new Hr,new Gs,new zs,new Ws,new Us,new Hs,new mn,new Vr,new Lt(O.Artificial),new Lt(O.Pinch),new Lt(O.Tap),new Lt(O.Semi),new Lt(O.Feedback),new Gr,new cn,new pn,new Ur,new Xr,new Yr,new js,new Mr];return e.set(Bt.Tab,[new tr,new ti("tab-effects",t),new ea(!0,!0,!0),new ti("tab-bottom-effects",[new Os])]),e.set(Bt.TabMixed,[new tr,new ti("tab-effects",t),new ea(!1,!1,!1),new ti("tab-bottom-effects",[new Os])]),e}static createDefaultLayoutEngines(){const e=new Map;return e.set(ai.Page,new Rn(!0,t=>new Ko(t))),e.set(ai.Horizontal,new Rn(!1,t=>new $o(t))),e}static initializeMain(e,t){v.isRunningInWorker||v.isRunningInAudioWorklet||((v.webPlatform===Kt.Browser||v.webPlatform===Kt.BrowserModule)&&(v.registerJQueryPlugin(),v.HighDpiFactor=window.devicePixelRatio,"ResizeObserver"in v.globalThis||(v.globalThis.ResizeObserver=Rh),"IntersectionObserver"in v.globalThis||(v.globalThis.IntersectionObserver=Ih),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...i){this.innerHTML="",this.append(...i)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(i,s){return this.replace(new RegExp(i,"g"),s)})),v.createWebWorker=e,v.createAudioWorklet=t)}static get alphaTabWorker(){return this.globalThis.Worker}static initializeWorker(){if(!v.isRunningInWorker)throw new nt(at.General,"Not running in worker, cannot run worker initialization");Er.init(),Fr.init(),v.createWebWorker=e=>{throw new nt(at.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!v.isRunningInAudioWorklet)throw new nt(at.General,"Not running in audio worklet, cannot run worklet initialization");cs.init()}static detectWebPack(){try{if(typeof __webpack_require__=="function")return!0}catch{}return!1}static detectVite(){try{if(typeof __BASE__=="string")return!0}catch{}return!1}static detectWebPlatform(){try{if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return Kt.NodeJs}catch{}try{const e=self.location.href;if(e&&typeof e=="string"&&!e.startsWith("file://"))return Kt.BrowserModule}catch{}return Kt.Browser}}v.MusicFontSize=34,v.HighDpiFactor=1,v._globalThis=void 0,v.webPlatform=v.detectWebPlatform(),v.isWebPackBundled=v.detectWebPack(),v.isViteBundled=v.detectVite(),v.scriptFile=v.detectScriptFile(),v.fontDirectory=v.detectFontDirectory(),v.bravuraFontChecker=new sn(["alphaTab"]),v.renderEngines=v.createDefaultRenderEngines(),v.layoutEngines=v.createDefaultLayoutEngines(),v.staveProfiles=v.createDefaultStaveProfiles();class In{constructor(){this.scriptFile=null,this.fontDirectory=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=Vt.Info,this.useWorkers=!0,this.includeNoteBounds=!1,this.scriptFile=v.scriptFile,this.fontDirectory=v.fontDirectory}}var T;(function(n){n[n.SteelGuitar=1]="SteelGuitar",n[n.AcousticGuitar=2]="AcousticGuitar",n[n.TwelveStringGuitar=3]="TwelveStringGuitar",n[n.ElectricGuitar=4]="ElectricGuitar",n[n.Bass=5]="Bass",n[n.ClassicalGuitar=23]="ClassicalGuitar",n[n.UprightBass=6]="UprightBass",n[n.Ukulele=7]="Ukulele",n[n.Banjo=8]="Banjo",n[n.Mandolin=9]="Mandolin",n[n.Piano=10]="Piano",n[n.Synth=12]="Synth",n[n.Strings=11]="Strings",n[n.Brass=13]="Brass",n[n.Reed=14]="Reed",n[n.Woodwind=15]="Woodwind",n[n.Vocal=16]="Vocal",n[n.PitchedIdiophone=17]="PitchedIdiophone",n[n.Fx=21]="Fx",n[n.PercussionKit=18]="PercussionKit",n[n.Idiophone=19]="Idiophone",n[n.Membraphone=20]="Membraphone"})(T||(T={}));class N{constructor(e,t,i=null){if(this.icon=T.Piano,this.icon=e,this.instrumentSetName=t,i)this.instrumentSetType=i;else{const s=t.split(" ");s[0]=s[0].substr(0,1).toLowerCase()+s[0].substr(1),this.instrumentSetType=s.join("")}}}new N(T.Piano,"Acoustic Piano"),new N(T.Piano,"Acoustic Piano"),new N(T.Piano,"Electric Piano"),new N(T.Piano,"Acoustic Piano"),new N(T.Piano,"Electric Piano"),new N(T.Piano,"Electric Piano"),new N(T.Piano,"Harpsichord"),new N(T.Piano,"Harpsichord"),new N(T.PitchedIdiophone,"Celesta"),new N(T.PitchedIdiophone,"Vibraphone"),new N(T.PitchedIdiophone,"Vibraphone"),new N(T.PitchedIdiophone,"Vibraphone"),new N(T.PitchedIdiophone,"Xylophone"),new N(T.PitchedIdiophone,"Xylophone"),new N(T.PitchedIdiophone,"Vibraphone"),new N(T.Banjo,"Banjo"),new N(T.Piano,"Electric Organ"),new N(T.Piano,"Electric Organ"),new N(T.Piano,"Electric Organ"),new N(T.Piano,"Electric Organ"),new N(T.Piano,"Electric Organ"),new N(T.Piano,"Electric Organ"),new N(T.Woodwind,"Recorder"),new N(T.Piano,"Electric Organ"),new N(T.ClassicalGuitar,"Nylon Guitar"),new N(T.SteelGuitar,"Steel Guitar"),new N(T.SteelGuitar,"Electric Guitar"),new N(T.ElectricGuitar,"Electric Guitar"),new N(T.ElectricGuitar,"Electric Guitar"),new N(T.ElectricGuitar,"Electric Guitar"),new N(T.SteelGuitar,"Electric Guitar"),new N(T.SteelGuitar,"Electric Guitar"),new N(T.Bass,"Acoustic Bass"),new N(T.Bass,"Electric Bass"),new N(T.Bass,"Electric Bass"),new N(T.Bass,"Acoustic Bass"),new N(T.Bass,"Electric Bass"),new N(T.Bass,"Electric Bass"),new N(T.Synth,"Synth Bass"),new N(T.Synth,"Synth Bass"),new N(T.Strings,"Violin"),new N(T.Strings,"Viola"),new N(T.Strings,"Cello"),new N(T.Strings,"Contrabass"),new N(T.Strings,"Violin"),new N(T.Strings,"Violin"),new N(T.Piano,"Harp"),new N(T.Membraphone,"Timpani"),new N(T.Strings,"Violin"),new N(T.Strings,"Violin"),new N(T.Strings,"Violin"),new N(T.Strings,"Violin"),new N(T.Vocal,"Voice"),new N(T.Vocal,"Voice"),new N(T.Vocal,"Voice"),new N(T.Synth,"Pad Synthesizer"),new N(T.Brass,"Trumpet"),new N(T.Brass,"Trombone"),new N(T.Brass,"Tuba"),new N(T.Brass,"Trumpet"),new N(T.Brass,"French Horn"),new N(T.Brass,"Trumpet"),new N(T.Brass,"Trumpet"),new N(T.Brass,"Trumpet"),new N(T.Reed,"Saxophone"),new N(T.Reed,"Saxophone"),new N(T.Reed,"Saxophone"),new N(T.Reed,"Saxophone"),new N(T.Reed,"Oboe"),new N(T.Reed,"English Horn"),new N(T.Reed,"Bassoon"),new N(T.Reed,"Clarinet"),new N(T.Reed,"Piccolo"),new N(T.Woodwind,"Flute"),new N(T.Woodwind,"Recorder"),new N(T.Woodwind,"Flute"),new N(T.Woodwind,"Recorder"),new N(T.Woodwind,"Flute"),new N(T.Woodwind,"Recorder"),new N(T.Woodwind,"Flute"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Lead Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Synth,"Pad Synthesizer"),new N(T.Fx,"Pad Synthesizer"),new N(T.Fx,"Pad Synthesizer"),new N(T.Fx,"Pad Synthesizer"),new N(T.Fx,"Pad Synthesizer"),new N(T.Fx,"Lead Synthesizer"),new N(T.Fx,"Lead Synthesizer"),new N(T.Fx,"Lead Synthesizer"),new N(T.Fx,"Trumpet"),new N(T.ElectricGuitar,"Banjo"),new N(T.Banjo,"Banjo"),new N(T.Ukulele,"Ukulele"),new N(T.Banjo,"Banjo"),new N(T.PitchedIdiophone,"Xylophone"),new N(T.Reed,"Bassoon"),new N(T.Strings,"Violin"),new N(T.Woodwind,"Flute"),new N(T.PitchedIdiophone,"Xylophone"),new N(T.Idiophone,"Celesta"),new N(T.PitchedIdiophone,"Vibraphone"),new N(T.Idiophone,"Xylophone"),new N(T.Membraphone,"Xylophone"),new N(T.Membraphone,"Xylophone"),new N(T.Membraphone,"Xylophone"),new N(T.Idiophone,"Celesta"),new N(T.Fx,"Steel Guitar"),new N(T.Fx,"Recorder"),new N(T.Fx,"Recorder"),new N(T.Fx,"Recorder"),new N(T.Fx,"Recorder"),new N(T.Fx,"Recorder"),new N(T.Fx,"Recorder"),new N(T.Fx,"Timpani"),new N(T.PercussionKit,"Drums","drumKit");class Wi{static buildCrc32Lookup(){const t=new Uint32Array(256);for(let i=0;i<t.length;i++){let s=i;for(let r=0;r<8;r++)s=(s&1)===1?s>>>1^3988292384:s>>>1;t[i]=s}return t}get value(){return~this._checkValue}constructor(){this._checkValue=Wi.CrcInit,this.reset()}update(e,t,i){for(let s=0;s<i;s++)this._checkValue=Wi.Crc32Lookup[(this._checkValue^e[t+s])&255]^this._checkValue>>>8}reset(){this._checkValue=Wi.CrcInit}}Wi.Crc32Lookup=Wi.buildCrc32Lookup(),Wi.CrcInit=4294967295;class ve{}ve.MAX_WBITS=15,ve.WSIZE=1<<ve.MAX_WBITS,ve.WMASK=ve.WSIZE-1,ve.MIN_MATCH=3,ve.MAX_MATCH=258,ve.DEFAULT_MEM_LEVEL=8,ve.PENDING_BUF_SIZE=1<<ve.DEFAULT_MEM_LEVEL+8,ve.HASH_BITS=ve.DEFAULT_MEM_LEVEL+7,ve.HASH_SIZE=1<<ve.HASH_BITS,ve.HASH_SHIFT=(ve.HASH_BITS+ve.MIN_MATCH-1)/ve.MIN_MATCH,ve.HASH_MASK=ve.HASH_SIZE-1,ve.MIN_LOOKAHEAD=ve.MAX_MATCH+ve.MIN_MATCH+1,ve.MAX_DIST=ve.WSIZE-ve.MIN_LOOKAHEAD;class Ft{constructor(e,t,i,s){this.length=null,this.numCodes=0,this.codes=null,this.huffman=e,this.minNumCodes=i,this.maxLength=s,this.freqs=new Int16Array(t),this.bitLengthCounts=new Int32Array(s)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this.codes=null,this.length=null}buildTree(){let e=this.freqs.length,t=new Int32Array(e),i=0,s=0;for(let l=0;l<e;l++){let d=this.freqs[l];if(d!==0){let c=i++;for(;c>0;){let f=Math.floor((c-1)/2);if(this.freqs[t[f]]>d)t[c]=t[f],c=f;else break}t[c]=l,s=l}}for(;i<2;){let l=s<2?++s:0;t[i++]=l}this.numCodes=Math.max(s+1,this.minNumCodes);let r=i,a=new Int32Array(4*i-2),o=new Int32Array(2*i-1),h=r;for(let l=0;l<i;l++){let d=t[l];a[2*l]=d,a[2*l+1]=-1,o[l]=this.freqs[d]<<8,t[l]=l}do{let l=t[0],d=t[--i],c=0,f=1;for(;f<i;)f+1<i&&o[t[f]]>o[t[f+1]]&&f++,t[c]=t[f],c=f,f=f*2+1;let p=o[d];for(;f=c,c>0;)if(c=Math.floor((f-1)/2),o[t[c]]>p)t[f]=t[c];else break;t[f]=d;let g=t[0];d=h++,a[2*d]=l,a[2*d+1]=g;let b=Math.min(o[l]&255,o[g]&255);for(p=o[l]+o[g]-b+1,o[d]=p,c=0,f=1;f<i;)f+1<i&&o[t[f]]>o[t[f+1]]&&f++,t[c]=t[f],c=f,f=c*2+1;for(;f=c,f>0;)if(c=Math.floor((f-1)/2),o[t[c]]>p)t[f]=t[c];else break;t[f]=d}while(i>1);this.buildLength(a)}buildLength(e){this.length=new Uint8Array(this.freqs.length);let t=Math.floor(e.length/2),i=Math.floor((t+1)/2),s=0;for(let h=0;h<this.maxLength;h++)this.bitLengthCounts[h]=0;let r=new Int32Array(t);r[t-1]=0;for(let h=t-1;h>=0;h--)if(e[2*h+1]!=-1){let l=r[h]+1;l>this.maxLength&&(l=this.maxLength,s++),r[e[2*h]]=l,r[e[2*h+1]]=l}else{let l=r[h];this.bitLengthCounts[l-1]++,this.length[e[2*h]]=r[h]}if(s==0)return;let a=this.maxLength-1;do{for(;this.bitLengthCounts[--a]==0;);do this.bitLengthCounts[a]--,this.bitLengthCounts[++a]++,s-=1<<this.maxLength-1-a;while(s>0&&a<this.maxLength-1)}while(s>0);this.bitLengthCounts[this.maxLength-1]+=s,this.bitLengthCounts[this.maxLength-2]-=s;let o=2*i;for(let h=this.maxLength;h!=0;h--){let l=this.bitLengthCounts[h-1];for(;l>0;){let d=2*e[o++];e[d+1]==-1&&(this.length[e[d]]=h,l--)}}}getEncodedLength(){let e=0;for(let t=0;t<this.freqs.length;t++)e+=this.freqs[t]*this.length[t];return e}calcBLFreq(e){let t,i,s,r=-1,a=0;for(;a<this.numCodes;){s=1;let o=this.length[a];for(o==0?(t=138,i=3):(t=6,i=3,r!=o&&(e.freqs[o]++,s=0)),r=o,a++;a<this.numCodes&&r==this.length[a]&&(a++,!(++s>=t)););s<i?e.freqs[r]+=s:r!=0?e.freqs[Ft.Repeat3To6]++:s<=10?e.freqs[Ft.Repeat3To10]++:e.freqs[Ft.Repeat11To138]++}}setStaticCodes(e,t){this.codes=e,this.length=t}buildCodes(){let e=new Int32Array(this.maxLength),t=0;this.codes=new Int16Array(this.freqs.length);for(let i=0;i<this.maxLength;i++)e[i]=t,t+=this.bitLengthCounts[i]<<15-i;for(let i=0;i<this.numCodes;i++){let s=this.length[i];s>0&&(this.codes[i]=H.bitReverse(e[s-1]),e[s-1]+=1<<16-s)}}writeTree(e){let t,i,s,r=-1,a=0;for(;a<this.numCodes;){s=1;let o=this.length[a];for(o==0?(t=138,i=3):(t=6,i=3,r!=o&&(e.writeSymbol(o),s=0)),r=o,a++;a<this.numCodes&&r==this.length[a]&&(a++,!(++s>=t)););if(s<i)for(;s-- >0;)e.writeSymbol(r);else r!=0?(e.writeSymbol(Ft.Repeat3To6),this.huffman.pending.writeBits(s-3,2)):s<=10?(e.writeSymbol(Ft.Repeat3To10),this.huffman.pending.writeBits(s-3,3)):(e.writeSymbol(Ft.Repeat11To138),this.huffman.pending.writeBits(s-11,7))}}writeSymbol(e){this.huffman.pending.writeBits(this.codes[e]&65535,this.length[e])}}Ft.Repeat3To6=16,Ft.Repeat3To10=17,Ft.Repeat11To138=18;class H{static staticInit(){let e=0;for(;e<144;)H.staticLCodes[e]=H.bitReverse(48+e<<8),H.staticLLength[e++]=8;for(;e<256;)H.staticLCodes[e]=H.bitReverse(256+e<<7),H.staticLLength[e++]=9;for(;e<280;)H.staticLCodes[e]=H.bitReverse(-256+e<<9),H.staticLLength[e++]=7;for(;e<H.LITERAL_NUM;)H.staticLCodes[e]=H.bitReverse(-88+e<<8),H.staticLLength[e++]=8;for(e=0;e<H.DIST_NUM;e++)H.staticDCodes[e]=H.bitReverse(e<<11),H.staticDLength[e]=5}static bitReverse(e){return H.bit4Reverse[e&15]<<12|H.bit4Reverse[e>>4&15]<<8|H.bit4Reverse[e>>8&15]<<4|H.bit4Reverse[e>>12]}constructor(e){this.last_lit=0,this.extra_bits=0,this.pending=e,this.literalTree=new Ft(this,H.LITERAL_NUM,257,15),this.distTree=new Ft(this,H.DIST_NUM,1,15),this.blTree=new Ft(this,H.BITLEN_NUM,4,7),this.d_buf=new Int16Array(H.BUFSIZE),this.l_buf=new Uint8Array(H.BUFSIZE)}isFull(){return this.last_lit>=H.BUFSIZE}reset(){this.last_lit=0,this.extra_bits=0,this.literalTree.reset(),this.distTree.reset(),this.blTree.reset()}flushStoredBlock(e,t,i,s){this.pending.writeBits((H.STORED_BLOCK<<1)+(s?1:0),3),this.pending.alignToByte(),this.pending.writeShort(i),this.pending.writeShort(~i),this.pending.writeBlock(e,t,i),this.reset()}flushBlock(e,t,i,s){this.literalTree.freqs[H.EOF_SYMBOL]++,this.literalTree.buildTree(),this.distTree.buildTree(),this.literalTree.calcBLFreq(this.blTree),this.distTree.calcBLFreq(this.blTree),this.blTree.buildTree();let r=4;for(let h=18;h>r;h--)this.blTree.length[H.BL_ORDER[h]]>0&&(r=h+1);let a=14+r*3+this.blTree.getEncodedLength()+this.literalTree.getEncodedLength()+this.distTree.getEncodedLength()+this.extra_bits,o=this.extra_bits;for(let h=0;h<H.LITERAL_NUM;h++)o+=this.literalTree.freqs[h]*H.staticLLength[h];for(let h=0;h<H.DIST_NUM;h++)o+=this.distTree.freqs[h]*H.staticDLength[h];a>=o&&(a=o),t>=0&&i+4<a>>3?this.flushStoredBlock(e,t,i,s):a==o?(this.pending.writeBits((H.STATIC_TREES<<1)+(s?1:0),3),this.literalTree.setStaticCodes(H.staticLCodes,H.staticLLength),this.distTree.setStaticCodes(H.staticDCodes,H.staticDLength),this.compressBlock(),this.reset()):(this.pending.writeBits((H.DYN_TREES<<1)+(s?1:0),3),this.sendAllTrees(r),this.compressBlock(),this.reset())}sendAllTrees(e){this.blTree.buildCodes(),this.literalTree.buildCodes(),this.distTree.buildCodes(),this.pending.writeBits(this.literalTree.numCodes-257,5),this.pending.writeBits(this.distTree.numCodes-1,5),this.pending.writeBits(e-4,4);for(let t=0;t<e;t++)this.pending.writeBits(this.blTree.length[H.BL_ORDER[t]],3);this.literalTree.writeTree(this.blTree),this.distTree.writeTree(this.blTree)}compressBlock(){for(let e=0;e<this.last_lit;e++){let t=this.l_buf[e]&255,i=this.d_buf[e];if(i--!=0){let s=H.Lcode(t);this.literalTree.writeSymbol(s);let r=Math.floor((s-261)/4);r>0&&r<=5&&this.pending.writeBits(t&(1<<r)-1,r);let a=H.Dcode(i);this.distTree.writeSymbol(a),r=Math.floor(a/2)-1,r>0&&this.pending.writeBits(i&(1<<r)-1,r)}else this.literalTree.writeSymbol(t)}this.literalTree.writeSymbol(H.EOF_SYMBOL)}tallyDist(e,t){this.d_buf[this.last_lit]=e,this.l_buf[this.last_lit++]=t-3;let i=H.Lcode(t-3);this.literalTree.freqs[i]++,i>=265&&i<285&&(this.extra_bits+=Math.floor((i-261)/4));let s=H.Dcode(e-1);return this.distTree.freqs[s]++,s>=4&&(this.extra_bits+=Math.floor(s/2)-1),this.isFull()}tallyLit(e){return this.d_buf[this.last_lit]=0,this.l_buf[this.last_lit++]=e,this.literalTree.freqs[e]++,this.isFull()}static Lcode(e){if(e==255)return 285;let t=257;for(;e>=8;)t+=4,e=e>>1;return t+e}static Dcode(e){let t=0;for(;e>=4;)t+=2,e=e>>1;return t+e}}H.BUFSIZE=1<<ve.DEFAULT_MEM_LEVEL+6,H.LITERAL_NUM=286,H.STORED_BLOCK=0,H.STATIC_TREES=1,H.DYN_TREES=2,H.DIST_NUM=30,H.staticLCodes=new Int16Array(H.LITERAL_NUM),H.staticLLength=new Uint8Array(H.LITERAL_NUM),H.staticDCodes=new Int16Array(H.DIST_NUM),H.staticDLength=new Uint8Array(H.DIST_NUM),H.BL_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],H.bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),H.BITLEN_NUM=19,H.EOF_SYMBOL=256,H.staticInit(),v.initializeWorker()})();
